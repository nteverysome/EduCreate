generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?
  emailVerified DateTime?
  image         String?
  country       String?   @default("TW")
  language      String?   @default("zh-TW") // 用戶界面語言
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  role          Role      @default(USER)

  // 社區個人資料
  bio         String? // 個人簡介
  socialLinks Json? // 社交媒體連結 {twitter, facebook, linkedin, website}

  accounts             Account[]
  activities           Activity[]
  activityVersions     ActivityVersion[]
  activityVersionLogs  ActivityVersionLog[]
  folders              Folder[]
  h5pContents          H5PContent[]
  invoices             Invoice[]
  notificationSettings NotificationSettings?
  passwordReset        PasswordReset?
  sessions             Session[]
  subscription         Subscription?
  learningProgress     LearningProgress[]
  vocabularySets       VocabularySet[]

  // 社區功能關聯
  activityLikes     ActivityLike[]
  activityBookmarks ActivityBookmark[]
  activityComments  ActivityComment[]
  communityReports  CommunityReport[]

  // 粉絲/關注關係
  following UserFollow[] @relation("UserFollowing")
  followers UserFollow[] @relation("UserFollowers")

  // 自訂標籤
  customTags String[] @default([])

  // 圖片管理
  images        UserImage[]    @relation("UserImages")
  imageTags     ImageTag[]     @relation("UserImageTags")
  imageVersions ImageVersion[] @relation("ImageVersions")

  // SRS 學習系統
  wordProgress     UserWordProgress[] @relation("UserWordProgress")
  learningSessions LearningSession[]  @relation("LearningSessions")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordReset {
  id      String   @id @default(cuid())
  token   String   @unique
  expires DateTime
  userId  String   @unique
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Activity {
  id             String           @id @default(cuid())
  title          String
  description    String?
  content        Json?
  elements       Json             @default("[]")
  type           String
  templateType   String?
  published      Boolean          @default(false)
  isPublic       Boolean          @default(false)
  isDraft        Boolean          @default(false)
  folderId       String?
  lastPlayed     DateTime?
  playCount      Int              @default(0)
  shareCount     Int              @default(0)
  gameTemplateId String?
  aiGenerated    Boolean          @default(false)
  difficulty     DifficultyLevel?
  estimatedTime  String?
  tags           String[]
  geptLevel      GEPTLevel?       @default(ELEMENTARY)
  totalWords     Int              @default(0)

  // 社區分享功能（基礎）
  isPublicShared Boolean @default(false)
  shareToken     String? @unique
  communityPlays Int     @default(0)

  // 社區功能（擴展）
  publishedToCommunityAt DateTime?
  communityCategory      String?
  communityTags          String[]  @default([])
  communityDescription   String?
  communityThumbnail     String?
  communityViews         Int       @default(0)
  communityLikes         Int       @default(0)
  communityBookmarks     Int       @default(0)
  communityComments      Int       @default(0)
  isFeatured             Boolean   @default(false)
  featuredAt             DateTime?
  thumbnailUrl           String? // 活動縮圖 URL（Vercel Blob Storage）
  screenshotStatus       String?   @default("pending") // pending, generating, completed, failed
  screenshotError        String? // 截圖生成錯誤信息
  screenshotRetryCount   Int       @default(0) // 重試次數

  // 原作者追蹤（用於複製活動）
  originalAuthorId     String? // 原作者 ID
  originalAuthorName   String? // 原作者名稱
  copiedFromActivityId String? // 原活動 ID

  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  deletedAt       DateTime?
  templateId      String?
  userId          String
  h5pContentId    String?
  folder          Folder?              @relation(fields: [folderId], references: [id])
  gameTemplate    GameTemplate?        @relation(fields: [gameTemplateId], references: [id])
  h5pContent      H5PContent?          @relation(fields: [h5pContentId], references: [id])
  template        Template?            @relation(fields: [templateId], references: [id])
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  versions        ActivityVersion[]
  versionLogs     ActivityVersionLog[]
  assignments     Assignment[]
  gameSettings    GameSettings?
  matchUpOptions  Json?            // 🔥 Match-up 遊戲選項
  vocabularyItems VocabularyItem[]

  // 社區功能關聯
  likes     ActivityLike[]
  bookmarks ActivityBookmark[]
  comments  ActivityComment[]
  reports   CommunityReport[]

  // 圖片管理
  activityImages ActivityImage[] @relation("ActivityImages")

  // 索引優化
  @@index([isPublicShared, publishedToCommunityAt])
  @@index([communityCategory])
  @@index([communityLikes])
  @@index([communityViews])
  @@index([isFeatured, featuredAt])
  @@index([userId, isPublicShared])
}

model Template {
  id          String       @id @default(cuid())
  name        String
  description String?
  type        TemplateType
  thumbnail   String?
  config      Json
  activities  Activity[]
}

model Folder {
  id          String             @id @default(cuid())
  name        String
  description String?
  color       String?
  icon        String?
  type        FolderType         @default(ACTIVITIES) // 資料夾類型：ACTIVITIES 或 RESULTS
  parentId    String? // 父資料夾 ID（null 表示根目錄）
  depth       Int                @default(0) // 資料夾深度（0 = 根目錄）
  path        String? // 資料夾路徑（例如：/folder1/folder2）
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  deletedAt   DateTime?
  userId      String
  activities  Activity[]
  results     AssignmentResult[] // 資料夾中的結果
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent      Folder?            @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Folder[]           @relation("FolderHierarchy")

  @@unique([name, userId, type, parentId]) // 同一用戶在同一父資料夾下不能有重名資料夾
  @@index([userId, type, parentId]) // 優化查詢性能
  @@index([userId, type, deletedAt]) // 優化查詢性能
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  planId               String
  status               SubStatus @default(ACTIVE)
  startDate            DateTime  @default(now())
  endDate              DateTime?
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  invoices             Invoice[]
  plan                 Plan      @relation(fields: [planId], references: [id])
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Plan {
  id            String          @id @default(cuid())
  name          String
  description   String?
  price         Float
  interval      BillingInterval
  features      String[]
  subscriptions Subscription[]
}

model H5PContent {
  id          String           @id @default(cuid())
  title       String
  description String?
  content     Json             @default("{}")
  library     String           @default("H5P.InteractiveVideo")
  contentType String
  contentPath String
  status      H5PContentStatus @default(DRAFT)
  published   Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  userId      String
  activities  Activity[]
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ActivityVersion {
  id           String               @id @default(cuid())
  versionName  String
  versionNotes String?
  content      Json?
  elements     Json
  published    Boolean              @default(false)
  createdAt    DateTime             @default(now())
  activityId   String
  userId       String
  activity     Activity             @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs         ActivityVersionLog[]
}

model ActivityVersionLog {
  id         String           @id @default(cuid())
  action     String
  details    String?
  createdAt  DateTime         @default(now())
  activityId String
  versionId  String?
  userId     String
  activity   Activity         @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  version    ActivityVersion? @relation(fields: [versionId], references: [id])
}

model Invoice {
  id               String            @id @default(cuid())
  stripeInvoiceId  String            @unique
  amount           Float
  currency         String            @default("usd")
  status           String
  invoiceUrl       String?
  invoicePdf       String?
  createdAt        DateTime          @default(now())
  paidAt           DateTime?
  subscriptionId   String
  userId           String
  subscription     Subscription      @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationLogs NotificationLog[]
}

model NotificationSettings {
  id                       String   @id @default(cuid())
  paymentSuccess           Boolean  @default(true)
  paymentFailed            Boolean  @default(true)
  subscriptionRenewal      Boolean  @default(true)
  subscriptionCancellation Boolean  @default(true)
  promotions               Boolean  @default(false)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  userId                   String   @unique
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model NotificationLog {
  id               String   @id @default(cuid())
  type             String
  recipient        String
  content          String?
  sentAt           DateTime @default(now())
  sentBy           String
  relatedInvoiceId String?
  relatedInvoice   Invoice? @relation(fields: [relatedInvoiceId], references: [id])
}

model GameTemplate {
  id                String          @id @default(cuid())
  name              String          @unique
  displayName       String
  description       String?
  icon              String?
  category          GameCategory    @default(QUIZ)
  difficulty        DifficultyLevel @default(EASY)
  estimatedTime     String?
  features          String[]
  minItems          Int             @default(1)
  maxItems          Int             @default(50)
  requiresEvenItems Boolean         @default(false)
  isActive          Boolean         @default(true)
  isPremium         Boolean         @default(false)
  sortOrder         Int             @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  activities        Activity[]
  gameSettings      GameSettings[]
}

model VisualTheme {
  id              String         @id @default(cuid())
  name            String         @unique
  displayName     String
  description     String?
  thumbnail       String?
  category        ThemeCategory  @default(CLASSIC)
  isPremium       Boolean        @default(false)
  isActive        Boolean        @default(true)
  sortOrder       Int            @default(0)
  primaryColor    String         @default("#007bff")
  secondaryColor  String         @default("#6c757d")
  backgroundColor String         @default("#ffffff")
  textColor       String         @default("#212529")
  accentColor     String?
  borderColor     String?
  fontFamily      String?
  borderRadius    String?
  boxShadow       String?
  backgroundImage String?
  customCSS       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  gameSettings    GameSettings[]
}

model GameSettings {
  id               String        @id @default(cuid())
  activityId       String        @unique
  templateId       String?
  themeId          String?
  visualStyle      String?       // 視覺風格 ID (clouds, videogame, magiclibrary, etc.)
  timerType        TimerType     @default(NONE)
  timerDuration    Int?
  livesCount       Int           @default(0)
  speed            Int           @default(3)  // 遊戲速度 (1-10)
  shuffleQuestions Boolean       @default(false)
  shuffleAnswers   Boolean       @default(false)
  autoProceed      Boolean       @default(true)
  showAnswers      Boolean       @default(true)
  answerLabels     AnswerLabels  @default(ABC)
  enableSounds     Boolean       @default(true)
  enableAnimations Boolean       @default(true)
  allowRetry       Boolean       @default(true)
  showProgress     Boolean       @default(true)
  showScore        Boolean       @default(true)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  activity         Activity      @relation(fields: [activityId], references: [id], onDelete: Cascade)
  template         GameTemplate? @relation(fields: [templateId], references: [id])
  theme            VisualTheme?  @relation(fields: [themeId], references: [id])
}

model AIPrompt {
  id             String       @id @default(cuid())
  name           String       @unique
  templateType   TemplateType
  promptTemplate String
  exampleInput   String?
  exampleOutput  String?
  isActive       Boolean      @default(true)
  version        String       @default("1.0")
  model          String       @default("gpt-4")
  temperature    Float        @default(0.7)
  maxTokens      Int          @default(2000)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model VocabularySet {
  id               String             @id @default(cuid())
  userId           String
  title            String
  description      String?
  geptLevel        GEPTLevel          @default(ELEMENTARY)
  isPublic         Boolean            @default(false)
  totalWords       Int                @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  learningProgress LearningProgress[]
  items            VocabularyItem[]
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("vocabulary_sets")
}

model VocabularyItem {
  id               String             @id @default(cuid())
  setId            String?
  activityId       String?
  english          String
  chinese          String
  phonetic         String?
  partOfSpeech     PartOfSpeech?
  difficultyLevel  Int                @default(1)
  exampleSentence  String?
  notes            String?

  // 英文圖片字段
  imageId          String?            // 英文圖片 ID（關聯到 UserImage）
  imageUrl         String?            // 英文圖片 URL
  imageSize        String?            // 英文圖片大小 (small, medium, large)

  // 中文圖片字段
  chineseImageId   String?            // 中文圖片 ID（關聯到 UserImage）
  chineseImageUrl  String?            // 中文圖片 URL
  chineseImageSize String?            // 中文圖片大小 (small, medium, large)

  audioUrl         String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  learningProgress LearningProgress[]
  activity         Activity?          @relation(fields: [activityId], references: [id], onDelete: Cascade)
  set              VocabularySet?     @relation(fields: [setId], references: [id], onDelete: Cascade)

  // SRS 學習系統
  wordProgress     UserWordProgress[] @relation("WordProgress")
  wordReviews      WordReview[]       @relation("WordReviews")

  // 詞彙分組系統
  prefix           String?            // 字首 (un-, re-, pre-, etc.)
  root             String?            // 字根 (port, dict, vis, etc.)
  suffix           String?            // 字尾 (-er, -tion, -ful, etc.)
  theme            String?            // 主題 (daily_life, school, work, etc.)
  frequency        Int?               // 使用頻率 (1-5, 5 最常用)

  // 新增分組字段
  wordFamily       String?            // 詞彙家族 ID (happy, care, use, etc.)
  antonyms         String?            // 反義詞 ID 列表 (JSON array)
  synonyms         String?            // 同義詞 ID 列表 (JSON array)
  context          String?            // 情境標籤 (restaurant, hospital, airport, etc.)
  syllableCount    Int?               // 音節數量
  phoneticEnding   String?            // 音標結尾 (用於押韻分組)
  emotionalTone    String?            // 情感色彩 (positive, negative, neutral)
  actionType       String?            // 動作類型 (movement, hand, thinking, sensory)
  visualFeature    String?            // 視覺特徵 (color, shape, size, material)
  temporalCategory String?            // 時間類別 (time_point, season, month, duration)
  geptLevel        GEPTLevel?         // GEPT 等級

  @@map("vocabulary_items")
}

model LearningProgress {
  id               String          @id @default(cuid())
  userId           String
  vocabularySetId  String
  vocabularyItemId String?
  gameType         String
  correctCount     Int             @default(0)
  incorrectCount   Int             @default(0)
  totalAttempts    Int             @default(0)
  bestScore        Int             @default(0)
  averageScore     Float           @default(0)
  masteryLevel     Int             @default(0)
  lastReviewed     DateTime?
  nextReview       DateTime?
  reviewInterval   Int             @default(1)
  totalStudyTime   Int             @default(0)
  sessionCount     Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  vocabularyItem   VocabularyItem? @relation(fields: [vocabularyItemId], references: [id], onDelete: Cascade)
  vocabularySet    VocabularySet   @relation(fields: [vocabularySetId], references: [id], onDelete: Cascade)

  @@unique([userId, vocabularySetId, vocabularyItemId, gameType])
  @@map("learning_progress")
}

enum Role {
  USER
  PREMIUM_USER
  TEACHER
  ADMIN
}

enum TemplateType {
  MATCHING
  FLASHCARDS
  QUIZ
  UNIVERSAL
  SPIN_WHEEL
  WHACK_A_MOLE
  MEMORY_CARDS
  WORD_SEARCH
  CROSSWORD
  FILL_BLANKS
  TRUE_FALSE
  DRAG_SORT
  BALLOON_POP
  AIRPLANE
  MAZE_CHASE
  HANGMAN
  IMAGE_QUIZ
  GAMESHOW_QUIZ
  OPEN_THE_BOX
  MATCHING_PAIRS
  FIND_THE_MATCH
  ANAGRAM
  SPEAKING_CARDS
  UNJUMBLE
  COMPLETE_SENTENCE
  SPELL_WORD
  FLIP_TILES
  TYPE_ANSWER
  SPEED_SORTING
  WATCH_MEMORIZE
  PAIR_NO_PAIR
  RANK_ORDER
  WIN_LOSE_QUIZ
  MATH_GENERATOR
  WORD_MAGNETS
  FLYING_FRUIT
  GROUP_SORT
  LABELLED_DIAGRAM
}

enum SubStatus {
  ACTIVE
  CANCELED
  PAYMENT_FAILED
  PAST_DUE
  UNPAID
  EXPIRED
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

enum H5PContentStatus {
  DRAFT
  PUBLISHED
}

enum GameCategory {
  QUIZ
  MATCHING
  MEMORY
  ACTION
  CREATIVE
  WORD_GAMES
  MATH_GAMES
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

enum ThemeCategory {
  CLASSIC
  THEMED
  SEASONAL
  EDUCATIONAL
  MODERN
}

enum TimerType {
  NONE
  COUNT_UP
  COUNT_DOWN
}

enum AnswerLabels {
  ABC
  NUMBERS
  NONE
}

enum GEPTLevel {
  KIDS
  ELEMENTARY
  INTERMEDIATE
  HIGH_INTERMEDIATE
}

enum FolderType {
  ACTIVITIES // 活動資料夾
  RESULTS // 結果資料夾
}

enum PartOfSpeech {
  NOUN
  VERB
  ADJECTIVE
  ADVERB
  PRONOUN
  PREPOSITION
  CONJUNCTION
  INTERJECTION
  ARTICLE
  PHRASE
}

// 課業分配模型
model Assignment {
  id               String           @id @default(cuid())
  activityId       String
  title            String
  registrationType RegistrationType @default(NAME)
  deadline         DateTime?
  gameEndSettings  Json? // 遊戲結束設置
  status           AssignmentStatus @default(ACTIVE)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // 關聯
  activity Activity           @relation(fields: [activityId], references: [id], onDelete: Cascade)
  results  AssignmentResult[]
}

// 課業結果模型
model AssignmentResult {
  id           String       @id @default(cuid())
  assignmentId String
  resultNumber Int // 結果編號（如：結果1、結果2）
  customTitle  String? // 自定義標題，用於重命名功能
  shareToken   String?      @unique // 可共用結果連結的 token
  status       ResultStatus @default(ACTIVE)
  folderId     String? // 資料夾ID，用於組織結果
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // 關聯
  assignment   Assignment        @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  folder       Folder?           @relation(fields: [folderId], references: [id], onDelete: SetNull)
  participants GameParticipant[]
}

// 遊戲參與者模型
model GameParticipant {
  id             String   @id @default(cuid())
  resultId       String
  studentName    String
  score          Int      @default(0)
  timeSpent      Int      @default(0) // 遊戲時間（秒）
  correctAnswers Int      @default(0)
  totalQuestions Int      @default(0)
  gameData       Json? // 詳細遊戲數據
  completedAt    DateTime @default(now())

  // 關聯
  result AssignmentResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
}

// 註冊類型枚舉
enum RegistrationType {
  NAME
  ANONYMOUS
  GOOGLE
}

enum AssignmentStatus {
  ACTIVE
  COMPLETED
  EXPIRED
}

enum ResultStatus {
  ACTIVE
  ARCHIVED
}

// ==================== 社區功能模型 ====================

// 活動喜歡模型
model ActivityLike {
  id         String   @id @default(cuid())
  activityId String
  userId     String
  createdAt  DateTime @default(now())

  // 關聯
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 唯一約束：每個用戶只能喜歡一次
  @@unique([activityId, userId])
  @@index([userId])
  @@index([activityId])
  @@index([createdAt])
}

// 活動收藏模型
model ActivityBookmark {
  id         String   @id @default(cuid())
  activityId String
  userId     String
  folderId   String? // 可選：收藏到特定資料夾
  createdAt  DateTime @default(now())

  // 關聯
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 唯一約束：每個用戶只能收藏一次
  @@unique([activityId, userId])
  @@index([userId])
  @@index([activityId])
  @@index([folderId])
  @@index([createdAt])
}

// 活動評論模型
model ActivityComment {
  id         String    @id @default(cuid())
  activityId String
  userId     String
  content    String
  parentId   String? // 父評論ID（用於回覆）
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime? // 軟刪除

  // 關聯
  activity Activity          @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   ActivityComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  ActivityComment[] @relation("CommentReplies")

  // 索引
  @@index([activityId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@index([deletedAt])
}

// 社區舉報模型
model CommunityReport {
  id         String       @id @default(cuid())
  activityId String
  userId     String
  reason     ReportReason
  details    String?
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  resolvedAt DateTime?
  resolvedBy String? // 處理人員ID

  // 關聯
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 索引
  @@index([activityId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// 舉報原因枚舉
enum ReportReason {
  INAPPROPRIATE_CONTENT
  SPAM
  COPYRIGHT_VIOLATION
  MISLEADING
  OTHER
}

// 用戶關注模型
model UserFollow {
  id          String   @id @default(cuid())
  followerId  String // 關注者ID
  followingId String // 被關注者ID
  createdAt   DateTime @default(now())

  // 關聯
  follower  User @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  // 索引和唯一約束
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@index([createdAt])
}

// 舉報狀態枚舉
enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  REJECTED
}

// ==================== 圖片管理功能模型 ====================

// 用戶圖片表
model UserImage {
  id     String @id @default(cuid())
  userId String
  user   User   @relation("UserImages", fields: [userId], references: [id], onDelete: Cascade)

  // 圖片信息
  url      String // Vercel Blob URL
  blobPath String // Blob 存儲路徑
  fileName String // 原始文件名
  fileSize Int // 文件大小（bytes）
  mimeType String // MIME 類型
  width    Int? // 圖片寬度
  height   Int? // 圖片高度

  // 元數據
  source   String   @default("upload") // upload | unsplash
  sourceId String? // Unsplash 圖片 ID（如果來自 Unsplash）
  alt      String? // 替代文字（可訪問性）
  tags     String[] // 標籤

  // 使用統計
  usageCount Int       @default(0) // 使用次數
  lastUsedAt DateTime? // 最後使用時間

  // 時間戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 關聯
  activities ActivityImage[]
  versions   ImageVersion[]

  @@index([userId])
  @@index([source])
  @@index([createdAt])
}

// 活動圖片關聯表
model ActivityImage {
  id         String    @id @default(cuid())
  activityId String
  activity   Activity  @relation("ActivityImages", fields: [activityId], references: [id], onDelete: Cascade)
  imageId    String
  image      UserImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  // 圖片在活動中的位置
  position Int // 圖片順序
  context  String? // 圖片上下文（例如：問題文字）

  createdAt DateTime @default(now())

  @@unique([activityId, imageId, position])
  @@index([activityId])
  @@index([imageId])
}

// 圖片標籤表
model ImageTag {
  id     String  @id @default(cuid())
  name   String  @unique
  userId String? // null 表示系統標籤
  user   User?   @relation("UserImageTags", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
}

// 圖片版本表
model ImageVersion {
  id        String   @id @default(cuid())
  imageId   String
  image     UserImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  // 版本信息
  version   Int      // 版本號（從 1 開始）
  url       String   // 版本圖片 URL
  blobPath  String   // Blob 存儲路徑

  // 變更記錄
  changes   Json     // 記錄變更內容（裁剪、旋轉、濾鏡等）

  // 創建信息
  createdAt DateTime @default(now())
  createdBy String
  user      User     @relation("ImageVersions", fields: [createdBy], references: [id], onDelete: Cascade)

  @@unique([imageId, version])
  @@index([imageId])
  @@index([createdBy])
}

// ==================== TTS 音頻緩存功能模型 ====================

// TTS 音頻緩存表
model TTSCache {
  id       String   @id @default(cuid())
  hash     String   @unique // MD5 hash of (text + language + voice)
  text     String   // 原始文本
  language String   // 語言代碼 (en-US, zh-TW, etc.)
  voice    String   // 語音類型 (male, female)

  // 音頻文件信息
  audioUrl  String  // R2 公開 URL
  r2Key     String  // R2 存儲鍵值
  fileSize  Int     // 文件大小（bytes）
  duration  Float?  // 音頻時長（秒）

  // GEPT 分級信息
  geptLevel GEPTLevel? // GEPT 等級

  // 使用統計
  hitCount  Int      @default(0) // 緩存命中次數
  lastHit   DateTime? // 最後訪問時間

  // 時間戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hash])
  @@index([geptLevel])
  @@index([language])
  @@index([createdAt])
  @@map("tts_cache")
}

// ==================== SRS (Spaced Repetition System) 功能模型 ====================

// 用戶單字學習進度表
model UserWordProgress {
  id       String   @id @default(cuid())
  userId   String
  wordId   String

  // ===== SRS 核心參數 =====
  memoryStrength  Int      @default(0)    // 記憶強度 (0-100)
  easeFactor      Float    @default(2.5)  // 難度係數 (1.3-2.5)
  interval        Int      @default(1)    // 複習間隔 (天數)
  repetitions     Int      @default(0)    // 連續正確次數

  // ===== 時間戳 =====
  firstLearnedAt  DateTime @default(now())
  lastReviewedAt  DateTime @default(now())
  nextReviewAt    DateTime @default(now())

  // ===== 統計數據 =====
  totalReviews     Int     @default(0)
  correctReviews   Int     @default(0)
  incorrectReviews Int     @default(0)

  // ===== 學習狀態 =====
  status          String   @default("NEW")  // NEW, LEARNING, REVIEWING, MASTERED

  // ===== 關聯 =====
  user            User     @relation("UserWordProgress", fields: [userId], references: [id], onDelete: Cascade)
  word            VocabularyItem @relation("WordProgress", fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
  @@index([userId, nextReviewAt])
  @@index([userId, status])
  @@index([wordId])
  @@map("user_word_progress")
}

// 學習會話表
model LearningSession {
  id              String   @id @default(cuid())
  userId          String
  geptLevel       String   // elementary, intermediate, high-intermediate

  // ===== 會話數據 =====
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  duration        Int?     // 秒數

  // ===== 單字統計 =====
  newWordsCount   Int      @default(0)
  reviewWordsCount Int     @default(0)
  totalWords      Int      @default(0)

  // ===== 正確率 =====
  correctAnswers  Int      @default(0)
  totalAnswers    Int      @default(0)
  accuracy        Float?   // 正確率 (0-100)

  // ===== 關聯 =====
  user            User     @relation("LearningSessions", fields: [userId], references: [id], onDelete: Cascade)
  wordReviews     WordReview[]

  @@index([userId, startedAt])
  @@index([geptLevel])
  @@map("learning_sessions")
}

// 單字複習記錄表
model WordReview {
  id              String   @id @default(cuid())
  sessionId       String
  wordId          String

  // ===== 複習數據 =====
  isCorrect       Boolean
  responseTime    Int      // 毫秒
  reviewedAt      DateTime @default(now())

  // ===== SRS 更新前後 =====
  memoryStrengthBefore  Int
  memoryStrengthAfter   Int
  intervalBefore        Int
  intervalAfter         Int

  // ===== 關聯 =====
  session         LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  word            VocabularyItem  @relation("WordReviews", fields: [wordId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([wordId])
  @@index([reviewedAt])
  @@map("word_reviews")
}

// ==================== 遊戲排行榜功能模型 ====================

// 遊戲排行榜表
model GameLeaderboard {
  id              String   @id @default(cuid())
  activityId      String   // 活動 ID
  playerName      String   // 玩家名稱
  score           Int      // 分數
  correctCount    Int      // 答對題數
  totalCount      Int      // 總題數
  accuracy        Float    // 正確率 (0-100)
  timeSpent       Int      // 遊戲時間（秒）
  gameData        Json?    // 詳細遊戲數據（問題答案記錄等）

  // 時間戳
  createdAt       DateTime @default(now())

  // 索引
  @@index([activityId, score])
  @@index([activityId, createdAt])
  @@index([createdAt])
  @@map("game_leaderboard")
}
