generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?
  emailVerified DateTime?
  image         String?
  country       String?   @default("TW")
  language      String?   @default("zh-TW") // ç”¨æˆ¶ç•Œé¢èªè¨€
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  role          Role      @default(USER)

  // ç¤¾å€å€‹äººè³‡æ–™
  bio         String? // å€‹äººç°¡ä»‹
  socialLinks Json? // ç¤¾äº¤åª’é«”é€£çµ {twitter, facebook, linkedin, website}

  accounts             Account[]
  activities           Activity[]
  activityVersions     ActivityVersion[]
  activityVersionLogs  ActivityVersionLog[]
  folders              Folder[]
  h5pContents          H5PContent[]
  invoices             Invoice[]
  notificationSettings NotificationSettings?
  passwordReset        PasswordReset?
  sessions             Session[]
  subscription         Subscription?
  learningProgress     LearningProgress[]
  vocabularySets       VocabularySet[]

  // ç¤¾å€åŠŸèƒ½é—œè¯
  activityLikes     ActivityLike[]
  activityBookmarks ActivityBookmark[]
  activityComments  ActivityComment[]
  communityReports  CommunityReport[]

  // ç²‰çµ²/é—œæ³¨é—œä¿‚
  following UserFollow[] @relation("UserFollowing")
  followers UserFollow[] @relation("UserFollowers")

  // è‡ªè¨‚æ¨™ç±¤
  customTags String[] @default([])

  // åœ–ç‰‡ç®¡ç†
  images        UserImage[]    @relation("UserImages")
  imageTags     ImageTag[]     @relation("UserImageTags")
  imageVersions ImageVersion[] @relation("ImageVersions")

  // SRS å­¸ç¿’ç³»çµ±
  wordProgress     UserWordProgress[] @relation("UserWordProgress")
  learningSessions LearningSession[]  @relation("LearningSessions")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordReset {
  id      String   @id @default(cuid())
  token   String   @unique
  expires DateTime
  userId  String   @unique
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Activity {
  id             String           @id @default(cuid())
  title          String
  description    String?
  content        Json?
  elements       Json             @default("[]")
  type           String
  templateType   String?
  published      Boolean          @default(false)
  isPublic       Boolean          @default(false)
  isDraft        Boolean          @default(false)
  folderId       String?
  lastPlayed     DateTime?
  playCount      Int              @default(0)
  shareCount     Int              @default(0)
  gameTemplateId String?
  aiGenerated    Boolean          @default(false)
  difficulty     DifficultyLevel?
  estimatedTime  String?
  tags           String[]
  geptLevel      GEPTLevel?       @default(ELEMENTARY)
  totalWords     Int              @default(0)

  // ç¤¾å€åˆ†äº«åŠŸèƒ½ï¼ˆåŸºç¤ï¼‰
  isPublicShared Boolean @default(false)
  shareToken     String? @unique
  communityPlays Int     @default(0)

  // ç¤¾å€åŠŸèƒ½ï¼ˆæ“´å±•ï¼‰
  publishedToCommunityAt DateTime?
  communityCategory      String?
  communityTags          String[]  @default([])
  communityDescription   String?
  communityThumbnail     String?
  communityViews         Int       @default(0)
  communityLikes         Int       @default(0)
  communityBookmarks     Int       @default(0)
  communityComments      Int       @default(0)
  isFeatured             Boolean   @default(false)
  featuredAt             DateTime?
  thumbnailUrl           String? // æ´»å‹•ç¸®åœ– URLï¼ˆVercel Blob Storageï¼‰
  screenshotStatus       String?   @default("pending") // pending, generating, completed, failed
  screenshotError        String? // æˆªåœ–ç”ŸæˆéŒ¯èª¤ä¿¡æ¯
  screenshotRetryCount   Int       @default(0) // é‡è©¦æ¬¡æ•¸

  // åŸä½œè€…è¿½è¹¤ï¼ˆç”¨æ–¼è¤‡è£½æ´»å‹•ï¼‰
  originalAuthorId     String? // åŸä½œè€… ID
  originalAuthorName   String? // åŸä½œè€…åç¨±
  copiedFromActivityId String? // åŸæ´»å‹• ID

  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  deletedAt       DateTime?
  templateId      String?
  userId          String
  h5pContentId    String?
  folder          Folder?              @relation(fields: [folderId], references: [id])
  gameTemplate    GameTemplate?        @relation(fields: [gameTemplateId], references: [id])
  h5pContent      H5PContent?          @relation(fields: [h5pContentId], references: [id])
  template        Template?            @relation(fields: [templateId], references: [id])
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  versions        ActivityVersion[]
  versionLogs     ActivityVersionLog[]
  assignments     Assignment[]
  gameSettings    GameSettings?
  matchUpOptions  Json?            // ğŸ”¥ Match-up éŠæˆ²é¸é …
  vocabularyItems VocabularyItem[]

  // ç¤¾å€åŠŸèƒ½é—œè¯
  likes     ActivityLike[]
  bookmarks ActivityBookmark[]
  comments  ActivityComment[]
  reports   CommunityReport[]

  // åœ–ç‰‡ç®¡ç†
  activityImages ActivityImage[] @relation("ActivityImages")

  // ç´¢å¼•å„ªåŒ–
  @@index([isPublicShared, publishedToCommunityAt])
  @@index([communityCategory])
  @@index([communityLikes])
  @@index([communityViews])
  @@index([isFeatured, featuredAt])
  @@index([userId, isPublicShared])
}

model Template {
  id          String       @id @default(cuid())
  name        String
  description String?
  type        TemplateType
  thumbnail   String?
  config      Json
  activities  Activity[]
}

model Folder {
  id          String             @id @default(cuid())
  name        String
  description String?
  color       String?
  icon        String?
  type        FolderType         @default(ACTIVITIES) // è³‡æ–™å¤¾é¡å‹ï¼šACTIVITIES æˆ– RESULTS
  parentId    String? // çˆ¶è³‡æ–™å¤¾ IDï¼ˆnull è¡¨ç¤ºæ ¹ç›®éŒ„ï¼‰
  depth       Int                @default(0) // è³‡æ–™å¤¾æ·±åº¦ï¼ˆ0 = æ ¹ç›®éŒ„ï¼‰
  path        String? // è³‡æ–™å¤¾è·¯å¾‘ï¼ˆä¾‹å¦‚ï¼š/folder1/folder2ï¼‰
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  deletedAt   DateTime?
  userId      String
  activities  Activity[]
  results     AssignmentResult[] // è³‡æ–™å¤¾ä¸­çš„çµæœ
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent      Folder?            @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Folder[]           @relation("FolderHierarchy")

  @@unique([name, userId, type, parentId]) // åŒä¸€ç”¨æˆ¶åœ¨åŒä¸€çˆ¶è³‡æ–™å¤¾ä¸‹ä¸èƒ½æœ‰é‡åè³‡æ–™å¤¾
  @@index([userId, type, parentId]) // å„ªåŒ–æŸ¥è©¢æ€§èƒ½
  @@index([userId, type, deletedAt]) // å„ªåŒ–æŸ¥è©¢æ€§èƒ½
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  planId               String
  status               SubStatus @default(ACTIVE)
  startDate            DateTime  @default(now())
  endDate              DateTime?
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  invoices             Invoice[]
  plan                 Plan      @relation(fields: [planId], references: [id])
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Plan {
  id            String          @id @default(cuid())
  name          String
  description   String?
  price         Float
  interval      BillingInterval
  features      String[]
  subscriptions Subscription[]
}

model H5PContent {
  id          String           @id @default(cuid())
  title       String
  description String?
  content     Json             @default("{}")
  library     String           @default("H5P.InteractiveVideo")
  contentType String
  contentPath String
  status      H5PContentStatus @default(DRAFT)
  published   Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  userId      String
  activities  Activity[]
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ActivityVersion {
  id           String               @id @default(cuid())
  versionName  String
  versionNotes String?
  content      Json?
  elements     Json
  published    Boolean              @default(false)
  createdAt    DateTime             @default(now())
  activityId   String
  userId       String
  activity     Activity             @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs         ActivityVersionLog[]
}

model ActivityVersionLog {
  id         String           @id @default(cuid())
  action     String
  details    String?
  createdAt  DateTime         @default(now())
  activityId String
  versionId  String?
  userId     String
  activity   Activity         @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  version    ActivityVersion? @relation(fields: [versionId], references: [id])
}

model Invoice {
  id               String            @id @default(cuid())
  stripeInvoiceId  String            @unique
  amount           Float
  currency         String            @default("usd")
  status           String
  invoiceUrl       String?
  invoicePdf       String?
  createdAt        DateTime          @default(now())
  paidAt           DateTime?
  subscriptionId   String
  userId           String
  subscription     Subscription      @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationLogs NotificationLog[]
}

model NotificationSettings {
  id                       String   @id @default(cuid())
  paymentSuccess           Boolean  @default(true)
  paymentFailed            Boolean  @default(true)
  subscriptionRenewal      Boolean  @default(true)
  subscriptionCancellation Boolean  @default(true)
  promotions               Boolean  @default(false)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  userId                   String   @unique
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model NotificationLog {
  id               String   @id @default(cuid())
  type             String
  recipient        String
  content          String?
  sentAt           DateTime @default(now())
  sentBy           String
  relatedInvoiceId String?
  relatedInvoice   Invoice? @relation(fields: [relatedInvoiceId], references: [id])
}

model GameTemplate {
  id                String          @id @default(cuid())
  name              String          @unique
  displayName       String
  description       String?
  icon              String?
  category          GameCategory    @default(QUIZ)
  difficulty        DifficultyLevel @default(EASY)
  estimatedTime     String?
  features          String[]
  minItems          Int             @default(1)
  maxItems          Int             @default(50)
  requiresEvenItems Boolean         @default(false)
  isActive          Boolean         @default(true)
  isPremium         Boolean         @default(false)
  sortOrder         Int             @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  activities        Activity[]
  gameSettings      GameSettings[]
}

model VisualTheme {
  id              String         @id @default(cuid())
  name            String         @unique
  displayName     String
  description     String?
  thumbnail       String?
  category        ThemeCategory  @default(CLASSIC)
  isPremium       Boolean        @default(false)
  isActive        Boolean        @default(true)
  sortOrder       Int            @default(0)
  primaryColor    String         @default("#007bff")
  secondaryColor  String         @default("#6c757d")
  backgroundColor String         @default("#ffffff")
  textColor       String         @default("#212529")
  accentColor     String?
  borderColor     String?
  fontFamily      String?
  borderRadius    String?
  boxShadow       String?
  backgroundImage String?
  customCSS       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  gameSettings    GameSettings[]
}

model GameSettings {
  id               String        @id @default(cuid())
  activityId       String        @unique
  templateId       String?
  themeId          String?
  visualStyle      String?       // è¦–è¦ºé¢¨æ ¼ ID (clouds, videogame, magiclibrary, etc.)
  timerType        TimerType     @default(NONE)
  timerDuration    Int?
  livesCount       Int           @default(0)
  speed            Int           @default(3)  // éŠæˆ²é€Ÿåº¦ (1-10)
  shuffleQuestions Boolean       @default(false)
  shuffleAnswers   Boolean       @default(false)
  autoProceed      Boolean       @default(true)
  showAnswers      Boolean       @default(true)
  answerLabels     AnswerLabels  @default(ABC)
  enableSounds     Boolean       @default(true)
  enableAnimations Boolean       @default(true)
  allowRetry       Boolean       @default(true)
  showProgress     Boolean       @default(true)
  showScore        Boolean       @default(true)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  activity         Activity      @relation(fields: [activityId], references: [id], onDelete: Cascade)
  template         GameTemplate? @relation(fields: [templateId], references: [id])
  theme            VisualTheme?  @relation(fields: [themeId], references: [id])
}

model AIPrompt {
  id             String       @id @default(cuid())
  name           String       @unique
  templateType   TemplateType
  promptTemplate String
  exampleInput   String?
  exampleOutput  String?
  isActive       Boolean      @default(true)
  version        String       @default("1.0")
  model          String       @default("gpt-4")
  temperature    Float        @default(0.7)
  maxTokens      Int          @default(2000)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model VocabularySet {
  id               String             @id @default(cuid())
  userId           String
  title            String
  description      String?
  geptLevel        GEPTLevel          @default(ELEMENTARY)
  isPublic         Boolean            @default(false)
  totalWords       Int                @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  learningProgress LearningProgress[]
  items            VocabularyItem[]
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("vocabulary_sets")
}

model VocabularyItem {
  id               String             @id @default(cuid())
  setId            String?
  activityId       String?
  english          String
  chinese          String
  phonetic         String?
  partOfSpeech     PartOfSpeech?
  difficultyLevel  Int                @default(1)
  exampleSentence  String?
  notes            String?

  // è‹±æ–‡åœ–ç‰‡å­—æ®µ
  imageId          String?            // è‹±æ–‡åœ–ç‰‡ IDï¼ˆé—œè¯åˆ° UserImageï¼‰
  imageUrl         String?            // è‹±æ–‡åœ–ç‰‡ URL
  imageSize        String?            // è‹±æ–‡åœ–ç‰‡å¤§å° (small, medium, large)

  // ä¸­æ–‡åœ–ç‰‡å­—æ®µ
  chineseImageId   String?            // ä¸­æ–‡åœ–ç‰‡ IDï¼ˆé—œè¯åˆ° UserImageï¼‰
  chineseImageUrl  String?            // ä¸­æ–‡åœ–ç‰‡ URL
  chineseImageSize String?            // ä¸­æ–‡åœ–ç‰‡å¤§å° (small, medium, large)

  audioUrl         String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  learningProgress LearningProgress[]
  activity         Activity?          @relation(fields: [activityId], references: [id], onDelete: Cascade)
  set              VocabularySet?     @relation(fields: [setId], references: [id], onDelete: Cascade)

  // SRS å­¸ç¿’ç³»çµ±
  wordProgress     UserWordProgress[] @relation("WordProgress")
  wordReviews      WordReview[]       @relation("WordReviews")

  // è©å½™åˆ†çµ„ç³»çµ±
  prefix           String?            // å­—é¦– (un-, re-, pre-, etc.)
  root             String?            // å­—æ ¹ (port, dict, vis, etc.)
  suffix           String?            // å­—å°¾ (-er, -tion, -ful, etc.)
  theme            String?            // ä¸»é¡Œ (daily_life, school, work, etc.)
  frequency        Int?               // ä½¿ç”¨é »ç‡ (1-5, 5 æœ€å¸¸ç”¨)

  // æ–°å¢åˆ†çµ„å­—æ®µ
  wordFamily       String?            // è©å½™å®¶æ— ID (happy, care, use, etc.)
  antonyms         String?            // åç¾©è© ID åˆ—è¡¨ (JSON array)
  synonyms         String?            // åŒç¾©è© ID åˆ—è¡¨ (JSON array)
  context          String?            // æƒ…å¢ƒæ¨™ç±¤ (restaurant, hospital, airport, etc.)
  syllableCount    Int?               // éŸ³ç¯€æ•¸é‡
  phoneticEnding   String?            // éŸ³æ¨™çµå°¾ (ç”¨æ–¼æŠ¼éŸ»åˆ†çµ„)
  emotionalTone    String?            // æƒ…æ„Ÿè‰²å½© (positive, negative, neutral)
  actionType       String?            // å‹•ä½œé¡å‹ (movement, hand, thinking, sensory)
  visualFeature    String?            // è¦–è¦ºç‰¹å¾µ (color, shape, size, material)
  temporalCategory String?            // æ™‚é–“é¡åˆ¥ (time_point, season, month, duration)
  geptLevel        GEPTLevel?         // GEPT ç­‰ç´š

  @@map("vocabulary_items")
}

model LearningProgress {
  id               String          @id @default(cuid())
  userId           String
  vocabularySetId  String
  vocabularyItemId String?
  gameType         String
  correctCount     Int             @default(0)
  incorrectCount   Int             @default(0)
  totalAttempts    Int             @default(0)
  bestScore        Int             @default(0)
  averageScore     Float           @default(0)
  masteryLevel     Int             @default(0)
  lastReviewed     DateTime?
  nextReview       DateTime?
  reviewInterval   Int             @default(1)
  totalStudyTime   Int             @default(0)
  sessionCount     Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  vocabularyItem   VocabularyItem? @relation(fields: [vocabularyItemId], references: [id], onDelete: Cascade)
  vocabularySet    VocabularySet   @relation(fields: [vocabularySetId], references: [id], onDelete: Cascade)

  @@unique([userId, vocabularySetId, vocabularyItemId, gameType])
  @@map("learning_progress")
}

enum Role {
  USER
  PREMIUM_USER
  TEACHER
  ADMIN
}

enum TemplateType {
  MATCHING
  FLASHCARDS
  QUIZ
  UNIVERSAL
  SPIN_WHEEL
  WHACK_A_MOLE
  MEMORY_CARDS
  WORD_SEARCH
  CROSSWORD
  FILL_BLANKS
  TRUE_FALSE
  DRAG_SORT
  BALLOON_POP
  AIRPLANE
  MAZE_CHASE
  HANGMAN
  IMAGE_QUIZ
  GAMESHOW_QUIZ
  OPEN_THE_BOX
  MATCHING_PAIRS
  FIND_THE_MATCH
  ANAGRAM
  SPEAKING_CARDS
  UNJUMBLE
  COMPLETE_SENTENCE
  SPELL_WORD
  FLIP_TILES
  TYPE_ANSWER
  SPEED_SORTING
  WATCH_MEMORIZE
  PAIR_NO_PAIR
  RANK_ORDER
  WIN_LOSE_QUIZ
  MATH_GENERATOR
  WORD_MAGNETS
  FLYING_FRUIT
  GROUP_SORT
  LABELLED_DIAGRAM
}

enum SubStatus {
  ACTIVE
  CANCELED
  PAYMENT_FAILED
  PAST_DUE
  UNPAID
  EXPIRED
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

enum H5PContentStatus {
  DRAFT
  PUBLISHED
}

enum GameCategory {
  QUIZ
  MATCHING
  MEMORY
  ACTION
  CREATIVE
  WORD_GAMES
  MATH_GAMES
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

enum ThemeCategory {
  CLASSIC
  THEMED
  SEASONAL
  EDUCATIONAL
  MODERN
}

enum TimerType {
  NONE
  COUNT_UP
  COUNT_DOWN
}

enum AnswerLabels {
  ABC
  NUMBERS
  NONE
}

enum GEPTLevel {
  KIDS
  ELEMENTARY
  INTERMEDIATE
  HIGH_INTERMEDIATE
}

enum FolderType {
  ACTIVITIES // æ´»å‹•è³‡æ–™å¤¾
  RESULTS // çµæœè³‡æ–™å¤¾
}

enum PartOfSpeech {
  NOUN
  VERB
  ADJECTIVE
  ADVERB
  PRONOUN
  PREPOSITION
  CONJUNCTION
  INTERJECTION
  ARTICLE
  PHRASE
}

// èª²æ¥­åˆ†é…æ¨¡å‹
model Assignment {
  id               String           @id @default(cuid())
  activityId       String
  title            String
  registrationType RegistrationType @default(NAME)
  deadline         DateTime?
  gameEndSettings  Json? // éŠæˆ²çµæŸè¨­ç½®
  status           AssignmentStatus @default(ACTIVE)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // é—œè¯
  activity Activity           @relation(fields: [activityId], references: [id], onDelete: Cascade)
  results  AssignmentResult[]
}

// èª²æ¥­çµæœæ¨¡å‹
model AssignmentResult {
  id           String       @id @default(cuid())
  assignmentId String
  resultNumber Int // çµæœç·¨è™Ÿï¼ˆå¦‚ï¼šçµæœ1ã€çµæœ2ï¼‰
  customTitle  String? // è‡ªå®šç¾©æ¨™é¡Œï¼Œç”¨æ–¼é‡å‘½ååŠŸèƒ½
  shareToken   String?      @unique // å¯å…±ç”¨çµæœé€£çµçš„ token
  status       ResultStatus @default(ACTIVE)
  folderId     String? // è³‡æ–™å¤¾IDï¼Œç”¨æ–¼çµ„ç¹”çµæœ
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // é—œè¯
  assignment   Assignment        @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  folder       Folder?           @relation(fields: [folderId], references: [id], onDelete: SetNull)
  participants GameParticipant[]
}

// éŠæˆ²åƒèˆ‡è€…æ¨¡å‹
model GameParticipant {
  id             String   @id @default(cuid())
  resultId       String
  studentName    String
  score          Int      @default(0)
  timeSpent      Int      @default(0) // éŠæˆ²æ™‚é–“ï¼ˆç§’ï¼‰
  correctAnswers Int      @default(0)
  totalQuestions Int      @default(0)
  gameData       Json? // è©³ç´°éŠæˆ²æ•¸æ“š
  completedAt    DateTime @default(now())

  // é—œè¯
  result AssignmentResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
}

// è¨»å†Šé¡å‹æšèˆ‰
enum RegistrationType {
  NAME
  ANONYMOUS
  GOOGLE
}

enum AssignmentStatus {
  ACTIVE
  COMPLETED
  EXPIRED
}

enum ResultStatus {
  ACTIVE
  ARCHIVED
}

// ==================== ç¤¾å€åŠŸèƒ½æ¨¡å‹ ====================

// æ´»å‹•å–œæ­¡æ¨¡å‹
model ActivityLike {
  id         String   @id @default(cuid())
  activityId String
  userId     String
  createdAt  DateTime @default(now())

  // é—œè¯
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // å”¯ä¸€ç´„æŸï¼šæ¯å€‹ç”¨æˆ¶åªèƒ½å–œæ­¡ä¸€æ¬¡
  @@unique([activityId, userId])
  @@index([userId])
  @@index([activityId])
  @@index([createdAt])
}

// æ´»å‹•æ”¶è—æ¨¡å‹
model ActivityBookmark {
  id         String   @id @default(cuid())
  activityId String
  userId     String
  folderId   String? // å¯é¸ï¼šæ”¶è—åˆ°ç‰¹å®šè³‡æ–™å¤¾
  createdAt  DateTime @default(now())

  // é—œè¯
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // å”¯ä¸€ç´„æŸï¼šæ¯å€‹ç”¨æˆ¶åªèƒ½æ”¶è—ä¸€æ¬¡
  @@unique([activityId, userId])
  @@index([userId])
  @@index([activityId])
  @@index([folderId])
  @@index([createdAt])
}

// æ´»å‹•è©•è«–æ¨¡å‹
model ActivityComment {
  id         String    @id @default(cuid())
  activityId String
  userId     String
  content    String
  parentId   String? // çˆ¶è©•è«–IDï¼ˆç”¨æ–¼å›è¦†ï¼‰
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime? // è»Ÿåˆªé™¤

  // é—œè¯
  activity Activity          @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   ActivityComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  ActivityComment[] @relation("CommentReplies")

  // ç´¢å¼•
  @@index([activityId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@index([deletedAt])
}

// ç¤¾å€èˆ‰å ±æ¨¡å‹
model CommunityReport {
  id         String       @id @default(cuid())
  activityId String
  userId     String
  reason     ReportReason
  details    String?
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  resolvedAt DateTime?
  resolvedBy String? // è™•ç†äººå“¡ID

  // é—œè¯
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ç´¢å¼•
  @@index([activityId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// èˆ‰å ±åŸå› æšèˆ‰
enum ReportReason {
  INAPPROPRIATE_CONTENT
  SPAM
  COPYRIGHT_VIOLATION
  MISLEADING
  OTHER
}

// ç”¨æˆ¶é—œæ³¨æ¨¡å‹
model UserFollow {
  id          String   @id @default(cuid())
  followerId  String // é—œæ³¨è€…ID
  followingId String // è¢«é—œæ³¨è€…ID
  createdAt   DateTime @default(now())

  // é—œè¯
  follower  User @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  // ç´¢å¼•å’Œå”¯ä¸€ç´„æŸ
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@index([createdAt])
}

// èˆ‰å ±ç‹€æ…‹æšèˆ‰
enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  REJECTED
}

// ==================== åœ–ç‰‡ç®¡ç†åŠŸèƒ½æ¨¡å‹ ====================

// ç”¨æˆ¶åœ–ç‰‡è¡¨
model UserImage {
  id     String @id @default(cuid())
  userId String
  user   User   @relation("UserImages", fields: [userId], references: [id], onDelete: Cascade)

  // åœ–ç‰‡ä¿¡æ¯
  url      String // Vercel Blob URL
  blobPath String // Blob å­˜å„²è·¯å¾‘
  fileName String // åŸå§‹æ–‡ä»¶å
  fileSize Int // æ–‡ä»¶å¤§å°ï¼ˆbytesï¼‰
  mimeType String // MIME é¡å‹
  width    Int? // åœ–ç‰‡å¯¬åº¦
  height   Int? // åœ–ç‰‡é«˜åº¦

  // å…ƒæ•¸æ“š
  source   String   @default("upload") // upload | unsplash
  sourceId String? // Unsplash åœ–ç‰‡ IDï¼ˆå¦‚æœä¾†è‡ª Unsplashï¼‰
  alt      String? // æ›¿ä»£æ–‡å­—ï¼ˆå¯è¨ªå•æ€§ï¼‰
  tags     String[] // æ¨™ç±¤

  // ä½¿ç”¨çµ±è¨ˆ
  usageCount Int       @default(0) // ä½¿ç”¨æ¬¡æ•¸
  lastUsedAt DateTime? // æœ€å¾Œä½¿ç”¨æ™‚é–“

  // æ™‚é–“æˆ³
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // é—œè¯
  activities ActivityImage[]
  versions   ImageVersion[]

  @@index([userId])
  @@index([source])
  @@index([createdAt])
}

// æ´»å‹•åœ–ç‰‡é—œè¯è¡¨
model ActivityImage {
  id         String    @id @default(cuid())
  activityId String
  activity   Activity  @relation("ActivityImages", fields: [activityId], references: [id], onDelete: Cascade)
  imageId    String
  image      UserImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  // åœ–ç‰‡åœ¨æ´»å‹•ä¸­çš„ä½ç½®
  position Int // åœ–ç‰‡é †åº
  context  String? // åœ–ç‰‡ä¸Šä¸‹æ–‡ï¼ˆä¾‹å¦‚ï¼šå•é¡Œæ–‡å­—ï¼‰

  createdAt DateTime @default(now())

  @@unique([activityId, imageId, position])
  @@index([activityId])
  @@index([imageId])
}

// åœ–ç‰‡æ¨™ç±¤è¡¨
model ImageTag {
  id     String  @id @default(cuid())
  name   String  @unique
  userId String? // null è¡¨ç¤ºç³»çµ±æ¨™ç±¤
  user   User?   @relation("UserImageTags", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
}

// åœ–ç‰‡ç‰ˆæœ¬è¡¨
model ImageVersion {
  id        String   @id @default(cuid())
  imageId   String
  image     UserImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  // ç‰ˆæœ¬ä¿¡æ¯
  version   Int      // ç‰ˆæœ¬è™Ÿï¼ˆå¾ 1 é–‹å§‹ï¼‰
  url       String   // ç‰ˆæœ¬åœ–ç‰‡ URL
  blobPath  String   // Blob å­˜å„²è·¯å¾‘

  // è®Šæ›´è¨˜éŒ„
  changes   Json     // è¨˜éŒ„è®Šæ›´å…§å®¹ï¼ˆè£å‰ªã€æ—‹è½‰ã€æ¿¾é¡ç­‰ï¼‰

  // å‰µå»ºä¿¡æ¯
  createdAt DateTime @default(now())
  createdBy String
  user      User     @relation("ImageVersions", fields: [createdBy], references: [id], onDelete: Cascade)

  @@unique([imageId, version])
  @@index([imageId])
  @@index([createdBy])
}

// ==================== TTS éŸ³é »ç·©å­˜åŠŸèƒ½æ¨¡å‹ ====================

// TTS éŸ³é »ç·©å­˜è¡¨
model TTSCache {
  id       String   @id @default(cuid())
  hash     String   @unique // MD5 hash of (text + language + voice)
  text     String   // åŸå§‹æ–‡æœ¬
  language String   // èªè¨€ä»£ç¢¼ (en-US, zh-TW, etc.)
  voice    String   // èªéŸ³é¡å‹ (male, female)

  // éŸ³é »æ–‡ä»¶ä¿¡æ¯
  audioUrl  String  // R2 å…¬é–‹ URL
  r2Key     String  // R2 å­˜å„²éµå€¼
  fileSize  Int     // æ–‡ä»¶å¤§å°ï¼ˆbytesï¼‰
  duration  Float?  // éŸ³é »æ™‚é•·ï¼ˆç§’ï¼‰

  // GEPT åˆ†ç´šä¿¡æ¯
  geptLevel GEPTLevel? // GEPT ç­‰ç´š

  // ä½¿ç”¨çµ±è¨ˆ
  hitCount  Int      @default(0) // ç·©å­˜å‘½ä¸­æ¬¡æ•¸
  lastHit   DateTime? // æœ€å¾Œè¨ªå•æ™‚é–“

  // æ™‚é–“æˆ³
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hash])
  @@index([geptLevel])
  @@index([language])
  @@index([createdAt])
  @@map("tts_cache")
}

// ==================== SRS (Spaced Repetition System) åŠŸèƒ½æ¨¡å‹ ====================

// ç”¨æˆ¶å–®å­—å­¸ç¿’é€²åº¦è¡¨
model UserWordProgress {
  id       String   @id @default(cuid())
  userId   String
  wordId   String

  // ===== SRS æ ¸å¿ƒåƒæ•¸ =====
  memoryStrength  Int      @default(0)    // è¨˜æ†¶å¼·åº¦ (0-100)
  easeFactor      Float    @default(2.5)  // é›£åº¦ä¿‚æ•¸ (1.3-2.5)
  interval        Int      @default(1)    // è¤‡ç¿’é–“éš” (å¤©æ•¸)
  repetitions     Int      @default(0)    // é€£çºŒæ­£ç¢ºæ¬¡æ•¸

  // ===== æ™‚é–“æˆ³ =====
  firstLearnedAt  DateTime @default(now())
  lastReviewedAt  DateTime @default(now())
  nextReviewAt    DateTime @default(now())

  // ===== çµ±è¨ˆæ•¸æ“š =====
  totalReviews     Int     @default(0)
  correctReviews   Int     @default(0)
  incorrectReviews Int     @default(0)

  // ===== å­¸ç¿’ç‹€æ…‹ =====
  status          String   @default("NEW")  // NEW, LEARNING, REVIEWING, MASTERED

  // ===== é—œè¯ =====
  user            User     @relation("UserWordProgress", fields: [userId], references: [id], onDelete: Cascade)
  word            VocabularyItem @relation("WordProgress", fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
  @@index([userId, nextReviewAt])
  @@index([userId, status])
  @@index([wordId])
  @@map("user_word_progress")
}

// å­¸ç¿’æœƒè©±è¡¨
model LearningSession {
  id              String   @id @default(cuid())
  userId          String
  geptLevel       String   // elementary, intermediate, high-intermediate

  // ===== æœƒè©±æ•¸æ“š =====
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  duration        Int?     // ç§’æ•¸

  // ===== å–®å­—çµ±è¨ˆ =====
  newWordsCount   Int      @default(0)
  reviewWordsCount Int     @default(0)
  totalWords      Int      @default(0)

  // ===== æ­£ç¢ºç‡ =====
  correctAnswers  Int      @default(0)
  totalAnswers    Int      @default(0)
  accuracy        Float?   // æ­£ç¢ºç‡ (0-100)

  // ===== é—œè¯ =====
  user            User     @relation("LearningSessions", fields: [userId], references: [id], onDelete: Cascade)
  wordReviews     WordReview[]

  @@index([userId, startedAt])
  @@index([geptLevel])
  @@map("learning_sessions")
}

// å–®å­—è¤‡ç¿’è¨˜éŒ„è¡¨
model WordReview {
  id              String   @id @default(cuid())
  sessionId       String
  wordId          String

  // ===== è¤‡ç¿’æ•¸æ“š =====
  isCorrect       Boolean
  responseTime    Int      // æ¯«ç§’
  reviewedAt      DateTime @default(now())

  // ===== SRS æ›´æ–°å‰å¾Œ =====
  memoryStrengthBefore  Int
  memoryStrengthAfter   Int
  intervalBefore        Int
  intervalAfter         Int

  // ===== é—œè¯ =====
  session         LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  word            VocabularyItem  @relation("WordReviews", fields: [wordId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([wordId])
  @@index([reviewedAt])
  @@map("word_reviews")
}

// ==================== éŠæˆ²æ’è¡Œæ¦œåŠŸèƒ½æ¨¡å‹ ====================

// éŠæˆ²æ’è¡Œæ¦œè¡¨
model GameLeaderboard {
  id              String   @id @default(cuid())
  activityId      String   // æ´»å‹• ID
  playerName      String   // ç©å®¶åç¨±
  score           Int      // åˆ†æ•¸
  correctCount    Int      // ç­”å°é¡Œæ•¸
  totalCount      Int      // ç¸½é¡Œæ•¸
  accuracy        Float    // æ­£ç¢ºç‡ (0-100)
  timeSpent       Int      // éŠæˆ²æ™‚é–“ï¼ˆç§’ï¼‰
  gameData        Json?    // è©³ç´°éŠæˆ²æ•¸æ“šï¼ˆå•é¡Œç­”æ¡ˆè¨˜éŒ„ç­‰ï¼‰

  // æ™‚é–“æˆ³
  createdAt       DateTime @default(now())

  // ç´¢å¼•
  @@index([activityId, score])
  @@index([activityId, createdAt])
  @@index([createdAt])
  @@map("game_leaderboard")
}
