<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduCreate - Starshake</title>

    <style>
        /* reset CSS */
        html, body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            font-family: 'Open Sans', sans-serif;
        }

        #app {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            width: 100%;
            height: 100%;
            max-width: 1000px;
            max-height: 800px;
        }

        /* æ‰‹æ©Ÿç›´å‘æ¨¡å¼å„ªåŒ– */
        @media (max-width: 768px) and (orientation: portrait) {
            #game-container {
                /* åœ¨æ‰‹æ©Ÿç›´å‘æ¨¡å¼ä¸‹ï¼Œç‚ºè™›æ“¬æ§åˆ¶ç•™å‡ºæ›´å¤šåº•éƒ¨ç©ºé–“ */
                margin-bottom: 120px;  /* å¢åŠ åˆ°120pxï¼Œç‚ºè™›æ“¬æ§åˆ¶æä¾›æ›´å¤šé»‘è‰²å€åŸŸ */
                height: calc(100% - 120px);
            }

            /* ç¢ºä¿éŠæˆ²ç•«é¢ä¸è¢«è™›æ“¬æ§åˆ¶é®æ“‹ */
            body {
                padding-bottom: 120px;  /* å¢åŠ åˆ°120px */
            }

            /* æ‰‹æ©Ÿç›´å‘æ¨¡å¼ä¸‹çš„è™›æ“¬æ§åˆ¶å®šä½ - æ”¾åœ¨é»‘è‰²å€åŸŸ */
            .touch-joystick {
                bottom: 20px !important;  /* æ›´é è¿‘åº•éƒ¨ï¼Œæ”¾åœ¨é»‘è‰²å€åŸŸ */
            }

            .touch-shoot-btn {
                bottom: 20px !important;  /* æ›´é è¿‘åº•éƒ¨ï¼Œæ”¾åœ¨é»‘è‰²å€åŸŸ */
            }

            .fullscreen-btn {
                bottom: 20px !important;  /* å…¨è¢å¹•æŒ‰éˆ•ä¹Ÿèª¿æ•´åˆ°é»‘è‰²å€åŸŸ */
            }
        }
    </style>
  <script type="module" crossorigin src="/games/starshake-game/dist/assets/index-DEhXC0VF.js"></script>
  <link rel="modulepreload" crossorigin href="/games/starshake-game/dist/assets/phaser-CmFXOKba.js">

    <!-- è§¸æ‘¸æ§åˆ¶æ¨£å¼ -->
    

    <!-- è§¸æ‘¸æ§åˆ¶æ¨£å¼ -->
    <style>
        /* è§¸æ‘¸æ§åˆ¶é¢æ¿ */
        #touch-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 240px;  /* å¾ 200px å¢åŠ åˆ° 240pxï¼Œç‚ºæ–æ¡¿ä¸‹ç§»æä¾›ç©ºé–“ */
            background: transparent;
            display: none;
            z-index: 1000;
            pointer-events: none;
        }
        
        /* ç§»å‹•æ§åˆ¶å€åŸŸ */
        .touch-joystick {
            position: absolute;
            bottom: 60px;  /* å¾ 20px å¢åŠ åˆ° 60pxï¼Œè®“æ–æ¡¿å¾€ä¸‹ç§»å‹• */
            left: 20px;
            width: 120px;
            height: 120px;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            pointer-events: all;
        }
        
        .touch-joystick-knob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s ease;
        }
        
        /* å°„æ“ŠæŒ‰éˆ• */
        .touch-shoot-btn {
            position: absolute;
            bottom: 60px;  /* å¾ 20px å¢åŠ åˆ° 60pxï¼Œèˆ‡æ–æ¡¿ä¿æŒä¸€è‡´ */
            right: 20px;
            width: 80px;
            height: 80px;
            background: transparent;
            border: 2px solid rgba(255, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 0, 0, 0.8);
            font-size: 24px;
            font-weight: bold;
            pointer-events: all;
            user-select: none;
        }
        
        .touch-shoot-btn:active {
            background: rgba(255, 0, 0, 0.2);
            border-color: rgba(255, 0, 0, 0.8);
            transform: scale(0.95);
        }
        
        /* ç§»å‹•è¨­å‚™æª¢æ¸¬ */
        @media (max-width: 768px), (pointer: coarse) {
            #touch-controls {
                display: block;
            }
        }
        
        /* å…¨è¢å¹•æŒ‰éˆ• */
        .fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            pointer-events: all;
            cursor: pointer;
        }

        /* æ‰‹æ©Ÿæ©«å‘æ¨¡å¼å„ªåŒ– */
        @media (max-width: 768px) and (orientation: landscape) {
            #game-container {
                /* ç§»é™¤å°ºå¯¸é™åˆ¶ï¼Œè®“éŠæˆ²å……åˆ†åˆ©ç”¨æ©«å‘è¢å¹•ç©ºé–“ */
                max-width: none !important;
                max-height: none !important;
                width: 100vw !important;
                height: 100vh !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            #app {
                width: 100vw !important;
                height: 100vh !important;
            }

            body {
                padding: 0 !important;
                margin: 0 !important;
            }

            /* æ©«å‘æ¨¡å¼ä¸‹çš„è™›æ“¬æ§åˆ¶èª¿æ•´ */
            #touch-controls {
                height: 200px; /* æ¸›å°‘é«˜åº¦ï¼Œé¿å…é®æ“‹éå¤šéŠæˆ²å…§å®¹ */
            }

            .touch-joystick {
                bottom: 30px !important; /* èª¿æ•´ä½ç½® */
                left: 30px !important;
                width: 100px !important; /* ç¨å¾®ç¸®å° */
                height: 100px !important;
            }

            .touch-joystick-knob {
                width: 35px !important;
                height: 35px !important;
            }

            .touch-shoot-btn {
                bottom: 30px !important; /* èª¿æ•´ä½ç½® */
                right: 30px !important;
                width: 70px !important; /* ç¨å¾®ç¸®å° */
                height: 70px !important;
                font-size: 18px !important;
            }

            .fullscreen-btn {
                top: 20px !important;
                right: 20px !important;
                width: 40px !important;
                height: 40px !important;
                font-size: 16px !important;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="game-container"></div>
        
        <!-- è§¸æ‘¸æ§åˆ¶é¢æ¿ -->
        <div id="touch-controls">
            <!-- ç§»å‹•æ–æ¡¿ -->
            <div class="touch-joystick" id="touch-joystick">
                <div class="touch-joystick-knob" id="joystick-knob"></div>
            </div>
            
            <!-- å°„æ“ŠæŒ‰éˆ• -->
            <div class="touch-shoot-btn" id="touch-shoot">
                ğŸš€
            </div>
            
            <!-- å…¨è¢å¹•æŒ‰éˆ• -->
            <div class="fullscreen-btn" id="fullscreen-btn">
                â›¶
            </div>
        </div>
    </div>
    
    <!-- è§¸æ‘¸æ§åˆ¶ JavaScript -->
    <script>
        // è§¸æ‘¸æ§åˆ¶ç³»çµ±
        // è§¸æ‘¸æ§åˆ¶ç³»çµ±
        class TouchControls {
            constructor() {
                this.joystick = document.getElementById('touch-joystick');
                this.knob = document.getElementById('joystick-knob');
                this.shootBtn = document.getElementById('touch-shoot');
                this.fullscreenBtn = document.getElementById('fullscreen-btn');
                
                this.joystickActive = false;
                this.joystickCenter = { x: 0, y: 0 };
                this.currentDirection = { x: 0, y: 0 };
                this.shooting = false;
                
                // èª¿è©¦æ¨™èªŒ
                this.debug = true;
                
                this.init();
            }
            
            init() {
                if (this.debug) console.log('ğŸ® TouchControls åˆå§‹åŒ–é–‹å§‹...');
                
                // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!this.joystick || !this.knob || !this.shootBtn) {
                    console.error('âŒ TouchControls å…ƒç´ æœªæ‰¾åˆ°:', {
                        joystick: !!this.joystick,
                        knob: !!this.knob,
                        shootBtn: !!this.shootBtn
                    });
                    return;
                }
                
                // æ–æ¡¿æ§åˆ¶ - æ·»åŠ å¤šç¨®äº‹ä»¶é¡å‹
                this.joystick.addEventListener('touchstart', this.onJoystickStart.bind(this), { passive: false });
                this.joystick.addEventListener('touchmove', this.onJoystickMove.bind(this), { passive: false });
                this.joystick.addEventListener('touchend', this.onJoystickEnd.bind(this), { passive: false });
                this.joystick.addEventListener('touchcancel', this.onJoystickEnd.bind(this), { passive: false });
                
                // æ·»åŠ é¼ æ¨™äº‹ä»¶ä½œç‚ºå‚™ç”¨ï¼ˆç”¨æ–¼æ¡Œé¢æ¸¬è©¦ï¼‰
                this.joystick.addEventListener('mousedown', this.onJoystickStartMouse.bind(this));
                this.joystick.addEventListener('mousemove', this.onJoystickMoveMouse.bind(this));
                this.joystick.addEventListener('mouseup', this.onJoystickEndMouse.bind(this));
                this.joystick.addEventListener('mouseleave', this.onJoystickEndMouse.bind(this));
                
                // å°„æ“ŠæŒ‰éˆ•
                this.shootBtn.addEventListener('touchstart', this.onShootStart.bind(this), { passive: false });
                this.shootBtn.addEventListener('touchend', this.onShootEnd.bind(this), { passive: false });
                this.shootBtn.addEventListener('touchcancel', this.onShootEnd.bind(this), { passive: false });
                
                // é¼ æ¨™äº‹ä»¶ä½œç‚ºå‚™ç”¨
                this.shootBtn.addEventListener('mousedown', this.onShootStart.bind(this));
                this.shootBtn.addEventListener('mouseup', this.onShootEnd.bind(this));
                
                // å…¨è¢å¹•æŒ‰éˆ•
                if (this.fullscreenBtn) {
                    this.fullscreenBtn.addEventListener('click', this.toggleFullscreen.bind(this));
                    this.fullscreenBtn.addEventListener('touchend', this.toggleFullscreen.bind(this));
                }
                
                // é˜²æ­¢é»˜èªè§¸æ‘¸è¡Œç‚º
                document.addEventListener('touchmove', (e) => {
                    if (e.target.closest('#touch-controls')) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // é˜²æ­¢ä¸Šä¸‹æ–‡èœå–®
                document.addEventListener('contextmenu', (e) => {
                    if (e.target.closest('#touch-controls')) {
                        e.preventDefault();
                    }
                });
                
                if (this.debug) console.log('âœ… TouchControls äº‹ä»¶ç›£è½å™¨å·²è¨­ç½®');
            }
            
            onJoystickStart(e) {
                e.preventDefault();
                if (this.debug) console.log('ğŸ•¹ï¸ æ–æ¡¿è§¸æ‘¸é–‹å§‹');
                this.joystickActive = true;
                const rect = this.joystick.getBoundingClientRect();
                this.joystickCenter = {
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2
                };
                if (this.debug) console.log('ğŸ“ æ–æ¡¿ä¸­å¿ƒ:', this.joystickCenter);
            }
            
            onJoystickStartMouse(e) {
                e.preventDefault();
                if (this.debug) console.log('ğŸ–±ï¸ æ–æ¡¿é¼ æ¨™é–‹å§‹');
                this.joystickActive = true;
                const rect = this.joystick.getBoundingClientRect();
                this.joystickCenter = {
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2
                };
            }
            
            onJoystickMove(e) {
                if (!this.joystickActive) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                if (!touch) return;
                
                this.updateJoystickPosition(touch.clientX, touch.clientY);
            }
            
            onJoystickMoveMouse(e) {
                if (!this.joystickActive) return;
                e.preventDefault();
                
                this.updateJoystickPosition(e.clientX, e.clientY);
            }
            
            updateJoystickPosition(clientX, clientY) {
                const deltaX = clientX - this.joystickCenter.x;
                const deltaY = clientY - this.joystickCenter.y;
                
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const maxDistance = 40;
                
                if (distance <= maxDistance) {
                    this.knob.style.transform = `translate(${deltaX - 20}px, ${deltaY - 20}px)`;
                    this.currentDirection = {
                        x: deltaX / maxDistance,
                        y: deltaY / maxDistance
                    };
                } else {
                    const angle = Math.atan2(deltaY, deltaX);
                    const limitedX = Math.cos(angle) * maxDistance;
                    const limitedY = Math.sin(angle) * maxDistance;
                    
                    this.knob.style.transform = `translate(${limitedX - 20}px, ${limitedY - 20}px)`;
                    this.currentDirection = {
                        x: Math.cos(angle),
                        y: Math.sin(angle)
                    };
                }
                
                if (this.debug && Math.abs(this.currentDirection.x) > 0.1 || Math.abs(this.currentDirection.y) > 0.1) {
                    console.log('ğŸ¯ æ–æ¡¿æ–¹å‘:', this.currentDirection);
                }
            }
            
            onJoystickEnd(e) {
                e.preventDefault();
                if (this.debug) console.log('ğŸ•¹ï¸ æ–æ¡¿è§¸æ‘¸çµæŸ');
                this.joystickActive = false;
                this.knob.style.transform = 'translate(-50%, -50%)';
                this.currentDirection = { x: 0, y: 0 };
            }
            
            onJoystickEndMouse(e) {
                e.preventDefault();
                if (this.debug) console.log('ğŸ–±ï¸ æ–æ¡¿é¼ æ¨™çµæŸ');
                this.joystickActive = false;
                this.knob.style.transform = 'translate(-50%, -50%)';
                this.currentDirection = { x: 0, y: 0 };
            }
            
            onShootStart(e) {
                e.preventDefault();
                if (this.debug) console.log('ğŸš€ å°„æ“Šé–‹å§‹');
                this.shooting = true;
                // æ·»åŠ è¦–è¦ºåé¥‹
                this.shootBtn.style.transform = 'scale(0.9)';
                this.shootBtn.style.backgroundColor = '#ff6b6b';
            }
            
            onShootEnd(e) {
                e.preventDefault();
                if (this.debug) console.log('ğŸš€ å°„æ“ŠçµæŸ');
                this.shooting = false;
                // æ¢å¾©è¦–è¦ºåé¥‹
                this.shootBtn.style.transform = 'scale(1)';
                this.shootBtn.style.backgroundColor = '#ff4757';
            }
            
            toggleFullscreen() {
                if (this.debug) console.log('ğŸ–¥ï¸ åˆ‡æ›å…¨è¢å¹•');
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log('å…¨è¢å¹•è«‹æ±‚å¤±æ•—:', err);
                    });
                } else {
                    document.exitFullscreen().catch(err => {
                        console.log('é€€å‡ºå…¨è¢å¹•å¤±æ•—:', err);
                    });
                }
            }
            
            // ç²å–ç•¶å‰è¼¸å…¥ç‹€æ…‹
            getInputState() {
                const state = {
                    direction: { ...this.currentDirection },
                    shooting: this.shooting
                };
                
                // åªåœ¨ç‹€æ…‹è®ŠåŒ–æ™‚è¨˜éŒ„
                if (this.debug && (Math.abs(state.direction.x) > 0.1 || Math.abs(state.direction.y) > 0.1 || state.shooting)) {
                    console.log('ğŸ“Š ç•¶å‰ç‹€æ…‹:', state);
                }
                
                return state;
            }
            
            // æ¸¬è©¦æ–¹æ³•
            testControls() {
                console.log('ğŸ§ª TouchControls æ¸¬è©¦:');
                console.log('  - æ–æ¡¿å…ƒç´ :', !!this.joystick);
                console.log('  - æ–æ¡¿æ—‹éˆ•:', !!this.knob);
                console.log('  - å°„æ“ŠæŒ‰éˆ•:', !!this.shootBtn);
                console.log('  - å…¨è¢å¹•æŒ‰éˆ•:', !!this.fullscreenBtn);
                console.log('  - ç•¶å‰ç‹€æ…‹:', this.getInputState());
                return true;
            }
        }
        
        // åˆå§‹åŒ–è§¸æ‘¸æ§åˆ¶
        window.touchControls = new TouchControls();
        
        // æ·»åŠ æ¸¬è©¦æ–¹æ³•åˆ° window
        window.testTouchControls = () => window.touchControls.testControls();
        
        console.log('ğŸ® è§¸æ‘¸æ§åˆ¶ç³»çµ±å·²åˆå§‹åŒ–');
        console.log('ğŸ’¡ ä½¿ç”¨ testTouchControls() é€²è¡Œæ¸¬è©¦');
        
        // èª¿è©¦åŠŸèƒ½
        window.toggleTouchDebug = function() {
            document.body.classList.toggle('touch-debug');
            console.log('ğŸ› TouchControls èª¿è©¦æ¨¡å¼:', document.body.classList.contains('touch-debug') ? 'é–‹å•Ÿ' : 'é—œé–‰');
        };
        
        // å¼·åˆ¶é¡¯ç¤º TouchControlsï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
        window.forceTouchControls = function(show = true) {
            const controls = document.getElementById('touch-controls');
            if (controls) {
                controls.style.display = show ? 'block' : 'none';
                console.log('ğŸ® TouchControls å¼·åˆ¶é¡¯ç¤º:', show);
            }
        };
        
        // æª¢æŸ¥åª’é«”æŸ¥è©¢
        window.checkMediaQueries = function() {
            const queries = [
                '(max-width: 1024px)',
                '(max-height: 768px)',
                '(pointer: coarse)',
                '(hover: none) and (pointer: coarse)',
                '(min-width: 768px) and (max-width: 1024px)',
                '(min-width: 414px) and (max-width: 768px)'
            ];
            
            console.log('ğŸ“± åª’é«”æŸ¥è©¢æª¢æŸ¥:');
            queries.forEach(query => {
                const matches = window.matchMedia(query).matches;
                console.log(`  ${query}: ${matches ? 'âœ…' : 'âŒ'}`);
            });
            
            const controls = document.getElementById('touch-controls');
            const isVisible = controls && window.getComputedStyle(controls).display !== 'none';
            console.log(`ğŸ® TouchControls å¯è¦‹: ${isVisible ? 'âœ…' : 'âŒ'}`);
        };
    </script>

    <!-- å•Ÿå‹•ç•«é¢é»æ“Šæ”¯æ´ JavaScript -->
    <script>
        // å•Ÿå‹•ç•«é¢é»æ“Šå’Œè§¸æ‘¸æ”¯æ´
        window.addStartScreenClickSupport = function() {
            console.log('ğŸ® æ·»åŠ å•Ÿå‹•ç•«é¢é»æ“Šå’Œè§¸æ‘¸æ”¯æ´');
            
            // ç­‰å¾… Phaser éŠæˆ²åˆå§‹åŒ–
            const checkPhaserGame = setInterval(() => {
                if (window.game && window.game.scene && window.game.scene.scenes.length > 0) {
                    clearInterval(checkPhaserGame);
                    
                    // æŸ¥æ‰¾ splash å ´æ™¯
                    const splashScene = window.game.scene.scenes.find(scene => scene.scene.key === 'splash');
                    
                    if (splashScene && splashScene.scene.isActive()) {
                        console.log('ğŸ¯ æ‰¾åˆ° splash å ´æ™¯ï¼Œæ·»åŠ é»æ“Šæ”¯æ´');
                        addClickSupportToSplash(splashScene);
                    } else {
                        // ç›£è½å ´æ™¯åˆ‡æ›ï¼Œç•¶ splash å ´æ™¯å•Ÿå‹•æ™‚æ·»åŠ æ”¯æ´
                        window.game.events.on('scenestart', (scene) => {
                            if (scene.scene.key === 'splash') {
                                console.log('ğŸ¯ splash å ´æ™¯å•Ÿå‹•ï¼Œæ·»åŠ é»æ“Šæ”¯æ´');
                                setTimeout(() => addClickSupportToSplash(scene), 100);
                            }
                        });
                    }
                }
            }, 100);
            
            // ç‚º splash å ´æ™¯æ·»åŠ é»æ“Šå’Œè§¸æ‘¸æ”¯æ´
            function addClickSupportToSplash(scene) {
                if (scene.clickSupportAdded) return;
                scene.clickSupportAdded = true;
                
                console.log('âœ… ç‚º splash å ´æ™¯æ·»åŠ é»æ“Šå’Œè§¸æ‘¸æ”¯æ´');
                
                // æ·»åŠ é»æ“Šäº‹ä»¶ç›£è½å™¨
                scene.input.on('pointerdown', () => {
                    console.log('ğŸ–±ï¸ æª¢æ¸¬åˆ°é»æ“Šï¼Œé–‹å§‹éŠæˆ²');
                    if (scene.transitionToChange && typeof scene.transitionToChange === 'function') {
                        scene.transitionToChange();
                    }
                });
                
                // æ·»åŠ è§¸æ‘¸äº‹ä»¶ç›£è½å™¨ï¼ˆå‚™ç”¨ï¼‰
                const canvas = scene.sys.game.canvas;
                if (canvas) {
                    const touchStartHandler = (e) => {
                        e.preventDefault();
                        console.log('ğŸ‘† æª¢æ¸¬åˆ°è§¸æ‘¸ï¼Œé–‹å§‹éŠæˆ²');
                        if (scene.transitionToChange && typeof scene.transitionToChange === 'function') {
                            scene.transitionToChange();
                        }
                    };
                    
                    canvas.addEventListener('touchstart', touchStartHandler, { passive: false });
                    canvas.addEventListener('click', touchStartHandler);
                    
                    // æ¸…ç†å‡½æ•¸
                    scene.events.once('shutdown', () => {
                        canvas.removeEventListener('touchstart', touchStartHandler);
                        canvas.removeEventListener('click', touchStartHandler);
                    });
                }
                
                // æ·»åŠ è¦–è¦ºæç¤º
                const instructionText = scene.add.bitmapText(
                    scene.center_width, 
                    scene.center_height + 150, 
                    "wendy", 
                    "é»æ“Šä»»æ„ä½ç½®æˆ–æŒ‰ SPACE é–‹å§‹", 
                    40
                ).setOrigin(0.5);
                
                // é–ƒçˆæ•ˆæœ
                scene.tweens.add({
                    targets: instructionText,
                    alpha: { from: 0.3, to: 1 },
                    duration: 800,
                    repeat: -1,
                    yoyo: true
                });
            }
        };
        
        // ç•¶é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.addStartScreenClickSupport);
        } else {
            window.addStartScreenClickSupport();
        }
    </script>


        <!-- ğŸ¯ åº§æ¨™åŒæ­¥è§£æ±ºæ–¹æ¡ˆ - COORDINATE_SYNC_SOLUTION -->
        <script>
            console.log('ğŸ¯ è¼‰å…¥åº§æ¨™åŒæ­¥è§£æ±ºæ–¹æ¡ˆ');
            
            // ç­‰å¾… TouchControls è¼‰å…¥å®Œæˆ
            function waitForTouchControls() {
                return new Promise((resolve) => {
                    const checkTouchControls = () => {
                        if (window.touchControls && window.touchControls.toggleFullscreen) {
                            resolve();
                        } else {
                            setTimeout(checkTouchControls, 100);
                        }
                    };
                    checkTouchControls();
                });
            }
            
            // å¯¦ç¾åº§æ¨™åŒæ­¥çš„å…¨è¢å¹•åˆ‡æ›
            async function implementCoordinateSync() {
                await waitForTouchControls();
                
                console.log('ğŸ”§ é–‹å§‹å¯¦ç¾åº§æ¨™åŒæ­¥');
                
                // ä¿å­˜åŸå§‹çš„å…¨è¢å¹•åˆ‡æ›å‡½æ•¸
                const originalToggleFullscreen = window.touchControls.toggleFullscreen;
                
                // æ›¿æ›ç‚ºåº§æ¨™åŒæ­¥ç‰ˆæœ¬
                window.touchControls.toggleFullscreen = async function() {
                    console.log('ğŸ¯ åŸ·è¡Œåº§æ¨™åŒæ­¥å…¨è¢å¹•åˆ‡æ›');
                    
                    try {
                        const isCurrentlyFullscreen = !!document.fullscreenElement;
                        
                        if (!isCurrentlyFullscreen) {
                            // é€²å…¥å…¨è¢å¹•
                            console.log('ğŸ“± é€²å…¥å…¨è¢å¹•æ¨¡å¼');
                            
                            // 1. è§¸ç™¼åŸç”Ÿ Fullscreen API
                            await document.documentElement.requestFullscreen();
                            console.log('âœ… åŸç”Ÿå…¨è¢å¹•å·²è§¸ç™¼');
                            
                            // 2. ç­‰å¾…å…¨è¢å¹•ç‹€æ…‹ç©©å®š
                            await new Promise(resolve => setTimeout(resolve, 300));
                            
                            // 3. é‡æ–°è¨ˆç®—åº§æ¨™
                            this.recalculateCoordinates();
                            
                            // 4. è§¸ç™¼ resize äº‹ä»¶è®“ Phaser é‡æ–°è¨ˆç®—
                            window.dispatchEvent(new Event('resize'));
                            
                            // 5. å¦‚æœæœ‰ Phaser éŠæˆ²ï¼Œåˆ·æ–° scale
                            if (window.game && window.game.scale) {
                                setTimeout(() => {
                                    window.game.scale.refresh();
                                    console.log('ğŸ® Phaser éŠæˆ² scale å·²åˆ·æ–°');
                                }, 100);
                            }
                            
                        } else {
                            // é€€å‡ºå…¨è¢å¹•
                            console.log('ğŸ“± é€€å‡ºå…¨è¢å¹•æ¨¡å¼');
                            
                            await document.exitFullscreen();
                            console.log('âœ… å·²é€€å‡ºåŸç”Ÿå…¨è¢å¹•');
                            
                            // ç­‰å¾…é€€å‡ºç‹€æ…‹ç©©å®š
                            await new Promise(resolve => setTimeout(resolve, 300));
                            
                            // é‡æ–°è¨ˆç®—åº§æ¨™
                            this.recalculateCoordinates();
                            
                            // è§¸ç™¼ resize äº‹ä»¶
                            window.dispatchEvent(new Event('resize'));
                            
                            // åˆ·æ–° Phaser scale
                            if (window.game && window.game.scale) {
                                setTimeout(() => {
                                    window.game.scale.refresh();
                                    console.log('ğŸ® Phaser éŠæˆ² scale å·²åˆ·æ–°');
                                }, 100);
                            }
                        }
                        
                        console.log('âœ… åº§æ¨™åŒæ­¥å…¨è¢å¹•åˆ‡æ›å®Œæˆ');
                        
                    } catch (error) {
                        console.log('âŒ åº§æ¨™åŒæ­¥å…¨è¢å¹•åˆ‡æ›å¤±æ•—:', error);
                        // å›é€€åˆ°åŸå§‹æ–¹æ³•
                        originalToggleFullscreen.call(this);
                    }
                };
                
                // æ·»åŠ åº§æ¨™é‡æ–°è¨ˆç®—æ–¹æ³•
                window.touchControls.recalculateCoordinates = function() {
                    console.log('ğŸ”„ é‡æ–°è¨ˆç®— TouchControls åº§æ¨™');
                    
                    // é‡æ–°è¨ˆç®—æ–æ¡¿ä¸­å¿ƒåº§æ¨™
                    if (this.joystick) {
                        const rect = this.joystick.getBoundingClientRect();
                        this.joystickCenter = {
                            x: rect.left + rect.width / 2,
                            y: rect.top + rect.height / 2
                        };
                        console.log('ğŸ•¹ï¸ æ–æ¡¿ä¸­å¿ƒåº§æ¨™å·²æ›´æ–°:', this.joystickCenter);
                    }
                    
                    // é‡æ–°è¨ˆç®—å°„æ“ŠæŒ‰éˆ•åº§æ¨™
                    if (this.shootBtn) {
                        const rect = this.shootBtn.getBoundingClientRect();
                        console.log('ğŸš€ å°„æ“ŠæŒ‰éˆ•åº§æ¨™å·²æ›´æ–°:', {
                            left: rect.left,
                            top: rect.top,
                            width: rect.width,
                            height: rect.height
                        });
                    }
                    
                    // é‡æ–°è¨ˆç®—å…¨è¢å¹•æŒ‰éˆ•åº§æ¨™
                    const fullscreenBtn = document.querySelector('.fullscreen-btn');
                    if (fullscreenBtn) {
                        const rect = fullscreenBtn.getBoundingClientRect();
                        console.log('â›¶ å…¨è¢å¹•æŒ‰éˆ•åº§æ¨™å·²æ›´æ–°:', {
                            left: rect.left,
                            top: rect.top,
                            width: rect.width,
                            height: rect.height
                        });
                    }
                };
                
                // ç§»é™¤ fullscreenchange ç›£è½å™¨ä»¥é˜²æ­¢ç„¡é™å¾ªç’°
                // åŸå› ï¼šfullscreenchange äº‹ä»¶æœƒè§¸ç™¼åº§æ¨™é‡æ–°è¨ˆç®—ï¼Œå¯èƒ½é–“æ¥è§¸ç™¼æ–°çš„å…¨è¢å¹•è«‹æ±‚
                console.log('ğŸš« å·²ç§»é™¤ fullscreenchange äº‹ä»¶ç›£è½å™¨ï¼Œé˜²æ­¢ç„¡é™å¾ªç’°');
                
                // ç›£è½ resize äº‹ä»¶
                window.addEventListener('resize', () => {
                    console.log('ğŸ”„ è¦–çª—å¤§å°è®ŠåŒ–ï¼Œé‡æ–°è¨ˆç®—åº§æ¨™');
                    setTimeout(() => {
                        if (window.touchControls && window.touchControls.recalculateCoordinates) {
                            window.touchControls.recalculateCoordinates();
                        }
                    }, 100);
                });
                
                console.log('âœ… åº§æ¨™åŒæ­¥è§£æ±ºæ–¹æ¡ˆå¯¦ç¾å®Œæˆ');
                
                // æ·»åŠ æ¸¬è©¦å‡½æ•¸
                window.testCoordinateSync = function() {
                    console.log('ğŸ§ª æ¸¬è©¦åº§æ¨™åŒæ­¥åŠŸèƒ½');
                    
                    const currentCoords = {
                        viewport: {
                            width: window.innerWidth,
                            height: window.innerHeight
                        },
                        isFullscreen: !!document.fullscreenElement,
                        touchControls: {}
                    };
                    
                    if (window.touchControls) {
                        if (window.touchControls.joystickCenter) {
                            currentCoords.touchControls.joystickCenter = window.touchControls.joystickCenter;
                        }
                        
                        const joystick = document.querySelector('.touch-joystick');
                        if (joystick) {
                            const rect = joystick.getBoundingClientRect();
                            currentCoords.touchControls.joystick = {
                                left: rect.left,
                                top: rect.top,
                                width: rect.width,
                                height: rect.height
                            };
                        }
                    }
                    
                    console.log('ğŸ“Š ç•¶å‰åº§æ¨™ç‹€æ…‹:', currentCoords);
                    return currentCoords;
                };
                
                // æ·»åŠ å¼·åˆ¶é‡æ–°è¨ˆç®—å‡½æ•¸
                window.forceRecalculateCoordinates = function() {
                    console.log('ğŸ”§ å¼·åˆ¶é‡æ–°è¨ˆç®—æ‰€æœ‰åº§æ¨™');
                    
                    if (window.touchControls && window.touchControls.recalculateCoordinates) {
                        window.touchControls.recalculateCoordinates();
                    }
                    
                    // è§¸ç™¼ Phaser é‡æ–°è¨ˆç®—
                    window.dispatchEvent(new Event('resize'));
                    
                    if (window.game && window.game.scale) {
                        window.game.scale.refresh();
                    }
                    
                    console.log('âœ… å¼·åˆ¶é‡æ–°è¨ˆç®—å®Œæˆ');
                };
            }
            
            // é é¢è¼‰å…¥å®Œæˆå¾Œå¯¦ç¾åº§æ¨™åŒæ­¥
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', implementCoordinateSync);
            } else {
                implementCoordinateSync();
            }
        </script>
        
        
        
        <!-- ğŸ” PostMessage é€šä¿¡è¨ºæ–·å·¥å…· - POSTMESSAGE_DIAGNOSTIC_TOOL -->
        <script>
            console.log('ğŸ” è¼‰å…¥ PostMessage é€šä¿¡è¨ºæ–·å·¥å…·');
            
            // PostMessage é€šä¿¡è¨ºæ–·é¡
            class PostMessageDiagnostic {
                constructor() {
                    this.diagnosticResults = {
                        environment: {},
                        communication: {},
                        errors: [],
                        timeline: []
                    };
                    this.init();
                }
                
                init() {
                    console.log('ğŸš€ åˆå§‹åŒ– PostMessage è¨ºæ–·å·¥å…·');
                    this.diagnoseEnvironment();
                    this.setupCommunicationTest();
                    this.addDiagnosticFunctions();
                }
                
                // è¨ºæ–·ç’°å¢ƒ
                diagnoseEnvironment() {
                    console.log('ğŸ” è¨ºæ–·ç’°å¢ƒè¨­ç½®');
                    
                    const env = {
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        isInIframe: window !== window.parent,
                        canAccessParent: this.canAccessParent(),
                        isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
                        isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
                        isMobile: /Mobi|Android/i.test(navigator.userAgent),
                        windowLocation: window.location.href,
                        parentLocation: this.getParentLocation(),
                        hasPostMessage: typeof window.postMessage === 'function',
                        hasParentPostMessage: this.hasParentPostMessage()
                    };
                    
                    this.diagnosticResults.environment = env;
                    console.log('ğŸ” ç’°å¢ƒè¨ºæ–·çµæœ:', env);
                    
                    // è¨˜éŒ„é—œéµç™¼ç¾
                    if (!env.isInIframe) {
                        this.addError('NOT_IN_IFRAME', 'ä¸åœ¨ iframe ç’°å¢ƒä¸­ï¼ŒPostMessage é€šä¿¡ä¸é©ç”¨');
                    }
                    
                    if (!env.canAccessParent) {
                        this.addError('CANNOT_ACCESS_PARENT', 'ç„¡æ³•è¨ªå•çˆ¶é é¢ï¼Œå¯èƒ½æœ‰è·¨åŸŸé™åˆ¶');
                    }
                    
                    if (env.isIOS && env.isSafari) {
                        this.addWarning('IOS_SAFARI_DETECTED', 'iOS Safari æª¢æ¸¬åˆ°ï¼Œå¯èƒ½æœ‰ç‰¹æ®Šé™åˆ¶');
                    }
                }
                
                // æª¢æŸ¥æ˜¯å¦èƒ½è¨ªå•çˆ¶é é¢
                canAccessParent() {
                    try {
                        return window.parent && window.parent !== window;
                    } catch (error) {
                        this.addError('PARENT_ACCESS_ERROR', error.message);
                        return false;
                    }
                }
                
                // ç²å–çˆ¶é é¢ä½ç½®
                getParentLocation() {
                    try {
                        return window.parent ? window.parent.location.href : 'N/A';
                    } catch (error) {
                        return 'BLOCKED_BY_CORS';
                    }
                }
                
                // æª¢æŸ¥çˆ¶é é¢æ˜¯å¦æœ‰ postMessage
                hasParentPostMessage() {
                    try {
                        return window.parent && typeof window.parent.postMessage === 'function';
                    } catch (error) {
                        return false;
                    }
                }
                
                // è¨­ç½®é€šä¿¡æ¸¬è©¦
                setupCommunicationTest() {
                    console.log('ğŸ“¡ è¨­ç½®é€šä¿¡æ¸¬è©¦');
                    
                    // ç›£è½ä¾†è‡ªçˆ¶é é¢çš„æ¶ˆæ¯
                    window.addEventListener('message', (event) => {
                        this.handleIncomingMessage(event);
                    });
                    
                    // å¦‚æœåœ¨ iframe ä¸­ï¼Œè¨­ç½®å®šæœŸæ¸¬è©¦
                    if (this.diagnosticResults.environment.isInIframe) {
                        this.startCommunicationTest();
                    }
                }
                
                // è™•ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
                handleIncomingMessage(event) {
                    const timestamp = new Date().toISOString();
                    console.log('ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯:', event.data, 'from:', event.origin);
                    
                    this.diagnosticResults.timeline.push({
                        timestamp: timestamp,
                        type: 'RECEIVED',
                        data: event.data,
                        origin: event.origin,
                        source: event.source === window.parent ? 'PARENT' : 'OTHER'
                    });
                    
                    // å¦‚æœæ˜¯è¨ºæ–·éŸ¿æ‡‰
                    if (event.data.type === 'DIAGNOSTIC_RESPONSE') {
                        this.diagnosticResults.communication.parentResponse = {
                            received: true,
                            timestamp: timestamp,
                            data: event.data
                        };
                        console.log('âœ… çˆ¶é é¢éŸ¿æ‡‰å·²æ”¶åˆ°');
                    }
                }
                
                // é–‹å§‹é€šä¿¡æ¸¬è©¦
                startCommunicationTest() {
                    console.log('ğŸ§ª é–‹å§‹é€šä¿¡æ¸¬è©¦');
                    
                    const testMessage = {
                        type: 'DIAGNOSTIC_REQUEST',
                        action: 'COMMUNICATION_TEST',
                        timestamp: new Date().toISOString(),
                        testId: Math.random().toString(36).substr(2, 9)
                    };
                    
                    try {
                        window.parent.postMessage(testMessage, '*');
                        
                        this.diagnosticResults.timeline.push({
                            timestamp: testMessage.timestamp,
                            type: 'SENT',
                            data: testMessage,
                            target: 'PARENT'
                        });
                        
                        console.log('ğŸ“¤ æ¸¬è©¦æ¶ˆæ¯å·²ç™¼é€:', testMessage);
                        
                        // ç­‰å¾…éŸ¿æ‡‰
                        setTimeout(() => {
                            if (!this.diagnosticResults.communication.parentResponse) {
                                this.addError('NO_PARENT_RESPONSE', 'çˆ¶é é¢æ²’æœ‰éŸ¿æ‡‰æ¸¬è©¦æ¶ˆæ¯');
                            }
                        }, 3000);
                        
                    } catch (error) {
                        this.addError('SEND_MESSAGE_ERROR', 'ç™¼é€æ¶ˆæ¯å¤±æ•—: ' + error.message);
                    }
                }
                
                // æ¸¬è©¦é›™é‡å…¨è¢å¹•é€šä¿¡
                testDualFullscreenCommunication() {
                    console.log('ğŸ¯ æ¸¬è©¦é›™é‡å…¨è¢å¹•é€šä¿¡');
                    
                    if (!this.diagnosticResults.environment.isInIframe) {
                        console.log('âš ï¸ ä¸åœ¨ iframe ä¸­ï¼Œè·³éé›™é‡å…¨è¢å¹•é€šä¿¡æ¸¬è©¦');
                        return {
                            skipped: true,
                            reason: 'Not in iframe environment'
                        };
                    }
                    
                    const testMessage = {
                        type: 'DUAL_FULLSCREEN_REQUEST',
                        action: 'ENTER_CSS_FULLSCREEN',
                        timestamp: new Date().toISOString(),
                        testMode: true
                    };
                    
                    try {
                        window.parent.postMessage(testMessage, '*');
                        
                        this.diagnosticResults.timeline.push({
                            timestamp: testMessage.timestamp,
                            type: 'SENT',
                            data: testMessage,
                            target: 'PARENT'
                        });
                        
                        console.log('ğŸ“¤ é›™é‡å…¨è¢å¹•æ¸¬è©¦æ¶ˆæ¯å·²ç™¼é€');
                        
                        return {
                            sent: true,
                            message: testMessage
                        };
                        
                    } catch (error) {
                        this.addError('DUAL_FULLSCREEN_SEND_ERROR', error.message);
                        return {
                            sent: false,
                            error: error.message
                        };
                    }
                }
                
                // æ·»åŠ éŒ¯èª¤
                addError(code, message) {
                    const error = {
                        code: code,
                        message: message,
                        timestamp: new Date().toISOString()
                    };
                    this.diagnosticResults.errors.push(error);
                    console.log('âŒ è¨ºæ–·éŒ¯èª¤:', error);
                }
                
                // æ·»åŠ è­¦å‘Š
                addWarning(code, message) {
                    const warning = {
                        code: code,
                        message: message,
                        timestamp: new Date().toISOString(),
                        type: 'WARNING'
                    };
                    this.diagnosticResults.errors.push(warning);
                    console.log('âš ï¸ è¨ºæ–·è­¦å‘Š:', warning);
                }
                
                // æ·»åŠ è¨ºæ–·å‡½æ•¸åˆ°å…¨å±€
                addDiagnosticFunctions() {
                    // ç²å–å®Œæ•´è¨ºæ–·å ±å‘Š
                    window.getPostMessageDiagnostic = () => {
                        console.log('ğŸ“Š PostMessage è¨ºæ–·å ±å‘Š:', this.diagnosticResults);
                        return this.diagnosticResults;
                    };
                    
                    // æ¸¬è©¦é€šä¿¡
                    window.testPostMessageCommunication = () => {
                        console.log('ğŸ§ª æ‰‹å‹•æ¸¬è©¦ PostMessage é€šä¿¡');
                        return this.testDualFullscreenCommunication();
                    };
                    
                    // æª¢æŸ¥çˆ¶é é¢ç›£è½å™¨
                    window.checkParentListener = () => {
                        console.log('ğŸ” æª¢æŸ¥çˆ¶é é¢ç›£è½å™¨');
                        
                        const checkMessage = {
                            type: 'LISTENER_CHECK',
                            timestamp: new Date().toISOString()
                        };
                        
                        try {
                            window.parent.postMessage(checkMessage, '*');
                            console.log('ğŸ“¤ ç›£è½å™¨æª¢æŸ¥æ¶ˆæ¯å·²ç™¼é€');
                            return { sent: true };
                        } catch (error) {
                            console.log('âŒ ç›£è½å™¨æª¢æŸ¥å¤±æ•—:', error);
                            return { sent: false, error: error.message };
                        }
                    };
                    
                    // å¼·åˆ¶è¨ºæ–·
                    window.forceDiagnostic = () => {
                        console.log('ğŸ”§ å¼·åˆ¶åŸ·è¡Œå®Œæ•´è¨ºæ–·');
                        this.diagnoseEnvironment();
                        this.startCommunicationTest();
                        return this.diagnosticResults;
                    };
                    
                    console.log('âœ… PostMessage è¨ºæ–·å‡½æ•¸å·²æ·»åŠ åˆ°å…¨å±€');
                }
                
                // ç”Ÿæˆè¨ºæ–·å ±å‘Š
                generateReport() {
                    const report = {
                        summary: {
                            environment: this.diagnosticResults.environment.isInIframe ? 'IFRAME' : 'DIRECT',
                            canCommunicate: this.diagnosticResults.communication.parentResponse?.received || false,
                            errorCount: this.diagnosticResults.errors.filter(e => e.type !== 'WARNING').length,
                            warningCount: this.diagnosticResults.errors.filter(e => e.type === 'WARNING').length
                        },
                        details: this.diagnosticResults,
                        recommendations: this.generateRecommendations()
                    };
                    
                    console.log('ğŸ“‹ PostMessage è¨ºæ–·å ±å‘Š:', report);
                    return report;
                }
                
                // ç”Ÿæˆå»ºè­°
                generateRecommendations() {
                    const recommendations = [];
                    
                    if (!this.diagnosticResults.environment.isInIframe) {
                        recommendations.push({
                            type: 'INFO',
                            message: 'ç›´æ¥è¨ªå•æ¨¡å¼ï¼šä½¿ç”¨ Safari åŸç”Ÿ APIï¼Œä¸éœ€è¦ PostMessage é€šä¿¡'
                        });
                    }
                    
                    if (this.diagnosticResults.environment.isIOS && this.diagnosticResults.environment.isSafari) {
                        recommendations.push({
                            type: 'WARNING',
                            message: 'iOS Safariï¼šç¢ºä¿å…¨è¢å¹•ç”±ç›´æ¥ç”¨æˆ¶æ‰‹å‹¢è§¸ç™¼'
                        });
                    }
                    
                    if (this.diagnosticResults.errors.some(e => e.code === 'CANNOT_ACCESS_PARENT')) {
                        recommendations.push({
                            type: 'ERROR',
                            message: 'è·¨åŸŸé™åˆ¶ï¼šæª¢æŸ¥ iframe å’Œçˆ¶é é¢çš„åŸŸåè¨­ç½®'
                        });
                    }
                    
                    if (!this.diagnosticResults.communication.parentResponse) {
                        recommendations.push({
                            type: 'ERROR',
                            message: 'çˆ¶é é¢ç„¡éŸ¿æ‡‰ï¼šæª¢æŸ¥ GameSwitcher çš„æ¶ˆæ¯ç›£è½å™¨'
                        });
                    }
                    
                    return recommendations;
                }
            }
            
            // åˆå§‹åŒ–è¨ºæ–·å·¥å…·
            let postMessageDiagnostic;
            
            function initPostMessageDiagnostic() {
                console.log('ğŸš€ åˆå§‹åŒ– PostMessage è¨ºæ–·å·¥å…·');
                postMessageDiagnostic = new PostMessageDiagnostic();
                
                // 5ç§’å¾Œç”Ÿæˆåˆå§‹å ±å‘Š
                setTimeout(() => {
                    const report = postMessageDiagnostic.generateReport();
                    console.log('ğŸ“‹ åˆå§‹è¨ºæ–·å ±å‘Šå·²ç”Ÿæˆ');
                }, 5000);
            }
            
            // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initPostMessageDiagnostic);
            } else {
                initPostMessageDiagnostic();
            }
        </script>
        <!-- PostMessage é€šä¿¡è¨ºæ–·å·¥å…·çµæŸ -->
        <!-- ğŸ Safari å…¨è¢å¹•æ”¯æ´ - SAFARI_FULLSCREEN_SUPPORT -->
        <script>
            console.log('ğŸ è¼‰å…¥ Safari å…¨è¢å¹•æ”¯æ´');
            
            // è·¨ç€è¦½å™¨å…¨è¢å¹• API å…¼å®¹æ€§å‡½æ•¸
            function createCrossBrowserFullscreenAPI() {
                console.log('ğŸ”§ å‰µå»ºè·¨ç€è¦½å™¨å…¨è¢å¹• API');
                
                // æª¢æ¸¬ç€è¦½å™¨é¡å‹
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                const isWebKit = 'webkitRequestFullscreen' in document.documentElement;
                
                console.log('ğŸ” ç€è¦½å™¨æª¢æ¸¬:', {
                    isIOS: isIOS,
                    isSafari: isSafari,
                    isWebKit: isWebKit,
                    userAgent: navigator.userAgent
                });
                
                // è·¨ç€è¦½å™¨è«‹æ±‚å…¨è¢å¹•å‡½æ•¸
                window.requestFullscreenCrossBrowser = function(element = document.documentElement) {
                    console.log('ğŸ“± åŸ·è¡Œè·¨ç€è¦½å™¨å…¨è¢å¹•è«‹æ±‚');
                    
                    return new Promise((resolve, reject) => {
                        try {
                            // æ¨™æº– Fullscreen API
                            if (element.requestFullscreen) {
                                console.log('âœ… ä½¿ç”¨æ¨™æº– requestFullscreen');
                                element.requestFullscreen().then(resolve).catch(reject);
                            }
                            // WebKit (Safari)
                            else if (element.webkitRequestFullscreen) {
                                console.log('ğŸ ä½¿ç”¨ WebKit webkitRequestFullscreen');
                                element.webkitRequestFullscreen();
                                resolve();
                            }
                            // WebKit (èˆŠç‰ˆ)
                            else if (element.webkitRequestFullScreen) {
                                console.log('ğŸ ä½¿ç”¨èˆŠç‰ˆ WebKit webkitRequestFullScreen');
                                element.webkitRequestFullScreen();
                                resolve();
                            }
                            // Mozilla
                            else if (element.mozRequestFullScreen) {
                                console.log('ğŸ¦Š ä½¿ç”¨ Mozilla mozRequestFullScreen');
                                element.mozRequestFullScreen();
                                resolve();
                            }
                            // Microsoft
                            else if (element.msRequestFullscreen) {
                                console.log('ğŸªŸ ä½¿ç”¨ Microsoft msRequestFullscreen');
                                element.msRequestFullscreen();
                                resolve();
                            }
                            // iOS Safari ç‰¹æ®Šè™•ç†
                            else if (isIOS) {
                                console.log('ğŸ“± iOS Safari ç‰¹æ®Šè™•ç†');
                                // iOS Safari ä¸æ”¯æ´çœŸæ­£çš„å…¨è¢å¹•ï¼Œä½¿ç”¨ CSS æ¨¡æ“¬
                                document.body.classList.add('ios-fullscreen-simulation');
                                resolve();
                            }
                            else {
                                console.log('âŒ ç€è¦½å™¨ä¸æ”¯æ´å…¨è¢å¹• API');
                                reject(new Error('Fullscreen not supported'));
                            }
                        } catch (error) {
                            console.log('âŒ å…¨è¢å¹•è«‹æ±‚å¤±æ•—:', error);
                            reject(error);
                        }
                    });
                };
                
                // è·¨ç€è¦½å™¨é€€å‡ºå…¨è¢å¹•å‡½æ•¸
                window.exitFullscreenCrossBrowser = function() {
                    console.log('ğŸ“± åŸ·è¡Œè·¨ç€è¦½å™¨é€€å‡ºå…¨è¢å¹•');
                    
                    return new Promise((resolve, reject) => {
                        try {
                            // æ¨™æº– Fullscreen API
                            if (document.exitFullscreen) {
                                console.log('âœ… ä½¿ç”¨æ¨™æº– exitFullscreen');
                                document.exitFullscreen().then(resolve).catch(reject);
                            }
                            // WebKit (Safari)
                            else if (document.webkitExitFullscreen) {
                                console.log('ğŸ ä½¿ç”¨ WebKit webkitExitFullscreen');
                                document.webkitExitFullscreen();
                                resolve();
                            }
                            // WebKit (èˆŠç‰ˆ)
                            else if (document.webkitCancelFullScreen) {
                                console.log('ğŸ ä½¿ç”¨èˆŠç‰ˆ WebKit webkitCancelFullScreen');
                                document.webkitCancelFullScreen();
                                resolve();
                            }
                            // Mozilla
                            else if (document.mozCancelFullScreen) {
                                console.log('ğŸ¦Š ä½¿ç”¨ Mozilla mozCancelFullScreen');
                                document.mozCancelFullScreen();
                                resolve();
                            }
                            // Microsoft
                            else if (document.msExitFullscreen) {
                                console.log('ğŸªŸ ä½¿ç”¨ Microsoft msExitFullscreen');
                                document.msExitFullscreen();
                                resolve();
                            }
                            // iOS Safari ç‰¹æ®Šè™•ç†
                            else if (isIOS) {
                                console.log('ğŸ“± iOS Safari é€€å‡ºæ¨¡æ“¬å…¨è¢å¹•');
                                document.body.classList.remove('ios-fullscreen-simulation');
                                resolve();
                            }
                            else {
                                console.log('âŒ ç€è¦½å™¨ä¸æ”¯æ´é€€å‡ºå…¨è¢å¹•');
                                reject(new Error('Exit fullscreen not supported'));
                            }
                        } catch (error) {
                            console.log('âŒ é€€å‡ºå…¨è¢å¹•å¤±æ•—:', error);
                            reject(error);
                        }
                    });
                };
                
                // è·¨ç€è¦½å™¨æª¢æŸ¥å…¨è¢å¹•ç‹€æ…‹å‡½æ•¸
                window.isFullscreenCrossBrowser = function() {
                    const fullscreenElement = document.fullscreenElement ||
                                            document.webkitFullscreenElement ||
                                            document.webkitCurrentFullScreenElement ||
                                            document.mozFullScreenElement ||
                                            document.msFullscreenElement;
                    
                    const isIOSSimulation = document.body.classList.contains('ios-fullscreen-simulation');
                    
                    return !!(fullscreenElement || isIOSSimulation);
                };
                
                console.log('âœ… è·¨ç€è¦½å™¨å…¨è¢å¹• API å·²å‰µå»º');
            }
            
            // ç‚º iOS Safari æ·»åŠ  CSS æ¨¡æ“¬å…¨è¢å¹•æ¨£å¼
            function addIOSFullscreenStyles() {
                console.log('ğŸ“± æ·»åŠ  iOS Safari å…¨è¢å¹•æ¨¡æ“¬æ¨£å¼');
                
                let style = document.getElementById('ios-fullscreen-style');
                if (!style) {
                    style = document.createElement('style');
                    style.id = 'ios-fullscreen-style';
                    style.textContent = `
                        /* iOS Safari å…¨è¢å¹•æ¨¡æ“¬ */
                        body.ios-fullscreen-simulation {
                            position: fixed !important;
                            top: 0 !important;
                            left: 0 !important;
                            width: 100vw !important;
                            height: 100vh !important;
                            height: 100dvh !important;
                            margin: 0 !important;
                            padding: 0 !important;
                            overflow: hidden !important;
                            background: black !important;
                            z-index: 2147483647 !important;
                        }
                        
                        body.ios-fullscreen-simulation #app {
                            width: 100vw !important;
                            height: 100vh !important;
                            height: 100dvh !important;
                        }
                        
                        body.ios-fullscreen-simulation #game-container {
                            width: 100% !important;
                            height: 100% !important;
                            max-width: none !important;
                            max-height: none !important;
                        }
                        
                        /* éš±è— iOS Safari åœ°å€æ¬„ */
                        @supports (-webkit-touch-callout: none) {
                            body.ios-fullscreen-simulation {
                                height: -webkit-fill-available !important;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                    console.log('âœ… iOS Safari å…¨è¢å¹•æ¨¡æ“¬æ¨£å¼å·²æ·»åŠ ');
                }
            }
            
            // ä¿®æ”¹åŸå§‹çš„ toggleFullscreen æ–¹æ³•ä»¥æ”¯æ´ Safari
            function enhanceToggleFullscreenForSafari() {
                console.log('ğŸ”§ å¢å¼· toggleFullscreen æ–¹æ³•ä»¥æ”¯æ´ Safari');
                
                // ç­‰å¾… TouchControls è¼‰å…¥
                const waitForTouchControls = () => {
                    return new Promise((resolve) => {
                        const check = () => {
                            if (window.touchControls && window.touchControls.toggleFullscreen) {
                                resolve();
                            } else {
                                setTimeout(check, 100);
                            }
                        };
                        check();
                    });
                };
                
                waitForTouchControls().then(() => {
                    console.log('ğŸ”§ é–‹å§‹å¢å¼· TouchControls çš„ Safari æ”¯æ´');
                    
                    // ä¿å­˜ç•¶å‰çš„ toggleFullscreen æ–¹æ³•
                    const originalToggleFullscreen = window.touchControls.toggleFullscreen;
                    
                    // æ›¿æ›ç‚º Safari å…¼å®¹ç‰ˆæœ¬
                    window.touchControls.toggleFullscreen = async function() {
                        console.log('ğŸ åŸ·è¡Œ Safari å…¼å®¹å…¨è¢å¹•åˆ‡æ›');
                        
                        try {
                            const isCurrentlyFullscreen = window.isFullscreenCrossBrowser();
                            
                            if (!isCurrentlyFullscreen) {
                                console.log('ğŸ“± é€²å…¥ Safari å…¼å®¹å…¨è¢å¹•æ¨¡å¼');
                                
                                // ä½¿ç”¨è·¨ç€è¦½å™¨ API
                                await window.requestFullscreenCrossBrowser();
                                
                                // ç­‰å¾…ç‹€æ…‹ç©©å®š
                                await new Promise(resolve => setTimeout(resolve, 300));
                                
                                // é‡æ–°è¨ˆç®—åº§æ¨™
                                if (this.recalculateCoordinates) {
                                    this.recalculateCoordinates();
                                }
                                
                                // è§¸ç™¼ resize äº‹ä»¶
                                window.dispatchEvent(new Event('resize'));
                                
                                // å¦‚æœæœ‰ Phaser éŠæˆ²ï¼Œåˆ·æ–° scale
                                if (window.game && window.game.scale) {
                                    setTimeout(() => {
                                        window.game.scale.refresh();
                                        console.log('ğŸ® Phaser éŠæˆ² scale å·²åˆ·æ–°');
                                    }, 100);
                                }
                                
                                console.log('âœ… Safari å…¼å®¹å…¨è¢å¹•å·²å•Ÿç”¨');
                                
                            } else {
                                console.log('ğŸ“± é€€å‡º Safari å…¼å®¹å…¨è¢å¹•æ¨¡å¼');
                                
                                await window.exitFullscreenCrossBrowser();
                                
                                // ç­‰å¾…é€€å‡ºç‹€æ…‹ç©©å®š
                                await new Promise(resolve => setTimeout(resolve, 300));
                                
                                // é‡æ–°è¨ˆç®—åº§æ¨™
                                if (this.recalculateCoordinates) {
                                    this.recalculateCoordinates();
                                }
                                
                                // è§¸ç™¼ resize äº‹ä»¶
                                window.dispatchEvent(new Event('resize'));
                                
                                // åˆ·æ–° Phaser scale
                                if (window.game && window.game.scale) {
                                    setTimeout(() => {
                                        window.game.scale.refresh();
                                        console.log('ğŸ® Phaser éŠæˆ² scale å·²åˆ·æ–°');
                                    }, 100);
                                }
                                
                                console.log('âœ… å·²é€€å‡º Safari å…¼å®¹å…¨è¢å¹•');
                            }
                            
                        } catch (error) {
                            console.log('âŒ Safari å…¼å®¹å…¨è¢å¹•åˆ‡æ›å¤±æ•—:', error);
                            // å›é€€åˆ°åŸå§‹æ–¹æ³•
                            if (originalToggleFullscreen) {
                                originalToggleFullscreen.call(this);
                            }
                        }
                    };
                    
                    console.log('âœ… TouchControls Safari æ”¯æ´å¢å¼·å®Œæˆ');
                });
            }
            
            // åˆå§‹åŒ– Safari æ”¯æ´
            function initSafariFullscreenSupport() {
                console.log('ğŸš€ åˆå§‹åŒ– Safari å…¨è¢å¹•æ”¯æ´');
                
                // å‰µå»ºè·¨ç€è¦½å™¨ API
                createCrossBrowserFullscreenAPI();
                
                // æ·»åŠ  iOS æ¨£å¼
                addIOSFullscreenStyles();
                
                // å¢å¼· toggleFullscreen æ–¹æ³•
                enhanceToggleFullscreenForSafari();
                
                console.log('âœ… Safari å…¨è¢å¹•æ”¯æ´åˆå§‹åŒ–å®Œæˆ');
                
                // æ·»åŠ æ¸¬è©¦å‡½æ•¸
                window.testSafariFullscreen = function() {
                    console.log('ğŸ§ª æ¸¬è©¦ Safari å…¨è¢å¹•æ”¯æ´');
                    
                    const support = {
                        standardAPI: !!document.documentElement.requestFullscreen,
                        webkitAPI: !!document.documentElement.webkitRequestFullscreen,
                        oldWebkitAPI: !!document.documentElement.webkitRequestFullScreen,
                        mozAPI: !!document.documentElement.mozRequestFullScreen,
                        msAPI: !!document.documentElement.msRequestFullscreen,
                        isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
                        isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
                        currentFullscreen: window.isFullscreenCrossBrowser()
                    };
                    
                    console.log('ğŸ Safari å…¨è¢å¹•æ”¯æ´ç‹€æ…‹:', support);
                    return support;
                };
            }
            
            // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initSafariFullscreenSupport);
            } else {
                initSafariFullscreenSupport();
            }
        </script>
        <!-- Safari å…¨è¢å¹•æ”¯æ´çµæŸ -->
        <!-- ğŸ¯ é›™é‡å…¨è¢å¹•åŒæ­¥åŠŸèƒ½ - DUAL_FULLSCREEN_SYNC -->
        <script>
            console.log('ğŸ¯ è¼‰å…¥é›™é‡å…¨è¢å¹•åŒæ­¥åŠŸèƒ½');
            
            // ç­‰å¾… TouchControls å’Œåº§æ¨™åŒæ­¥è¼‰å…¥å®Œæˆ
            function waitForEnhancedTouchControls() {
                return new Promise((resolve) => {
                    const checkEnhanced = () => {
                        if (window.touchControls && 
                            window.touchControls.toggleFullscreen && 
                            window.touchControls.recalculateCoordinates) {
                            resolve();
                        } else {
                            setTimeout(checkEnhanced, 100);
                        }
                    };
                    checkEnhanced();
                });
            }
            
            // å¯¦ç¾é›™é‡å…¨è¢å¹•åŒæ­¥
            async function implementDualFullscreenSync() {
                await waitForEnhancedTouchControls();
                
                console.log('ğŸ”§ é–‹å§‹å¯¦ç¾é›™é‡å…¨è¢å¹•åŒæ­¥');
                
                // ä¿å­˜ç•¶å‰çš„åº§æ¨™åŒæ­¥ç‰ˆæœ¬
                const coordinateSyncToggleFullscreen = window.touchControls.toggleFullscreen;
                
                // æ›¿æ›ç‚ºé›™é‡åŒæ­¥ç‰ˆæœ¬
                window.touchControls.toggleFullscreen = async function() {
                    console.log('ğŸ¯ åŸ·è¡Œé›™é‡å…¨è¢å¹•åŒæ­¥åˆ‡æ›');
                    
                    try {
                        const isCurrentlyFullscreen = !!document.fullscreenElement;
                        const isInIframe = window !== window.parent;
                        
                        if (!isCurrentlyFullscreen) {
                            // é€²å…¥å…¨è¢å¹•
                            console.log('ğŸ“± é€²å…¥é›™é‡å…¨è¢å¹•æ¨¡å¼');
                            
                            // 1. è§¸ç™¼åŸç”Ÿ Fullscreen APIï¼ˆåº§æ¨™åŒæ­¥ç‰ˆæœ¬ï¼‰
                            await coordinateSyncToggleFullscreen.call(this);
                            
                            // 2. å¦‚æœåœ¨ iframe ä¸­ï¼Œé€šçŸ¥çˆ¶é é¢è§¸ç™¼ CSS å¼·åˆ¶å…¨è¢å¹•
                            if (isInIframe) {
                                console.log('ğŸ“¤ é€šçŸ¥çˆ¶é é¢è§¸ç™¼ CSS å¼·åˆ¶å…¨è¢å¹•');
                                window.parent.postMessage({
                                    type: 'DUAL_FULLSCREEN_REQUEST',
                                    action: 'ENTER_CSS_FULLSCREEN',
                                    timestamp: Date.now()
                                }, '*');
                            }
                            
                            // 3. ç­‰å¾…çˆ¶é é¢éŸ¿æ‡‰
                            await new Promise(resolve => setTimeout(resolve, 200));
                            
                            console.log('âœ… é›™é‡å…¨è¢å¹•ï¼ˆåŸç”Ÿ + CSSï¼‰å·²å•Ÿç”¨');
                            
                        } else {
                            // é€€å‡ºå…¨è¢å¹•
                            console.log('ğŸ“± é€€å‡ºé›™é‡å…¨è¢å¹•æ¨¡å¼');
                            
                            // 1. å¦‚æœåœ¨ iframe ä¸­ï¼Œé€šçŸ¥çˆ¶é é¢é€€å‡º CSS å¼·åˆ¶å…¨è¢å¹•
                            if (isInIframe) {
                                console.log('ğŸ“¤ é€šçŸ¥çˆ¶é é¢é€€å‡º CSS å¼·åˆ¶å…¨è¢å¹•');
                                window.parent.postMessage({
                                    type: 'DUAL_FULLSCREEN_REQUEST',
                                    action: 'EXIT_CSS_FULLSCREEN',
                                    timestamp: Date.now()
                                }, '*');
                            }
                            
                            // 2. è§¸ç™¼åŸç”Ÿ Fullscreen API é€€å‡ºï¼ˆåº§æ¨™åŒæ­¥ç‰ˆæœ¬ï¼‰
                            await coordinateSyncToggleFullscreen.call(this);
                            
                            console.log('âœ… é›™é‡å…¨è¢å¹•å·²é€€å‡º');
                        }
                        
                    } catch (error) {
                        console.log('âŒ é›™é‡å…¨è¢å¹•åŒæ­¥å¤±æ•—:', error);
                        // å›é€€åˆ°åº§æ¨™åŒæ­¥ç‰ˆæœ¬
                        coordinateSyncToggleFullscreen.call(this);
                    }
                };
                
                // ç›£è½ä¾†è‡ªçˆ¶é é¢çš„éŸ¿æ‡‰
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'DUAL_FULLSCREEN_RESPONSE') {
                        console.log('ğŸ“¥ æ”¶åˆ°çˆ¶é é¢éŸ¿æ‡‰:', event.data);
                        
                        switch (event.data.action) {
                            case 'CSS_FULLSCREEN_ENABLED':
                                console.log('âœ… çˆ¶é é¢ CSS å¼·åˆ¶å…¨è¢å¹•å·²å•Ÿç”¨');
                                break;
                            case 'CSS_FULLSCREEN_DISABLED':
                                console.log('âœ… çˆ¶é é¢ CSS å¼·åˆ¶å…¨è¢å¹•å·²åœç”¨');
                                break;
                            case 'CSS_FULLSCREEN_ERROR':
                                console.log('âŒ çˆ¶é é¢ CSS å¼·åˆ¶å…¨è¢å¹•éŒ¯èª¤:', event.data.error);
                                break;
                        }
                    }
                });
                
                console.log('âœ… é›™é‡å…¨è¢å¹•åŒæ­¥åŠŸèƒ½å¯¦ç¾å®Œæˆ');
                
                // æ·»åŠ æ¸¬è©¦å‡½æ•¸
                window.testDualFullscreen = function() {
                    console.log('ğŸ§ª æ¸¬è©¦é›™é‡å…¨è¢å¹•åŠŸèƒ½');
                    
                    const status = {
                        isInIframe: window !== window.parent,
                        nativeFullscreen: !!document.fullscreenElement,
                        viewport: {
                            width: window.innerWidth,
                            height: window.innerHeight
                        },
                        touchControls: !!window.touchControls,
                        dualSyncEnabled: true
                    };
                    
                    console.log('ğŸ“Š é›™é‡å…¨è¢å¹•ç‹€æ…‹:', status);
                    return status;
                };
                
                // æ·»åŠ å¼·åˆ¶åŒæ­¥å‡½æ•¸
                window.forceDualFullscreenSync = async function() {
                    console.log('ğŸ”§ å¼·åˆ¶åŸ·è¡Œé›™é‡å…¨è¢å¹•åŒæ­¥');
                    
                    if (window.touchControls && window.touchControls.toggleFullscreen) {
                        await window.touchControls.toggleFullscreen();
                    }
                    
                    console.log('âœ… å¼·åˆ¶åŒæ­¥å®Œæˆ');
                };
            }
            
            // é é¢è¼‰å…¥å®Œæˆå¾Œå¯¦ç¾é›™é‡åŒæ­¥
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', implementDualFullscreenSync);
            } else {
                implementDualFullscreenSync();
            }
        </script>
        <!-- é›™é‡å…¨è¢å¹•åŒæ­¥åŠŸèƒ½çµæŸ -->
        <!-- ğŸ”§ Safari æ•´åˆé †åºä¿®å¾© - SAFARI_INTEGRATION_ORDER_FIXED -->
        <script>
            console.log('ğŸ”§ è¼‰å…¥ Safari æ•´åˆé †åºä¿®å¾©');
            
            // ç­‰å¾…æ‰€æœ‰æ”¯æ´è¼‰å…¥å®Œæˆå¾Œä¿®å¾©æ•´åˆé †åº
            function fixSafariIntegrationOrder() {
                console.log('ğŸš€ é–‹å§‹ä¿®å¾© Safari æ•´åˆé †åº');
                
                // ç­‰å¾…æ‰€æœ‰åŠŸèƒ½è¼‰å…¥
                const waitForAllFeatures = () => {
                    return new Promise((resolve) => {
                        const checkFeatures = () => {
                            const hasBasicTouchControls = window.touchControls && window.touchControls.toggleFullscreen;
                            const hasSafariSupport = window.requestFullscreenCrossBrowser && window.testSafariFullscreen;
                            const hasCoordinateSync = hasBasicTouchControls; // åº§æ¨™åŒæ­¥å·²æ•´åˆåˆ° TouchControls
                            
                            if (hasBasicTouchControls && hasSafariSupport && hasCoordinateSync) {
                                resolve();
                            } else {
                                setTimeout(checkFeatures, 100);
                            }
                        };
                        checkFeatures();
                    });
                };
                
                waitForAllFeatures().then(() => {
                    console.log('âœ… æ‰€æœ‰åŠŸèƒ½å·²è¼‰å…¥ï¼Œé–‹å§‹ä¿®å¾©æ•´åˆé †åº');
                    
                    // ä¿å­˜ç•¶å‰çš„å„å€‹ç‰ˆæœ¬
                    const originalToggleFullscreen = window.touchControls.toggleFullscreen;
                    const safariCrossBrowserAPI = window.requestFullscreenCrossBrowser;
                    const safariExitAPI = window.exitFullscreenCrossBrowser;
                    const safariStateCheck = window.isFullscreenCrossBrowser;
                    
                    console.log('ğŸ”§ å‰µå»º Safari å¢å¼·çš„åº§æ¨™åŒæ­¥ç‰ˆæœ¬');
                    
                    // å‰µå»º Safari å¢å¼·çš„åº§æ¨™åŒæ­¥ç‰ˆæœ¬
                    const safariEnhancedCoordinateSync = async function() {
                        console.log('ğŸ åŸ·è¡Œ Safari å¢å¼·çš„åº§æ¨™åŒæ­¥å…¨è¢å¹•åˆ‡æ›');
                        
                        try {
                            const isCurrentlyFullscreen = safariStateCheck ? safariStateCheck() : !!document.fullscreenElement;
                            
                            if (!isCurrentlyFullscreen) {
                                console.log('ğŸ“± é€²å…¥ Safari å¢å¼·å…¨è¢å¹•æ¨¡å¼');
                                
                                // 1. ä½¿ç”¨ Safari å…¼å®¹çš„è·¨ç€è¦½å™¨ API
                                if (safariCrossBrowserAPI) {
                                    await safariCrossBrowserAPI();
                                    console.log('âœ… Safari å…¼å®¹å…¨è¢å¹•å·²è§¸ç™¼');
                                } else {
                                    // å›é€€åˆ°æ¨™æº– API
                                    await document.documentElement.requestFullscreen();
                                    console.log('âœ… æ¨™æº–å…¨è¢å¹•å·²è§¸ç™¼ï¼ˆå›é€€ï¼‰');
                                }
                                
                                // 2. ç­‰å¾…å…¨è¢å¹•ç‹€æ…‹ç©©å®š
                                await new Promise(resolve => setTimeout(resolve, 300));
                                
                                // 3. é‡æ–°è¨ˆç®—åº§æ¨™
                                if (this.recalculateCoordinates) {
                                    this.recalculateCoordinates();
                                    console.log('ğŸ“ åº§æ¨™å·²é‡æ–°è¨ˆç®—');
                                }
                                
                                // 4. è§¸ç™¼ resize äº‹ä»¶è®“ Phaser é‡æ–°è¨ˆç®—
                                window.dispatchEvent(new Event('resize'));
                                
                                // 5. åˆ·æ–° Phaser scale
                                if (window.game && window.game.scale) {
                                    setTimeout(() => {
                                        window.game.scale.refresh();
                                        console.log('ğŸ® Phaser éŠæˆ² scale å·²åˆ·æ–°');
                                    }, 100);
                                }
                                
                                console.log('âœ… Safari å¢å¼·å…¨è¢å¹•å·²å®Œæˆ');
                                
                            } else {
                                console.log('ğŸ“± é€€å‡º Safari å¢å¼·å…¨è¢å¹•æ¨¡å¼');
                                
                                // ä½¿ç”¨ Safari å…¼å®¹çš„é€€å‡º API
                                if (safariExitAPI) {
                                    await safariExitAPI();
                                    console.log('âœ… Safari å…¼å®¹é€€å‡ºå…¨è¢å¹•å·²è§¸ç™¼');
                                } else {
                                    // å›é€€åˆ°æ¨™æº– API
                                    await document.exitFullscreen();
                                    console.log('âœ… æ¨™æº–é€€å‡ºå…¨è¢å¹•å·²è§¸ç™¼ï¼ˆå›é€€ï¼‰');
                                }
                                
                                // ç­‰å¾…é€€å‡ºç‹€æ…‹ç©©å®š
                                await new Promise(resolve => setTimeout(resolve, 300));
                                
                                // é‡æ–°è¨ˆç®—åº§æ¨™
                                if (this.recalculateCoordinates) {
                                    this.recalculateCoordinates();
                                    console.log('ğŸ“ åº§æ¨™å·²é‡æ–°è¨ˆç®—');
                                }
                                
                                // è§¸ç™¼ resize äº‹ä»¶
                                window.dispatchEvent(new Event('resize'));
                                
                                // åˆ·æ–° Phaser scale
                                if (window.game && window.game.scale) {
                                    setTimeout(() => {
                                        window.game.scale.refresh();
                                        console.log('ğŸ® Phaser éŠæˆ² scale å·²åˆ·æ–°');
                                    }, 100);
                                }
                                
                                console.log('âœ… å·²é€€å‡º Safari å¢å¼·å…¨è¢å¹•');
                            }
                            
                        } catch (error) {
                            console.log('âŒ Safari å¢å¼·å…¨è¢å¹•åˆ‡æ›å¤±æ•—:', error);
                            
                            // å›é€€åˆ°åŸå§‹æ–¹æ³•
                            if (originalToggleFullscreen) {
                                console.log('ğŸ”„ å›é€€åˆ°åŸå§‹å…¨è¢å¹•æ–¹æ³•');
                                originalToggleFullscreen.call(this);
                            }
                        }
                    };
                    
                    console.log('ğŸ”§ æ›´æ–°é›™é‡åŒæ­¥ä»¥ä½¿ç”¨ Safari å¢å¼·ç‰ˆæœ¬');
                    
                    // æ‰¾åˆ°ä¸¦æ›´æ–°é›™é‡åŒæ­¥å‡½æ•¸
                    if (window.touchControls && typeof window.touchControls.toggleFullscreen === 'function') {
                        // æª¢æŸ¥æ˜¯å¦æ˜¯é›™é‡åŒæ­¥ç‰ˆæœ¬
                        const currentFunction = window.touchControls.toggleFullscreen.toString();
                        
                        if (currentFunction.includes('é›™é‡å…¨è¢å¹•åŒæ­¥åˆ‡æ›')) {
                            console.log('ğŸ”§ ç™¼ç¾é›™é‡åŒæ­¥ç‰ˆæœ¬ï¼Œé€²è¡Œ Safari å¢å¼·');
                            
                            // ä¿å­˜ç•¶å‰é›™é‡åŒæ­¥ç‰ˆæœ¬
                            const currentDualSync = window.touchControls.toggleFullscreen;
                            
                            // å‰µå»º Safari å¢å¼·çš„é›™é‡åŒæ­¥ç‰ˆæœ¬
                            window.touchControls.toggleFullscreen = async function() {
                                console.log('ğŸğŸ¯ åŸ·è¡Œ Safari å¢å¼·çš„é›™é‡å…¨è¢å¹•åŒæ­¥åˆ‡æ›');
                                
                                try {
                                    const isCurrentlyFullscreen = safariStateCheck ? safariStateCheck() : !!document.fullscreenElement;
                                    const isInIframe = window !== window.parent;
                                    
                                    if (!isCurrentlyFullscreen) {
                                        console.log('ğŸ“± é€²å…¥ Safari å¢å¼·é›™é‡å…¨è¢å¹•æ¨¡å¼');
                                        
                                        // 1. è§¸ç™¼ Safari å¢å¼·çš„åº§æ¨™åŒæ­¥ç‰ˆæœ¬
                                        await safariEnhancedCoordinateSync.call(this);
                                        
                                        // 2. å¦‚æœåœ¨ iframe ä¸­ï¼Œé€šçŸ¥çˆ¶é é¢è§¸ç™¼ CSS å¼·åˆ¶å…¨è¢å¹•
                                        if (isInIframe) {
                                            console.log('ğŸ“¤ é€šçŸ¥çˆ¶é é¢è§¸ç™¼ CSS å¼·åˆ¶å…¨è¢å¹•');
                                            window.parent.postMessage({
                                                type: 'DUAL_FULLSCREEN_REQUEST',
                                                action: 'ENTER_CSS_FULLSCREEN',
                                                timestamp: Date.now()
                                            }, '*');
                                        }
                                        
                                        // 3. ç­‰å¾…çˆ¶é é¢éŸ¿æ‡‰
                                        await new Promise(resolve => setTimeout(resolve, 200));
                                        
                                        console.log('âœ… Safari å¢å¼·é›™é‡å…¨è¢å¹•ï¼ˆåŸç”Ÿ + CSSï¼‰å·²å•Ÿç”¨');
                                        
                                    } else {
                                        console.log('ğŸ“± é€€å‡º Safari å¢å¼·é›™é‡å…¨è¢å¹•æ¨¡å¼');
                                        
                                        // 1. å¦‚æœåœ¨ iframe ä¸­ï¼Œé€šçŸ¥çˆ¶é é¢é€€å‡º CSS å¼·åˆ¶å…¨è¢å¹•
                                        if (isInIframe) {
                                            console.log('ğŸ“¤ é€šçŸ¥çˆ¶é é¢é€€å‡º CSS å¼·åˆ¶å…¨è¢å¹•');
                                            window.parent.postMessage({
                                                type: 'DUAL_FULLSCREEN_REQUEST',
                                                action: 'EXIT_CSS_FULLSCREEN',
                                                timestamp: Date.now()
                                            }, '*');
                                        }
                                        
                                        // 2. è§¸ç™¼ Safari å¢å¼·çš„åº§æ¨™åŒæ­¥é€€å‡º
                                        await safariEnhancedCoordinateSync.call(this);
                                        
                                        console.log('âœ… Safari å¢å¼·é›™é‡å…¨è¢å¹•å·²é€€å‡º');
                                    }
                                    
                                } catch (error) {
                                    console.log('âŒ Safari å¢å¼·é›™é‡å…¨è¢å¹•åŒæ­¥å¤±æ•—:', error);
                                    
                                    // å›é€€åˆ° Safari å¢å¼·åº§æ¨™åŒæ­¥ç‰ˆæœ¬
                                    console.log('ğŸ”„ å›é€€åˆ° Safari å¢å¼·åº§æ¨™åŒæ­¥ç‰ˆæœ¬');
                                    safariEnhancedCoordinateSync.call(this);
                                }
                            };
                            
                            console.log('âœ… é›™é‡åŒæ­¥å·²å‡ç´šç‚º Safari å¢å¼·ç‰ˆæœ¬');
                            
                        } else {
                            console.log('ğŸ”§ ç›´æ¥å‡ç´šç‚º Safari å¢å¼·åº§æ¨™åŒæ­¥ç‰ˆæœ¬');
                            
                            // ç›´æ¥æ›¿æ›ç‚º Safari å¢å¼·ç‰ˆæœ¬
                            window.touchControls.toggleFullscreen = safariEnhancedCoordinateSync;
                        }
                    }
                    
                    // æ·»åŠ æ¸¬è©¦å‡½æ•¸
                    window.testSafariIntegrationFix = function() {
                        console.log('ğŸ§ª æ¸¬è©¦ Safari æ•´åˆä¿®å¾©');
                        
                        const status = {
                            hasTouchControls: !!window.touchControls,
                            hasToggleFullscreen: !!(window.touchControls && window.touchControls.toggleFullscreen),
                            hasSafariSupport: !!window.requestFullscreenCrossBrowser,
                            hasCoordinateSync: !!(window.touchControls && window.touchControls.recalculateCoordinates),
                            integrationFixed: true,
                            currentFunction: window.touchControls ? window.touchControls.toggleFullscreen.toString().substring(0, 100) + '...' : 'N/A'
                        };
                        
                        console.log('ğŸ Safari æ•´åˆä¿®å¾©ç‹€æ…‹:', status);
                        return status;
                    };
                    
                    console.log('âœ… Safari æ•´åˆé †åºä¿®å¾©å®Œæˆ');
                    console.log('ğŸ¯ ä¿®å¾©å…§å®¹ï¼š');
                    console.log('   âœ… å‰µå»º Safari å¢å¼·çš„åº§æ¨™åŒæ­¥ç‰ˆæœ¬');
                    console.log('   âœ… é›™é‡åŒæ­¥ç¾åœ¨ä½¿ç”¨ Safari å¢å¼·ç‰ˆæœ¬');
                    console.log('   âœ… è·¨ç€è¦½å™¨ API æ­£ç¢ºæ•´åˆ');
                    console.log('   âœ… éŒ¯èª¤è™•ç†å’Œå›é€€æ©Ÿåˆ¶å®Œå–„');
                });
            }
            
            // é é¢è¼‰å…¥å®Œæˆå¾Œä¿®å¾©æ•´åˆé †åº
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', fixSafariIntegrationOrder);
            } else {
                // å»¶é²åŸ·è¡Œç¢ºä¿æ‰€æœ‰åŠŸèƒ½éƒ½å·²è¼‰å…¥
                setTimeout(fixSafariIntegrationOrder, 1000);
            }
        </script>
        <!-- Safari æ•´åˆé †åºä¿®å¾©çµæŸ -->
        <!-- ğŸ”§ PostMessage é€šä¿¡ä¿®å¾© - POSTMESSAGE_COMMUNICATION_FIXED -->
        <script>
            console.log('ğŸ”§ è¼‰å…¥ PostMessage é€šä¿¡ä¿®å¾©');
            
            // å¼·åŒ–çš„ PostMessage é€šä¿¡ä¿®å¾©ç³»çµ±
            function initPostMessageCommFix() {
                console.log('ğŸš€ åˆå§‹åŒ– PostMessage é€šä¿¡ä¿®å¾©ç³»çµ±');
                
                // é€šä¿¡ç‹€æ…‹ç®¡ç†
                window.postMessageCommStatus = {
                    initialized: false,
                    parentListenerActive: false,
                    communicationWorking: false,
                    lastTestTime: null,
                    retryCount: 0,
                    maxRetries: 10,
                    testResults: []
                };
                
                // å¼·åŒ–çš„çˆ¶é é¢ç›£è½å™¨è¨­ç½®
                window.setupParentListener = function() {
                    console.log('ğŸ“¡ è¨­ç½®å¼·åŒ–çš„çˆ¶é é¢ç›£è½å™¨');
                    
                    try {
                        // æª¢æŸ¥æ˜¯å¦åœ¨ iframe ä¸­
                        const isInIframe = window !== window.parent;
                        
                        if (!isInIframe) {
                            console.log('âš ï¸ ä¸åœ¨ iframe ä¸­ï¼Œè·³éçˆ¶é é¢ç›£è½å™¨è¨­ç½®');
                            return false;
                        }
                        
                        // å˜—è©¦é€šçŸ¥çˆ¶é é¢è¨­ç½®ç›£è½å™¨
                        const setupMessage = {
                            type: 'SETUP_PARENT_LISTENER',
                            timestamp: Date.now(),
                            userAgent: navigator.userAgent,
                            location: window.location.href
                        };
                        
                        console.log('ğŸ“¤ ç™¼é€çˆ¶é é¢ç›£è½å™¨è¨­ç½®è«‹æ±‚:', setupMessage);
                        window.parent.postMessage(setupMessage, '*');
                        
                        // ç­‰å¾…çˆ¶é é¢éŸ¿æ‡‰
                        return new Promise((resolve) => {
                            const timeout = setTimeout(() => {
                                console.log('â° çˆ¶é é¢ç›£è½å™¨è¨­ç½®è¶…æ™‚');
                                resolve(false);
                            }, 3000);
                            
                            const responseHandler = (event) => {
                                if (event.data && event.data.type === 'PARENT_LISTENER_READY') {
                                    console.log('âœ… çˆ¶é é¢ç›£è½å™¨å·²å°±ç·’');
                                    clearTimeout(timeout);
                                    window.removeEventListener('message', responseHandler);
                                    window.postMessageCommStatus.parentListenerActive = true;
                                    resolve(true);
                                }
                            };
                            
                            window.addEventListener('message', responseHandler);
                        });
                        
                    } catch (error) {
                        console.log('âŒ è¨­ç½®çˆ¶é é¢ç›£è½å™¨å¤±æ•—:', error);
                        return false;
                    }
                };
                
                // å¼·åŒ–çš„é€šä¿¡æ¸¬è©¦
                window.testPostMessageCommEnhanced = async function() {
                    console.log('ğŸ§ª åŸ·è¡Œå¼·åŒ–çš„ PostMessage é€šä¿¡æ¸¬è©¦');
                    
                    const testId = 'test_' + Date.now();
                    const testResult = {
                        testId: testId,
                        timestamp: Date.now(),
                        success: false,
                        error: null,
                        responseTime: null,
                        retryCount: window.postMessageCommStatus.retryCount
                    };
                    
                    try {
                        const isInIframe = window !== window.parent;
                        
                        if (!isInIframe) {
                            testResult.error = 'NOT_IN_IFRAME';
                            console.log('âš ï¸ ä¸åœ¨ iframe ç’°å¢ƒä¸­');
                            return testResult;
                        }
                        
                        // ç™¼é€æ¸¬è©¦æ¶ˆæ¯
                        const testMessage = {
                            type: 'COMMUNICATION_TEST',
                            testId: testId,
                            timestamp: Date.now(),
                            userAgent: navigator.userAgent,
                            isMobile: /Mobi|Android/i.test(navigator.userAgent),
                            isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
                            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent)
                        };
                        
                        console.log('ğŸ“¤ ç™¼é€å¼·åŒ–æ¸¬è©¦æ¶ˆæ¯:', testMessage);
                        
                        const startTime = Date.now();
                        window.parent.postMessage(testMessage, '*');
                        
                        // ç­‰å¾…éŸ¿æ‡‰
                        const response = await new Promise((resolve, reject) => {
                            const timeout = setTimeout(() => {
                                reject(new Error('COMMUNICATION_TIMEOUT'));
                            }, 5000);
                            
                            const responseHandler = (event) => {
                                if (event.data && 
                                    event.data.type === 'COMMUNICATION_TEST_RESPONSE' && 
                                    event.data.testId === testId) {
                                    
                                    clearTimeout(timeout);
                                    window.removeEventListener('message', responseHandler);
                                    resolve(event.data);
                                }
                            };
                            
                            window.addEventListener('message', responseHandler);
                        });
                        
                        testResult.success = true;
                        testResult.responseTime = Date.now() - startTime;
                        window.postMessageCommStatus.communicationWorking = true;
                        
                        console.log('âœ… å¼·åŒ–é€šä¿¡æ¸¬è©¦æˆåŠŸ:', response);
                        console.log('â±ï¸ éŸ¿æ‡‰æ™‚é–“:', testResult.responseTime + 'ms');
                        
                    } catch (error) {
                        testResult.error = error.message;
                        console.log('âŒ å¼·åŒ–é€šä¿¡æ¸¬è©¦å¤±æ•—:', error);
                    }
                    
                    window.postMessageCommStatus.testResults.push(testResult);
                    window.postMessageCommStatus.lastTestTime = Date.now();
                    
                    return testResult;
                };
                
                // è‡ªå‹•é‡è©¦é€šä¿¡å»ºç«‹
                window.autoRetryCommSetup = async function() {
                    console.log('ğŸ”„ è‡ªå‹•é‡è©¦é€šä¿¡å»ºç«‹');
                    
                    while (window.postMessageCommStatus.retryCount < window.postMessageCommStatus.maxRetries) {
                        console.log(`ğŸ”„ é‡è©¦ ${window.postMessageCommStatus.retryCount + 1}/${window.postMessageCommStatus.maxRetries}`);
                        
                        // 1. è¨­ç½®çˆ¶é é¢ç›£è½å™¨
                        const listenerSetup = await window.setupParentListener();
                        
                        if (listenerSetup) {
                            // 2. æ¸¬è©¦é€šä¿¡
                            const testResult = await window.testPostMessageCommEnhanced();
                            
                            if (testResult.success) {
                                console.log('âœ… é€šä¿¡å»ºç«‹æˆåŠŸï¼');
                                return true;
                            }
                        }
                        
                        window.postMessageCommStatus.retryCount++;
                        
                        // ç­‰å¾…å¾Œé‡è©¦
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                    
                    console.log('âŒ é€šä¿¡å»ºç«‹å¤±æ•—ï¼Œå·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸');
                    return false;
                };
                
                // å¼·åŒ–çš„å…¨è¢å¹•è«‹æ±‚ï¼ˆä½¿ç”¨ä¿®å¾©å¾Œçš„é€šä¿¡ï¼‰
                window.requestFullscreenWithCommFix = async function() {
                    console.log('ğŸ ä½¿ç”¨ä¿®å¾©å¾Œçš„é€šä¿¡è«‹æ±‚å…¨è¢å¹•');

                    try {
                        // ç¢ºä¿é€šä¿¡æ­£å¸¸
                        if (!window.postMessageCommStatus.communicationWorking) {
                            console.log('ğŸ”„ é€šä¿¡æœªå»ºç«‹ï¼Œå˜—è©¦è‡ªå‹•ä¿®å¾©');
                            const commFixed = await window.autoRetryCommSetup();

                            if (!commFixed) {
                                console.log('âŒ é€šä¿¡ä¿®å¾©å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å…¨è¢å¹•');
                                // å›é€€åˆ°æœ¬åœ°å…¨è¢å¹•
                                if (window.touchControls && window.touchControls.toggleFullscreen) {
                                    window.touchControls.toggleFullscreen();
                                }
                                return;
                            }
                        }

                        // ç™¼é€å…¨è¢å¹•è«‹æ±‚
                        const fullscreenMessage = {
                            type: 'DUAL_FULLSCREEN_REQUEST',
                            action: 'ENTER_CSS_FULLSCREEN',
                            timestamp: Date.now(),
                            enhanced: true,
                            userAgent: navigator.userAgent
                        };

                        console.log('ğŸ“¤ ç™¼é€å¼·åŒ–å…¨è¢å¹•è«‹æ±‚:', fullscreenMessage);
                        window.parent.postMessage(fullscreenMessage, '*');

                        // åŒæ™‚è§¸ç™¼æœ¬åœ°å…¨è¢å¹•
                        if (window.touchControls && window.touchControls.toggleFullscreen) {
                            // ä½¿ç”¨ Safari å¢å¼·ç‰ˆæœ¬
                            window.touchControls.toggleFullscreen();
                        }

                        console.log('âœ… å¼·åŒ–å…¨è¢å¹•è«‹æ±‚å·²ç™¼é€');

                    } catch (error) {
                        console.log('âŒ å¼·åŒ–å…¨è¢å¹•è«‹æ±‚å¤±æ•—:', error);

                        // å›é€€åˆ°æœ¬åœ°å…¨è¢å¹•
                        if (window.touchControls && window.touchControls.toggleFullscreen) {
                            window.touchControls.toggleFullscreen();
                        }
                    }
                };

                // ğŸ”§ ä¿®å¾©éŠæˆ²å…§å…¨è¢å¹•æŒ‰éˆ•é€£æ¥
                function fixGameFullscreenButton() {
                    console.log('ğŸ”§ ä¿®å¾©éŠæˆ²å…§å…¨è¢å¹•æŒ‰éˆ•é€£æ¥');

                    // ç­‰å¾… TouchControls è¼‰å…¥
                    const waitForTouchControls = () => {
                        return new Promise((resolve) => {
                            const check = () => {
                                if (window.touchControls && window.touchControls.toggleFullscreen) {
                                    resolve();
                                } else {
                                    setTimeout(check, 100);
                                }
                            };
                            check();
                        });
                    };

                    waitForTouchControls().then(() => {
                        console.log('ğŸ¯ é–‹å§‹ä¿®å¾©éŠæˆ²å…§å…¨è¢å¹•æŒ‰éˆ•');

                        // ä¿å­˜åŸå§‹çš„ toggleFullscreen æ–¹æ³•
                        const originalToggleFullscreen = window.touchControls.toggleFullscreen;

                        // æ›¿æ›ç‚ºä½¿ç”¨ä¿®å¾©å¾Œé€šä¿¡çš„ç‰ˆæœ¬
                        window.touchControls.toggleFullscreen = async function() {
                            console.log('ğŸ® éŠæˆ²å…§å…¨è¢å¹•æŒ‰éˆ•è¢«é»æ“Š - ä½¿ç”¨ä¿®å¾©å¾Œçš„é€šä¿¡');

                            try {
                                // æª¢æŸ¥æ˜¯å¦åœ¨ iframe ä¸­
                                const isInIframe = window !== window.parent;

                                if (isInIframe) {
                                    console.log('ğŸ“± åœ¨ iframe ä¸­ï¼Œä½¿ç”¨ä¿®å¾©å¾Œçš„ PostMessage é€šä¿¡');

                                    // ä½¿ç”¨ä¿®å¾©å¾Œçš„é€šä¿¡ç³»çµ±
                                    await window.requestFullscreenWithCommFix();

                                } else {
                                    console.log('ğŸ–¥ï¸ ä¸åœ¨ iframe ä¸­ï¼Œä½¿ç”¨åŸå§‹å…¨è¢å¹•æ–¹æ³•');

                                    // ç›´æ¥ä½¿ç”¨åŸå§‹æ–¹æ³•
                                    await originalToggleFullscreen.call(this);
                                }

                            } catch (error) {
                                console.log('âŒ ä¿®å¾©å¾Œçš„å…¨è¢å¹•åˆ‡æ›å¤±æ•—:', error);

                                // å›é€€åˆ°åŸå§‹æ–¹æ³•
                                try {
                                    await originalToggleFullscreen.call(this);
                                } catch (fallbackError) {
                                    console.log('âŒ åŸå§‹å…¨è¢å¹•æ–¹æ³•ä¹Ÿå¤±æ•—:', fallbackError);
                                }
                            }
                        };

                        console.log('âœ… éŠæˆ²å…§å…¨è¢å¹•æŒ‰éˆ•ä¿®å¾©å®Œæˆ');
                        console.log('ğŸ¯ ç¾åœ¨é»æ“ŠéŠæˆ²å…§çš„ â›¶ æŒ‰éˆ•æ‡‰è©²æœƒä½¿ç”¨ä¿®å¾©å¾Œçš„ PostMessage é€šä¿¡');
                    });
                }

                // åŸ·è¡Œä¿®å¾©
                setTimeout(() => {
                    fixGameFullscreenButton();
                }, 2000);
                
                // é€šä¿¡ç‹€æ…‹ç›£æ§
                window.monitorCommStatus = function() {
                    console.log('ğŸ“Š PostMessage é€šä¿¡ç‹€æ…‹ç›£æ§');
                    
                    const status = {
                        ...window.postMessageCommStatus,
                        currentTime: Date.now(),
                        environment: {
                            isInIframe: window !== window.parent,
                            userAgent: navigator.userAgent,
                            isMobile: /Mobi|Android/i.test(navigator.userAgent),
                            isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
                            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent)
                        }
                    };
                    
                    console.log('ğŸ“Š é€šä¿¡ç‹€æ…‹:', status);
                    return status;
                };
                
                // åˆå§‹åŒ–å®Œæˆ
                window.postMessageCommStatus.initialized = true;
                console.log('âœ… PostMessage é€šä¿¡ä¿®å¾©ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
                
                // è‡ªå‹•å˜—è©¦å»ºç«‹é€šä¿¡
                setTimeout(() => {
                    console.log('ğŸš€ è‡ªå‹•å˜—è©¦å»ºç«‹ PostMessage é€šä¿¡');
                    window.autoRetryCommSetup();
                }, 1000);
            }
            
            // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initPostMessageCommFix);
            } else {
                setTimeout(initPostMessageCommFix, 500);
            }
        </script>
        <!-- PostMessage é€šä¿¡ä¿®å¾©çµæŸ -->
        <!-- ğŸ”§ å¼·åˆ¶éŠæˆ²å…¨è¢å¹•æŒ‰éˆ•ä¿®å¾© - FORCE_GAME_FULLSCREEN_FIX -->
        <script>
            console.log('ğŸ”§ è¼‰å…¥å¼·åˆ¶éŠæˆ²å…¨è¢å¹•æŒ‰éˆ•ä¿®å¾©');
            
            // å¼·åˆ¶ä¿®å¾©éŠæˆ²å…§å…¨è¢å¹•æŒ‰éˆ•
            function forceFixGameFullscreenButton() {
                console.log('ğŸ® é–‹å§‹å¼·åˆ¶ä¿®å¾©éŠæˆ²å…§å…¨è¢å¹•æŒ‰éˆ•');
                
                // æ–¹æ³•1ï¼šç›´æ¥æ›¿æ›æŒ‰éˆ•äº‹ä»¶
                function replaceButtonEvents() {
                    console.log('ğŸ”§ æ–¹æ³•1ï¼šç›´æ¥æ›¿æ›æŒ‰éˆ•äº‹ä»¶');
                    
                    const fullscreenBtn = document.getElementById('fullscreen-btn');
                    if (fullscreenBtn) {
                        console.log('âœ… æ‰¾åˆ°å…¨è¢å¹•æŒ‰éˆ•ï¼Œç§»é™¤èˆŠäº‹ä»¶');
                        
                        // ç§»é™¤æ‰€æœ‰ç¾æœ‰äº‹ä»¶ç›£è½å™¨
                        const newBtn = fullscreenBtn.cloneNode(true);
                        fullscreenBtn.parentNode.replaceChild(newBtn, fullscreenBtn);
                        
                        // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
                        newBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('ğŸ® éŠæˆ²å…§å…¨è¢å¹•æŒ‰éˆ•è¢«é»æ“Š - å¼·åˆ¶ä¿®å¾©ç‰ˆæœ¬');
                            handleGameFullscreen();
                        });
                        
                        newBtn.addEventListener('touchend', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('ğŸ“± éŠæˆ²å…§å…¨è¢å¹•æŒ‰éˆ•è¢«è§¸æ‘¸ - å¼·åˆ¶ä¿®å¾©ç‰ˆæœ¬');
                            handleGameFullscreen();
                        });
                        
                        console.log('âœ… å…¨è¢å¹•æŒ‰éˆ•äº‹ä»¶å·²æ›¿æ›');
                        return true;
                    } else {
                        console.log('âŒ æœªæ‰¾åˆ°å…¨è¢å¹•æŒ‰éˆ•');
                        return false;
                    }
                }
                
                // æ–¹æ³•2ï¼šæ›¿æ› TouchControls çš„ toggleFullscreen æ–¹æ³•
                function replaceTouchControlsMethod() {
                    console.log('ğŸ”§ æ–¹æ³•2ï¼šæ›¿æ› TouchControls æ–¹æ³•');
                    
                    if (window.touchControls && window.touchControls.toggleFullscreen) {
                        console.log('âœ… æ‰¾åˆ° TouchControlsï¼Œæ›¿æ› toggleFullscreen æ–¹æ³•');
                        
                        // ä¿å­˜åŸå§‹æ–¹æ³•
                        const originalMethod = window.touchControls.toggleFullscreen;
                        
                        // æ›¿æ›ç‚ºå¼·åˆ¶ä¿®å¾©ç‰ˆæœ¬
                        window.touchControls.toggleFullscreen = function() {
                            console.log('ğŸ® TouchControls.toggleFullscreen è¢«èª¿ç”¨ - å¼·åˆ¶ä¿®å¾©ç‰ˆæœ¬');
                            handleGameFullscreen();
                        };
                        
                        console.log('âœ… TouchControls.toggleFullscreen å·²æ›¿æ›');
                        return true;
                    } else {
                        console.log('âŒ æœªæ‰¾åˆ° TouchControls æˆ– toggleFullscreen æ–¹æ³•');
                        return false;
                    }
                }
                
                // é˜²é‡è¤‡é»æ“Šæ©Ÿåˆ¶
                let lastClickTime = 0;

                // è™•ç†éŠæˆ²å…¨è¢å¹•çš„æ ¸å¿ƒå‡½æ•¸
                async function handleGameFullscreen() {
                    console.log('ğŸš€ åŸ·è¡ŒéŠæˆ²å…¨è¢å¹•è™•ç† - é˜²å¾ªç’°ç‰ˆæœ¬');

                    // é˜²é‡è¤‡é»æ“Š
                    const now = Date.now();
                    if (now - lastClickTime < 1000) {
                        console.log('âš ï¸ é˜²é‡è¤‡ï¼šå¿½ç•¥1ç§’å…§çš„é‡è¤‡é»æ“Š');
                        return;
                    }
                    lastClickTime = now;

                    try {
                        // æª¢æŸ¥ç’°å¢ƒ
                        const isInIframe = window !== window.parent;

                        console.log('ğŸ” ç’°å¢ƒæª¢æ¸¬:', {
                            isInIframe: isInIframe,
                            timestamp: now
                        });

                        if (isInIframe) {
                            console.log('ğŸ“± åœ¨ iframe ä¸­ï¼Œç™¼é€ç°¡å–®åˆ‡æ›è«‹æ±‚');

                            // ç™¼é€ç°¡å–®çš„åˆ‡æ›è«‹æ±‚ï¼Œè®“çˆ¶é é¢æ±ºå®šé€²å…¥é‚„æ˜¯é€€å‡º
                            const fullscreenMessage = {
                                type: 'DUAL_FULLSCREEN_REQUEST',
                                timestamp: now,
                                source: 'GAME_BUTTON',
                                requestId: 'game_' + now
                            };

                            console.log('ğŸ“¤ ç™¼é€å…¨è¢å¹•åˆ‡æ›è«‹æ±‚:', fullscreenMessage);
                            window.parent.postMessage(fullscreenMessage, '*');

                            // è¦–è¦ºåé¥‹
                            const fullscreenBtn = document.querySelector('.fullscreen-btn') ||
                                                document.querySelector('[onclick*="fullscreen"]') ||
                                                document.querySelector('button[title*="å…¨è¢å¹•"]');
                            if (fullscreenBtn) {
                                fullscreenBtn.style.background = 'rgba(0, 255, 0, 0.4)';
                                setTimeout(() => {
                                    fullscreenBtn.style.background = '';
                                }, 300);
                            }
                            
                            // åŒæ™‚å˜—è©¦æœ¬åœ°å…¨è¢å¹•
                            await attemptLocalFullscreen();
                            
                        } else {
                            console.log('ğŸ–¥ï¸ ä¸åœ¨ iframe ä¸­ï¼Œä½¿ç”¨æœ¬åœ°å…¨è¢å¹•');
                            await attemptLocalFullscreen();
                        }
                        
                    } catch (error) {
                        console.log('âŒ éŠæˆ²å…¨è¢å¹•è™•ç†å¤±æ•—:', error);
                        
                        // æœ€å¾Œçš„å›é€€æ–¹æ¡ˆ
                        console.log('ğŸ”„ å˜—è©¦æœ€å¾Œçš„å›é€€æ–¹æ¡ˆ');
                        await attemptLocalFullscreen();
                    }
                }
                
                // å˜—è©¦æœ¬åœ°å…¨è¢å¹•
                async function attemptLocalFullscreen() {
                    console.log('ğŸ”§ å˜—è©¦æœ¬åœ°å…¨è¢å¹•');
                    
                    try {
                        const element = document.documentElement;
                        
                        // Safari æ”¯æ´
                        if (element.webkitRequestFullscreen) {
                            console.log('ğŸ ä½¿ç”¨ Safari webkitRequestFullscreen');
                            await element.webkitRequestFullscreen();
                        }
                        // æ¨™æº– API
                        else if (element.requestFullscreen) {
                            console.log('ğŸŒ ä½¿ç”¨æ¨™æº– requestFullscreen');
                            await element.requestFullscreen();
                        }
                        // å…¶ä»–ç€è¦½å™¨
                        else if (element.mozRequestFullScreen) {
                            console.log('ğŸ¦Š ä½¿ç”¨ Firefox mozRequestFullScreen');
                            await element.mozRequestFullScreen();
                        }
                        else if (element.msRequestFullscreen) {
                            console.log('ğŸ”· ä½¿ç”¨ IE msRequestFullscreen');
                            await element.msRequestFullscreen();
                        }
                        else {
                            console.log('âŒ ç€è¦½å™¨ä¸æ”¯æ´å…¨è¢å¹• API');
                        }
                        
                        console.log('âœ… æœ¬åœ°å…¨è¢å¹•è«‹æ±‚å·²ç™¼é€');
                        
                    } catch (error) {
                        console.log('âŒ æœ¬åœ°å…¨è¢å¹•å¤±æ•—:', error);
                    }
                }
                
                // åŸ·è¡Œä¿®å¾©
                console.log('ğŸš€ é–‹å§‹åŸ·è¡Œå¼·åˆ¶ä¿®å¾©');
                
                // å˜—è©¦æ–¹æ³•1ï¼šæ›¿æ›æŒ‰éˆ•äº‹ä»¶
                const method1Success = replaceButtonEvents();
                
                // å˜—è©¦æ–¹æ³•2ï¼šæ›¿æ› TouchControls æ–¹æ³•
                const method2Success = replaceTouchControlsMethod();
                
                if (method1Success || method2Success) {
                    console.log('âœ… å¼·åˆ¶ä¿®å¾©æˆåŠŸ');
                    console.log('ğŸ¯ ç¾åœ¨é»æ“ŠéŠæˆ²å…§çš„ â›¶ æŒ‰éˆ•æ‡‰è©²æœƒæœ‰åæ‡‰');
                } else {
                    console.log('âŒ å¼·åˆ¶ä¿®å¾©å¤±æ•—ï¼Œæœªæ‰¾åˆ°ç›®æ¨™å…ƒç´ æˆ–æ–¹æ³•');
                }
                
                // æ·»åŠ å…¨å±€æ¸¬è©¦å‡½æ•¸
                window.testGameFullscreenFix = function() {
                    console.log('ğŸ§ª æ¸¬è©¦éŠæˆ²å…¨è¢å¹•ä¿®å¾©');
                    handleGameFullscreen();
                };
                
                console.log('ğŸ§ª æ·»åŠ äº†æ¸¬è©¦å‡½æ•¸ï¼šwindow.testGameFullscreenFix()');
            }
            
            // ç­‰å¾…é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œä¿®å¾©
            function waitAndFix() {
                if (document.readyState === 'complete') {
                    // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿æ‰€æœ‰è…³æœ¬éƒ½è¼‰å…¥å®Œæˆ
                    setTimeout(() => {
                        forceFixGameFullscreenButton();
                    }, 3000);
                } else {
                    window.addEventListener('load', () => {
                        setTimeout(() => {
                            forceFixGameFullscreenButton();
                        }, 3000);
                    });
                }
            }
            
            // ç«‹å³é–‹å§‹ç­‰å¾…å’Œä¿®å¾©
            waitAndFix();
            
            // ä¹Ÿå¯ä»¥æ‰‹å‹•è§¸ç™¼ä¿®å¾©
            window.forceFixGameFullscreen = forceFixGameFullscreenButton;
            
            console.log('âœ… å¼·åˆ¶éŠæˆ²å…¨è¢å¹•æŒ‰éˆ•ä¿®å¾©å·²è¼‰å…¥');
        </script>
        <!-- å¼·åˆ¶éŠæˆ²å…¨è¢å¹•æŒ‰éˆ•ä¿®å¾©çµæŸ -->
        
        
        
        <!-- åº§æ¨™åŒæ­¥è§£æ±ºæ–¹æ¡ˆçµæŸ -->
    </body>
</html>
