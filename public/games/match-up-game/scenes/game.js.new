// ============================================
// 閬婃埐鍫存櫙 - 涓婚亰鎴查倧杓紙鍗＄墖鎷栧嫊閰嶅皪锛?// ============================================
// 娉ㄦ剰锛氶熆鎳夊紡閰嶇疆鍜屼綀灞€椤為€氶亷鍏ㄥ眬璁婇噺瑷晱
// - RESPONSIVE_BREAKPOINTS, DESIGN_TOKENS 绛変締鑷?responsive-config.js
// - GameResponsiveLayout 椤炰締鑷?responsive-layout.js
class GameScene extends Phaser.Scene {
    constructor() {
        super({ key: 'GameScene' });

        // 閰嶅皪鏁告摎锛堝皣寰?API 杓夊叆锛?        this.pairs = [];
        this.isLoadingVocabulary = false;
        this.vocabularyLoadError = null;

        // 閬婃埐鐙€鎱?        this.leftCards = [];
        this.rightCards = [];
        this.matchedPairs = new Set();
        this.isDragging = false;
        this.dragStartCard = null;
        this.sceneStopped = false;  // 馃敟 鍫存櫙鍋滄鐙€鎱嬫瑷?
        // 馃敟 鍒嗛爜鍔熻兘
        this.itemsPerPage = 7;  // 榛樿獚姣忛爜 7 鍊嬭褰欙紙鍙厤缃級
        this.currentPage = 0;   // 鐣跺墠闋佺⒓锛堝緸 0 闁嬪锛?        this.totalPages = 1;    // 绺介爜鏁?        this.enablePagination = false;  // 鏄惁鍟熺敤鍒嗛爜
        this.pageIndicatorText = null;  // 鍒嗛爜鎸囩ず鍣ㄦ枃瀛楀皪璞?
        // 馃敟 瑷堟檪鍣ㄥ姛鑳?        this.timerType = 'none';  // 瑷堟檪鍣ㄩ鍨嬶細none, countUp, countDown
        this.timerMinutes = 5;    // 鍊掓暩瑷堟檪鍒嗛悩鏁?        this.timerSeconds = 0;    // 鍊掓暩瑷堟檪绉掓暩
        this.startTime = null;    // 姝ｅ悜瑷堟檪闁嬪鏅傞枔
        this.remainingTime = 0;   // 鍊掓暩瑷堟檪鍓╅鏅傞枔锛堢锛?        this.timerText = null;    // 瑷堟檪鍣ㄦ枃瀛楀皪璞?        this.timerEvent = null;   // 瑷堟檪鍣ㄤ簨浠?
        // 馃敟 閬婃埐閬搁爡
        this.layout = 'separated';  // 浣堝眬妯″紡锛歴eparated, mixed
        this.random = 'different';  // 闅ㄦ妯″紡锛歞ifferent, same
        this.showAnswers = false;   // 閬婃埐绲愭潫鏅傞’绀虹瓟妗?
        // 馃敟 閬婃埐绲愭潫鐙€鎱嬬鐞?        this.gameState = 'playing';  // 閬婃埐鐙€鎱嬶細playing, completed
        this.gameStartTime = null;   // 閬婃埐闁嬪鏅傞枔
        this.gameEndTime = null;     // 閬婃埐绲愭潫鏅傞枔
        this.totalGameTime = 0;      // 绺介亰鎴叉檪闁擄紙绉掞級
        this.allPagesAnswers = [];   // 鎵€鏈夐爜闈㈢殑鐢ㄦ埗绛旀瑷橀寗
        this.currentPageAnswers = []; // 鐣跺墠闋侀潰鐨勭敤鎴剁瓟妗堣閷?
        // Audio diagnostics and dev helpers
        this.audioDiagnostics = null;
        this.devLayoutDefault = null;
        this.restartData = {};
    }

    init(data = {}) {
        this.restartData = data || {};

        if (this.restartData.devLayoutTest) {
            console.log('馃И GameScene: 鎺ユ敹鍒伴枊鐧兼脯瑭﹀弮鏁?, this.restartData.devLayoutTest);
        } else {
            this.devLayoutDefault = null;
        }
    }

    loadDevLayoutTestData(mode, urlParams) {
        const normalizedMode = (mode || '').toLowerCase();
        const layoutParam = urlParams ? urlParams.get('layout') : null;
        const defaultLayout = normalizedMode === 'separated' ? 'separated' : normalizedMode === 'mixed' ? 'mixed' : 'mixed';

        this.devLayoutDefault = layoutParam || defaultLayout;
        this.vocabularyLoadError = null;

        this.pairs = this.getDevLayoutSamplePairs();
        this.audioDiagnostics = this.buildAudioDiagnostics(this.pairs);
        window.matchUpAudioDiagnostics = this.audioDiagnostics;

        console.log('馃И GameScene: 宸茶級鍏ラ枊鐧兼脯瑭﹁褰欒硣鏂?, {
            defaultLayout: this.devLayoutDefault,
            totalPairs: this.pairs.length,
            audioDiagnostics: this.audioDiagnostics
        });

        return true;
    }

    getDevLayoutSamplePairs() {
        const imageA = '/icons/icon-128x128.png';
        const imageB = '/icons/icon-144x144.png';
        const audioA = '/games/runner-game/public/assets/sounds/coin.mp3';
        const audioB = '/games/pushpull-game/dist/assets/sounds/win.mp3';

        return [
            {
                id: 1,
                question: 'Apple',
                answer: '铇嬫灉',
                english: 'Apple',
                chinese: '铇嬫灉',
                imageUrl: imageA,
                chineseImageUrl: null,
                audioUrl: audioA
            },
            {
                id: 2,
                question: '',
                answer: '瑾為煶鎻愮ず',
                english: '',
                chinese: '瑾為煶鎻愮ず',
                imageUrl: null,
                chineseImageUrl: null,
                audioUrl: audioB
            },
            {
                id: 3,
                question: 'Sunshine',
                answer: '闄藉厜',
                english: 'Sunshine',
                chinese: '闄藉厜',
                imageUrl: null,
                chineseImageUrl: null,
                audioUrl: null
            },
            {
                id: 4,
                question: 'Mountain',
                answer: '灞辫剤',
                english: 'Mountain',
                chinese: '灞辫剤',
                imageUrl: imageB,
                chineseImageUrl: null,
                audioUrl: null
            },
            {
                id: 5,
                question: 'Harmony',
                answer: '鍜岃',
                english: 'Harmony',
                chinese: '鍜岃',
                imageUrl: null,
                chineseImageUrl: null,
                audioUrl: audioA
            },
            {
                id: 6,
                question: 'Placeholder',
                answer: '缂哄皯瑾為煶',
                english: 'Placeholder',
                chinese: '缂哄皯瑾為煶',
                imageUrl: imageA,
                chineseImageUrl: null,
                audioUrl: ''
            }
        ];
    }

    buildAudioDiagnostics(pairs) {
        const diagnostics = {
            total: pairs.length,
            available: 0,
            missing: 0,
            invalid: 0,
            missingItems: [],
            invalidItems: []
        };

        pairs.forEach((pair) => {
            const raw = typeof pair.audioUrl === 'string' ? pair.audioUrl.trim() : '';
            const hasValue = !!raw;
            const isValidFormat = hasValue ? /^(https?:\/\/|\/)/.test(raw) : false;

            if (hasValue && isValidFormat) {
                diagnostics.available += 1;
                pair.audioUrl = raw;
                pair.audioStatus = 'available';
                pair.invalidAudioUrl = null;
            } else if (hasValue && !isValidFormat) {
                diagnostics.invalid += 1;
                diagnostics.invalidItems.push({ id: pair.id, english: pair.english || pair.question, audioUrl: raw });
                pair.audioUrl = null;
                pair.audioStatus = 'invalid';
                pair.invalidAudioUrl = raw;
            } else {
                diagnostics.missing += 1;
                diagnostics.missingItems.push({ id: pair.id, english: pair.english || pair.question });
                pair.audioUrl = null;
                pair.audioStatus = 'missing';
                pair.invalidAudioUrl = null;
            }
        });

        console.log('馃帶 闊宠▕瑷烘柗绲愭灉', diagnostics);

        if (diagnostics.missing || diagnostics.invalid) {
            console.warn('鈿狅笍 鐧肩従缂哄皯鎴栫劇鏁堢殑 audioUrl锛岃珛妾㈡煡 CMS/寰岀杓稿嚭');
        }

        return diagnostics;
    }

    addAudioStatusBadge(container, width, height, audioStatus) {
        const badgeWidth = Math.min(width * 0.6, 100);
        const badgeHeight = Math.min(height * 0.18, 26);
        const badgeX = width / 2 - badgeWidth / 2 - 8;
        const badgeY = -height / 2 + badgeHeight / 2 + 8;
        const strokeColor = audioStatus === 'invalid' ? 0xf9a825 : 0xb0bec5;
        const icon = audioStatus === 'invalid' ? '鈿狅笍' : '馃攪';
        const label = audioStatus === 'invalid' ? 'Audio URL invalid' : 'No audio';

        const badgeBg = this.add.rectangle(badgeX, badgeY, badgeWidth, badgeHeight, 0xf5f5f5, 0.92);
        badgeBg.setOrigin(0.5);
        badgeBg.setStrokeStyle(1.5, strokeColor);

        const badgeText = this.add.text(badgeX, badgeY, `${icon} ${label}`, {
            fontSize: `${Math.max(10, badgeHeight * 0.55)}px`,
            color: '#546E7A',
            fontFamily: 'Arial'
        });
        badgeText.setOrigin(0.5);

        container.add([badgeBg, badgeText]);
    }

    // 寰?API 杓夊叆瑭炲綑鏁告摎
    async loadVocabularyFromAPI() {
        // 馃摑 瑾胯│瑷婃伅锛氳閷勫嚱鏁搁枊濮?        console.log('馃攧 闁嬪杓夊叆瑭炲綑鏁告摎');
        console.log('馃攳 [DEBUG] loadVocabularyFromAPI 鍑芥暩宸茶鐢?);

        try {
            // 寰?URL 鍙冩暩鐛插彇 activityId
            const urlParams = new URLSearchParams(window.location.search);
            const activityId = urlParams.get('activityId');
            const customVocabulary = urlParams.get('customVocabulary');
            const devLayoutTest = (this.restartData && this.restartData.devLayoutTest) || urlParams.get('devLayoutTest');

            console.log('馃攳 [DEBUG] URL 鍙冩暩:', {
                activityId,
                customVocabulary,
                devLayoutTest,
                fullURL: window.location.href
            });

            if (devLayoutTest) {
                console.warn('馃И GameScene: 鍟熺敤闁嬬櫦娓│璩囨枡闆嗭紝璺抽亷 API 杓夊叆', { devLayoutTest });
                return this.loadDevLayoutTestData(devLayoutTest, urlParams);
            }

            console.log('馃攳 Match-up 閬婃埐 - URL 鍙冩暩:', {
                activityId,
                customVocabulary,
                fullURL: window.location.href
            });

            // 馃敟 淇京锛氬繀闋堟彁渚?activityId锛屼笉浣跨敤榛樿獚鏁告摎
            if (!activityId) {
                const error = new Error('鉂?缂哄皯 activityId 鍙冩暩锛岀劇娉曡級鍏ヨ褰欐暩鎿?);
                console.error('鉂?鍙冩暩椹楄瓑澶辨晽:', error.message);
                throw error;
            }

            // 馃敟 淇京锛氬鏋滄矑鏈?customVocabulary 鍙冩暩锛岄粯瑾嶇偤 true锛堝厑瑷卞叕闁嬭í鍟忥級
            if (customVocabulary !== 'true' && customVocabulary !== null) {
                const error = new Error('鉂?customVocabulary 鍙冩暩鐒℃晥');
                console.error('鉂?鍙冩暩椹楄瓑澶辨晽:', error.message);
                throw error;
            }

            console.log('鉁?鍙冩暩椹楄瓑閫氶亷锛屽厑瑷辫級鍏ヨ褰欐暩鎿?);
            console.log('馃攳 [DEBUG] 婧栧倷鐧奸€?API 璜嬫眰');

            // 寰?API 杓夊叆瑭炲綑鏁告摎
            const apiUrl = `/api/activities/${activityId}`;
            console.log(`馃攧 鐧奸€?API 璜嬫眰: ${apiUrl}`);
            console.log('馃攳 [DEBUG] 闁嬪 fetch 瑾跨敤');

            const response = await fetch(apiUrl);

            console.log('馃攳 [DEBUG] fetch 瀹屾垚');
            console.log('馃摗 API 闊挎噳鐙€鎱?', {
                status: response.status,
                statusText: response.statusText,
                ok: response.ok,
                headers: {
                    contentType: response.headers.get('content-type')
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                const error = new Error(`API 璜嬫眰澶辨晽: ${response.status} ${response.statusText}`);
                console.error('鉂?API 璜嬫眰澶辨晽:', {
                    status: response.status,
                    statusText: response.statusText,
                    url: apiUrl,
                    errorBody: errorText
                });
                throw error;
            }

            const activity = await response.json();
            console.log('馃攳 [DEBUG] JSON 瑙ｆ瀽瀹屾垚');
            console.log('鉁?娲诲嫊鏁告摎杓夊叆鎴愬姛:', {
                id: activity.id,
                title: activity.title,
                hasVocabularyItems: !!activity.vocabularyItems,
                vocabularyItemsCount: activity.vocabularyItems?.length || 0,
                hasElements: !!activity.elements,
                elementsCount: activity.elements?.length || 0,
                hasContent: !!activity.content
            });

            // 鎻愬彇瑭炲綑鏁告摎锛堟敮鎸佸绋暩鎿氭簮锛?            console.log('馃攳 妾㈡煡瑭炲綑鏁告摎渚嗘簮...');
            let vocabularyData = [];

            if (activity.vocabularyItems && Array.isArray(activity.vocabularyItems) && activity.vocabularyItems.length > 0) {
                // 鏂版灦妲嬶細寰為棞鑱〃涓嵅鍙栬褰欐暩鎿?                vocabularyData = activity.vocabularyItems;
                console.log('馃摑 寰?vocabularyItems 杓夊叆瑭炲綑:', vocabularyData.length, '鍊?);
            } else if (activity.elements && Array.isArray(activity.elements) && activity.elements.length > 0) {
                // 涓枔鏋舵锛氬緸 elements 瀛楁杓夊叆瑭炲綑鏁告摎
                vocabularyData = activity.elements;
                console.log('馃摑 寰?elements 杓夊叆瑭炲綑:', vocabularyData.length, '鍊?);
            } else if (activity.content && activity.content.vocabularyItems && Array.isArray(activity.content.vocabularyItems)) {
                // 鑸婃灦妲嬶細寰?content 涓嵅鍙栬褰欐暩鎿?                vocabularyData = activity.content.vocabularyItems;
                console.log('馃摑 寰?content.vocabularyItems 杓夊叆瑭炲綑:', vocabularyData.length, '鍊?);
            } else {
                console.error('鉂?鐒℃硶鎵惧埌瑭炲綑鏁告摎:', {
                    hasVocabularyItems: !!activity.vocabularyItems,
                    hasElements: !!activity.elements,
                    hasContent: !!activity.content
                });
            }

            // 杞夋彌鐐洪亰鎴叉墍闇€鐨勬牸寮?            if (vocabularyData.length > 0) {
                console.log('馃攧 闁嬪杞夋彌瑭炲綑鏁告摎鏍煎紡...');

                // 馃敟 v9.0 瑭崇窗瑾胯│锛氭鏌ュ師濮嬫暩鎿氱祼妲?                const firstItem = vocabularyData[0] || {};
                const hasImageUrl = !!firstItem.imageUrl;
                const hasChineseImageUrl = !!firstItem.chineseImageUrl;
                console.log(`馃攳 [v9.0] 鍘熷瑭炲綑鏁告摎绲愭妾㈡煡 - 绺介爡鐩? ${vocabularyData.length}, hasImageUrl: ${hasImageUrl}, hasChineseImageUrl: ${hasChineseImageUrl}, imageUrl: ${firstItem.imageUrl || 'null'}, chineseImageUrl: ${firstItem.chineseImageUrl || 'null'}`);

                this.pairs = vocabularyData.map((item, index) => ({
                    id: index + 1,
                    question: item.english || item.word || '',
                    answer: item.chinese || item.translation || '',
                    english: item.english || item.word || '',  // 馃敟 娣诲姞 english 娆勪綅
                    chinese: item.chinese || item.translation || '',  // 馃敟 娣诲姞 chinese 娆勪綅
                    imageUrl: item.imageUrl || null,  // 馃敟 娣诲姞鑻辨枃鍦栫墖 URL
                    chineseImageUrl: item.chineseImageUrl || null,  // 馃敟 娣诲姞涓枃鍦栫墖 URL
                    audioUrl: item.audioUrl || null  // 馃敟 娣诲姞闊抽牷 URL
                }));

                // 馃敟 寰屽彴鐣版鐢熸垚缂哄け鐨勯煶闋伙紙涓嶉樆濉為亰鎴插姞杓夛級
                this.generateMissingAudioUrlsInBackground();

                this.audioDiagnostics = this.buildAudioDiagnostics(this.pairs);
                window.matchUpAudioDiagnostics = this.audioDiagnostics;

                console.log('鉁?瑭炲綑鏁告摎杞夋彌瀹屾垚:', {
                    totalPairs: this.pairs.length,
                    firstPair: this.pairs[0],
                    hasImages: this.pairs.some(p => p.imageUrl || p.chineseImageUrl || p.imageId || p.chineseImageId),
                    hasAudio: this.pairs.some(p => p.audioUrl)
                });

                // 馃敟 瑾胯│鏃ヨ獙 - 瑭崇窗妾㈡煡姣忓€嬭褰欓爡鐩殑english瀛楁
                console.log('馃攳 瑭崇窗瑭炲綑鏁告摎妾㈡煡:');
                this.pairs.forEach((pair, index) => {
                    console.log(`瑭炲綑 ${index + 1}:`, {
                        id: pair.id,
                        english: pair.english,
                        englishType: typeof pair.english,
                        englishLength: pair.english ? pair.english.length : 'null/undefined',
                        chinese: pair.chinese,
                        chineseType: typeof pair.chinese,
                        hasImage: !!pair.imageUrl,
                        hasAudio: !!pair.audioUrl
                    });
                });

                return true;
            } else {
                // 馃敟 淇京锛氫笉浣跨敤榛樿獚鏁告摎锛屾媼鍑洪尟瑾?                const error = new Error('鉂?娲诲嫊涓矑鏈夎褰欐暩鎿氾紝璜嬪厛娣诲姞瑭炲綑');
                console.error('鉂?瑭炲綑鏁告摎鐐虹┖:', {
                    activityId: activity.id,
                    activityTitle: activity.title
                });
                throw error;
            }
        } catch (error) {
            console.error('鉂?杓夊叆瑭炲綑鏁告摎澶辨晽:', {
                message: error.message,
                stack: error.stack,
                url: window.location.href
            });
            this.vocabularyLoadError = error.message;
            // 馃敟 淇京锛氫笉浣跨敤榛樿獚鏁告摎锛岀洿鎺ユ媼鍑洪尟瑾?            throw error;
        }
    }

    async create() {
        console.log('馃幃 GameScene: create 鏂规硶闁嬪');
        console.log('馃幃 GameScene: 鍫存櫙灏哄', {
            width: this.scale.width,
            height: this.scale.height,
            gameWidth: this.game.config.width,
            gameHeight: this.game.config.height
        });

        // 娓呯┖鏁哥祫锛堥槻姝㈤噸鏂伴枊濮嬫檪閲嶈锛?        this.leftCards = [];
        this.rightCards = [];
        this.matchedPairs = new Set();
        this.isDragging = false;
        this.dragStartCard = null;
        this.submitButton = null;  // 馃敟 鎻愪氦绛旀鎸夐垥

        // 椤ず杓夊叆鎻愮ず
        const width = this.scale.width;
        const height = this.scale.height;
        console.log('馃幃 GameScene: 鍓靛缓鐧借壊鑳屾櫙鍜岃級鍏ユ枃瀛?, { width, height });

        this.add.rectangle(width / 2, height / 2, width, height, 0xffffff).setDepth(-1);
        const loadingText = this.add.text(width / 2, height / 2, '杓夊叆瑭炲綑涓?..', {
            fontSize: '24px',
            color: '#333333',
            fontFamily: 'Arial'
        }).setOrigin(0.5);

        console.log('馃幃 GameScene: 闁嬪杓夊叆瑭炲綑鏁告摎');

        // 馃敟 淇京锛氫娇鐢?try-catch 铏曠悊閷
        this.isLoadingVocabulary = true;
        let success = false;

        try {
            success = await this.loadVocabularyFromAPI();
            console.log('馃幃 GameScene: 瑭炲綑鏁告摎杓夊叆瀹屾垚', { success, pairsCount: this.pairs.length });
        } catch (error) {
            console.error('鉂?GameScene: 瑭炲綑鏁告摎杓夊叆澶辨晽', error);
            this.vocabularyLoadError = error.message;
            success = false;
        }

        this.isLoadingVocabulary = false;

        // 绉婚櫎杓夊叆鎻愮ず
        loadingText.destroy();
        console.log('馃幃 GameScene: 杓夊叆鏂囧瓧宸茬Щ闄?);

        // 馃敟 淇京锛氬鏋滆級鍏ュけ鏁楋紝椤ず閷淇℃伅涓﹀仠姝㈤亰鎴?        if (!success || this.vocabularyLoadError) {
            console.warn('鈿狅笍 GameScene: 椤ず閷淇℃伅', this.vocabularyLoadError);

            // 椤ず閷妯欓
            this.add.text(width / 2, height / 2 - 80, '鉂?杓夊叆瑭炲綑澶辨晽', {
                fontSize: '32px',
                color: '#ff0000',
                fontFamily: 'Arial',
                fontStyle: 'bold'
            }).setOrigin(0.5);

            // 椤ず閷瑷婃伅
            this.add.text(width / 2, height / 2 - 20, this.vocabularyLoadError || '鏈煡閷', {
                fontSize: '18px',
                color: '#666666',
                fontFamily: 'Arial',
                align: 'center',
                wordWrap: { width: width - 100 }
            }).setOrigin(0.5);

            // 椤ず瑙ｆ焙鏂规
            this.add.text(width / 2, height / 2 + 40, '璜嬬⒑瑾嶏細', {
                fontSize: '16px',
                color: '#999999',
                fontFamily: 'Arial'
            }).setOrigin(0.5);

            this.add.text(width / 2, height / 2 + 70, '1. URL 鍖呭惈姝ｇ⒑鐨?activityId 鍙冩暩', {
                fontSize: '14px',
                color: '#999999',
                fontFamily: 'Arial'
            }).setOrigin(0.5);

            this.add.text(width / 2, height / 2 + 95, '2. URL 鍖呭惈 customVocabulary=true 鍙冩暩', {
                fontSize: '14px',
                color: '#999999',
                fontFamily: 'Arial'
            }).setOrigin(0.5);

            this.add.text(width / 2, height / 2 + 120, '3. 娲诲嫊涓凡娣诲姞瑭炲綑鏁告摎', {
                fontSize: '14px',
                color: '#999999',
                fontFamily: 'Arial'
            }).setOrigin(0.5);

            // 鍋滄閬婃埐锛屼笉绻肩簩鍩疯
            return;
        }

        // 馃敟 鐛插彇 Handler 鍫存櫙寮曠敤
        this.handlerScene = this.scene.get('handler');
        console.log('馃幃 GameScene: Handler 鍫存櫙寮曠敤', this.handlerScene ? '鉁?瀛樺湪' : '鉂?涓嶅瓨鍦?);

        // 馃敟 瑾跨敤 Handler 鐨?updateResize 鏂规硶瑷畾闊挎噳寮?        if (this.handlerScene && this.handlerScene.updateResize) {
            console.log('馃幃 GameScene: 瑾跨敤 Handler.updateResize');
            this.handlerScene.updateResize(this);
        } else {
            console.warn('鈿狅笍 GameScene: handlerScene 鏈垵濮嬪寲鎴?updateResize 鏂规硶涓嶅瓨鍦?);
        }

        // 馃敟 鍒濆鍖栧垎闋佽ō缃?        this.initializePagination();

        // 馃敟 鍒濆鍖栭亰鎴查伕闋?        this.initializeGameOptions();

        // 馃敟 鍒濆鍖栬▓鏅傚櫒
        this.initializeTimer();

        // 鐛插彇鐣跺墠铻㈠箷灏哄
        console.log('馃幃 GameScene: 瑾跨敤 updateLayout');
        this.updateLayout();
        console.log('馃幃 GameScene: updateLayout 瀹屾垚');

        // 馃敟 P1-4: 缍佸畾浜嬩欢鐩ｈ伣鍣紙浣跨敤 bind 纰轰繚 this 涓婁笅鏂囨纰猴級
        // 鐩ｈ伣铻㈠箷灏哄璁婂寲
        this.scale.on('resize', this.handleResize, this);
        console.log('鉁?宸茬秮瀹?resize 浜嬩欢鐩ｈ伣鍣?);

        // 鐩ｈ伣鍏ㄨ灑骞曡畩鍖?        document.addEventListener('fullscreenchange', this.handleFullscreenChange.bind(this));
        console.log('鉁?宸茬秮瀹?fullscreenchange 浜嬩欢鐩ｈ伣鍣?);

        // 鐩ｈ伣瑷倷鏂瑰悜璁婂寲
        window.addEventListener('orientationchange', this.handleOrientationChange.bind(this));
        console.log('鉁?宸茬秮瀹?orientationchange 浜嬩欢鐩ｈ伣鍣?);

        console.log('馃幃 GameScene: create 鏂规硶瀹屾垚');
    }

    // 馃敟 v6.0 瑷堢畻姣忛爜鑳藉绱嶇殑鏈€澶у崱鐗囨暩
    calculateMaxCardsPerPage(width, height, layout = 'mixed') {
        // 馃敟 妾㈡脯瑷倷椤炲瀷鍜屾ā寮?        const isMobileDevice = width < 768;
        const isLandscapeMobile = width > height && height < 500;
        const isTinyHeight = height < 400;
        const isCompactMode = isMobileDevice || isLandscapeMobile || isTinyHeight;

        // 鏍规摎浣堝眬妯″紡姹哄畾鍒楁暩
        let cols;
        if (layout === 'mixed') {
            cols = isCompactMode ? 5 : 3;  // 娣峰悎妯″紡锛氱穵婀?5 鍒楋紝姝ｅ父 3 鍒?        } else {
            // 鍒嗛洟妯″紡锛氭牴鎿氬搴﹀嫊鎱嬫焙瀹?            const sideMargin = 20;
            const availableWidth = width - sideMargin * 2;
            cols = Math.max(1, Math.floor(availableWidth / 150));  // 鍋囪ō鏈€灏忓崱鐗囧搴?150px
        }

        // 瑷堢畻鍙敤楂樺害
        const topButtonArea = isCompactMode ? 50 : 60;
        const bottomButtonArea = isCompactMode ? 50 : 60;
        const availableHeight = height - topButtonArea - bottomButtonArea;

        // 瑷堢畻鍗＄墖灏哄鍜岃鏁?        const verticalSpacing = Math.max(5, Math.min(20, availableHeight * 0.02));
        const cardHeight = 67;  // 娣峰悎妯″紡鍗＄墖楂樺害
        const chineseTextHeight = 20;  // 涓枃鏂囧瓧楂樺害
        const totalUnitHeight = cardHeight + chineseTextHeight + verticalSpacing;

        const maxRows = Math.max(1, Math.floor((availableHeight - verticalSpacing) / totalUnitHeight));
        const maxCardsPerPage = cols * maxRows;

        console.log('馃搳 姣忛爜鏈€澶у崱鐗囨暩瑷堢畻:', {
            layout,
            isCompactMode,
            cols,
            maxRows,
            maxCardsPerPage,
            availableHeight: availableHeight.toFixed(0),
            totalUnitHeight: totalUnitHeight.toFixed(0)
        });

        return maxCardsPerPage;
    }

    // 馃敟 v6.0 鏍规摎鏈€澶у崱鐗囨暩瑷堢畻鍒嗛爜
    calculatePaginationWithLayout(totalPairs, width, height, layout = 'mixed') {
        // 瑷堢畻姣忛爜鑳藉绱嶇殑鏈€澶у崱鐗囨暩
        const maxCardsPerPage = this.calculateMaxCardsPerPage(width, height, layout);

        // 纰轰繚姣忛爜鑷冲皯鏈?1 鍊嬪崱鐗?        const itemsPerPage = Math.max(1, maxCardsPerPage);

        // 瑷堢畻绺介爜鏁?        const totalPages = Math.ceil(totalPairs / itemsPerPage);

        // 姹哄畾鏄惁鍟熺敤鍒嗛爜
        const enablePagination = totalPages > 1;

        console.log('馃搫 鍒嗛爜瑷堢畻绲愭灉:', {
            totalPairs,
            maxCardsPerPage,
            itemsPerPage,
            totalPages,
            enablePagination
        });

        return {
            itemsPerPage,
            totalPages,
            enablePagination,
            maxCardsPerPage
        };
    }

    // 馃敟 鍒濆鍖栧垎闋佽ō缃紙v6.0 鏇存柊锛氫娇鐢ㄥ嫊鎱嬭▓绠楋級
    initializePagination() {
        const totalPairs = this.pairs.length;
        console.log('馃搫 鍒濆鍖栧垎闋佽ō缃?- 绺借褰欐暩:', totalPairs);

        // 寰?URL 鍙冩暩璁€鍙栬ō缃?        const urlParams = new URLSearchParams(window.location.search);
        const itemsPerPageParam = urlParams.get('itemsPerPage');
        const autoProceedParam = urlParams.get('autoProceed');

        // 璁€鍙栨瘡闋侀’绀烘暩閲?        if (itemsPerPageParam) {
            // 馃敟 濡傛灉 URL 鎸囧畾浜?itemsPerPage锛岀洿鎺ヤ娇鐢?            this.itemsPerPage = parseInt(itemsPerPageParam, 10);
            console.log('馃搫 寰?URL 璁€鍙?itemsPerPage:', this.itemsPerPage);
        } else {
            // 馃敟 v6.0 鏂伴倧杓細鏍规摎浣堝眬瑷堢畻姣忛爜鏈€澶у崱鐗囨暩
            const width = this.scale.width;
            const height = this.scale.height;
            const layout = this.layout || 'mixed';

            const paginationResult = this.calculatePaginationWithLayout(
                totalPairs,
                width,
                height,
                layout
            );

            this.itemsPerPage = paginationResult.itemsPerPage;
            console.log('馃搫 鏍规摎浣堝眬瑷堢畻 itemsPerPage:', this.itemsPerPage);
        }

        // 璁€鍙栬嚜鍕曠辜绾岃ō缃?        if (autoProceedParam !== null) {
            this.autoProceed = autoProceedParam === 'true';
            console.log('馃搫 寰?URL 璁€鍙?autoProceed:', this.autoProceed);
        } else {
            this.autoProceed = true;  // 榛樿獚闁嬪暉
            console.log('馃搫 浣跨敤榛樿獚 autoProceed:', this.autoProceed);
        }

        // 瑷堢畻绺介爜鏁?        this.totalPages = Math.ceil(totalPairs / this.itemsPerPage);

        // 姹哄畾鏄惁鍟熺敤鍒嗛爜
        this.enablePagination = this.totalPages > 1;

        // 閲嶇疆鐣跺墠闋佺⒓
        this.currentPage = 0;

        console.log('馃搫 鍒嗛爜瑷疆瀹屾垚:', {
            totalPairs,
            itemsPerPage: this.itemsPerPage,
            totalPages: this.totalPages,
            enablePagination: this.enablePagination,
            autoProceed: this.autoProceed
        });
    }

    // 馃敟 鍒濆鍖栭亰鎴查伕闋?    initializeGameOptions() {
        const urlParams = new URLSearchParams(window.location.search);

        // 馃敟 v10.1 瑭崇窗瑾胯│锛氭鏌?URL 鍙冩暩
        console.log('馃攳 [v10.1] URL 鍙冩暩瑭崇窗妾㈡煡:', {
            fullUrl: window.location.href,
            search: window.location.search,
            allParams: Array.from(urlParams.entries()),
            layoutParam: urlParams.get('layout'),
            randomParam: urlParams.get('random'),
            showAnswersParam: urlParams.get('showAnswers')
        });

        // 璁€鍙栦綀灞€閬搁爡
        const layoutParam = urlParams.get('layout');
        this.layout = layoutParam || this.devLayoutDefault || 'separated';
        console.log('馃幃 浣堝眬妯″紡:', this.layout, {
            source: layoutParam ? 'url' : this.devLayoutDefault ? 'dev-default' : 'fallback',
            layoutParam,
            devLayoutDefault: this.devLayoutDefault
        });

        // 璁€鍙栭毃姗熼伕闋?        this.random = urlParams.get('random') || 'different';
        console.log('馃幉 闅ㄦ妯″紡:', this.random);

        // 璁€鍙栭’绀虹瓟妗堥伕闋?        this.showAnswers = urlParams.get('showAnswers') === 'true';
        console.log('馃摑 椤ず绛旀:', this.showAnswers);
    }

    // 馃敟 鍒濆鍖栬▓鏅傚櫒
    initializeTimer() {
        const urlParams = new URLSearchParams(window.location.search);

        // 璁€鍙栬▓鏅傚櫒椤炲瀷
        this.timerType = urlParams.get('timerType') || 'none';
        console.log('鈴憋笍 瑷堟檪鍣ㄩ鍨?', this.timerType);

        if (this.timerType === 'countDown') {
            // 璁€鍙栧€掓暩瑷堟檪鏅傞枔
            this.timerMinutes = parseInt(urlParams.get('timerMinutes') || '5', 10);
            this.timerSeconds = parseInt(urlParams.get('timerSeconds') || '0', 10);
            this.remainingTime = this.timerMinutes * 60 + this.timerSeconds;
            console.log('鈴憋笍 鍊掓暩瑷堟檪鏅傞枔:', this.timerMinutes, '鍒?, this.timerSeconds, '绉?);
        } else if (this.timerType === 'countUp') {
            // 瑷橀寗闁嬪鏅傞枔
            this.startTime = Date.now();
            console.log('鈴憋笍 姝ｅ悜瑷堟檪闁嬪');
        }
    }

    // 馃敟 鍓靛缓瑷堟檪鍣?UI
    createTimerUI() {
        const width = this.scale.width;

        if (this.timerType === 'none') {
            return;  // 涓嶉’绀鸿▓鏅傚櫒
        }

        // 鍓靛缓瑷堟檪鍣ㄦ枃瀛?        const timerColor = this.timerType === 'countDown' ? '#ff0000' : '#000000';
        const initialText = this.timerType === 'countDown'
            ? this.formatTime(this.remainingTime)
            : '00:00';

        // 馃敟 瑷堟檪鍣ㄧ疆涓’绀?        this.timerText = this.add.text(width / 2, 20, initialText, {
            fontSize: '28px',
            color: timerColor,
            fontFamily: 'Arial',
            fontStyle: 'bold'
        }).setOrigin(0.5, 0).setDepth(1000);

        // 濡傛灉鏄€掓暩瑷堟檪锛屽暉鍕曡▓鏅傚櫒浜嬩欢
        if (this.timerType === 'countDown') {
            this.timerEvent = this.time.addEvent({
                delay: 1000,
                callback: this.updateCountDownTimer,
                callbackScope: this,
                loop: true
            });
        } else if (this.timerType === 'countUp') {
            // 姝ｅ悜瑷堟檪姣忕鏇存柊
            this.timerEvent = this.time.addEvent({
                delay: 1000,
                callback: this.updateCountUpTimer,
                callbackScope: this,
                loop: true
            });
        }

        console.log('鈴憋笍 瑷堟檪鍣?UI 宸插壍寤?);
    }

    // 馃敟 鏇存柊鍊掓暩瑷堟檪鍣?    updateCountDownTimer() {
        this.remainingTime--;

        if (this.remainingTime <= 0) {
            // 鏅傞枔鍒?            this.onTimeUp();
        } else {
            // 鏇存柊椤ず
            if (this.timerText) {
                this.timerText.setText(this.formatTime(this.remainingTime));

                // 鏈€寰?10 绉掕畩绱呰壊涓﹂杻鐖?                if (this.remainingTime <= 10) {
                    this.timerText.setColor('#ff0000');
                    this.tweens.add({
                        targets: this.timerText,
                        alpha: 0.3,
                        duration: 500,
                        yoyo: true
                    });
                }
            }
        }
    }

    // 馃敟 鏇存柊姝ｅ悜瑷堟檪鍣?    updateCountUpTimer() {
        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
        if (this.timerText) {
            this.timerText.setText(this.formatTime(elapsed));
        }
    }

    // 馃敟 鏍煎紡鍖栨檪闁擄紙绉?-> MM:SS锛?    formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // 馃敟 鏅傞枔鍒伴仈铏曠悊
    onTimeUp() {
        console.log('鈴憋笍 鏅傞枔鍒帮紒');

        // 鍋滄瑷堟檪鍣?        if (this.timerEvent) {
            this.timerEvent.remove();
        }

        // 椤ず鏅傞枔鍒拌▕鎭?        this.showTimeUpMessage();
    }

    // 馃敟 椤ず鏅傞枔鍒拌▕鎭?    showTimeUpMessage() {
        const width = this.scale.width;
        const height = this.scale.height;

        // 鍓靛缓鍗婇€忔槑鑳屾櫙
        const overlay = this.add.rectangle(width / 2, height / 2, width, height, 0x000000, 0.7)
            .setDepth(2000);

        // 椤ず鏅傞枔鍒拌▕鎭?        const messageText = this.add.text(width / 2, height / 2 - 50, '鈴?鏅傞枔鍒帮紒', {
            fontSize: '48px',
            color: '#ffffff',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        }).setOrigin(0.5).setDepth(2001);

        // 椤ず瀹屾垚閫插害
        const completedCount = this.matchedPairs.size;
        const totalCount = this.getCurrentPagePairs().length;
        const progressText = this.add.text(
            width / 2,
            height / 2 + 20,
            `宸插畬鎴?${completedCount} / ${totalCount} 鍊嬮厤灏峘,
            {
                fontSize: '24px',
                color: '#ffffff',
                fontFamily: 'Arial'
            }
        ).setOrigin(0.5).setDepth(2001);

        // 濡傛灉闁嬪暉椤ず绛旀锛岄’绀虹瓟妗堟寜閳?        if (this.showAnswers) {
            const showAnswersButton = this.add.text(
                width / 2,
                height / 2 + 80,
                '馃摑 鏌ョ湅绛旀',
                {
                    fontSize: '24px',
                    color: '#ffffff',
                    fontFamily: 'Arial',
                    backgroundColor: '#4CAF50',
                    padding: { x: 20, y: 10 }
                }
            ).setOrigin(0.5).setDepth(2001).setInteractive({ useHandCursor: true });

            showAnswersButton.on('pointerdown', () => {
                overlay.destroy();
                messageText.destroy();
                progressText.destroy();
                showAnswersButton.destroy();
                this.showAnswersScreen();
            });
        }
    }

    updateLayout() {
        console.log('馃幃 GameScene: updateLayout 闁嬪');
        console.log('馃幃 GameScene: 鐣跺墠鍫存櫙灏哄', {
            width: this.scale.width,
            height: this.scale.height
        });

        // 娓呴櫎鎵€鏈夌従鏈夊厓绱?        console.log('馃幃 GameScene: 娓呴櫎鎵€鏈夌従鏈夊厓绱?);
        this.children.removeAll(true);

        // 鐛插彇鐣跺墠铻㈠箷灏哄
        const width = this.scale.width;
        const height = this.scale.height;

        console.log('馃幃 GameScene: 娣诲姞鐧借壊鑳屾櫙', { width, height });
        // 娣诲姞鐧借壊鑳屾櫙
        this.add.rectangle(width / 2, height / 2, width, height, 0xffffff).setDepth(-1);

        // 馃敟 绉婚櫎妯欓锛氱敤鎴惰姹傛嬁鎺夐亰鎴插収鐨?"Match up" 妯欓

        console.log('馃幃 GameScene: 鍓靛缓鍗＄墖');
        // 鍓靛缓鍗＄墖
        this.createCards();
        console.log('馃幃 GameScene: 鍗＄墖鍓靛缓瀹屾垚');

        // 馃敟 瑷橀寗閬婃埐闁嬪鏅傞枔
        if (!this.gameStartTime) {
            this.gameStartTime = Date.now();
            console.log('馃幃 GameScene: 閬婃埐闁嬪鏅傞枔宸茶閷?);
        }

        // 馃敟 鍓靛缓瑷堟檪鍣?UI
        this.createTimerUI();

        // 馃敟 椤ず銆屾彁浜ょ瓟妗堛€嶆寜閳曪紙閬婃埐闁嬪鏅傚氨椤ず锛?        this.showSubmitButton();

        // 馃敟 绉婚櫎閲嶆柊闁嬪鎸夐垥锛氱敤鎴惰姹傛嬁鎺?        console.log('馃幃 GameScene: updateLayout 瀹屾垚');
    }

    handleResize(gameSize) {
        console.log('馃幃 GameScene: handleResize 瑙哥櫦', gameSize);
        // 铻㈠箷灏哄鏀硅畩鏅傞噸鏂颁綀灞€
        this.updateLayout();
    }

    createCards() {
        console.log('馃幃 GameScene: createCards 闁嬪');
        console.log('馃幃 GameScene: pairs 鏁告摎', this.pairs);

        // 馃敟 鐛插彇鐣跺墠闋佺殑瑭炲綑鏁告摎
        const startIndex = this.currentPage * this.itemsPerPage;
        const endIndex = Math.min(startIndex + this.itemsPerPage, this.pairs.length);
        const currentPagePairs = this.pairs.slice(startIndex, endIndex);

        console.log('馃搫 鐣跺墠闋佹暩鎿?', {
            currentPage: this.currentPage + 1,
            totalPages: this.totalPages,
            startIndex,
            endIndex,
            currentPagePairs: currentPagePairs.length
        });

        // 鐛插彇鐣跺墠铻㈠箷灏哄
        const width = this.scale.width;
        const height = this.scale.height;

        console.log('馃幃 GameScene: 瑷堢畻鍗＄墖灏哄鍜屼綅缃?, { width, height });

        // 鉁?v40.0锛歩Pad 鍕曟厠鍗＄墖灏哄瑾挎暣
        // 妾㈡脯 iPad锛堝搴?768-1280px锛屽寘鎷?iPad Air銆乮Pad Pro锛?        const isTablet = width >= 768 && width <= 1280;
        const isIPad = isTablet;
        console.log('馃攳 [v40.0] iPad 妾㈡脯:', { width, isTablet, isIPad });

        // 闊挎噳寮忓崱鐗囧昂瀵革紙鏍规摎铻㈠箷瀵害瑾挎暣锛?        let cardWidth, cardHeight;
        if (isIPad) {
            // iPad锛氭牴鎿氬鍣ㄥぇ灏忓嫊鎱嬭鏁?            // 鍒嗛洟浣堝眬锛氬乏鍙冲悇涓€鍒楋紝鎵€浠ュ崱鐗囧搴?= 鍙敤瀵害 / 2 - 閭婅窛
            cardWidth = Math.max(140, (width - 60) / 2 - 20);  // 60px 閭婅窛锛?0px 闁撹窛
            cardHeight = Math.max(60, height * 0.12);  // 楂樺害鐐鸿灑骞曢珮搴︾殑 12%
            console.log('馃摫 [v40.0] iPad 鍕曟厠鍗＄墖灏哄:', {
                availableWidth: width - 60,
                calculatedCardWidth: cardWidth.toFixed(1),
                calculatedCardHeight: cardHeight.toFixed(1)
            });
        } else {
            // 鍏朵粬瑷倷锛氫娇鐢ㄥ浐瀹氭瘮渚?            cardWidth = Math.max(150, Math.min(250, width * 0.2));
            cardHeight = Math.max(50, Math.min(80, height * 0.1));
        }

        console.log('馃幃 GameScene: 鍗＄墖灏哄', { cardWidth, cardHeight });

        // 闊挎噳寮忎綅缃紙浣跨敤鐧惧垎姣旓級
        const leftX = width * 0.25;        // 宸﹀伌鍗＄墖鍦?25% 浣嶇疆
        const rightX = width * 0.65;       // 鍙冲伌鍗＄墖鍦?65% 浣嶇疆
        const leftStartY = height * 0.25;  // 宸﹀伌璧峰浣嶇疆鍦?25% 楂樺害
        const rightStartY = height * 0.22; // 鍙冲伌璧峰浣嶇疆鍦?22% 楂樺害

        console.log('馃幃 GameScene: 鍗＄墖浣嶇疆', { leftX, rightX, leftStartY, rightStartY });

        // 闊挎噳寮忛枔璺?        const leftSpacing = cardHeight + Math.max(5, height * 0.01);   // 鍗＄墖楂樺害 + 5px 鎴?1% 楂樺害
        const rightSpacing = cardHeight + Math.max(15, height * 0.03); // 鍗＄墖楂樺害 + 15px 鎴?3% 楂樺害

        console.log('馃幃 GameScene: 鍗＄墖闁撹窛', { leftSpacing, rightSpacing });

        // 馃敟 鏍规摎浣堝眬妯″紡鍓靛缓鍗＄墖
        if (this.layout === 'mixed') {
            // 娣峰悎浣堝眬妯″紡
            this.createMixedLayout(currentPagePairs, width, height, cardWidth, cardHeight);
        } else {
            // 鍒嗛洟浣堝眬妯″紡锛堥粯瑾嶏級
            this.createSeparatedLayout(currentPagePairs, leftX, rightX, leftStartY, rightStartY,
                                      cardWidth, cardHeight, leftSpacing, rightSpacing);
        }

        // 馃敟 鍓靛缓鍒嗛爜鎸囩ず鍣?        if (this.enablePagination) {
            this.createPageIndicator();
        }

        console.log('馃幃 GameScene: createCards 瀹屾垚', {
            leftCardsCount: this.leftCards.length,
            rightCardsCount: this.rightCards.length
        });
    }

    // 馃敟 鍓靛缓鍒嗛洟浣堝眬锛堟牴鎿?Wordwall 绛栫暐锛?    createSeparatedLayout(currentPagePairs, leftX, rightX, leftStartY, rightStartY,
                          cardWidth, cardHeight, leftSpacing, rightSpacing) {
        const width = this.scale.width;
        const height = this.scale.height;
        const itemCount = currentPagePairs.length;

        // 馃敟 鏍规摎 Wordwall 绛栫暐鍒ゆ柗浣堝眬
        if (itemCount <= 5) {
            // 3-5 鍊嬶細宸﹀彸鍒嗛洟锛屽柈鍒?            console.log('馃幃 浣跨敤宸﹀彸鍒嗛洟浣堝眬锛?-5鍊嬪尮閰嶆暩锛屽柈鍒楋級');
            this.createLeftRightSingleColumn(currentPagePairs, width, height);
        } else {
            // 6-20 鍊嬶細宸﹀彸鍒嗛洟锛屽琛?2 鍒?            console.log('馃幃 浣跨敤宸﹀彸鍒嗛洟浣堝眬锛?-20鍊嬪尮閰嶆暩锛屽琛?鍒楋級');
            this.createLeftRightMultiRows(currentPagePairs, width, height);
        }
    }

    // 馃敟 鍓靛缓宸﹀彸鍒嗛洟浣堝眬 - 鍠垪锛?-5鍊嬪尮閰嶆暩锛?    createLeftRightSingleColumn(currentPagePairs, width, height) {
        console.log('馃搻 鍓靛缓宸﹀彸鍒嗛洟浣堝眬 - 鍠垪锛?-5鍊嬪尮閰嶆暩锛?);

        const itemCount = currentPagePairs.length;

        // 馃敟 妾㈡脯瀹瑰櫒楂樺害鍜屾墜姗熸┇鍚戞ā寮?        const isSmallContainer = height < 600;
        const isMediumContainer = height >= 600 && height < 800;
        const isLandscapeMobile = width > height && height < 450;  // 馃敟 鎵嬫姗悜妯″紡

        console.log(`馃搻 瀹瑰櫒灏哄: ${width} 脳 ${height}`, {
            isSmallContainer,
            isMediumContainer,
            isLargeContainer: height >= 800,
            isLandscapeMobile  // 馃敟 椤ず鏄惁鐐烘墜姗熸┇鍚戞ā寮?        });

        // 馃敟 鏍规摎瀹瑰櫒澶у皬鍕曟厠瑾挎暣鍗＄墖灏哄
        let cardWidth, cardHeight;

        if (isLandscapeMobile) {
            // 馃敟 鎵嬫姗悜妯″紡锛氫娇鐢ㄨ秴绶婃箠浣堝眬
            cardWidth = Math.max(100, Math.min(150, width * 0.15));
            cardHeight = Math.max(28, Math.min(40, height * 0.08));
            console.log('馃摫 鎵嬫姗悜妯″紡锛氫娇鐢ㄨ秴绶婃箠浣堝眬');
        } else if (isSmallContainer) {
            // 灏忓鍣細鏇村皬鐨勫崱鐗?            cardWidth = Math.max(120, Math.min(200, width * 0.18));
            cardHeight = Math.max(40, Math.min(65, height * 0.09));
        } else if (isMediumContainer) {
            // 涓瓑瀹瑰櫒锛氶仼涓殑鍗＄墖
            cardWidth = Math.max(140, Math.min(220, width * 0.19));
            cardHeight = Math.max(45, Math.min(72, height * 0.095));
        } else {
            // 澶у鍣細杓冨ぇ鐨勫崱鐗?            cardWidth = Math.max(150, Math.min(250, width * 0.2));
            cardHeight = Math.max(50, Math.min(80, height * 0.1));
        }

        console.log(`馃搻 鍗＄墖灏哄: ${cardWidth.toFixed(0)} 脳 ${cardHeight.toFixed(0)}`);

        // 馃敟 鏍规摎瀹瑰櫒澶у皬鍕曟厠瑾挎暣浣嶇疆
        // 馃敟 鑻辨枃鍗€鍩熷線鍙崇Щ鍕?20%锛岃嫳鏂囧崁鍜屼腑鏂囧崁閮藉線涓嬬Щ鍕?10%
        let leftX, rightX, leftStartY, rightStartY;

        if (isLandscapeMobile) {
            // 馃敟 鎵嬫姗悜妯″紡锛氭洿绶婃箠鐨勪綅缃?            leftX = width * 0.38;
            rightX = width * 0.70;
            leftStartY = height * 0.15;
            rightStartY = height * 0.12;
        } else if (isSmallContainer) {
            // 灏忓鍣細鏇寸穵婀婄殑浣堝眬
            leftX = width * 0.42;  // 馃敟 寰?0.22 鏀圭偤 0.42锛?20%锛?            rightX = width * 0.68;
            leftStartY = height * 0.25;   // 馃敟 寰?0.15 鏀圭偤 0.25锛?10%锛?            rightStartY = height * 0.22;  // 馃敟 寰?0.12 鏀圭偤 0.22锛?10%锛?        } else if (isMediumContainer) {
            // 涓瓑瀹瑰櫒锛氬钩琛＄殑浣堝眬
            leftX = width * 0.44;  // 馃敟 寰?0.24 鏀圭偤 0.44锛?20%锛?            rightX = width * 0.66;
            leftStartY = height * 0.3;    // 馃敟 寰?0.2 鏀圭偤 0.3锛?10%锛?            rightStartY = height * 0.27;  // 馃敟 寰?0.17 鏀圭偤 0.27锛?10%锛?        } else {
            // 澶у鍣細鑸掗仼鐨勪綀灞€
            leftX = width * 0.45;  // 馃敟 寰?0.25 鏀圭偤 0.45锛?20%锛?            rightX = width * 0.65;
            leftStartY = height * 0.35;   // 馃敟 寰?0.25 鏀圭偤 0.35锛?10%锛?            rightStartY = height * 0.32;  // 馃敟 寰?0.22 鏀圭偤 0.32锛?10%锛?        }

        // 馃敟 鏍规摎瀹瑰櫒澶у皬鍕曟厠瑾挎暣闁撹窛
        // 鑻辨枃鍗＄墖锛氬姞 cardHeight
        // 涓枃鍗＄墖锛?-5鍊嬪尮閰嶆暩锛夛細鍙姞 cardHeight锛堜笉鍔?textHeight + oneCharSpacing锛?        let leftSpacing, rightSpacing;

        if (isLandscapeMobile) {
            // 馃敟 鎵嬫姗悜妯″紡锛氳▓绠楁渶澶у彲鐢ㄩ珮搴︼紝纰轰繚鎵€鏈夊崱鐗囬兘鑳介’绀?            const availableHeight = height * 0.75;  // 浣跨敤 75% 鐨勯珮搴?            const maxSpacing = (availableHeight - cardHeight * itemCount) / (itemCount - 1);

            leftSpacing = Math.max(18, Math.min(maxSpacing, cardHeight + 3));
            rightSpacing = Math.max(18, Math.min(maxSpacing, cardHeight + 5));
            console.log(`馃摫 鎵嬫姗悜闁撹窛: 宸﹀伌=${leftSpacing.toFixed(1)}px, 鍙冲伌=${rightSpacing.toFixed(1)}px, 鍙敤楂樺害=${availableHeight.toFixed(0)}px`);
        } else if (isSmallContainer) {
            leftSpacing = cardHeight + Math.max(3, height * 0.008);
            rightSpacing = cardHeight + Math.max(8, height * 0.02);  // 馃敟 3-5鍊嬶細鍙姞 cardHeight
        } else if (isMediumContainer) {
            leftSpacing = cardHeight + Math.max(4, height * 0.009);
            rightSpacing = cardHeight + Math.max(12, height * 0.025);  // 馃敟 3-5鍊嬶細鍙姞 cardHeight
        } else {
            leftSpacing = cardHeight + Math.max(5, height * 0.01);
            rightSpacing = cardHeight + Math.max(15, height * 0.03);  // 馃敟 3-5鍊嬶細鍙姞 cardHeight
        }

        if (!isLandscapeMobile) {
            console.log(`馃搹 闁撹窛: 宸﹀伌=${leftSpacing.toFixed(1)}px, 鍙冲伌=${rightSpacing.toFixed(1)}px`);
        }

        // 馃敟 鏍规摎闅ㄦ妯″紡鎺掑垪绛旀
        let shuffledAnswers;
        if (this.random === 'same') {
            const urlParams = new URLSearchParams(window.location.search);
            const activityId = urlParams.get('activityId') || 'default-seed';
            const seed = activityId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const rng = new Phaser.Math.RandomDataGenerator([seed.toString()]);
            shuffledAnswers = rng.shuffle([...currentPagePairs]);
            console.log('馃幉 浣跨敤鍥哄畾闅ㄦ妯″紡锛岀ó瀛?', seed);
        } else {
            shuffledAnswers = Phaser.Utils.Array.Shuffle([...currentPagePairs]);
            console.log('馃幉 浣跨敤闅ㄦ鎺掑垪妯″紡');
        }

        // 鍓靛缓宸﹀伌澶栨
        this.createLeftContainerBox(leftX, leftStartY, cardWidth, cardHeight, leftSpacing, itemCount);

        // 馃敟 鍓靛缓宸﹀伌椤岀洰鍗＄墖锛堟寜鐓ч爢搴忓嚭鐝惧嫊鐣級
        currentPagePairs.forEach((pair, index) => {
            const y = leftStartY + index * leftSpacing;
            const animationDelay = index * 100;  // 馃敟 姣忓€嬪崱鐗囧欢閬?100ms
            const card = this.createLeftCard(leftX, y, cardWidth, cardHeight, pair.question, pair.id, animationDelay, pair.imageUrl, pair.audioUrl);
            this.leftCards.push(card);
        });

        // 鍓靛缓鍙冲伌绛旀鍗＄墖锛堟枃瀛楀湪妗嗗彸閭婏級
        shuffledAnswers.forEach((pair, index) => {
            const y = rightStartY + index * rightSpacing;
            const card = this.createRightCard(rightX, y, cardWidth, cardHeight, pair.answer, pair.id, 'right');  // 馃敟 鏂囧瓧鍦ㄦ鍙抽倞
            this.rightCards.push(card);
        });

        console.log('鉁?宸﹀彸鍒嗛洟浣堝眬鍓靛缓瀹屾垚');
    }

    // 馃敟 鍓靛缓涓婁笅鍒嗛洟浣堝眬 - 2 琛岋紙6-10鍊嬪尮閰嶆暩锛?    createTopBottomTwoRows(currentPagePairs, width, height) {
        console.log('馃搻 鍓靛缓涓婁笅鍒嗛洟浣堝眬 - 2琛岋紙6-10鍊嬪尮閰嶆暩锛?);

        const itemCount = currentPagePairs.length;

        // 馃敟 妾㈡脯瀹瑰櫒楂樺害
        const isSmallContainer = height < 600;
        const isMediumContainer = height >= 600 && height < 800;

        console.log(`馃搻 瀹瑰櫒灏哄: ${width} 脳 ${height}`, {
            isSmallContainer,
            isMediumContainer,
            isLargeContainer: height >= 800
        });

        // 馃敟 瑷堢畻鍒楁暩锛堝浐瀹?2 琛岋級
        const rows = 2;
        const columns = Math.ceil(itemCount / rows);

        console.log(`馃搳 鍖归厤鏁? ${itemCount}, 浣跨敤 ${rows} 琛?脳 ${columns} 鍒椾綀灞€`);

        // 馃敟 鏍规摎瀹瑰櫒澶у皬鍜屽垪鏁歌鏁村崱鐗囧昂瀵?        let cardWidth, cardHeight;
        if (isSmallContainer) {
            cardWidth = Math.max(80, Math.min(120, width * (0.85 / columns)));  // 鉁?鎻愰珮鏈€灏忓搴﹀緸 70px 鍒?80px
            cardHeight = Math.max(35, Math.min(55, height * 0.15));
        } else if (isMediumContainer) {
            cardWidth = Math.max(80, Math.min(140, width * (0.88 / columns)));
            cardHeight = Math.max(40, Math.min(65, height * 0.16));
        } else {
            cardWidth = Math.max(90, Math.min(160, width * (0.9 / columns)));
            cardHeight = Math.max(45, Math.min(75, height * 0.17));
        }

        console.log(`馃搻 鍗＄墖灏哄: ${cardWidth.toFixed(0)} 脳 ${cardHeight.toFixed(0)}`);

        // 馃敟 瑷堢畻闁撹窛
        const horizontalSpacing = Math.max(5, width * 0.01);

        // 馃敟 瑷堢畻鏂囧瓧楂樺害锛堢敤鏂间笅鏂逛腑鏂囧崱鐗囷級
        const textHeight = Math.max(24, Math.min(48, cardHeight * 0.6));

        // 馃敟 鑻辨枃鍗＄墖鐨勫瀭鐩撮枔璺濓紙涓嶅姞鏂囧瓧楂樺害锛?        const topVerticalSpacing = Math.max(5, height * 0.02);

        // 馃敟 涓枃鍗＄墖鐨勫瀭鐩撮枔璺濓紙鍙姞鏂囧瓧楂樺害锛屼笉鍔犻澶栭枔璺濓級
        const bottomVerticalSpacing = textHeight;

        // 馃敟 瑷堢畻涓婃柟鍗€鍩燂紙鑻辨枃锛夌殑璧峰浣嶇疆
        const topAreaStartX = (width - (columns * cardWidth + (columns - 1) * horizontalSpacing)) / 2;
        const topAreaStartY = height * 0.12;

        // 馃敟 瑷堢畻涓嬫柟鍗€鍩燂紙涓枃锛夌殑璧峰浣嶇疆
        const bottomAreaStartX = topAreaStartX;
        const bottomAreaStartY = height * 0.55;

        console.log(`馃搷 鍗€鍩熶綅缃?`, {
            topAreaStartX: topAreaStartX.toFixed(0),
            topAreaStartY: topAreaStartY.toFixed(0),
            bottomAreaStartX: bottomAreaStartX.toFixed(0),
            bottomAreaStartY: bottomAreaStartY.toFixed(0)
        });

        // 馃敟 鏍规摎闅ㄦ妯″紡鎺掑垪绛旀
        let shuffledAnswers;
        if (this.random === 'same') {
            const urlParams = new URLSearchParams(window.location.search);
            const activityId = urlParams.get('activityId') || 'default-seed';
            const seed = activityId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const rng = new Phaser.Math.RandomDataGenerator([seed.toString()]);
            shuffledAnswers = rng.shuffle([...currentPagePairs]);
            console.log('馃幉 浣跨敤鍥哄畾闅ㄦ妯″紡锛岀ó瀛?', seed);
        } else {
            shuffledAnswers = Phaser.Utils.Array.Shuffle([...currentPagePairs]);
            console.log('馃幉 浣跨敤闅ㄦ鎺掑垪妯″紡');
        }

        // 馃敟 鍓靛缓涓婃柟澶栨锛堝寘鍦嶆墍鏈夎嫳鏂囧崱鐗囷級
        this.createMultiColumnContainerBox(
            topAreaStartX,
            topAreaStartY,
            cardWidth,
            cardHeight,
            horizontalSpacing,
            topVerticalSpacing,  // 馃敟 鑻辨枃鍗＄墖浣跨敤 topVerticalSpacing
            columns,
            rows
        );

        // 馃敟 涓嶅壍寤轰笅鏂瑰妗嗭紙涓枃鍗＄墖涓嶉渶瑕佸妗嗭級

        // 馃敟 鍓靛缓涓婃柟鑻辨枃鍗＄墖锛? 琛屽鍒楋紝鎸夌収闋嗗簭鍑虹従鍕曠暙锛?        currentPagePairs.forEach((pair, index) => {
            const col = index % columns;
            const row = Math.floor(index / columns);
            const x = topAreaStartX + col * (cardWidth + horizontalSpacing) + cardWidth / 2;
            const y = topAreaStartY + row * (cardHeight + topVerticalSpacing) + cardHeight / 2;  // 馃敟 鑻辨枃鍗＄墖浣跨敤 topVerticalSpacing

            const animationDelay = index * 100;  // 馃敟 姣忓€嬪崱鐗囧欢閬?100ms
            const card = this.createLeftCard(x, y, cardWidth, cardHeight, pair.question, pair.id, animationDelay, pair.imageUrl, pair.audioUrl);
            this.leftCards.push(card);
        });

        // 馃敟 鍓靛缓涓嬫柟涓枃鍗＄墖锛? 琛屽鍒楋級
        shuffledAnswers.forEach((pair, index) => {
            const col = index % columns;
            const row = Math.floor(index / columns);
            const x = bottomAreaStartX + col * (cardWidth + horizontalSpacing) + cardWidth / 2;
            const y = bottomAreaStartY + row * (cardHeight + bottomVerticalSpacing) + cardHeight / 2;  // 馃敟 涓枃鍗＄墖浣跨敤 bottomVerticalSpacing

            const card = this.createRightCard(x, y, cardWidth, cardHeight, pair.answer, pair.id);
            this.rightCards.push(card);
        });

        console.log('鉁?涓婁笅鍒嗛洟浣堝眬锛?琛岋級鍓靛缓瀹屾垚');
    }

    // 馃敟 鍓靛缓宸﹀彸鍒嗛洟浣堝眬 - 澶氳 2 鍒楋紙6-20鍊嬪尮閰嶆暩锛?    createLeftRightMultiRows(currentPagePairs, width, height) {
        console.log('馃搻 鍓靛缓宸﹀彸鍒嗛洟浣堝眬 - 澶氳2鍒楋紙6-20鍊嬪尮閰嶆暩锛?);

        const itemCount = currentPagePairs.length;

        // 馃敟 妾㈡脯瀹瑰櫒楂樺害
        const isSmallContainer = height < 600;
        const isMediumContainer = height >= 600 && height < 800;

        console.log(`馃搻 瀹瑰櫒灏哄: ${width} 脳 ${height}`, {
            isSmallContainer,
            isMediumContainer,
            isLargeContainer: height >= 800
        });

        // 馃敟 v10.0 妾㈡脯鏄惁鏈夊湒鐗囷紙鍙鏈変换浣曚竴鍊嬪湒鐗囧氨閫插叆姝ｆ柟褰㈡ā寮忥級
        const hasImages = currentPagePairs.some(pair =>
            pair.imageUrl || pair.chineseImageUrl || pair.imageId || pair.chineseImageId
        );
        console.log(`馃攳 [v10.0] 鍒嗛洟浣堝眬鍦栫墖妾㈡脯: hasImages=${hasImages}, mode=${hasImages ? '馃煢 姝ｆ柟褰㈡ā寮? : '馃煥 闀锋柟褰㈡ā寮?}`);

        // 馃敟 v10.0 鏍规摎鍦栫墖妾㈡脯姹哄畾鍒楁暩
        // 鏈夊湒鐗囨檪锛氫娇鐢?5 鍒楋紙姝ｆ柟褰㈡ā寮忥級
        // 鐒″湒鐗囨檪锛氫娇鐢?2 鍒楋紙闀锋柟褰㈡ā寮忥級
        const columns = hasImages ? 5 : 2;
        const rows = Math.ceil(itemCount / columns);

        console.log(`馃搳 鍖归厤鏁? ${itemCount}, 浣跨敤 ${rows} 琛?脳 ${columns} 鍒椾綀灞€ [v10.0]`);

        // 馃敟 瑷堢畻闁撹窛锛堝厛瑷堢畻锛岀敤鏂煎緦绾屽崱鐗囬珮搴﹁▓绠楋級
        const horizontalSpacing = Math.max(5, width * 0.01);
        const verticalSpacing = Math.max(3, height * 0.008);

        // 馃敟 鍕曟厠瑷堢畻鏈€澶у崱鐗囬珮搴︼紝纰轰繚鎵€鏈夊崱鐗囬兘鑳芥斁鍏ュ鍣?        const availableHeight = height * 0.8;  // 浣跨敤 80% 鐨勫鍣ㄩ珮搴?        const totalVerticalSpacing = (rows - 1) * verticalSpacing;
        const maxCardHeight = (availableHeight - totalVerticalSpacing) / rows;

        // 馃敟 鏍规摎瀹瑰櫒澶у皬鍜屽尮閰嶆暩瑾挎暣鍗＄墖灏哄
        let cardWidth, cardHeight;

        // 馃敟 6-10 鍊嬪拰 16-20 鍊嬪尮閰嶆暩浣跨敤鏇村皬鐨勫崱鐗囧昂瀵?        const isSmallCardSize = itemCount <= 10 || itemCount >= 16;

        // 馃敟 v10.0 鏍规摎鍒楁暩瑾挎暣鍗＄墖灏哄
        // 5 鍒楁ā寮忥紙鏈夊湒鐗囷級锛氬崱鐗囨洿灏?        // 2 鍒楁ā寮忥紙鐒″湒鐗囷級锛氬崱鐗囨洿澶?        if (columns === 5) {
            // 馃敟 v10.0 姝ｆ柟褰㈡ā寮忥紙5 鍒楋級锛氬崱鐗囨洿灏?            if (isSmallContainer) {
                cardWidth = Math.max(50, Math.min(80, width * 0.08));
                cardHeight = Math.max(50, Math.min(80, width * 0.08));  // 姝ｆ柟褰?            } else if (isMediumContainer) {
                cardWidth = Math.max(60, Math.min(100, width * 0.10));
                cardHeight = Math.max(60, Math.min(100, width * 0.10));  // 姝ｆ柟褰?            } else {
                cardWidth = Math.max(80, Math.min(140, width * 0.12));
                cardHeight = Math.max(80, Math.min(140, width * 0.12));  // 姝ｆ柟褰?            }
        } else {
            // 馃敟 v10.0 闀锋柟褰㈡ā寮忥紙2 鍒楋級锛氬崱鐗囨洿澶?            if (isSmallCardSize) {
                cardWidth = Math.max(70, Math.min(110, width * 0.11));  // 馃敟 6-10 鍊嬪拰 16-20 鍊嬶細鏇村皬鐨勫搴?                cardHeight = Math.max(18, Math.min(maxCardHeight, 38));  // 馃敟 6-10 鍊嬪拰 16-20 鍊嬶細鏇村皬鐨勯珮搴?            } else {
                cardWidth = Math.max(80, Math.min(130, width * 0.13));
                cardHeight = Math.max(20, Math.min(maxCardHeight, 45));
            }
        }

        console.log(`馃搻 鍗＄墖灏哄 [v10.0]: ${cardWidth.toFixed(0)} 脳 ${cardHeight.toFixed(0)}, 妯″紡: ${columns === 5 ? '馃煢 姝ｆ柟褰?(5鍒?' : '馃煥 闀锋柟褰?(2鍒?'}`);
        console.log(`馃搹 鍙敤楂樺害: ${availableHeight.toFixed(0)}, 鏈€澶у崱鐗囬珮搴? ${maxCardHeight.toFixed(0)}`);

        // 馃敟 鑻辨枃鍗＄墖鍜屼腑鏂囧崱鐗囩殑鍨傜洿闁撹窛锛堟枃瀛楀湪妗嗗彸閭婏紝涓嶉渶瑕侀澶栭枔璺濓級
        const leftVerticalSpacing = verticalSpacing;
        const rightVerticalSpacing = verticalSpacing;  // 馃敟 鑸囧乏鍋寸浉鍚?
        // 馃敟 瑷堢畻宸﹀伌鍗€鍩燂紙鑻辨枃锛夌殑璧峰浣嶇疆
        const leftAreaStartX = width * 0.08;
        const leftAreaStartY = height * 0.1;

        // 馃敟 瑷堢畻鍙冲伌鍗€鍩燂紙涓枃锛夌殑璧峰浣嶇疆
        const rightAreaStartX = width * 0.52;
        const rightAreaStartY = height * 0.1;

        console.log(`馃搷 鍗€鍩熶綅缃?`, {
            leftAreaStartX: leftAreaStartX.toFixed(0),
            leftAreaStartY: leftAreaStartY.toFixed(0),
            rightAreaStartX: rightAreaStartX.toFixed(0),
            rightAreaStartY: rightAreaStartY.toFixed(0)
        });

        // 馃敟 鏍规摎闅ㄦ妯″紡鎺掑垪绛旀
        let shuffledAnswers;
        if (this.random === 'same') {
            const urlParams = new URLSearchParams(window.location.search);
            const activityId = urlParams.get('activityId') || 'default-seed';
            const seed = activityId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const rng = new Phaser.Math.RandomDataGenerator([seed.toString()]);
            shuffledAnswers = rng.shuffle([...currentPagePairs]);
            console.log('馃幉 浣跨敤鍥哄畾闅ㄦ妯″紡锛岀ó瀛?', seed);
        } else {
            shuffledAnswers = Phaser.Utils.Array.Shuffle([...currentPagePairs]);
            console.log('馃幉 浣跨敤闅ㄦ鎺掑垪妯″紡');
        }

        // 馃敟 鍓靛缓宸﹀伌澶栨锛堝寘鍦嶆墍鏈夎嫳鏂囧崱鐗囷級
        this.createMultiColumnContainerBox(
            leftAreaStartX,
            leftAreaStartY,
            cardWidth,
            cardHeight,
            horizontalSpacing,
            leftVerticalSpacing,  // 馃敟 鑻辨枃鍗＄墖浣跨敤 leftVerticalSpacing
            columns,
            rows
        );

        // 馃敟 涓嶅壍寤哄彸鍋村妗嗭紙涓枃鍗＄墖涓嶉渶瑕佸妗嗭級

        // 馃敟 鍓靛缓宸﹀伌鑻辨枃鍗＄墖锛堝琛?2 鍒楋紝鎸夌収闋嗗簭鍑虹従鍕曠暙锛?        currentPagePairs.forEach((pair, index) => {
            const col = index % columns;
            const row = Math.floor(index / columns);
            const x = leftAreaStartX + col * (cardWidth + horizontalSpacing) + cardWidth / 2;
            const y = leftAreaStartY + row * (cardHeight + leftVerticalSpacing) + cardHeight / 2;  // 馃敟 鑻辨枃鍗＄墖浣跨敤 leftVerticalSpacing

            const animationDelay = index * 100;  // 馃敟 姣忓€嬪崱鐗囧欢閬?100ms
            const card = this.createLeftCard(x, y, cardWidth, cardHeight, pair.question, pair.id, animationDelay, pair.imageUrl, pair.audioUrl);
            this.leftCards.push(card);
        });

        // 馃敟 鍓靛缓鍙冲伌涓枃鍗＄墖锛堝琛?2 鍒楋級
        shuffledAnswers.forEach((pair, index) => {
            const col = index % columns;
            const row = Math.floor(index / columns);
            const x = rightAreaStartX + col * (cardWidth + horizontalSpacing) + cardWidth / 2;
            const y = rightAreaStartY + row * (cardHeight + rightVerticalSpacing) + cardHeight / 2;  // 馃敟 涓枃鍗＄墖浣跨敤 rightVerticalSpacing

            // 馃敟 鏍规摎鍒楄櫉姹哄畾鏂囧瓧浣嶇疆锛氱涓€鍒楋紙col=0锛夋枃瀛楀湪宸﹂倞锛岀浜屽垪锛坈ol=1锛夋枃瀛楀湪鍙抽倞
            const textPosition = col === 0 ? 'left' : 'right';
            const card = this.createRightCard(x, y, cardWidth, cardHeight, pair.answer, pair.id, textPosition);
            this.rightCards.push(card);
        });

        console.log('鉁?宸﹀彸鍒嗛洟浣堝眬锛堝琛?鍒楋級鍓靛缓瀹屾垚');
    }

    // 馃敟 鍓靛缓涓婁笅鍒嗛洟浣堝眬 - 澶氳澶氬垪锛?1-30鍊嬪尮閰嶆暩锛?    createTopBottomMultiRows(currentPagePairs, width, height) {
        console.log('馃搻 鍓靛缓涓婁笅鍒嗛洟浣堝眬 - 澶氳澶氬垪锛?1-30鍊嬪尮閰嶆暩锛?);

        const itemCount = currentPagePairs.length;

        // 馃敟 妾㈡脯瀹瑰櫒楂樺害
        const isSmallContainer = height < 600;
        const isMediumContainer = height >= 600 && height < 800;

        console.log(`馃搻 瀹瑰櫒灏哄: ${width} 脳 ${height}`, {
            isSmallContainer,
            isMediumContainer,
            isLargeContainer: height >= 800
        });

        // 馃敟 鏍规摎鍖归厤鏁歌▓绠楄鍒楁暩
        let rows, columns;
        if (itemCount <= 24) {
            // 21-24 鍊嬶細3 琛?脳 8 鍒?            rows = 3;
            columns = 8;
        } else {
            // 25-30 鍊嬶細3 琛?脳 10 鍒?            rows = 3;
            columns = 10;
        }

        console.log(`馃搳 鍖归厤鏁? ${itemCount}, 浣跨敤 ${rows} 琛?脳 ${columns} 鍒椾綀灞€`);

        // 馃敟 鏍规摎瀹瑰櫒澶у皬鍜屽垪鏁歌鏁村崱鐗囧昂瀵?        let cardWidth, cardHeight;
        if (isSmallContainer) {
            cardWidth = Math.max(50, Math.min(85, width * (0.85 / columns)));
            cardHeight = Math.max(28, Math.min(42, height * 0.11));
        } else if (isMediumContainer) {
            cardWidth = Math.max(60, Math.min(95, width * (0.88 / columns)));
            cardHeight = Math.max(32, Math.min(48, height * 0.12));
        } else {
            cardWidth = Math.max(70, Math.min(105, width * (0.9 / columns)));
            cardHeight = Math.max(35, Math.min(55, height * 0.13));
        }

        console.log(`馃搻 鍗＄墖灏哄: ${cardWidth.toFixed(0)} 脳 ${cardHeight.toFixed(0)}`);

        // 馃敟 瑷堢畻闁撹窛
        const horizontalSpacing = Math.max(3, width * 0.005);

        // 馃敟 瑷堢畻鏂囧瓧楂樺害鍜屼竴鍊嬪瓧鐨勯枔璺濓紙鐢ㄦ柤涓嬫柟涓枃鍗＄墖锛?        const textHeight = Math.max(24, Math.min(48, cardHeight * 0.6));
        const oneCharSpacing = textHeight;

        // 馃敟 鑻辨枃鍗＄墖鐨勫瀭鐩撮枔璺濓紙涓嶅姞鏂囧瓧楂樺害锛?        const topVerticalSpacing = Math.max(3, height * 0.01);

        // 馃敟 涓枃鍗＄墖鐨勫瀭鐩撮枔璺濓紙鍔犳枃瀛楅珮搴?+ 涓€鍊嬪瓧鐨勯枔璺濓級
        const bottomVerticalSpacing = textHeight + oneCharSpacing + Math.max(3, height * 0.01);

        // 馃敟 瑷堢畻涓婃柟鍗€鍩燂紙鑻辨枃锛夌殑璧峰浣嶇疆
        const topAreaStartX = (width - (columns * cardWidth + (columns - 1) * horizontalSpacing)) / 2;
        const topAreaStartY = height * 0.08;

        // 馃敟 瑷堢畻涓婃柟鍗€鍩熺殑绺介珮搴?        const topAreaHeight = rows * cardHeight + (rows - 1) * topVerticalSpacing;

        // 馃敟 瑷堢畻涓嬫柟鍗€鍩熺殑绺介珮搴︼紙鍖呭惈鏂囧瓧锛?        const bottomAreaHeight = rows * cardHeight + (rows - 1) * bottomVerticalSpacing;

        // 馃敟 瑷堢畻涓嬫柟鍗€鍩燂紙涓枃锛夌殑璧峰浣嶇疆锛岀⒑淇濇墍鏈夊収瀹归兘鑳介’绀?        const bottomAreaStartX = topAreaStartX;
        const availableBottomSpace = height - topAreaStartY - topAreaHeight - 10;  // 10px 鐐轰笂涓嬪崁鍩熼枔璺?        const bottomAreaStartY = Math.max(
            topAreaStartY + topAreaHeight + 10,  // 鑷冲皯鍦ㄤ笂鏂瑰崁鍩熶笅鏂?10px
            height - bottomAreaHeight - 10  // 纰轰繚涓嬫柟鍗€鍩熷畬鍏ㄩ’绀?        );

        console.log(`馃搷 鍗€鍩熶綅缃?`, {
            topAreaStartX: topAreaStartX.toFixed(0),
            topAreaStartY: topAreaStartY.toFixed(0),
            topAreaHeight: topAreaHeight.toFixed(0),
            bottomAreaStartX: bottomAreaStartX.toFixed(0),
            bottomAreaStartY: bottomAreaStartY.toFixed(0),
            bottomAreaHeight: bottomAreaHeight.toFixed(0),
            availableBottomSpace: availableBottomSpace.toFixed(0)
        });

        // 馃敟 鏍规摎闅ㄦ妯″紡鎺掑垪绛旀
        let shuffledAnswers;
        if (this.random === 'same') {
            const urlParams = new URLSearchParams(window.location.search);
            const activityId = urlParams.get('activityId') || 'default-seed';
            const seed = activityId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const rng = new Phaser.Math.RandomDataGenerator([seed.toString()]);
            shuffledAnswers = rng.shuffle([...currentPagePairs]);
            console.log('馃幉 浣跨敤鍥哄畾闅ㄦ妯″紡锛岀ó瀛?', seed);
        } else {
            shuffledAnswers = Phaser.Utils.Array.Shuffle([...currentPagePairs]);
            console.log('馃幉 浣跨敤闅ㄦ鎺掑垪妯″紡');
        }

        // 馃敟 鍓靛缓涓婃柟澶栨锛堝寘鍦嶆墍鏈夎嫳鏂囧崱鐗囷級
        this.createMultiColumnContainerBox(
            topAreaStartX,
            topAreaStartY,
            cardWidth,
            cardHeight,
            horizontalSpacing,
            topVerticalSpacing,  // 馃敟 鑻辨枃鍗＄墖浣跨敤 topVerticalSpacing
            columns,
            rows
        );

        // 馃敟 涓嶅壍寤轰笅鏂瑰妗嗭紙涓枃鍗＄墖涓嶉渶瑕佸妗嗭級

        // 馃敟 鍓靛缓涓婃柟鑻辨枃鍗＄墖锛堝琛屽鍒楋紝鎸夌収闋嗗簭鍑虹従鍕曠暙锛?        currentPagePairs.forEach((pair, index) => {
            const col = index % columns;
            const row = Math.floor(index / columns);
            const x = topAreaStartX + col * (cardWidth + horizontalSpacing) + cardWidth / 2;
            const y = topAreaStartY + row * (cardHeight + topVerticalSpacing) + cardHeight / 2;  // 馃敟 鑻辨枃鍗＄墖浣跨敤 topVerticalSpacing

            const animationDelay = index * 100;  // 馃敟 姣忓€嬪崱鐗囧欢閬?100ms
            const card = this.createLeftCard(x, y, cardWidth, cardHeight, pair.question, pair.id, animationDelay, pair.imageUrl, pair.audioUrl);
            this.leftCards.push(card);
        });

        // 馃敟 鍓靛缓涓嬫柟涓枃鍗＄墖锛堝琛屽鍒楋級
        shuffledAnswers.forEach((pair, index) => {
            const col = index % columns;
            const row = Math.floor(index / columns);
            const x = bottomAreaStartX + col * (cardWidth + horizontalSpacing) + cardWidth / 2;
            const y = bottomAreaStartY + row * (cardHeight + bottomVerticalSpacing) + cardHeight / 2;  // 馃敟 涓枃鍗＄墖浣跨敤 bottomVerticalSpacing

            const card = this.createRightCard(x, y, cardWidth, cardHeight, pair.answer, pair.id);
            this.rightCards.push(card);
        });

        console.log('鉁?涓婁笅鍒嗛洟浣堝眬锛堝琛屽鍒楋級鍓靛缓瀹屾垚');
    }

    // 馃敟 鍓靛缓娣峰悎缍叉牸浣堝眬锛?1鍊嬩互涓婂尮閰嶆暩锛?    createMixedGridLayout(currentPagePairs, width, height) {
        console.log('馃搻 鍓靛缓娣峰悎缍叉牸浣堝眬锛?1鍊嬩互涓婂尮閰嶆暩锛?);

        const itemCount = currentPagePairs.length;
        const totalCards = itemCount * 2;  // 鑻辨枃 + 涓枃

        // 馃敟 妾㈡脯瀹瑰櫒楂樺害鍜屽搴︼紙v7.0 淇京锛氭牴鎿氬搴﹀垽瀹氾紝涓嶅彧鐪嬮珮搴︼級
        const isMobilePortrait = width < 500;  // 鎵嬫鐩村悜
        const isSmallContainer = height < 500;  // 妤靛皬楂樺害
        const isMediumContainer = height >= 500 && height < 800;

        console.log(`馃搻 瀹瑰櫒灏哄: ${width} 脳 ${height}`, {
            isMobilePortrait,
            isSmallContainer,
            isMediumContainer,
            isLargeContainer: height >= 800,
            totalCards
        });

        // 馃敟 鏍规摎瀹瑰櫒楂樺害鍜岀附鍗＄墖鏁歌▓绠楀垪鏁革紙v7.0 淇京锛氭墜姗熺洿鍚戝劒鍏堜娇鐢?5 鍒楋級
        let columns = 1;

        if (isMobilePortrait) {
            // 馃敟 v7.0 鏂板锛氭墜姗熺洿鍚戯紙瀵害 < 500px锛? 鍎厛浣跨敤 5 鍒?            if (totalCards > 40) {
                columns = 5;  // 41-60 寮靛崱鐗囷細5 鍒?            } else if (totalCards > 30) {
                columns = 5;  // 31-40 寮靛崱鐗囷細5 鍒楋紙鏀圭偤 5 鍒楋級
            } else if (totalCards > 20) {
                columns = 5;  // 21-30 寮靛崱鐗囷細5 鍒楋紙鏀圭偤 5 鍒楋級
            } else {
                columns = 5;  // 20 寮典互涓嬪崱鐗囷細5 鍒楋紙鏀圭偤 5 鍒楋級
            }
        } else if (isSmallContainer) {
            // 灏忓鍣紙楂樺害 < 500px锛夛細鏇存棭鍒囨彌鍒板鍒?            if (totalCards > 40) {
                columns = 5;  // 41-60 寮靛崱鐗囷細5 鍒?            } else if (totalCards > 30) {
                columns = 4;  // 31-40 寮靛崱鐗囷細4 鍒?            } else {
                columns = 3;  // 22-30 寮靛崱鐗囷細3 鍒?            }
        } else if (isMediumContainer) {
            // 涓瓑瀹瑰櫒锛堥珮搴?500-800px锛夛細閬╀腑鐨勫垏鎻涢粸
            if (totalCards > 48) {
                columns = 6;  // 49-60 寮靛崱鐗囷細6 鍒?            } else if (totalCards > 36) {
                columns = 5;  // 37-48 寮靛崱鐗囷細5 鍒?            } else if (totalCards > 24) {
                columns = 4;  // 25-36 寮靛崱鐗囷細4 鍒?            } else {
                columns = 3;  // 22-24 寮靛崱鐗囷細3 鍒?            }
        } else {
            // 澶у鍣紙楂樺害 >= 800px锛夛細杓冩櫄鍒囨彌鍒板鍒?            if (totalCards > 48) {
                columns = 6;  // 49-60 寮靛崱鐗囷細6 鍒?            } else if (totalCards > 36) {
                columns = 5;  // 37-48 寮靛崱鐗囷細5 鍒?            } else {
                columns = 4;  // 22-36 寮靛崱鐗囷細4 鍒?            }
        }

        console.log(`馃搳 绺藉崱鐗囨暩: ${totalCards}, 瀹瑰櫒楂樺害: ${height}px, 浣跨敤 ${columns} 鍒椾綀灞€`);

        // 馃敟 鏍规摎鍒楁暩鍜屽鍣ㄥぇ灏忚鏁村崱鐗囧搴?        let dynamicCardWidth;
        if (isSmallContainer) {
            // 灏忓鍣細鏇村皬鐨勫崱鐗?            dynamicCardWidth = {
                3: Math.max(80, Math.min(120, width * 0.11)),    // 11% 瀵害
                4: Math.max(70, Math.min(100, width * 0.09)),    // 9% 瀵害
                5: Math.max(60, Math.min(85, width * 0.075))     // 7.5% 瀵害
            }[columns];
        } else if (isMediumContainer) {
            // 涓瓑瀹瑰櫒锛氶仼涓殑鍗＄墖
            dynamicCardWidth = {
                3: Math.max(90, Math.min(130, width * 0.115)),   // 11.5% 瀵害
                4: Math.max(75, Math.min(110, width * 0.095)),   // 9.5% 瀵害
                5: Math.max(65, Math.min(95, width * 0.08)),     // 8% 瀵害
                6: Math.max(60, Math.min(85, width * 0.07))      // 7% 瀵害
            }[columns];
        } else {
            // 澶у鍣細杓冨ぇ鐨勫崱鐗?            dynamicCardWidth = {
                4: Math.max(80, Math.min(120, width * 0.1)),     // 10% 瀵害
                5: Math.max(70, Math.min(100, width * 0.085)),   // 8.5% 瀵害
                6: Math.max(60, Math.min(90, width * 0.075))     // 7.5% 瀵害
            }[columns];
        }

        // 馃敟 鏍规摎鍒楁暩鍜屽鍣ㄥぇ灏忚鏁村崱鐗囬珮搴?        let dynamicCardHeight;
        if (isSmallContainer) {
            // 灏忓鍣細鏇村皬鐨勫崱鐗囬珮搴?            dynamicCardHeight = {
                3: Math.max(35, Math.min(50, height * 0.07)),    // 7% 楂樺害
                4: Math.max(32, Math.min(45, height * 0.06)),    // 6% 楂樺害
                5: Math.max(30, Math.min(42, height * 0.055))    // 5.5% 楂樺害
            }[columns];
        } else if (isMediumContainer) {
            // 涓瓑瀹瑰櫒锛氶仼涓殑鍗＄墖楂樺害
            dynamicCardHeight = {
                3: Math.max(38, Math.min(55, height * 0.075)),   // 7.5% 楂樺害
                4: Math.max(34, Math.min(48, height * 0.065)),   // 6.5% 楂樺害
                5: Math.max(32, Math.min(45, height * 0.06)),    // 6% 楂樺害
                6: Math.max(30, Math.min(42, height * 0.055))    // 5.5% 楂樺害
            }[columns];
        } else {
            // 澶у鍣細杓冨ぇ鐨勫崱鐗囬珮搴?            dynamicCardHeight = {
                4: Math.max(35, Math.min(50, height * 0.07)),    // 7% 楂樺害
                5: Math.max(33, Math.min(48, height * 0.065)),   // 6.5% 楂樺害
                6: Math.max(30, Math.min(45, height * 0.06))     // 6% 楂樺害
            }[columns];
        }

        console.log(`馃搻 鍗＄墖灏哄: ${dynamicCardWidth.toFixed(0)} 脳 ${dynamicCardHeight.toFixed(0)}`);

        // 馃敟 鍓靛缓鎵€鏈夊崱鐗囨暩鎿氾紙鑻辨枃 + 涓枃锛?        const allCards = [];

        // 娣诲姞鑻辨枃鍗＄墖
        currentPagePairs.forEach((pair) => {
            allCards.push({
                type: 'question',
                pair: pair,
                text: pair.question,
                pairId: pair.id
            });
        });

        // 娣诲姞涓枃鍗＄墖
        currentPagePairs.forEach((pair) => {
            allCards.push({
                type: 'answer',
                pair: pair,
                text: pair.answer,
                pairId: pair.id
            });
        });

        // 馃敟 鏍规摎闅ㄦ妯″紡鎺掑垪鎵€鏈夊崱鐗?        let shuffledCards;
        if (this.random === 'same') {
            // 鍥哄畾闅ㄦ妯″紡锛氫娇鐢ㄦ椿鍕?ID 浣滅偤绋瓙
            const urlParams = new URLSearchParams(window.location.search);
            const activityId = urlParams.get('activityId') || 'default-seed';
            const seed = activityId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);

            // 浣跨敤鍥哄畾绋瓙鍓靛缓闅ㄦ鏁哥敓鎴愬櫒
            const rng = new Phaser.Math.RandomDataGenerator([seed.toString()]);
            shuffledCards = rng.shuffle(allCards);
            console.log('馃幉 娣峰悎缍叉牸浣跨敤鍥哄畾闅ㄦ妯″紡锛岀ó瀛?', seed);
        } else {
            // 姣忔涓嶅悓妯″紡锛氶毃姗熸帓鍒?            shuffledCards = Phaser.Utils.Array.Shuffle(allCards);
            console.log('馃幉 娣峰悎缍叉牸浣跨敤闅ㄦ鎺掑垪妯″紡');
        }

        // 馃敟 瑷堢畻琛屾暩
        const rows = Math.ceil(totalCards / columns);
        console.log(`馃搳 琛屾暩: ${rows}`);

        // 馃敟 鏍规摎瀹瑰櫒楂樺害鍕曟厠瑾挎暣鍙敤绌洪枔鍜岃捣濮嬩綅缃?        let availableHeightPercent, startYPercent;

        if (isSmallContainer) {
            // 灏忓鍣細浣跨敤鏇村绌洪枔锛屾洿绶婃箠鐨勪綀灞€
            availableHeightPercent = 0.85;  // 浣跨敤 85% 鐨勯珮搴?            startYPercent = 0.05;  // 寰?5% 楂樺害闁嬪
        } else if (isMediumContainer) {
            // 涓瓑瀹瑰櫒锛氬钩琛＄殑浣堝眬
            availableHeightPercent = 0.80;  // 浣跨敤 80% 鐨勯珮搴?            startYPercent = 0.08;  // 寰?8% 楂樺害闁嬪
        } else {
            // 澶у鍣細鑸掗仼鐨勪綀灞€
            availableHeightPercent = 0.75;  // 浣跨敤 75% 鐨勯珮搴?            startYPercent = 0.12;  // 寰?12% 楂樺害闁嬪
        }

        const availableHeight = height * availableHeightPercent;
        const startY = height * startYPercent;

        console.log(`馃搻 浣堝眬鍙冩暩:`, {
            availableHeight: availableHeight.toFixed(0),
            startY: startY.toFixed(0),
            availableHeightPercent: `${(availableHeightPercent * 100).toFixed(0)}%`,
            startYPercent: `${(startYPercent * 100).toFixed(0)}%`
        });

        // 馃敟 瑷堢畻鍨傜洿闁撹窛
        const totalCardHeight = rows * dynamicCardHeight;
        const verticalSpacing = Math.max(3, (availableHeight - totalCardHeight) / (rows + 1));

        console.log(`馃搹 鍨傜洿闁撹窛: ${verticalSpacing.toFixed(1)}px`);

        // 馃敟 瑷堢畻姘村钩闁撹窛
        const horizontalSpacing = Math.max(5, dynamicCardWidth * 0.08);  // 鍗＄墖瀵害鐨?8%锛屾渶灏?5px

        // 馃敟 瑷堢畻缍叉牸璧峰浣嶇疆
        const gridStartX = width * 0.05;  // 寰?5% 浣嶇疆闁嬪
        const gridStartY = startY;

        console.log(`馃搷 缍叉牸浣嶇疆:`, {
            gridStartX: gridStartX.toFixed(0),
            gridStartY: gridStartY.toFixed(0),
            horizontalSpacing: horizontalSpacing.toFixed(1)
        });

        // 馃敟 鍓靛缓娣峰悎缍叉牸鍗＄墖锛堟寜鐓ч爢搴忓嚭鐝惧嫊鐣級
        shuffledCards.forEach((cardData, index) => {
            const col = index % columns;
            const row = Math.floor(index / columns);
            const x = gridStartX + col * (dynamicCardWidth + horizontalSpacing) + dynamicCardWidth / 2;
            const y = gridStartY + row * (dynamicCardHeight + verticalSpacing) + dynamicCardHeight / 2;

            const animationDelay = index * 100;  // 馃敟 姣忓€嬪崱鐗囧欢閬?100ms

            if (cardData.type === 'question') {
                const card = this.createLeftCard(x, y, dynamicCardWidth, dynamicCardHeight, cardData.text, cardData.pairId, animationDelay, cardData.pair.imageUrl, cardData.pair.audioUrl);
                this.leftCards.push(card);
            } else {
                const card = this.createRightCard(x, y, dynamicCardWidth, dynamicCardHeight, cardData.text, cardData.pairId);
                this.rightCards.push(card);
            }
        });

        console.log('鉁?娣峰悎缍叉牸浣堝眬鍓靛缓瀹屾垚');
    }

    // 馃敟 鍓靛缓娣峰悎浣堝眬锛堣嫳鏂囧崱鐗囧拰涓枃妗嗘贩鍚堟帓鍒楋級
    createMixedLayout(currentPagePairs, width, height, cardWidth, cardHeight) {
        console.log('馃幃 鍓靛缓娣峰悎浣堝眬锛堣嫳鏂囧崱鐗囧湪涓枃妗嗗収锛屽彲浜ゆ彌浣嶇疆锛?);

        const itemCount = currentPagePairs.length;

        // ============================================
        // 馃敟 Phase 3锛氫娇鐢?GameResponsiveLayout 绲变竴绠＄悊浣堝眬
        // ============================================

        // 1锔忊儯 妾㈡脯鍦栫墖
        const hasImages = currentPagePairs.some(pair =>
            pair.imageUrl || pair.chineseImageUrl || pair.imageId || pair.chineseImageId
        );
        console.log(`馃攳 [Phase 3] 鍦栫墖妾㈡脯: hasImages=${hasImages}, mode=${hasImages ? '馃煢 姝ｆ柟褰㈡ā寮? : '馃煥 闀锋柟褰㈡ā寮?}`);

        // 2锔忊儯 鍓靛缓浣堝眬寮曟搸
        const isTablet = width >= 768 && width <= 1280;
        const layout = new GameResponsiveLayout(width, height, {
            isIPad: isTablet,
            hasImages: hasImages,
            itemCount: itemCount
        });

        // 3锔忊儯 鐛插彇瀹屾暣閰嶇疆
        const config = layout.getLayoutConfig();
        console.log('馃搻 [Phase 3] 浣堝眬閰嶇疆:', config);

        // ============================================
        // 寰為厤缃腑鎻愬彇鎵€鏈夐渶瑕佺殑鍊?        // ============================================

        // 瑷倷妾㈡脯淇℃伅
        const isMobileDevice = width < 768;
        const isPortraitMode = height > width;
        const isLandscapeMode = width > height;
        const isLandscapeMobile = isLandscapeMode && height < 500;
        const isTinyHeight = height < 400;
        const isIPad = isTablet;
        const iPadSize = config.iPadSize;  // 寰?config 涓嵅鍙?iPad 澶у皬鍒嗛
        const isCompactMode = isMobileDevice || isLandscapeMobile || isTinyHeight;
        const isPortraitCompactMode = isMobileDevice && isPortraitMode;
        const isLandscapeCompactMode = isLandscapeMobile || isTinyHeight;

        console.log('馃摫 闊挎噳寮忔娓?[v38.0 + Phase 3]:', {
            width,
            height,
            isPortraitMode,
            isLandscapeMode,
            isPortraitCompactMode,
            isLandscapeCompactMode,
            isCompactMode,
            isIPad,
            aspectRatio: (width / height).toFixed(2)
        });

        // 馃敟 鏍规摎鍖归厤鏁稿拰妯″紡姹哄畾鍒楁暩鍜屾鐨勫昂瀵?        let cols, frameWidth, totalUnitHeight, cardHeightInFrame, chineseFontSize, chineseTextHeight, verticalSpacing;
        // 馃摑 totalUnitHeight = 鍠厓绺介珮搴︼紙鍖呭惈鑻辨枃鍗＄墖楂樺害 + 涓枃鏂囧瓧楂樺害锛?
        // 馃摑 涓枃鏂囧瓧楂樺害鏈冩牴鎿氭ā寮忓嫊鎱嬭鏁?        // 绶婃箠妯″紡锛?6px瀛楅珨 鈫?~16px楂樺害
        // 姝ｅ父妯″紡锛?8px瀛楅珨 鈫?~18px楂樺害

        // 馃敟 闋愬厛鑱叉槑 chineseFontSizes 璁婇噺锛堢敤鏂煎瓨鍎叉墍鏈変腑鏂囨枃瀛楃殑瀵﹂殯瀛楅珨澶у皬锛?        let chineseFontSizes;

        if (isCompactMode) {
            // 馃摑 绶婃箠妯″紡锛堟墜姗熸┇鍚戞垨妤靛皬楂樺害锛?            // 鐩锛氭笡灏戝瀭鐩寸┖闁撲綌鐢紝澧炲姞鍒楁暩
            console.log('馃摫 浣跨敤绶婃箠妯″紡浣堝眬');

            // 馃敟 v10.0 妾㈡脯鏄惁鏈夊湒鐗囷紙鍙鏈変换浣曚竴鍊嬪湒鐗囧氨閫插叆姝ｆ柟褰㈡ā寮忥級
            const hasImages = currentPagePairs.some(pair =>
                pair.imageUrl || pair.chineseImageUrl || pair.imageId || pair.chineseImageId
            );
            console.log(`馃攳 [v10.0] 绶婃箠妯″紡鍦栫墖妾㈡脯: hasImages=${hasImages}, mode=${hasImages ? '馃煢 姝ｆ柟褰㈡ā寮? : '馃煥 闀锋柟褰㈡ā寮?}`);

            // 馃敟 v18.0锛氬嫊鎱嬪垪鏁歌▓绠?            // 鏍规摎姣忛爜鍖归厤鏁稿嫊鎱嬭鏁村垪鏁稿拰鍗＄墖灏哄
            // 20 鍊?鈫?5 鍒楋紝10 鍊?鈫?4 鍒楋紝5 鍊?鈫?3 鍒?            // 鉁?v37.0锛氭┇鍚戞ā寮忓浐瀹?7 鍒楋紙3 琛岋級
            if (isLandscapeCompactMode) {
                // 姗悜妯″紡锛氬浐瀹?7 鍒楋紙鍏呭垎鍒╃敤瀵害锛?                cols = 7;  // 姗悜妯″紡锛氬浐瀹?7 鍒?            } else {
                // 鐩村悜妯″紡锛氫繚鎸佸師鏈夐倧杓?                if (itemCount >= 16) {
                    cols = 5;  // 16-20 鍊嬶細5 鍒?                } else if (itemCount >= 9) {
                    cols = 4;  // 9-15 鍊嬶細4 鍒?                } else if (itemCount >= 4) {
                    cols = 3;  // 4-8 鍊嬶細3 鍒?                } else {
                    cols = Math.min(itemCount, 2);  // 1-3 鍊嬶細2 鍒楁垨鏇村皯
                }
            }
            cols = Math.min(cols, itemCount);  // 纰轰繚鍒楁暩涓嶈秴閬庨爡鐩暩

            console.log(`馃敟 [v37.0] 鍕曟厠鍒楁暩瑷堢畻: itemCount=${itemCount}, cols=${cols}, isLandscapeCompactMode=${isLandscapeCompactMode}`);

            // 馃敟 v20.0锛氭坊鍔犺┏绱扮殑瑷倷灏哄鍜屽楂樻瘮瑾胯│淇℃伅
            const aspectRatio = width / height;
            console.log(`馃摫 [v20.0] 瑷倷灏哄鍜屽楂樻瘮瑭崇窗淇℃伅:`, {
                width,
                height,
                aspectRatio: aspectRatio.toFixed(3),
                isPortraitMode,
                isLandscapeMode,
                isPortraitCompactMode,
                isLandscapeCompactMode,
                deviceType: width < 768 ? '鎵嬫' : width < 1024 ? '骞虫澘' : '妗岄潰',
                screenCategory: aspectRatio > 1.5 ? '瀵灑骞? : aspectRatio > 1.2 ? '妯欐簴铻㈠箷' : '鐩村悜铻㈠箷'
            });

            // 瑷堢畻琛屾暩
            const rows = Math.ceil(itemCount / cols);

            // 馃摑 瑷堢畻鍙敤鍨傜洿绌洪枔
            const topBottomMargin = 30;  // 涓婁笅閭婅窛
            const minVerticalSpacing = 2;  // 鏈€灏忓瀭鐩撮枔璺?            const availableHeight = height - topBottomMargin;  // 鍙敤楂樺害

            // 馃摑 瑷堢畻姣忚鐨勯珮搴︼紙鍒濇浼扮畻锛?            // 鍏紡锛?鍙敤楂樺害 - 闁撹窛绺藉拰) / 琛屾暩
            const rowHeight = (availableHeight - minVerticalSpacing * (rows + 1)) / rows;

            // 馃摑 鏍规摎鍒楁暩鍕曟厠瑷堢畻鏈€澶у崱鐗囬珮搴?            // 馃敟 v19.0锛氭牴鎿氬垪鏁歌嚜鍕曡鏁村崱鐗囧昂瀵?            // 5 鍒楋細65px锛? 鍒楋細75px锛? 鍒楋細85px锛? 鍒楋細95px
            let maxCardHeight;
            let chineseTextHeightBase;
            let verticalSpacingBase;

            if (isPortraitCompactMode) {
                // 馃敟 v19.0锛氭墜姗熺洿鍚?- 鏍规摎鍒楁暩鍕曟厠瑾挎暣
                if (cols === 5) {
                    // 5 鍒楋細绶婃箠鎺掑垪锛圵ordwall 棰ㄦ牸锛?                    maxCardHeight = hasImages ? 65 : 50;
                    chineseTextHeightBase = 18;
                    verticalSpacingBase = 3;
                } else if (cols === 4) {
                    // 4 鍒楋細涓瓑鎺掑垪
                    maxCardHeight = hasImages ? 75 : 60;
                    chineseTextHeightBase = 20;
                    verticalSpacingBase = 3;
                } else if (cols === 3) {
                    // 3 鍒楋細瀵瑔鎺掑垪
                    maxCardHeight = hasImages ? 85 : 70;
                    chineseTextHeightBase = 22;
                    verticalSpacingBase = 4;
                } else {
                    // 2 鍒楁垨鏇村皯锛氭渶瀵瑔鎺掑垪
                    maxCardHeight = hasImages ? 95 : 80;
                    chineseTextHeightBase = 24;
                    verticalSpacingBase = 5;
                }
                console.log('馃摫 [v19.0] 鎵嬫鐩村悜妯″紡 - 鏍规摎鍒楁暩瑾挎暣鍗＄墖灏哄:', { cols, maxCardHeight, chineseTextHeightBase, verticalSpacingBase });
            } else if (isLandscapeCompactMode) {
                // 馃敟 v19.0锛氭墜姗熸┇鍚?- 鏍规摎鍒楁暩鍕曟厠瑾挎暣锛堟洿绶婃箠锛?                // 鉁?v37.0锛氭坊鍔?7 鍒楃殑瑷畾
                if (cols === 7) {
                    maxCardHeight = hasImages ? 40 : 30;
                    chineseTextHeightBase = 10;
                    verticalSpacingBase = 1;
                } else if (cols === 6) {
                    maxCardHeight = hasImages ? 45 : 35;
                    chineseTextHeightBase = 11;
                    verticalSpacingBase = 2;
                } else if (cols === 5) {
                    maxCardHeight = hasImages ? 50 : 40;
                    chineseTextHeightBase = 12;
                    verticalSpacingBase = 2;
                } else if (cols === 4) {
                    maxCardHeight = hasImages ? 60 : 50;
                    chineseTextHeightBase = 14;
                    verticalSpacingBase = 2;
                } else if (cols === 3) {
                    maxCardHeight = hasImages ? 70 : 60;
                    chineseTextHeightBase = 16;
                    verticalSpacingBase = 3;
                } else {
                    maxCardHeight = hasImages ? 80 : 70;
                    chineseTextHeightBase = 18;
                    verticalSpacingBase = 3;
                }
                console.log('馃摫 [v37.0] 鎵嬫姗悜妯″紡 - 鏍规摎鍒楁暩瑾挎暣鍗＄墖灏哄:', { cols, maxCardHeight, chineseTextHeightBase, verticalSpacingBase });
            } else {
                // 鍏朵粬妯″紡锛堜笉鎳夎┎鍩疯鍒伴€欒！锛?                maxCardHeight = hasImages ? 65 : 50;
                chineseTextHeightBase = 18;
                verticalSpacingBase = 3;
            }

            // 馃敟 瑷堢畻妗嗗搴?            // v10.0锛氬鏋滄湁鍦栫墖锛屾瀵害 = 鍗＄墖楂樺害锛堟鏂瑰舰锛夛紱鍚﹀墖妗嗗搴?> 鍗＄墖楂樺害锛堥暦鏂瑰舰锛?            // 馃敟 v23.0锛氭牴鎿氬垪鏁稿嫊鎱嬭鏁撮倞璺濓紝纰轰繚 5 鍒楀崱鐗囧湪 iPhone 14 (390px) 涓婂畬鏁撮’绀?            // iPhone 14 鐩村悜 (390px) 鎳夎┎鏈?330px 鍙敤瀵害锛屾墍浠ラ倞璺濇噳瑭叉槸 30px 脳 2 = 60px
            let horizontalMargin;
            // 鉁?v37.0锛氱偤 7 鍒楁坊鍔犻倞璺濊ō瀹?            if (cols === 7) {
                // 7 鍒楋細鏈€灏忛倞璺濓紙10px锛? 姗悜妯″紡鍏呭垎鍒╃敤瀵害
                horizontalMargin = 10;
            } else if (cols === 6) {
                // 6 鍒楋細杓冨皬閭婅窛锛?5px锛?                horizontalMargin = 15;
            } else if (cols === 5) {
                // 5 鍒楋細閭婅窛 = 30px锛堢⒑淇?390px 瀵害涓嬫湁 330px 鍙敤瀵害锛?                horizontalMargin = 30;
            } else if (cols === 4) {
                // 4 鍒楋細涓瓑閭婅窛锛?0px锛?                horizontalMargin = 20;
            } else {
                // 3 鍒楁垨鏇村皯锛氳純澶ч倞璺濓紙25px锛?                horizontalMargin = 25;
            }

            const maxFrameWidth = hasImages
                ? (itemCount <= 5 ? 280 : itemCount <= 10 ? 230 : itemCount <= 20 ? 180 : 250)  // 姝ｆ柟褰㈡ā寮?                : (itemCount <= 5 ? 280 : itemCount <= 10 ? 230 : itemCount <= 20 ? 180 : 250);  // 闀锋柟褰㈡ā寮?            frameWidth = hasImages
                ? Math.min(maxCardHeight, (width - 2 * horizontalMargin) / cols)  // 姝ｆ柟褰細frameWidth = cardHeight
                : Math.min(maxFrameWidth, (width - 2 * horizontalMargin) / cols);  // 闀锋柟褰細frameWidth 鍙互鏇村

            // 馃敟 鏅鸿兘闋愬厛瑷堢畻鎵€鏈変腑鏂囨枃瀛楃殑瀵﹂殯瀛楅珨澶у皬
            console.log('馃攳 闁嬪闋愬厛瑷堢畻涓枃瀛楅珨澶у皬...');
            const tempCardHeight = Math.min(maxCardHeight, Math.max(20, Math.floor(rowHeight * 0.6)));  // 鑷ㄦ檪鍗＄墖楂樺害
            chineseFontSizes = currentPagePairs.map(pair => {
                // 鉁?v27.2锛氳▓绠楀垵濮嬪瓧楂斿ぇ灏忥紙鏀圭偤 脳 0.4锛?                let fontSize = Math.max(24, Math.min(48, tempCardHeight * 0.4));

                // 鉁?v27.0锛氭牴鎿氭枃瀛楅暦搴﹁鏁村瓧楂斿ぇ灏忥紙1-2瀛楃浉鍚岋紝3-4瀛楃府灏忥級
                const textLength = pair.answer ? pair.answer.length : 0;
                if (textLength <= 2) {
                    fontSize = fontSize * 1.0;  // 1-2 鍊嬪瓧锛?00%锛堜繚鎸佸師澶у皬锛?                } else if (textLength <= 4) {
                    fontSize = fontSize * 0.8;  // 3-4 鍊嬪瓧锛氱府灏?20%
                } else if (textLength <= 6) {
                    fontSize = fontSize * 0.7;  // 5-6 鍊嬪瓧锛氱府灏?30%
                } else {
                    fontSize = fontSize * 0.6;  // 7+ 鍊嬪瓧锛氱府灏?40%
                }
                fontSize = Math.max(18, fontSize);  // 鏈€灏忓瓧楂斿ぇ灏?18px

                // 鍓靛缓鑷ㄦ檪鏂囧瓧灏嶈薄渚嗘脯閲忓搴?                const tempText = this.add.text(0, 0, pair.answer, {
                    fontSize: `${fontSize}px`,
                    fontFamily: 'Arial',
                    fontStyle: 'bold'
                });

                // 濡傛灉鏂囧瓧瀵害瓒呴亷妗嗗搴︾殑 85%锛岄€蹭竴姝ョ府灏忓瓧楂?                const maxTextWidth = (frameWidth - 10) * 0.85;
                while (tempText.width > maxTextWidth && fontSize > 14) {
                    fontSize -= 1;
                    tempText.setFontSize(fontSize);
                }

                // 閵锋瘈鑷ㄦ檪鏂囧瓧灏嶈薄
                tempText.destroy();

                return fontSize;
            });

            // 鎵惧嚭鏈€澶х殑瀛楅珨澶у皬
            const maxChineseFontSize = Math.max(...chineseFontSizes);
            const minChineseFontSize = Math.min(...chineseFontSizes);
            const avgChineseFontSize = (chineseFontSizes.reduce((a, b) => a + b, 0) / chineseFontSizes.length).toFixed(1);

            console.log('馃搳 涓枃瀛楅珨澶у皬绡勫湇:', {
                min: minChineseFontSize,
                max: maxChineseFontSize,
                average: avgChineseFontSize,
                allSizes: chineseFontSizes
            });

            // 馃敟 v19.0锛氭牴鎿氬垪鏁稿嫊鎱嬭鏁翠腑鏂囨枃瀛楅珮搴﹀拰闁撹窛
            let dynamicVerticalSpacing;

            // 浣跨敤涔嬪墠瑷堢畻鐨勫熀绀庡€?            chineseTextHeight = chineseTextHeightBase;
            dynamicVerticalSpacing = verticalSpacingBase;

            // 鏍规摎鍒楁暩瑾挎暣瀛楅珨澶у皬闄愬埗
            let maxFontSizeLimit;
            if (cols === 5) {
                maxFontSizeLimit = isPortraitCompactMode ? 15 : 12;
            } else if (cols === 4) {
                maxFontSizeLimit = isPortraitCompactMode ? 17 : 14;
            } else if (cols === 3) {
                maxFontSizeLimit = isPortraitCompactMode ? 19 : 16;
            } else {
                maxFontSizeLimit = isPortraitCompactMode ? 21 : 18;
            }

            chineseFontSize = `${Math.min(maxChineseFontSize, maxFontSizeLimit)}px`;

            console.log('馃摫 [v19.0] 鏍规摎鍒楁暩瑾挎暣涓枃鏂囧瓧:', {
                cols,
                chineseTextHeight,
                chineseFontSize,
                dynamicVerticalSpacing,
                maxFontSizeLimit
            });

            console.log('馃搻 鍕曟厠鍨傜洿闁撹窛:', {
                chineseTextHeight,
                dynamicVerticalSpacing,
                formula: `max(5, ${maxChineseFontSize} * 0.2) = ${dynamicVerticalSpacing}`
            });

            // 馃敟 v23.0锛氭坊鍔犻倞璺濊瑭︿俊鎭?            console.log('馃敟 [v23.0] 閭婅窛瑷堢畻:', {
                cols,
                width,
                horizontalMargin,
                availableWidth: width - 2 * horizontalMargin,
                frameWidth,
                totalFrameWidth: frameWidth * cols,
                formula: `horizontalMargin = ${cols === 5 ? 30 : cols === 4 ? 20 : 25}px (鍥哄畾鍊?`
            });

            // 鉁?v26.0锛氬厛瑷堢畻 dynamicVerticalSpacing锛屼互渚垮湪 cardHeightInFrame 瑷堢畻涓娇鐢?            // 鍨傜洿闁撹窛 = 鍙敤楂樺害 脳 0.03锛堢瘎鍦?10-40px锛?            dynamicVerticalSpacing = Math.max(10, Math.min(40, availableHeight * 0.03));

            // 閲嶆柊瑷堢畻鍗＄墖楂樺害锛堣€冩叜瀵﹂殯鐨勪腑鏂囨枃瀛楅珮搴︼級
            // 馃敟 v10.0锛氬鏋滄湁鍦栫墖锛宑ardHeightInFrame = frameWidth锛堟鏂瑰舰锛夛紱鍚﹀墖鏍规摎鍙敤绌洪枔瑷堢畻
            if (hasImages) {
                // 姝ｆ柟褰㈡ā寮忥細鍗＄墖楂樺害 = 妗嗗搴?                cardHeightInFrame = frameWidth;
                console.log(`馃敟 [v10.0] 姝ｆ柟褰㈡ā寮忥細cardHeightInFrame = frameWidth = ${frameWidth}`);
            } else {
                // 闀锋柟褰㈡ā寮忥細鏍规摎鍙敤绌洪枔瑷堢畻
                cardHeightInFrame = Math.min(maxCardHeight, Math.max(20, Math.floor(rowHeight - chineseTextHeight - dynamicVerticalSpacing)));
                console.log(`馃敟 [v10.0] 闀锋柟褰㈡ā寮忥細cardHeightInFrame = ${cardHeightInFrame}`);
            }

            // 鉁?v25.0锛氬湪 cardHeightInFrame 瑷堢畻瀹屾垚寰岋紝浣跨敤鍕曟厠瑷堢畻鑰屼笉鏄浐瀹氬€?            // 鉁?v29.0锛氭柟妗?B - 澧炲姞闋愮暀绲︿腑鏂囧瓧鐨勯珮搴︼紙寰?脳 0.4 鏀圭偤 脳 0.5锛?            // 涓枃鏂囧瓧楂樺害 = 鍗＄墖楂樺害 脳 0.5锛堢⒑淇濅腑鏂囧瓧鏈夎冻澶犵┖闁擄級
            chineseTextHeight = cardHeightInFrame * 0.5;

            // 鉁?v26.0锛氭柟妗?A - 鍦ㄨ嫳鏂囧崱鐗囧拰涓枃瀛椾箣闁撳姞鍏?verticalSpacing
            // 馃摑 鍠厓绺介珮搴?= 鑻辨枃鍗＄墖楂樺害 + verticalSpacing + 涓枃鏂囧瓧楂樺害 + verticalSpacing
            // 鉁?v27.3锛氫繚鎸佸師濮嬬祼妲嬶紝涓婁笅閮芥湁 verticalSpacing
            // 鉁?v35.0锛氬彇娑堜笂闈㈢殑 verticalSpacing锛堝彧淇濈暀涓嬮潰鐨勶級
            totalUnitHeight = cardHeightInFrame + chineseTextHeight + dynamicVerticalSpacing;

            // 馃敟 v15.0锛氬皣 dynamicVerticalSpacing 璩﹀€肩郸 verticalSpacing锛屼互渚垮緦绾屼娇鐢?            verticalSpacing = dynamicVerticalSpacing;
            console.log('馃敟 [v15.0] 绶婃箠妯″紡 verticalSpacing 宸茶ō缃?', { dynamicVerticalSpacing, verticalSpacing, isPortraitCompactMode });

            console.log('馃敟 绶婃箠妯″紡鏅鸿兘鍕曟厠灏哄 [v10.0]:', {
                rows,
                availableHeight,
                rowHeight,
                maxCardHeight,
                cardHeightInFrame,
                maxFrameWidth,
                frameWidth,
                chineseTextHeight,
                dynamicVerticalSpacing,
                totalUnitHeight,
                ratio: (frameWidth / cardHeightInFrame).toFixed(1) + ':1',
                mode: hasImages ? '馃煢 姝ｆ柟褰㈡ā寮? : '馃煥 闀锋柟褰㈡ā寮?
            });
        } else {
            // 馃敟 妗岄潰鍕曟厠闊挎噳寮忎綀灞€锛堝惈鎸夐垥绌洪枔锛?            console.log('馃枼锔?浣跨敤妗岄潰鍕曟厠闊挎噳寮忎綀灞€锛堝惈鎸夐垥绌洪枔锛?);

            // 馃敟 绗浂姝ワ細妾㈡脯鏄惁鏈夊湒鐗?            const hasImages = currentPagePairs.some(pair =>
                pair.imageUrl || pair.chineseImageUrl || pair.imageId || pair.chineseImageId
            );

            // 馃敟 v8.0 瑭崇窗瑾胯│锛氭鏌ユ瘡鍊嬪崱鐗囩殑鍦栫墖瀛楁
            console.log('馃攳 瑭崇窗鍦栫墖妾㈡脯:', {
                totalPairs: currentPagePairs.length,
                hasImages,
                mode: hasImages ? '馃煢 姝ｆ柟褰㈡ā寮? : '馃煥 闀锋柟褰㈡ā寮?,
                pairDetails: currentPagePairs.slice(0, 3).map((pair, idx) => ({
                    index: idx,
                    imageUrl: pair.imageUrl,
                    chineseImageUrl: pair.chineseImageUrl,
                    imageId: pair.imageId,
                    chineseImageId: pair.chineseImageId,
                    hasAnyImage: !!(pair.imageUrl || pair.chineseImageUrl || pair.imageId || pair.chineseImageId)
                }))
            });

            // ============================================================================
            // 鉁?v42.0锛歩Pad 瀹瑰櫒澶у皬鍒嗛绯荤当 - 鏍规摎瀹瑰櫒澶у皬鍕曟厠瑾挎暣鎵€鏈夊弮鏁?            // ============================================================================

            // 馃敟 绗竴姝ワ細iPad 瀹瑰櫒澶у皬鍒嗛鍑芥暩
            // 鉁?v42.2锛氭牴鎿氬搴﹀拰楂樺害鐨勭祫鍚堝垎椤烇紝鑰屼笉鏄彧鐪嬪搴?            // 閫欐ǎ 768脳1024 鍜?1024脳768 鏈冭鍒嗛鐐哄悓涓€鍊嬭ō鍌?            function classifyIPadSize(w, h) {
                // 鐛插彇瀵害鍜岄珮搴︾殑鏈€灏忓€煎拰鏈€澶у€?                const minDim = Math.min(w, h);
                const maxDim = Math.max(w, h);

                // 鏍规摎鏈€灏忓昂瀵稿垎椤炶ō鍌?                // iPad mini: 768脳1024 鎴?1024脳768 鈫?minDim = 768
                // iPad: 810脳1080 鎴?1080脳810 鈫?minDim = 810
                // iPad Air: 820脳1180 鎴?1180脳820 鈫?minDim = 820
                // iPad Pro 11": 834脳1194 鎴?1194脳834 鈫?minDim = 834
                // iPad Pro 12.9": 1024脳1366 鎴?1366脳1024 鈫?minDim = 1024

                let deviceSize;
                if (minDim <= 768) {
                    deviceSize = 'small';       // iPad mini: 768
                } else if (minDim <= 810) {
                    deviceSize = 'medium';      // iPad: 810
                } else if (minDim <= 820) {
                    deviceSize = 'medium_large'; // iPad Air: 820
                } else if (minDim <= 834) {
                    deviceSize = 'large';       // iPad Pro 11": 834
                } else {
                    deviceSize = 'xlarge';      // iPad Pro 12.9": 1024
                }

                // 鏍规摎鏂瑰悜娣诲姞寰岀洞
                const aspectRatio = w / h;
                const isPortrait = aspectRatio < 1;
                const orientation = isPortrait ? '_portrait' : '_landscape';

                return deviceSize + orientation;
            }

            // 馃敟 绗簩姝ワ細鏍规摎 iPad 澶у皬鐛插彇鏈€鍎弮鏁?            // 鉁?v42.2锛氭牴鎿氳ō鍌欏皪瑙掔窔闀峰害鍜屾柟鍚戣ō缃弮鏁?            function getIPadOptimalParams(iPadSize) {
                const params = {
                    // 璞庡睆妯″紡锛堥珮搴?> 瀵害锛?                    small_portrait: {
                        sideMargin: 15,
                        topButtonArea: 35,
                        bottomButtonArea: 35,
                        horizontalSpacing: 12,
                        verticalSpacing: 30,
                        chineseFontSize: 22
                    },
                    medium_portrait: {
                        sideMargin: 18,
                        topButtonArea: 38,
                        bottomButtonArea: 38,
                        horizontalSpacing: 14,
                        verticalSpacing: 32,
                        chineseFontSize: 26
                    },
                    medium_large_portrait: {
                        sideMargin: 20,
                        topButtonArea: 40,
                        bottomButtonArea: 40,
                        horizontalSpacing: 15,
                        verticalSpacing: 35,
                        chineseFontSize: 28
                    },
                    large_portrait: {
                        sideMargin: 22,
                        topButtonArea: 42,
                        bottomButtonArea: 42,
                        horizontalSpacing: 16,
                        verticalSpacing: 37,
                        chineseFontSize: 30
                    },
                    xlarge_portrait: {
                        sideMargin: 25,
                        topButtonArea: 45,
                        bottomButtonArea: 45,
                        horizontalSpacing: 18,
                        verticalSpacing: 40,
                        chineseFontSize: 34
                    },
                    // 姗睆妯″紡锛堝搴?> 楂樺害锛?                    small_landscape: {
                        sideMargin: 12,
                        topButtonArea: 30,
                        bottomButtonArea: 30,
                        horizontalSpacing: 10,
                        verticalSpacing: 25,
                        chineseFontSize: 20
                    },
                    medium_landscape: {
                        sideMargin: 15,
                        topButtonArea: 32,
                        bottomButtonArea: 32,
                        horizontalSpacing: 12,
                        verticalSpacing: 28,
                        chineseFontSize: 24
                    },
                    medium_large_landscape: {
                        sideMargin: 17,
                        topButtonArea: 34,
                        bottomButtonArea: 34,
                        horizontalSpacing: 13,
                        verticalSpacing: 30,
                        chineseFontSize: 26
                    },
                    large_landscape: {
                        sideMargin: 19,
                        topButtonArea: 36,
                        bottomButtonArea: 36,
                        horizontalSpacing: 14,
                        verticalSpacing: 32,
                        chineseFontSize: 28
                    },
                    xlarge_landscape: {
                        sideMargin: 20,
                        topButtonArea: 38,
                        bottomButtonArea: 38,
                        horizontalSpacing: 16,
                        verticalSpacing: 35,
                        chineseFontSize: 32
                    }
                };
                return params[iPadSize];
            }

            // 馃敟 绗笁姝ワ細瀹氱京鎸夐垥鍗€鍩熷拰閭婅窛
            // 鉁?Phase 3锛氫娇鐢?GameResponsiveLayout 鐨勯厤缃?            const margins = config.margins;
            const topButtonAreaHeight = margins.top;
            const bottomButtonAreaHeight = margins.bottom;
            const sideMargin = margins.side;

            console.log('馃搻 [Phase 3] 閭婅窛閰嶇疆:', {
                top: topButtonAreaHeight,
                bottom: bottomButtonAreaHeight,
                side: sideMargin
            });

            // 馃敟 绗洓姝ワ細瑷堢畻鍙敤绌洪枔锛堟墸闄ゆ寜閳曞崁鍩燂級
            // 鉁?Phase 3锛氫娇鐢?GameResponsiveLayout 鐨勯厤缃?            const availableWidth = config.availableWidth;
            const availableHeight = config.availableHeight;

            // 馃敟 绗簲姝ワ細瑷堢畻铻㈠箷瀵珮姣斿拰闁撹窛
            const aspectRatio = width / height;

            // 馃敟 绗叚姝ワ細瑷堢畻姘村钩鍜屽瀭鐩撮枔璺?            // 鉁?Phase 3锛氫娇鐢?GameResponsiveLayout 鐨勯厤缃?            const gaps = config.gaps;
            const horizontalSpacing = gaps.horizontal;
            const verticalSpacing = gaps.vertical;

            console.log('馃搻 [Phase 3] 闁撹窛閰嶇疆:', {
                horizontal: horizontalSpacing,
                vertical: verticalSpacing,
                availableWidth: availableWidth,
                availableHeight: availableHeight
            });

            if (hasImages) {
                // 馃煢 姝ｆ柟褰㈡ā寮忥紙鏈夊湒鐗囷級
                console.log('馃煢 浣跨敤姝ｆ柟褰㈠崱鐗囨ā寮?);

                // 鉁?Phase 3锛氫娇鐢?GameResponsiveLayout 鐨勯厤缃?                // 鎵€鏈夎闆滅殑鍗＄墖澶у皬瑷堢畻宸插湪 GameResponsiveLayout 涓畬鎴?                const cardSize = config.cardSize;  // { width, height }
                const cardWidth = config.cardWidth;
                const cardHeight = config.cardHeight;
                const optimalCols = config.cols;
                const optimalRows = config.rows;

                console.log('馃搻 [Phase 3] 姝ｆ柟褰㈠崱鐗囬厤缃?', {
                    cardSize: `${cardWidth.toFixed(1)}脳${cardHeight.toFixed(1)}`,
                    cols: optimalCols,
                    rows: optimalRows,
                    totalCards: itemCount
                });

                // 鉁?Phase 3锛氫娇鐢?GameResponsiveLayout 瑷堢畻鐨勫崱鐗囧昂瀵?                // 鎵€鏈夎闆滅殑杩唬瑷堢畻宸插湪 GameResponsiveLayout 涓畬鎴?                const squareSize = cardWidth;  // 姝ｆ柟褰㈡ā寮忥細瀵害 = 楂樺害
                cols = optimalCols;
                const rows = optimalRows;

                // 馃敟 绗崄涓€姝ワ細瑷疆鍗＄墖灏哄锛堟鏂瑰舰锛?                frameWidth = squareSize;
                cardHeightInFrame = squareSize;
                chineseTextHeight = squareSize * 0.4;  // 涓枃鏂囧瓧楂樺害鐐哄崱鐗囬珮搴︾殑40%
                totalUnitHeight = cardHeightInFrame + chineseTextHeight + verticalSpacing;  // = squareSize * 1.4 + verticalSpacing

                console.log('馃煢 姝ｆ柟褰㈠崱鐗囦綀灞€:', {
                    resolution: `${width}脳${height}`,
                    aspectRatio: aspectRatio.toFixed(2),
                    topButtonArea: topButtonAreaHeight.toFixed(1),
                    bottomButtonArea: bottomButtonAreaHeight.toFixed(1),
                    sideMargin: sideMargin.toFixed(1),
                    availableWidth: availableWidth.toFixed(1),
                    availableHeight: availableHeight.toFixed(1),
                    cardAreaPercentage: ((availableHeight / height) * 100).toFixed(1) + '%',
                    itemCount,
                    cols,
                    rows,
                    squareSize: squareSize.toFixed(1),
                    frameWidth: frameWidth.toFixed(1),
                    cardHeightInFrame: cardHeightInFrame.toFixed(1),
                    chineseTextHeight: chineseTextHeight.toFixed(1),
                    totalUnitHeight: totalUnitHeight.toFixed(1),
                    cardRatio: '1:1 (姝ｆ柟褰?',
                    screenType: aspectRatio > 2.0 ? '瓒呭铻㈠箷' : aspectRatio > 1.5 ? '瀵灑骞? : aspectRatio > 1.2 ? '妯欐簴铻㈠箷' : '鐩村悜铻㈠箷'
                });
            } else {
                // 馃煥 闀锋柟褰㈡ā寮忥紙鐒″湒鐗囷級
                console.log('馃煥 浣跨敤闀锋柟褰㈠崱鐗囨ā寮?);

                // 鉁?Phase 3锛氫娇鐢?GameResponsiveLayout 鐨勯厤缃?                // 鎵€鏈夎闆滅殑鍗＄墖澶у皬瑷堢畻宸插湪 GameResponsiveLayout 涓畬鎴?                const cardSize = config.cardSize;  // { width, height }
                const cardWidth = config.cardWidth;
                const cardHeight = config.cardHeight;
                const optimalCols = config.cols;
                const optimalRows = config.rows;

                console.log('馃搻 [Phase 3] 闀锋柟褰㈠崱鐗囬厤缃?', {
                    cardWidth: cardWidth.toFixed(1),
                    cardHeight: cardHeight.toFixed(1),
                    cols: optimalCols,
                    rows: optimalRows,
                    totalCards: itemCount
                });

                // 鉁?Phase 3锛氫娇鐢?GameResponsiveLayout 瑷堢畻鐨勫崱鐗囧昂瀵?                cols = optimalCols;
                const rows = optimalRows;

                // 馃敟 绗崄姝ワ細瑷疆鍗＄墖澶у皬锛堜娇鐢?GameResponsiveLayout 瑷堢畻鐨勫€硷級
                frameWidth = cardSize;
                cardHeightInFrame = cardSize * 0.5;  // 闀锋柟褰㈡ā寮忥細楂樺害鐐哄搴︾殑 50%
                chineseTextHeight = cardHeightInFrame * 0.4;  // 涓枃鏂囧瓧楂樺害 = 鍗＄墖楂樺害鐨?40%
                totalUnitHeight = cardHeightInFrame + chineseTextHeight + verticalSpacing;

                console.log('馃煥 闀锋柟褰㈠崱鐗囦綀灞€:', {
                    resolution: `${width}脳${height}`,
                    aspectRatio: aspectRatio.toFixed(2),
                    topButtonArea: topButtonAreaHeight.toFixed(1),
                    bottomButtonArea: bottomButtonAreaHeight.toFixed(1),
                    sideMargin: sideMargin.toFixed(1),
                    availableWidth: availableWidth.toFixed(1),
                    availableHeight: availableHeight.toFixed(1),
                    cardAreaPercentage: ((availableHeight / height) * 100).toFixed(1) + '%',
                    itemCount,
                    cols,
                    rows,
                    maxPossibleCols,
                    maxPossibleRows,
                    frameWidth: frameWidth.toFixed(1),
                    cardHeightInFrame: cardHeightInFrame.toFixed(1),
                    chineseTextHeight: chineseTextHeight.toFixed(1),
                    totalUnitHeight: totalUnitHeight.toFixed(1),
                    cardRatio: (frameWidth / cardHeightInFrame).toFixed(2) + ':1',
                    screenType: aspectRatio > 2.0 ? '瓒呭铻㈠箷' : aspectRatio > 1.5 ? '瀵灑骞? : aspectRatio > 1.2 ? '妯欐簴铻㈠箷' : '鐩村悜铻㈠箷'
                });
            }
        }

        console.log('馃搻 娣峰悎浣堝眬鍙冩暩:', { itemCount, cols, frameWidth, totalUnitHeight, cardHeightInFrame, chineseFontSize, isCompactMode });

        // 馃敟 瑷堢畻闁撹窛鍜岃鏁?        const rows = Math.ceil(itemCount / cols);

        // 馃敟 v23.0锛氬畾缇╂按骞抽倞璺濓紝纰轰繚鍗＄墖涓嶈鍒囧壊
        // 鏍规摎鍒楁暩鍕曟厠瑾挎暣閭婅窛
        let horizontalMargin;
        if (cols === 5) {
            // 5 鍒楋細閭婅窛 = 30px锛堢⒑淇?390px 瀵害涓嬫湁 330px 鍙敤瀵害锛?            horizontalMargin = 30;
        } else if (cols === 4) {
            // 4 鍒楋細涓瓑閭婅窛锛?0px锛?            horizontalMargin = 20;
        } else {
            // 3 鍒楁垨鏇村皯锛氳純澶ч倞璺濓紙25px锛?            horizontalMargin = 25;
        }

        // 馃敟 v23.0锛氬劒鍖栨按骞抽枔璺濊▓绠楋紝纰轰繚鍗＄墖涓嶈鍒囧壊
        // 鍏紡锛?鍙敤瀵害 - 閭婅窛 - 鍗＄墖绺藉搴? / (鍒楁暩 + 1)
        // 鍩烘柤瀵﹂殯鍙敤瀵害锛坵idth - 2 * horizontalMargin锛夎▓绠?        const availableWidth = width - 2 * horizontalMargin;
        const totalCardWidth = frameWidth * cols;
        const availableSpace = availableWidth - totalCardWidth;

        console.log('馃搻 [v23.0] 瀵害瑷堢畻瑭虫儏:', {
            screenWidth: width,
            horizontalMargin,
            availableWidth,
            cols,
            frameWidth,
            totalCardWidth,
            availableSpace,
            note: `iPhone 14 (390px) 鎳夎┎鏈?330px 鍙敤瀵害`
        });

        let horizontalSpacing;
        if (cols === 5) {
            // 5 鍒楋細鏈€灏忛枔璺濓紙1-3px锛夛紝纰轰繚鍦?330px 鍙敤瀵害涓婂畬鏁撮’绀?            horizontalSpacing = Math.max(1, Math.min(3, availableSpace / (cols + 1)));
        } else {
            // 鍏朵粬鍒楁暩锛氫娇鐢ㄨ▓绠楁柟寮?            horizontalSpacing = Math.max(5, availableSpace / (cols + 1));
        }

        // 馃敟 v13.0锛氱穵婀婃ā寮忕殑 verticalSpacing 宸插湪鍓嶉潰瑷疆锛屼笉闇€瑕侀噸鏂拌▓绠?        // 妗岄潰妯″紡鐨?verticalSpacing 宸插湪涓婇潰鐨?if/else 鍒嗘敮涓畾缇?        // 娉ㄦ剰锛氱穵婀婃ā寮忎笅锛寁erticalSpacing 宸茬稉鍦ㄧ 1949 琛屾垨 1956 琛岃ō缃偤 dynamicVerticalSpacing
        // 涓嶈鍦ㄩ€欒！瑕嗚搵瀹冿紒

        // 馃敟 瑷堢畻闋傞儴鍋忕Щ锛岀⒑淇濅綀灞€鍨傜洿灞呬腑鎴栧緸闋傞儴闁嬪锛堟墜姗熺増娓涘皯10px锛?        // 馃摑 totalUnitHeight 宸茬稉鍖呭惈 chineseTextHeight 鍜?verticalSpacing锛屾墍浠ヤ笉闇€瑕侀噸瑜囧姞
        const totalContentHeight = rows * totalUnitHeight;
        const topOffset = isCompactMode ? 30 : Math.max(10, (height - totalContentHeight) / 2);

        console.log('馃搻 娣峰悎浣堝眬闁撹窛:', {
            horizontalSpacing,
            verticalSpacing,
            chineseTextHeight,
            rows,
            totalContentHeight,
            topOffset,
            verticalSpacingFormula: isCompactMode ? `${chineseTextHeight} * 0.2 = ${verticalSpacing.toFixed(1)}` : '0'
        });

        // 馃敟 v23.0锛氭坊鍔犳按骞抽枔璺濊瑭︿俊鎭?        console.log('馃敟 [v23.0] 姘村钩闁撹窛瑷堢畻:', {
            cols,
            screenWidth: width,
            horizontalMargin,
            availableWidth,
            frameWidth,
            totalCardWidth,
            availableSpace,
            horizontalSpacing,
            totalWidth: totalCardWidth + horizontalSpacing * (cols + 1),
            formula: cols === 5 ? `max(1, min(3, (${availableWidth} - ${totalCardWidth}) / ${cols + 1})) = ${horizontalSpacing}` : `max(5, (${availableWidth} - ${totalCardWidth}) / ${cols + 1}) = ${horizontalSpacing}`
        });

        // 馃敟 绗竴姝ワ細闋愬厛瑷堢畻鎵€鏈変腑鏂囨枃瀛楃殑瀵﹂殯瀛楅珨澶у皬锛堝鏋滃皻鏈▓绠楋級
        // 馃摑 绶婃箠妯″紡宸茬稉鍦ㄤ笂闈㈣▓绠楅亷锛屾闈㈡ā寮忛渶瑕佸湪閫欒！瑷堢畻
        let chineseFontSizesArray;
        if (!isCompactMode) {
            console.log('馃攳 妗岄潰妯″紡锛氭櫤鑳借▓绠椾腑鏂囧瓧楂斿ぇ灏?..');

            // 鉁?v42.0锛歩Pad 浣跨敤瀹瑰櫒鍒嗛鐨勫浐瀹氭枃瀛楀ぇ灏?            let baseFontSize;
            if (isIPad && iPadSize) {
                // iPad 鏂囧瓧澶у皬鏍规摎瑷倷澶у皬鍒嗛
                const iPadFontSizes = {
                    small_portrait: 22,
                    medium_portrait: 26,
                    medium_large_portrait: 28,
                    large_portrait: 30,
                    xlarge_portrait: 34,
                    small_landscape: 20,
                    medium_landscape: 24,
                    medium_large_landscape: 26,
                    large_landscape: 28,
                    xlarge_landscape: 32
                };
                baseFontSize = iPadFontSizes[iPadSize] || Math.max(18, Math.min(72, cardHeightInFrame * 0.6));
                console.log('馃摫 [v42.0] iPad 鏂囧瓧澶у皬:', {
                    size: iPadSize,
                    baseFontSize: baseFontSize
                });
            } else {
                baseFontSize = Math.max(18, Math.min(72, cardHeightInFrame * 0.6));
            }

            chineseFontSizes = currentPagePairs.map(pair => {
                // 馃敟 瑷堢畻鍒濆瀛楅珨澶у皬
                // 鉁?v42.0锛歩Pad 浣跨敤鍥哄畾鍊硷紝鍏朵粬瑷倷鍩烘柤鍗＄墖楂樺害瑷堢畻
                let fontSize = baseFontSize;

                // 鍓靛缓鑷ㄦ檪鏂囧瓧灏嶈薄渚嗘脯閲忓搴?                const tempText = this.add.text(0, 0, pair.answer, {
                    fontSize: `${fontSize}px`,
                    fontFamily: 'Arial',
                    fontStyle: 'bold'
                });

                // 濡傛灉鏂囧瓧瀵害瓒呴亷妗嗗搴︾殑 85%锛岀府灏忓瓧楂?                const maxTextWidth = (frameWidth - 10) * 0.85;
                while (tempText.width > maxTextWidth && fontSize > 18) {
                    fontSize -= 2;
                    tempText.setFontSize(fontSize);
                }

                // 閵锋瘈鑷ㄦ檪鏂囧瓧灏嶈薄
                tempText.destroy();

                return fontSize;
            });

            // 浣跨敤鏈€澶у瓧楂斿ぇ灏?            const maxChineseFontSize = Math.max(...chineseFontSizes);
            const minChineseFontSize = Math.min(...chineseFontSizes);
            const avgChineseFontSize = (chineseFontSizes.reduce((a, b) => a + b, 0) / chineseFontSizes.length).toFixed(1);

            console.log('馃搳 妗岄潰妯″紡涓枃瀛楅珨澶у皬绡勫湇:', {
                min: minChineseFontSize,
                max: maxChineseFontSize,
                average: avgChineseFontSize,
                allSizes: chineseFontSizes
            });

            chineseFontSizesArray = chineseFontSizes;
        } else {
            // 绶婃箠妯″紡浣跨敤涔嬪墠瑷堢畻鐨勫瓧楂斿ぇ灏?            chineseFontSizesArray = chineseFontSizes;
        }

        // 馃敟 绗簩姝ワ細鍓靛缓涓枃鏂囧瓧锛堝浐瀹氫綅缃紝浣滅偤"妗?鐨勫弮鑰冿級
        const chineseFrames = [];
        currentPagePairs.forEach((pair, i) => {
            const col = i % cols;
            const row = Math.floor(i / cols);

            // 馃敟 v23.0锛氫慨寰╁鍣ㄤ綅缃▓绠楋紝鑰冩叜閭婅窛
            // 鍦?Phaser 涓紝瀹瑰櫒鐨勪綅缃槸鍩烘柤鍏跺乏涓婅锛屼笉鏄腑蹇?            // 鎵€浠ユ垜鍊戦渶瑕佽鏁?frameX 鐨勮▓绠楋紝浣垮叾姝ｇ⒑瀹氫綅瀹瑰櫒
            // 鍏紡锛氶倞璺?+ 闁撹窛 + col * (frameWidth + 闁撹窛) + frameWidth / 2
            const frameX = horizontalMargin + horizontalSpacing + col * (frameWidth + horizontalSpacing) + frameWidth / 2;
            // 馃摑 浣跨敤 totalUnitHeight 瑷堢畻鍨傜洿浣嶇疆锛堝凡鍖呭惈 chineseTextHeight 鍜?verticalSpacing锛?            const frameY = topOffset + row * totalUnitHeight + totalUnitHeight / 2;

            // 馃敟 鍓靛缓涓枃鏂囧瓧瀹瑰櫒锛堝寘鍚櫧鑹叉锛?            const frameContainer = this.add.container(frameX, frameY);

            // 馃敟 鐧借壊鑳屾櫙妗嗭紙鑸囪嫳鏂囧崱鐗囧悓澶у皬锛?            const background = this.add.rectangle(0, 0, frameWidth - 10, cardHeightInFrame, 0xffffff);
            background.setStrokeStyle(2, 0x333333);
            frameContainer.add(background);

            // 馃敟 涓枃鏂囧瓧浣嶇疆瑷堢畻锛堢鍏锛?            // 鉁?v26.0锛氭柟妗?A - 鍦ㄨ嫳鏂囧崱鐗囧拰涓枃瀛椾箣闁撳姞鍏?verticalSpacing
            // 鏂扮祼妲嬶細鑻辨枃鍗＄墖 + verticalSpacing + 涓枃瀛?+ verticalSpacing
            const chineseActualFontSize = chineseFontSizesArray[i];
            const chineseTextHeightActual = chineseActualFontSize + 5;  // 瀛楅珨澶у皬 + 琛岄珮

            // 涓枃鏂囧瓧浣嶇疆锛氳嫳鏂囧崱鐗囦笅鏂?+ 涓枃瀛楅珮搴?2
            // 鉁?v35.0锛氬彇娑堜笂闈㈢殑 verticalSpacing锛屼腑鏂囧瓧鐩存帴璨艰憲鑻辨枃鍗＄墖
            const chineseY = cardHeightInFrame / 2 + chineseTextHeightActual / 2;

            console.log(`馃摑 鍓靛缓涓枃鏂囧瓧 [${i}]: "${pair.answer}", 瀛楅珨澶у皬: ${chineseActualFontSize}px, 浣嶇疆Y: ${chineseY.toFixed(1)}`);

            // 馃敟 鍓靛缓鏈€绲傜殑涓枃鏂囧瓧
            const chineseText = this.add.text(0, chineseY, pair.answer, {
                fontSize: `${chineseActualFontSize}px`,  // 浣跨敤闋愬厛瑷堢畻鐨勫瓧楂斿ぇ灏?                color: '#000000',
                fontFamily: 'Arial',
                fontStyle: 'bold'
            });
            chineseText.setOrigin(0.5, 0.5);  // 鉁?鏀归€诧細姘村钩鍜屽瀭鐩撮兘灞呬腑
            frameContainer.add(chineseText);

            // 淇濆瓨妗嗙殑鏁告摎
            frameContainer.setData('pairId', pair.id);  // 姝ｇ⒑鐨勯厤灏?ID
            frameContainer.setData('text', pair.answer);  // 涓枃鏂囧瓧
            frameContainer.setData('frameIndex', i);  // 妗嗙殑绱㈠紩
            frameContainer.setData('currentCardPairId', null);  // 鐣跺墠妗嗗収鐨勮嫳鏂囧崱鐗囩殑 pairId
            frameContainer.setDepth(0);

            chineseFrames.push(frameContainer);
            this.rightCards.push(frameContainer);
        });

        // 馃敟 绗簩姝ワ細鍓靛缓鑻辨枃鍗＄墖锛堝垵濮嬮毃姗熸斁鍦ㄦ鍏э級
        // 鏍规摎闅ㄦ妯″紡姹哄畾鑻辨枃鍗＄墖鐨勫垵濮嬩綅缃?        let shuffledPairs;
        if (this.random === 'same') {
            // 鍥哄畾闅ㄦ妯″紡
            const urlParams = new URLSearchParams(window.location.search);
            const activityId = urlParams.get('activityId') || 'default-seed';
            const seed = activityId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);

            const rng = new Phaser.Math.RandomDataGenerator([seed.toString()]);
            shuffledPairs = rng.shuffle([...currentPagePairs]);
            console.log('馃幉 娣峰悎浣堝眬浣跨敤鍥哄畾闅ㄦ妯″紡锛岀ó瀛?', seed);
        } else {
            // 姣忔涓嶅悓妯″紡
            shuffledPairs = Phaser.Utils.Array.Shuffle([...currentPagePairs]);
            console.log('馃幉 娣峰悎浣堝眬浣跨敤闅ㄦ鎺掑垪妯″紡');
        }

        // 鍓靛缓鑻辨枃鍗＄墖涓︽斁鍦ㄤ腑鏂囨枃瀛椾笂鏂?        shuffledPairs.forEach((pair, i) => {
            const frame = chineseFrames[i];
            const frameX = frame.x;
            const frameY = frame.y;

            // 馃敟 鑻辨枃鍗＄墖浣嶇疆锛堝湪涓枃鏂囧瓧涓婃柟锛?            const cardY = frameY;  // 鑸囦腑鏂囨枃瀛楀鍣ㄥ悓涓€浣嶇疆锛堣嫳鏂囧崱鐗囨渻鍦ㄤ笂鏂癸級

            const animationDelay = i * 100;  // 姣忓€嬪崱鐗囧欢閬?100ms

            // 馃敟 妾㈡煡鑻辨枃鍏у鏄惁鐐虹┖ - 濡傛灉鐐虹┖锛岃烦閬庡壍寤鸿嫳鏂囧崱鐗?            if (!pair.question || pair.question.trim() === '') {
                console.log(`鈴笍 璺抽亷绌虹櫧鑻辨枃鍗＄墖 [${i}]: 鑻辨枃鍏у鐐虹┖`);
                // 鏇存柊妗嗙殑鏁告摎锛屼絾涓嶅壍寤哄崱鐗?                frame.setData('currentCardPairId', pair.id);
                return;  // 璺抽亷姝ら爡
            }

            // 鍓靛缓鑻辨枃鍗＄墖锛堜娇鐢ㄨ垏涓枃鏂囧瓧鐩稿悓鐨勫搴︼級
            const card = this.createLeftCard(frameX, cardY, frameWidth - 10, cardHeightInFrame, pair.question, pair.id, animationDelay, pair.imageUrl, pair.audioUrl);

            // 淇濆瓨鍗＄墖鐣跺墠鎵€鍦ㄧ殑妗嗙殑绱㈠紩
            card.setData('currentFrameIndex', i);

            // 鏇存柊妗嗙殑鏁告摎
            frame.setData('currentCardPairId', pair.id);

            this.leftCards.push(card);
        });

        console.log('鉁?娣峰悎浣堝眬鍓靛缓瀹屾垚:', {
            chineseFrames: chineseFrames.length,
            leftCards: this.leftCards.length,
            rightCards: this.rightCards.length
        });
    }

    createLeftContainerBox(x, y, cardWidth, cardHeight, spacing, count) {
        // 瑷堢畻澶栨鐨勫昂瀵?        const padding = 10;  // 澶栨鑸囧崱鐗囦箣闁撶殑闁撹窛
        const boxWidth = cardWidth + padding * 2;
        const boxHeight = (cardHeight * count) + (spacing - cardHeight) * (count - 1) + padding * 2;

        // 瑷堢畻澶栨鐨勪腑蹇冧綅缃?        const boxCenterY = y + (spacing * (count - 1)) / 2;

        // 鍓靛缓澶栨
        const containerBox = this.add.rectangle(x, boxCenterY, boxWidth, boxHeight);
        containerBox.setStrokeStyle(2, 0x333333);  // 榛戣壊閭婃
        containerBox.setFillStyle(0xffffff, 0);    // 閫忔槑濉厖
        containerBox.setDepth(0);  // 鍦ㄥ崱鐗囦笅灞?    }

    // 馃敟 鍓靛缓澶氬垪澶栨锛堟櫤鑳藉鍒椾綀灞€锛?    createMultiColumnContainerBox(startX, startY, cardWidth, cardHeight, horizontalSpacing, verticalSpacing, columns, rows) {
        const padding = 10;  // 澶栨鑸囧崱鐗囦箣闁撶殑闁撹窛

        // 瑷堢畻澶栨鐨勫昂瀵?        const boxWidth = columns * cardWidth + (columns - 1) * horizontalSpacing + padding * 2;
        const boxHeight = rows * cardHeight + (rows - 1) * verticalSpacing + padding * 2;

        // 瑷堢畻澶栨鐨勪腑蹇冧綅缃?        const boxCenterX = startX + (columns * cardWidth + (columns - 1) * horizontalSpacing) / 2;
        const boxCenterY = startY + (rows * cardHeight + (rows - 1) * verticalSpacing) / 2;

        // 鍓靛缓澶栨
        const containerBox = this.add.rectangle(boxCenterX, boxCenterY, boxWidth, boxHeight);
        containerBox.setStrokeStyle(2, 0x333333);  // 榛戣壊閭婃
        containerBox.setFillStyle(0xffffff, 0);    // 閫忔槑濉厖
        containerBox.setDepth(0);  // 鍦ㄥ崱鐗囦笅灞?
        console.log('馃摝 澶氬垪澶栨宸插壍寤?', {
            columns,
            rows,
            boxWidth,
            boxHeight,
            centerX: boxCenterX,
            centerY: boxCenterY
        });
    }

    createLeftCard(x, y, width, height, text, pairId, animationDelay = 0, imageUrl = null, audioUrl = null) {
        // 鍓靛缓鍗＄墖瀹瑰櫒
        // 馃敟 v17.0锛氫慨寰╁鍣ㄤ綅缃▓绠?        // 鍦?Phaser 3 涓紝瀹瑰櫒涓嶆敮鎸?setOrigin锛屾墍浠ラ渶瑕佽鏁村鍣ㄥ収閮ㄥ厓绱犵殑浣嶇疆
        // 瀹瑰櫒鐨勪綅缃槸鍩烘柤鍏跺瓙鍏冪礌鐨勪綅缃紝鎵€浠ユ垜鍊戦渶瑕佸皣鎵€鏈夊瓙鍏冪礌鐩稿皪鏂煎鍣ㄤ腑蹇冨畾浣?        const container = this.add.container(x, y);
        container.setSize(width, height);
        container.setDepth(5);

        // 馃敟 瑷疆鍒濆閫忔槑搴︾偤 0锛堥毐钘忥級
        container.setAlpha(0);

        // 鍓靛缓鍗＄墖鑳屾櫙锛堢櫧鑹诧級
        const background = this.add.rectangle(0, 0, width, height, 0xffffff);
        background.setStrokeStyle(2, 0x333333);

        // 馃敟 鑱叉槑璁婇噺锛堝湪鍒嗘敮澶栭儴锛?        let cardText;
        let audioButton;

        // 馃敟 妾㈡煡鍏у绲勫悎
        const pairData = this.pairs.find(pair => pair.id === pairId);
        const hasImage = imageUrl && imageUrl.trim() !== '';
        const hasText = text && text.trim() !== '' && text.trim() !== '<br>';
        const audioStatus = pairData ? pairData.audioStatus : (audioUrl ? 'available' : 'missing');
        const hasAudio = audioStatus === 'available';
        const safeAudioUrl = hasAudio ? audioUrl : null;

        // 馃敟 瑾胯│鏃ヨ獙 - 鏌ョ湅瀵﹂殯鏁告摎鍏у
        console.log('馃攳 createLeftCard 瑾胯│淇℃伅:', {
            pairId,
            text: text,
            textType: typeof text,
            textLength: text ? text.length : 'null/undefined',
            hasText: hasText,
            hasImage: hasImage,
            audioStatus: audioStatus,
            imageUrl: imageUrl,
            audioUrl: safeAudioUrl,
            invalidAudioUrl: pairData ? pairData.invalidAudioUrl : null
        });

        // 馃敟 鏍规摎鍏у绲勫悎姹哄畾浣堝眬
        // 鎯呮硜 A锛氬湒鐗?+ 鏂囧瓧 + 瑾為煶锛?,1,1锛?        // 鎯呮硜 B锛氬彧鏈夎獮闊筹紙0,0,1锛?        // 鎯呮硜 C锛氬彧鏈夋枃瀛楋紙0,1,0锛?        // 鎯呮硜 D锛氬湒鐗?+ 鏂囧瓧锛?,1,0锛?        // 鎯呮硜 E锛氳獮闊?+ 鏂囧瓧锛?,1,1锛?
        if (hasImage && hasText && hasAudio) {
            // 鎯呮硜 A锛氬湒鐗?+ 鏂囧瓧 + 瑾為煶鎸夐垥
            this.createCardLayoutA(container, background, width, height, text, imageUrl, safeAudioUrl, pairId);
        } else if (!hasImage && !hasText && hasAudio) {
            // 鎯呮硜 B锛氬彧鏈夎獮闊虫寜閳?            this.createCardLayoutB(container, background, width, height, safeAudioUrl, pairId);
        } else if (!hasImage && hasText && !hasAudio) {
            // 鎯呮硜 C锛氬彧鏈夋枃瀛楋紙宸插鐝撅級
            this.createCardLayoutC(container, background, width, height, text);
        } else if (hasImage && hasText && !hasAudio) {
            // 鎯呮硜 D锛氬湒鐗?+ 鏂囧瓧锛堝凡瀵︾従锛?            this.createCardLayoutD(container, background, width, height, text, imageUrl, pairId);
        } else if (!hasImage && hasText && hasAudio) {
            // 鎯呮硜 E锛氳獮闊?+ 鏂囧瓧
            this.createCardLayoutE(container, background, width, height, text, safeAudioUrl, pairId);
        } else if (hasImage && !hasText && !hasAudio) {
            // 鍙湁鍦栫墖锛堢劇鏂囧瓧銆佺劇瑾為煶锛? 1:1 姣斾緥椤ず
            this.createCardLayoutF(container, background, width, height, imageUrl, pairId);
        } else if (hasImage && !hasText && hasAudio) {
            // 鍦栫墖 + 瑾為煶锛堢劇鏂囧瓧锛?            this.createCardLayoutA(container, background, width, height, '', imageUrl, safeAudioUrl, pairId);
        } else {
            // 鍏朵粬鎯呮硜锛氬彧椤ず鑳屾櫙
            container.add([background]);
        }

        // 馃敟 宸茬Щ闄?"No audio" 妯欑ず锛堢敤鎴惰姹傦級- 绂佺敤闊抽牷鐙€鎱嬪窘绔犻’绀?        // if (audioStatus && audioStatus !== 'available') {
        //     this.addAudioStatusBadge(container, width, height, audioStatus);
        // }

        // 馃摑 娣″叆鍕曠暙閰嶇疆锛堟寜鐓ч爢搴忓嚭鐝撅級
        this.tweens.add({
            targets: container,
            alpha: 1,           // 寰?0 娣″叆鍒?1锛堝畬鍏ㄤ笉閫忔槑锛?            duration: 300,      // 鍕曠暙鎸佺簩 300ms锛?.3绉掞級
            delay: animationDelay,  // 寤堕伈鏅傞枔锛堢敤鏂奸爢搴忓嚭鐝炬晥鏋滐級
            ease: 'Power2'      // 绶╁嫊鍑芥暩锛堝钩婊戝姞閫燂級
        });

        // 瑷疆浜掑嫊锛堟暣鍊嬪鍣ㄥ彲鎷栨洺锛?        container.setInteractive({ useHandCursor: true, draggable: true });

        // 鍎插瓨鍘熷浣嶇疆
        container.setData({
            pairId: pairId,
            side: 'left',
            background: background,
            text: cardText,
            isMatched: false,
            originalX: x,
            originalY: y,
            hasAudio: hasAudio,
            audioStatus: audioStatus,
            invalidAudioUrl: pairData ? pairData.invalidAudioUrl : null,
            isPlaying: false,
            clickStartTime: 0
        });

        // 馃敟 榛炴搳鍗＄墖鎾斁闊抽牷锛堢煭鎸夋檪锛?        container.on('pointerdown', (pointer) => {
            // 瑷橀寗榛炴搳闁嬪鏅傞枔
            container.setData('clickStartTime', Date.now());
            console.log('馃柋锔?鍗＄墖琚粸鎿?', { pairId, hasAudio });
        });

        // 馃敟 榛炴搳绲愭潫鏅傛鏌ユ槸鍚︽槸鐭寜锛堟挱鏀鹃煶闋伙級
        container.on('pointerup', (pointer) => {
            const clickDuration = Date.now() - container.getData('clickStartTime');
            const isDragging = this.isDragging;

            // 濡傛灉榛炴搳鏅傞枔鐭柤 200ms 涓旀矑鏈夋嫋鏇筹紝鍓囨挱鏀鹃煶闋?            if (clickDuration < 200 && !isDragging && hasAudio && safeAudioUrl) {
                console.log('馃攰 鐭寜鍗＄墖锛屾挱鏀鹃煶闋?', { pairId, clickDuration });
                this.playAudio(safeAudioUrl, container, background);
            }
        });

        // 鎷栨洺闁嬪
        container.on('dragstart', (pointer) => {
            // 馃摑 瑾胯│瑷婃伅锛氳閷勬嫋鏇抽枊濮?            console.log('馃柋锔?闁嬪鎷栨洺鍗＄墖:', {
                pairId: container.getData('pairId'),
                side: container.getData('side'),
                position: { x: container.x, y: container.y },
                isMatched: container.getData('isMatched')
            });

            // 鍏佽ū宸查厤灏嶇殑鍗＄墖涔熷彲浠ユ嫋鍕?            this.isDragging = true;
            this.dragStartCard = container;

            // 馃摑 鍗＄墖"椋勬诞"璧蜂締鐨勮瑕烘晥鏋?            container.setDepth(100);   // 鎻愬崌鍒版渶涓婂堡锛堟繁搴﹀€?00锛?            container.setScale(1.1);   // 绋嶅井鏀惧ぇ锛?10%锛?            background.setAlpha(0.9);  // 鍗婇€忔槑锛?0%涓嶉€忔槑搴︼級
        });

        // 鎷栨洺涓?- 鍗＄墖璺熼毃榧犳
        container.on('drag', (pointer, dragX, dragY) => {
            if (!this.isDragging) {
                // 馃摑 瑾胯│瑷婃伅锛氭嫋鏇崇媭鎱嬬暟甯?                console.log('鈿狅笍 鎷栨洺鐙€鎱嬬暟甯革細isDragging = false');
                return;
            }

            // 绉诲嫊鏁村€嬪崱鐗?            container.x = pointer.x;
            container.y = pointer.y;
        });

        // 鎷栨洺绲愭潫
        container.on('dragend', (pointer) => {
            // 馃摑 瑾胯│瑷婃伅锛氳閷勬嫋鏇崇祼鏉?            console.log('馃柋锔?绲愭潫鎷栨洺:', {
                pairId: container.getData('pairId'),
                finalPosition: { x: pointer.x, y: pointer.y },
                layout: this.layout
            });

            this.isDragging = false;

            // 馃敟 娣峰悎妯″紡锛氬彧妾㈡煡鎷栨斁鍒颁腑鏂囨
            if (this.layout === 'mixed') {
                console.log('馃攧 娣峰悎妯″紡锛氭鏌ユ嫋鏀惧埌涓枃妗?);
                const dropped = this.checkDrop(pointer, container);
                console.log('馃搳 鎷栨斁绲愭灉:', dropped ? '鎴愬姛' : '澶辨晽');
                // checkDrop 鏈冭檿鐞嗘墍鏈夐倧杓紙浜ゆ彌鎴栬繑鍥炲師浣嶏級
            } else {
                console.log('馃攧 鍒嗛洟妯″紡锛氭鏌ユ嫋鏀鹃倧杓?);
                // 鍒嗛洟妯″紡锛氭鏌ユ槸鍚︽嫋鍥炲乏鍋村崁鍩燂紙鍙栨秷閰嶅皪锛?                const isInLeftArea = pointer.x < this.scale.width * 0.45;

                if (isInLeftArea && container.getData('isMatched')) {
                    // 鍙栨秷閰嶅皪
                    this.unmatchCard(container);

                    // 杩斿洖鍘熶綅
                    this.tweens.add({
                        targets: container,
                        x: container.getData('originalX'),
                        y: container.getData('originalY'),
                        scaleX: 1,
                        scaleY: 1,
                        duration: 300,
                        ease: 'Back.easeOut',
                        onComplete: () => {
                            container.setDepth(5);
                            background.setAlpha(1);
                        }
                    });
                } else {
                    // 鍏堟鏌ユ槸鍚︽嫋鏇冲埌鍏朵粬宸﹀伌鍗＄墖锛堜氦鎻涗綅缃級
                    const swapped = this.checkSwap(pointer, container);

                    if (!swapped) {
                        // 濡傛灉娌掓湁浜ゆ彌锛屾鏌ユ槸鍚︽嫋鏇冲埌鍙冲伌鍗＄墖
                        const dropped = this.checkDrop(pointer, container);

                        if (!dropped) {
                            // 娌掓湁鏀惧埌姝ｇ⒑浣嶇疆锛岃繑鍥炲師浣?                            this.tweens.add({
                                targets: container,
                                x: container.getData('originalX'),
                                y: container.getData('originalY'),
                                scaleX: 1,
                                scaleY: 1,
                                duration: 300,
                                ease: 'Back.easeOut',
                                onComplete: () => {
                                    container.setDepth(5);
                                    background.setAlpha(1);
                                }
                            });
                        }
                    }
                }
            }

            this.dragStartCard = null;
        });

        // 鍟熺敤鎷栨洺
        this.input.setDraggable(container);

        return container;
    }

    // 馃敟 浣堝眬鍑芥暩 - 鎯呮硜 A锛氳獮闊虫寜閳曪紙涓?30%锛? 鍦栫墖锛堜腑 40%锛? 鏂囧瓧锛堜笅 30%锛?    createCardLayoutA(container, background, width, height, text, imageUrl, audioUrl, pairId) {
        console.log('馃帹 浣堝眬 A: 瑾為煶鎸夐垥 + 鍦栫墖 + 鏂囧瓧', {
            width,
            height,
            pairId,
            hasText: !!text,
            hasAudioUrl: !!audioUrl,
            audioUrl: audioUrl ? audioUrl.substring(0, 50) + '...' : 'null'
        });

        // 馃敟 棣栧厛娣诲姞鑳屾櫙锛堟渶搴曞堡锛?        container.add([background]);

        // 1锔忊儯 瑾為煶鎸夐垥鍗€鍩燂紙涓婃柟 30%锛?        const buttonAreaHeight = height * 0.3;
        const buttonAreaY = -height / 2 + buttonAreaHeight / 2;
        const buttonSize = Math.max(20, Math.min(40, buttonAreaHeight * 0.6));  // 馃敟 娓涘皬鎸夐垥澶у皬锛岀⒑淇濆湪妗嗗収

        console.log('馃攰 婧栧倷瑾跨敤 createAudioButton:', {
            audioUrl: audioUrl ? '鏈? : '鐒?,
            buttonAreaY,
            buttonSize
        });

        this.createAudioButton(container, audioUrl, 0, buttonAreaY, buttonSize, pairId);

        console.log('鉁?createAudioButton 瑾跨敤瀹屾垚');

        // 2锔忊儯 鍦栫墖鍗€鍩燂紙涓枔 40%锛?        const imageAreaHeight = height * 0.4;
        const imageAreaY = -height / 2 + buttonAreaHeight + imageAreaHeight / 2;
        const squareSize = Math.min(width - 4, imageAreaHeight - 4);
        this.loadAndDisplayImage(container, imageUrl, 0, imageAreaY, squareSize, pairId);

        // 3锔忊儯 鏂囧瓧鍗€鍩燂紙涓嬫柟 30%锛岄渶瑕佺暀鍑哄簳閮ㄩ枔璺濓級
        const textAreaHeight = height * 0.3;
        const bottomPadding = Math.max(6, height * 0.06);  // 搴曢儴闁撹窛锛?px 鎴栭珮搴︾殑 6%
        const textHeight = textAreaHeight - bottomPadding;
        // 馃敟 鏂囧瓧浣嶇疆锛氬崱鐗囦笅閭婄晫 - 搴曢儴闁撹窛 - 鏂囧瓧楂樺害/2
        const textAreaY = height / 2 - bottomPadding - textHeight / 2;

        // 馃敟 鍙湁鏈夋晥鏂囧瓧鎵嶅壍寤?        if (text && text.trim() !== '' && text.trim() !== '<br>') {
            console.log('馃摑 鍓靛缓鏂囧瓧锛堜綀灞€ A锛?', {
                text,
                textAreaY,
                textHeight,
                bottomPadding,
                cardHeight: height,
                formula: `textAreaY = ${height / 2} - ${bottomPadding} - ${textHeight / 2} = ${textAreaY}`
            });
            this.createTextElement(container, text, 0, textAreaY, width, textHeight);
        } else {
            console.log('鈴笍 璺抽亷绌虹櫧鏂囧瓧');
        }
    }

    // 馃敟 浣堝眬鍑芥暩 - 鎯呮硜 B锛氬彧鏈夎獮闊虫寜閳?    createCardLayoutB(container, background, width, height, audioUrl, pairId) {
        // 馃敟 棣栧厛娣诲姞鑳屾櫙锛堟渶搴曞堡锛?        container.add([background]);

        // 瑾為煶鎸夐垥缃腑涓︽斁澶?        const buttonSize = Math.max(50, Math.min(80, width * 0.6));
        this.createAudioButton(container, audioUrl, 0, 0, buttonSize, pairId);
    }

    // 馃敟 浣堝眬鍑芥暩 - 鎯呮硜 C锛氬彧鏈夋枃瀛?    createCardLayoutC(container, background, width, height, text) {
        // 馃敟 棣栧厛娣诲姞鑳屾櫙锛堟渶搴曞堡锛?        container.add([background]);

        // 鏂囧瓧缃腑
        this.createTextElement(container, text, 0, 0, width, height);
    }

    // 馃敟 浣堝眬鍑芥暩 - 鎯呮硜 D锛氬湒鐗?+ 鏂囧瓧锛堝悇浣?50%锛屾枃瀛楁湁搴曢儴闁撹窛锛?    createCardLayoutD(container, background, width, height, text, imageUrl, pairId) {
        console.log('馃帹 浣堝眬 D: 鍦栫墖 + 鏂囧瓧 (鍚?50%锛屾櫤鑳介枔璺?', {
            width,
            height,
            pairId,
            hasText: !!text,
            imageUrl: imageUrl ? imageUrl.substring(0, 50) + '...' : 'null'
        });

        // 馃敟 棣栧厛娣诲姞鑳屾櫙锛堟渶搴曞堡锛?        container.add([background]);

        // 鍦栫墖鍗€鍩燂細浣旀摎鍗＄墖涓婃柟 50%
        const imageHeight = height * 0.5;
        const imageY = -height / 2 + imageHeight / 2;

        // 馃敟 鏂囧瓧鍗€鍩燂細浣旀摎鍗＄墖涓嬫柟 50%锛屼絾闇€瑕佺暀鍑哄簳閮ㄩ枔璺?        const textAreaHeight = height * 0.5;
        const bottomPadding = Math.max(8, height * 0.08);  // 搴曢儴闁撹窛锛?px 鎴栭珮搴︾殑 8%
        const textHeight = textAreaHeight - bottomPadding;
        // 馃敟 鏂囧瓧浣嶇疆锛氬崱鐗囦笅閭婄晫 - 搴曢儴闁撹窛 - 鏂囧瓧楂樺害/2
        const textY = height / 2 - bottomPadding - textHeight / 2;

        console.log('馃搻 浣堝眬 D 灏哄瑷堢畻:', {
            imageHeight,
            textAreaHeight,
            bottomPadding,
            textHeight,
            textY,
            cardHeight: height,
            formula: `textY = ${height / 2} - ${bottomPadding} - ${textHeight / 2} = ${textY}`
        });

        // 瑷堢畻姝ｆ柟褰㈠湒鐗囩殑灏哄锛?:1 姣斾緥锛?        const squareSize = Math.min(width - 4, imageHeight - 4);

        // 鍓靛缓鍦栫墖
        this.loadAndDisplayImage(container, imageUrl, 0, imageY, squareSize, pairId);

        // 鍓靛缓鏂囧瓧锛堝鏋滄湁锛?        if (text && text.trim() !== '' && text.trim() !== '<br>') {
            this.createTextElement(container, text, 0, textY, width, textHeight);
        }
    }

    // 馃敟 浣堝眬鍑芥暩 - 鎯呮硜 E锛氳獮闊?+ 鏂囧瓧锛堟枃瀛楁湁搴曢儴闁撹窛锛?    createCardLayoutE(container, background, width, height, text, audioUrl, pairId) {
        // 馃敟 棣栧厛娣诲姞鑳屾櫙锛堟渶搴曞堡锛?        container.add([background]);

        // 瑾為煶鎸夐垥鍦ㄤ笂鏂?        const buttonSize = Math.max(30, Math.min(50, width * 0.25));
        const buttonY = -height / 2 + buttonSize / 2 + 10;
        this.createAudioButton(container, audioUrl, 0, buttonY, buttonSize, pairId);

        // 馃敟 鏂囧瓧鍦ㄤ笅鏂癸紝闇€瑕佺暀鍑哄簳閮ㄩ枔璺?        const textAreaHeight = height * 0.4;
        const bottomPadding = Math.max(6, height * 0.06);  // 搴曢儴闁撹窛锛?px 鎴栭珮搴︾殑 6%
        const textHeight = textAreaHeight - bottomPadding;
        // 馃敟 鏂囧瓧浣嶇疆锛氬崱鐗囦笅閭婄晫 - 搴曢儴闁撹窛 - 鏂囧瓧楂樺害/2
        const textY = height / 2 - bottomPadding - textHeight / 2;

        console.log('馃摑 鍓靛缓鏂囧瓧锛堜綀灞€ E锛?', {
            text,
            textY,
            textHeight,
            bottomPadding,
            cardHeight: height,
            formula: `textY = ${height / 2} - ${bottomPadding} - ${textHeight / 2} = ${textY}`
        });

        this.createTextElement(container, text, 0, textY, width, textHeight);
    }

    // 馃敟 浣堝眬鍑芥暩 - 鎯呮硜 F锛氬彧鏈夊湒鐗囷紙1:1 姣斾緥锛?    createCardLayoutF(container, background, width, height, imageUrl, pairId) {
        console.log('馃帹 浣堝眬 F: 鍙湁鍦栫墖 (1:1 姣斾緥)', {
            width,
            height,
            pairId,
            imageUrl: imageUrl ? imageUrl.substring(0, 50) + '...' : 'null'
        });

        // 馃敟 棣栧厛娣诲姞鑳屾櫙锛堟渶搴曞堡锛?        container.add([background]);

        // 瑷堢畻姝ｆ柟褰㈠湒鐗囩殑灏哄锛堝彇瀵害鍜岄珮搴︾殑鏈€灏忓€硷紝淇濇寔 1:1锛?        const squareSize = Math.min(width - 4, height - 4);

        // 鍦栫墖缃腑椤ず
        this.loadAndDisplayImage(container, imageUrl, 0, 0, squareSize, pairId);
    }

    // 馃敟 浣堝眬鍑芥暩 - 鍦栫墖 + 瑾為煶锛堢劇鏂囧瓧锛?    createCardLayoutImageAudio(container, background, width, height, imageUrl, audioUrl, pairId) {
        // 馃敟 棣栧厛娣诲姞鑳屾櫙锛堟渶搴曞堡锛?        container.add([background]);

        // 鍦栫墖浣旀摎澶ч儴鍒嗗崁鍩?        const imageHeight = height * 0.8;
        const imageY = -height / 2 + imageHeight / 2;

        // 瑷堢畻姝ｆ柟褰㈠湒鐗囩殑灏哄
        const squareSize = Math.min(width - 4, imageHeight - 4);

        // 鍓靛缓鍦栫墖
        this.loadAndDisplayImage(container, imageUrl, 0, imageY, squareSize, pairId);

        // 鍓靛缓瑾為煶鎸夐垥锛堜笅鏂癸級
        const buttonSize = Math.max(30, Math.min(50, width * 0.2));
        const buttonY = height / 2 - buttonSize / 2 - 5;
        this.createAudioButton(container, audioUrl, 0, buttonY, buttonSize, pairId);
    }

    // 馃敟 杓斿姪鍑芥暩 - 杓夊叆涓﹂’绀哄湒鐗?    loadAndDisplayImage(container, imageUrl, x, y, size, pairId) {
        const imageKey = `card-image-${pairId}`;

        if (!this.textures.exists(imageKey)) {
            this.load.image(imageKey, imageUrl);

            this.load.once('complete', () => {
                if (this.textures.exists(imageKey)) {
                    const cardImage = this.add.image(x, y, imageKey);
                    cardImage.setDisplaySize(size, size);
                    cardImage.setOrigin(0.5);
                    container.add(cardImage);
                }
            });

            this.load.once('loaderror', (file) => {
                console.warn(`鈿狅笍 鍦栫墖杓夊叆澶辨晽: ${file.key}`, imageUrl);
            });

            this.load.start();
        } else {
            const cardImage = this.add.image(x, y, imageKey);
            cardImage.setDisplaySize(size, size);
            cardImage.setOrigin(0.5);
            container.add(cardImage);
        }
    }

    // 馃敟 杓斿姪鍑芥暩 - 鍓靛缓鏂囧瓧鍏冪礌锛堟櫤鑳借▓绠楀搴﹀拰楂樺害锛?    createTextElement(container, text, x, y, width, height) {
        // 馃敟 瑾胯│鏃ヨ獙 - 纰鸿獚鍑芥暩琚鐢?        console.log('馃摑 createTextElement 琚鐢?', {
            text: text,
            textType: typeof text,
            textLength: text ? text.length : 'null/undefined',
            x, y, width, height,
            containerExists: !!container
        });

        // 馃敟 鍒濆瀛楅珨澶у皬锛堝熀鏂奸珮搴︾殑 60%锛?        let fontSize = Math.max(14, Math.min(48, height * 0.6));

        // 鍓靛缓鑷ㄦ檪鏂囧瓧娓噺瀵害鍜岄珮搴?        const tempText = this.add.text(0, 0, text, {
            fontSize: `${fontSize}px`,
            fontFamily: 'Arial'
        });

        // 馃敟 瑷堢畻鏈€澶у搴︼紙鐣?15% 閭婅窛锛?        const maxTextWidth = width * 0.85;

        // 馃敟 瑷堢畻鏈€澶ч珮搴︼紙鐣?10% 閭婅窛锛?        const maxTextHeight = height * 0.9;

        // 馃敟 鍚屾檪妾㈡煡瀵害鍜岄珮搴︼紝濡傛灉瓒呴亷鍓囩府灏忓瓧楂?        while ((tempText.width > maxTextWidth || tempText.height > maxTextHeight) && fontSize > 12) {
            fontSize -= 2;
            tempText.setFontSize(fontSize);
        }

        // 馃敟 瑷橀寗鏈€绲傜殑鏂囧瓧灏哄
        const finalTextWidth = tempText.width;
        const finalTextHeight = tempText.height;

        tempText.destroy();

        // 鍓靛缓鏈€绲傛枃瀛?        const cardText = this.add.text(x, y, text, {
            fontSize: `${fontSize}px`,
            color: '#333333',
            fontFamily: 'Arial',
            fontStyle: 'normal'
        });
        cardText.setOrigin(0.5);
        container.add(cardText);

        // 馃敟 瑾胯│鏃ヨ獙 - 纰鸿獚鏂囧瓧灏嶈薄鍓靛缓鍜屽昂瀵?        console.log('鉁?鏂囧瓧灏嶈薄宸插壍寤猴紙鏅鸿兘瑷堢畻锛?', {
            text: text,
            fontSize: fontSize,
            textWidth: cardText.width,
            textHeight: cardText.height,
            maxTextWidth: maxTextWidth,
            maxTextHeight: maxTextHeight,
            widthRatio: (finalTextWidth / width * 100).toFixed(1) + '%',
            heightRatio: (finalTextHeight / height * 100).toFixed(1) + '%',
            visible: cardText.visible,
            alpha: cardText.alpha,
            x: cardText.x,
            y: cardText.y
        });

        return cardText;
    }

    // 馃敟 杓斿姪鍑芥暩 - 寰屽彴鐣版鐢熸垚缂哄け鐨勯煶闋伙紙涓嶉樆濉為亰鎴插姞杓夛級
    generateMissingAudioUrlsInBackground() {
        console.log('馃幍 [寰屽彴] 闁嬪妾㈡煡涓︾敓鎴愮己澶辩殑闊抽牷...');

        const missingAudioPairs = this.pairs.filter(pair => !pair.audioUrl);

        if (missingAudioPairs.length === 0) {
            console.log('鉁?[寰屽彴] 鎵€鏈夎褰欓兘鏈夐煶闋伙紝鐒￠渶鐢熸垚');
            return;
        }

        console.log(`鈴?[寰屽彴] 鐧肩従 ${missingAudioPairs.length} 鍊嬬己澶遍煶闋荤殑瑭炲綑锛屽湪寰屽彴鐢熸垚...`);

        // 馃敟 浣跨敤 Promise 鍦ㄥ緦鍙板煼琛岋紝涓嶇瓑寰呯祼鏋?        this.generateMissingAudioUrlsAsync(missingAudioPairs).catch(error => {
            console.error('鉂?[寰屽彴] 鐢熸垚缂哄け闊抽牷鏅傚嚭閷?', error);
        });
    }

    // 馃敟 杓斿姪鍑芥暩 - 鐣版鐢熸垚缂哄け鐨勯煶闋?    async generateMissingAudioUrlsAsync(missingAudioPairs) {
        try {
            for (const pair of missingAudioPairs) {
                try {
                    // 瑾跨敤 TTS API 鐢熸垚闊抽牷
                    const response = await fetch('/api/tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: pair.english,
                            language: 'en-US',
                            voice: 'en-US-Neural2-F'  // 濂宠伈
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        pair.audioUrl = data.audioUrl;
                        console.log(`鉁?[寰屽彴] 鐢熸垚闊抽牷: ${pair.english}`);
                    } else {
                        console.warn(`鈿狅笍 [寰屽彴] 鐢熸垚闊抽牷澶辨晽: ${pair.english} (${response.status})`);
                    }
                } catch (error) {
                    console.error(`鉂?[寰屽彴] 鐢熸垚闊抽牷鐣板父: ${pair.english}`, error);
                }

                // 閬垮厤 API 闄愬埗锛屾瘡鍊嬭珛姹備箣闁撶瓑寰?200ms
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            console.log('鉁?[寰屽彴] 闊抽牷鐢熸垚瀹屾垚');
        } catch (error) {
            console.error('鉂?[寰屽彴] 鐢熸垚缂哄け闊抽牷鏅傚嚭閷?', error);
        }
    }

    // 馃敟 杓斿姪鍑芥暩 - 鍓靛缓瑾為煶鎸夐垥
    createAudioButton(container, audioUrl, x, y, size, pairId) {
        console.log('馃攰 鍓靛缓瑾為煶鎸夐垥:', { x, y, size, audioUrl: audioUrl ? '鏈? : '鐒?, pairId });

        // 馃敟 鍓靛缓鎸夐垥鑳屾櫙锛堢浉灏嶆柤 buttonContainer 鐨勫骇妯欑偤 0, 0锛?        const buttonBg = this.add.rectangle(0, 0, size, size, 0x4CAF50);
        buttonBg.setStrokeStyle(2, 0x2E7D32);
        buttonBg.setOrigin(0.5);

        // 馃敟 鍓靛缓鍠囧彮鍦栨锛堢浉灏嶆柤 buttonContainer 鐨勫骇妯欑偤 0, 0锛?        const speakerIcon = this.add.text(0, 0, '馃攰', {
            fontSize: `${size * 0.6}px`,
            fontFamily: 'Arial'
        });
        speakerIcon.setOrigin(0.5);

        // 馃敟 鍓靛缓鎸夐垥瀹瑰櫒锛堜娇鐢ㄧ浉灏嶆柤鐖跺鍣ㄧ殑搴ф x, y锛?        const buttonContainer = this.add.container(0, 0, [buttonBg, speakerIcon]);
        buttonContainer.setSize(size, size);
        buttonContainer.setInteractive({ useHandCursor: true });

        // 馃敟 瑷疆鎸夐垥瀹瑰櫒鐨勪綅缃紙鐩稿皪鏂肩埗瀹瑰櫒锛?        buttonContainer.setPosition(x, y);

        // 鍎插瓨闊抽牷 URL
        buttonContainer.setData('audioUrl', audioUrl);
        buttonContainer.setData('isPlaying', false);
        buttonContainer.setData('pairId', pairId);

        // 榛炴搳浜嬩欢
        buttonContainer.on('pointerdown', (pointer, localX, localY, event) => {
            console.log('馃柋锔?瑾為煶鎸夐垥琚粸鎿?', { pairId, audioUrl });
            // 馃敟 闃绘浜嬩欢鍐掓场锛岄伩鍏嶈Ц鐧煎崱鐗囨嫋鏇?            event.stopPropagation();
            this.playAudio(audioUrl, buttonContainer, buttonBg);
        });

        // Hover 鏁堟灉
        buttonContainer.on('pointerover', () => {
            buttonBg.setFillStyle(0x45a049);
        });

        buttonContainer.on('pointerout', () => {
            if (!buttonContainer.getData('isPlaying')) {
                buttonBg.setFillStyle(0x4CAF50);
            }
        });

        // 馃敟 娣诲姞鍒扮埗瀹瑰櫒
        container.add(buttonContainer);

        console.log('鉁?瑾為煶鎸夐垥宸叉坊鍔犲埌瀹瑰櫒:', {
            buttonPosition: { x: buttonContainer.x, y: buttonContainer.y },
            containerPosition: { x: container.x, y: container.y }
        });

        return buttonContainer;
    }

    // 馃敟 杓斿姪鍑芥暩 - 鎾斁闊抽牷锛堜娇鐢?HTML5 Audio API锛?    playAudio(audioUrl, buttonContainer, buttonBg) {
        if (!audioUrl || audioUrl.trim() === '') {
            console.warn('鈿狅笍 闊抽牷 URL 鐐虹┖');
            return;
        }

        // 闃叉閲嶈榛炴搳
        if (buttonContainer.getData('isPlaying')) {
            console.log('馃攰 闊抽牷姝ｅ湪鎾斁涓紝蹇界暐閲嶈榛炴搳');
            return;
        }

        console.log('馃攰 婧栧倷鎾斁闊抽牷:', { audioUrl });

        try {
            // 鏇存柊鎸夐垥鐙€鎱嬬偤杓夊叆涓?            buttonContainer.setData('isPlaying', true);
            buttonBg.setFillStyle(0xFFC107);  // 榛冭壊琛ㄧず杓夊叆涓?
            // 浣跨敤 HTML5 Audio API 鐩存帴鎾斁
            const audio = new Audio(audioUrl);
            audio.volume = 0.8;

            // 闊抽牷鍙互鎾斁鏅?            audio.addEventListener('canplay', () => {
                console.log('鉁?闊抽牷宸叉簴鍌欏ソ锛岄枊濮嬫挱鏀?', audioUrl);
                buttonBg.setFillStyle(0xFF9800);  // 姗欒壊琛ㄧず鎾斁涓?                audio.play().catch(error => {
                    console.error('鉂?闊抽牷鎾斁澶辨晽:', error);
                    buttonContainer.setData('isPlaying', false);
                    buttonBg.setFillStyle(0xF44336);  // 绱呰壊琛ㄧず閷
                });
            });

            // 闊抽牷鎾斁瀹屾垚
            audio.addEventListener('ended', () => {
                console.log('鉁?闊抽牷鎾斁瀹屾垚:', audioUrl);
                buttonContainer.setData('isPlaying', false);
                buttonBg.setFillStyle(0x4CAF50);
            });

            // 闊抽牷杓夊叆澶辨晽
            audio.addEventListener('error', (error) => {
                console.error('鉂?闊抽牷杓夊叆澶辨晽:', error);
                buttonContainer.setData('isPlaying', false);
                buttonBg.setFillStyle(0xF44336);  // 绱呰壊琛ㄧず閷
            });

            // 闁嬪杓夊叆闊抽牷
            audio.load();

        } catch (error) {
            console.error('鉂?鎾斁闊抽牷鏅傜櫦鐢熺暟甯?', error);
            buttonContainer.setData('isPlaying', false);
            buttonBg.setFillStyle(0xF44336);  // 绱呰壊琛ㄧず閷
        }
    }

    createRightCard(x, y, width, height, text, pairId, textPosition = 'bottom') {
        // 鍓靛缓鍗＄墖瀹瑰櫒
        const container = this.add.container(x, y);
        container.setDepth(5);

        // 馃敟 鍓靛缓鐧借壊妗嗭紙鍏ф锛?        const background = this.add.rectangle(0, 0, width, height, 0xffffff);
        background.setStrokeStyle(2, 0x333333);
        background.setDepth(1);

        // 馃敟 鍓靛缓鏂囧瓧妯欑堡锛堝嫊鎱嬪瓧楂斿ぇ灏忥紝鏍规摎鏂囧瓧闀峰害鍜屽収妗嗗搴﹁鏁达級
        const textLength = text.length;
        let baseFontSize = Math.max(24, Math.min(48, height * 0.6));

        // 馃敟 鏍规摎鏂囧瓧闀峰害瑾挎暣瀛楅珨澶у皬
        let fontSize;
        if (textLength <= 4) {
            fontSize = baseFontSize * 0.8;  // 1-4 鍊嬪瓧锛氱府灏?20%
        } else if (textLength <= 6) {
            fontSize = baseFontSize * 0.7;  // 5-6 鍊嬪瓧锛氱府灏?30%
        } else {
            fontSize = baseFontSize * 0.6;  // 7+ 鍊嬪瓧锛氱府灏?40%
        }

        fontSize = Math.max(18, fontSize);  // 鏈€灏忓瓧楂斿ぇ灏?18px

        // 馃敟 鍓靛缓鑷ㄦ檪鏂囧瓧灏嶈薄渚嗘脯閲忓搴︼紙閬╂噳鍏ф瀵害锛?        const tempText = this.add.text(0, 0, text, {
            fontSize: `${fontSize}px`,
            fontFamily: 'Arial'
        });

        // 馃敟 濡傛灉鏂囧瓧瀵害瓒呴亷鍏ф瀵害鐨?85%锛岀府灏忓瓧楂?        const maxTextWidth = width * 0.85;  // 鐣?15% 鐨勯倞璺?        while (tempText.width > maxTextWidth && fontSize > 14) {
            fontSize -= 1;  // 姣忔绺皬 1px
            tempText.setFontSize(fontSize);
        }

        // 閵锋瘈鑷ㄦ檪鏂囧瓧灏嶈薄
        tempText.destroy();

        // 馃敟 鏍规摎 textPosition 瑷疆鏂囧瓧浣嶇疆
        let textX, textY, originX, originY;
        if (textPosition === 'right') {
            // 鏂囧瓧鍦ㄦ鍙抽倞
            textX = width / 2 + 15;
            textY = 0;
            originX = 0;      // 宸﹀皪榻?            originY = 0.5;    // 鍨傜洿灞呬腑
        } else if (textPosition === 'left') {
            // 鏂囧瓧鍦ㄦ宸﹂倞
            textX = -width / 2 - 15;
            textY = 0;
            originX = 1;      // 鍙冲皪榻?            originY = 0.5;    // 鍨傜洿灞呬腑
        } else {
            // 鏂囧瓧鍦ㄦ涓嬮倞锛堥粯瑾嶏級
            textX = 0;
            textY = height / 2 + 10;
            originX = 0.5;    // 姘村钩灞呬腑
            originY = 0;      // 闋傞儴灏嶉綂
        }

        const cardText = this.add.text(textX, textY, text, {
            fontSize: `${fontSize}px`,
            color: '#333333',
            fontFamily: 'Arial',
            fontStyle: 'normal'
        });
        cardText.setOrigin(originX, originY);
        cardText.setDepth(10);  // 纰轰繚鏂囧瓧鍦ㄦ渶涓婂堡

        // 娣诲姞鍒板鍣?        container.add([background, cardText]);

        // 瑷疆浜掑嫊锛堟帴鏀舵嫋鏇筹級
        background.setInteractive({ useHandCursor: true });

        // 鎳稿仠鏁堟灉
        background.on('pointerover', () => {
            if (!container.getData('isMatched') && this.isDragging) {
                background.setStrokeStyle(3, 0xfe7606); // 姗欒壊閭婃
            }
        });
        background.on('pointerout', () => {
            if (!container.getData('isMatched')) {
                background.setStrokeStyle(2, 0x333333);
            }
        });

        // 鍎插瓨鍗＄墖鏁告摎
        container.setData({
            pairId: pairId,
            side: 'right',
            background: background,
            text: cardText,
            isMatched: false
        });

        return container;
    }

    checkSwap(pointer, draggedCard) {
        // 馃摑 瑾胯│瑷婃伅锛氳閷勪氦鎻涙鏌ラ枊濮?        console.log('馃攧 妾㈡煡鍗＄墖浜ゆ彌:', {
            draggedCardId: draggedCard?.getData('pairId'),
            pointerPosition: { x: pointer.x, y: pointer.y }
        });

        if (!draggedCard) {
            console.log('鈿狅笍 娌掓湁鎷栨洺鐨勫崱鐗?);
            return false;
        }

        // 妾㈡煡鎸囬嚌鏄惁鍦ㄥ叾浠栧乏鍋村崱鐗囦笂
        let targetCard = null;

        for (const card of this.leftCards) {
            // 璺抽亷鑷繁鍜屽凡閰嶅皪鐨勫崱鐗?            if (card === draggedCard || card.getData('isMatched')) continue;

            const bounds = card.getBounds();
            if (bounds.contains(pointer.x, pointer.y)) {
                targetCard = card;
                console.log('鉁?鎵惧埌鐩鍗＄墖:', card.getData('pairId'));
                break;
            }
        }

        if (targetCard) {
            console.log('馃攧 鍩疯鍗＄墖浜ゆ彌:', {
                card1: draggedCard.getData('pairId'),
                card2: targetCard.getData('pairId')
            });
            // 浜ゆ彌鍏╁嫉鍗＄墖鐨勪綅缃?            this.swapCards(draggedCard, targetCard);
            return true;
        }

        console.log('鉂?娌掓湁鎵惧埌鐩鍗＄墖');
        return false;
    }

    swapCards(card1, card2) {
        // 鐛插彇鍏╁嫉鍗＄墖鐨勫師濮嬩綅缃?        const card1OriginalX = card1.getData('originalX');
        const card1OriginalY = card1.getData('originalY');
        const card2OriginalX = card2.getData('originalX');
        const card2OriginalY = card2.getData('originalY');

        // 浜ゆ彌鍘熷浣嶇疆鏁告摎
        card1.setData('originalX', card2OriginalX);
        card1.setData('originalY', card2OriginalY);
        card2.setData('originalX', card1OriginalX);
        card2.setData('originalY', card1OriginalY);

        // 鍕曠暙绉诲嫊鍒版柊浣嶇疆
        this.tweens.add({
            targets: card1,
            x: card2OriginalX,
            y: card2OriginalY,
            scaleX: 1,
            scaleY: 1,
            duration: 300,
            ease: 'Back.easeOut',
            onComplete: () => {
                card1.setDepth(5);
                const bg1 = card1.getAt(0);
                if (bg1) bg1.setAlpha(1);
            }
        });

        this.tweens.add({
            targets: card2,
            x: card1OriginalX,
            y: card1OriginalY,
            duration: 300,
            ease: 'Back.easeOut'
        });
    }

    checkDrop(pointer, draggedCard) {
        // 馃摑 瑾胯│瑷婃伅锛氳閷勬嫋鏀炬鏌ラ枊濮?        console.log('馃幆 妾㈡煡鎷栨斁:', {
            draggedCardId: draggedCard?.getData('pairId'),
            layout: this.layout,
            pointerPosition: { x: pointer.x, y: pointer.y }
        });

        if (!draggedCard) {
            console.log('鈿狅笍 娌掓湁鎷栨洺鐨勫崱鐗?);
            return false;
        }

        // 馃敟 娣峰悎妯″紡锛氭鏌ユ槸鍚︽嫋鏇冲埌鍙︿竴鍊嬩腑鏂囨
        if (this.layout === 'mixed') {
            console.log('馃攧 浣跨敤娣峰悎妯″紡鎷栨斁閭忚集');
            return this.checkMixedModeDrop(pointer, draggedCard);
        }

        // 鍒嗛洟妯″紡锛氭鏌ユ寚閲濇槸鍚﹀湪浠讳綍鍙冲伌鍗＄墖涓?        let targetCard = null;

        for (const card of this.rightCards) {
            if (card.getData('isMatched')) continue;  // 璺抽亷宸查厤灏嶇殑鍗＄墖

            const bounds = card.getBounds();
            if (bounds.contains(pointer.x, pointer.y)) {
                targetCard = card;
                console.log('鉁?鎵惧埌鐩鍗＄墖:', card.getData('pairId'));
                break;
            }
        }

        if (targetCard) {
            console.log('馃幆 鍩疯閰嶅皪妾㈡煡:', {
                leftCard: draggedCard.getData('pairId'),
                rightCard: targetCard.getData('pairId')
            });
            this.checkMatch(draggedCard, targetCard);
            return true;
        }

        console.log('鉂?娌掓湁鎵惧埌鐩鍗＄墖');
        return false;
    }

    // 馃敟 娣峰悎妯″紡锛氭鏌ユ嫋鏀惧埌鍏朵粬鑻辨枃鍗＄墖锛堜氦鎻涗綅缃級
    checkMixedModeDrop(pointer, draggedCard) {
        // 馃摑 瑾胯│瑷婃伅锛氳閷勬贩鍚堟ā寮忔嫋鏀炬鏌ラ枊濮?        console.log('馃攧 娣峰悎妯″紡鎷栨斁妾㈡煡:', {
            draggedCardId: draggedCard.getData('pairId'),
            pointerPosition: { x: pointer.x, y: pointer.y }
        });

        // 鎵惧埌鎷栨洺鍒扮殑鐩鑻辨枃鍗＄墖
        let targetCard = null;

        for (const card of this.leftCards) {
            if (card === draggedCard) continue;  // 璺抽亷鑷繁

            const bounds = card.getBounds();
            // 馃摑 鎿村ぇ妾㈡脯绡勫湇锛屽寘鎷崱鐗囦笅鏂圭殑涓枃鏂囧瓧鍗€鍩?            // 鍘熷洜锛氫腑鏂囨枃瀛楀湪鍗＄墖涓嬫柟锛岀敤鎴跺彲鑳芥嫋鏀惧埌涓枃鏂囧瓧涓?            // 鎿村ぇ绡勫湇锛氶珮搴?+ 50px锛堜腑鏂囨枃瀛楀崁鍩熺殑楂樺害锛?            const expandedBounds = new Phaser.Geom.Rectangle(
                bounds.x,
                bounds.y,
                bounds.width,
                bounds.height + 50  // 鎿村ぇ50px锛屽寘鎷腑鏂囨枃瀛楀崁鍩?            );

            if (expandedBounds.contains(pointer.x, pointer.y)) {
                targetCard = card;
                console.log('鉁?鎵惧埌鐩鍗＄墖锛堟摯灞曠瘎鍦嶏級:', {
                    targetCardId: card.getData('pairId'),
                    bounds: { x: bounds.x, y: bounds.y, width: bounds.width, height: bounds.height }
                });
                break;
            }
        }

        if (!targetCard) {
            // 娌掓湁鎷栨洺鍒颁换浣曞崱鐗囷紝杩斿洖鍘熶綅
            this.tweens.add({
                targets: draggedCard,
                x: draggedCard.getData('originalX'),
                y: draggedCard.getData('originalY'),
                scaleX: 1,
                scaleY: 1,
                duration: 300,
                ease: 'Back.easeOut',
                onComplete: () => {
                    draggedCard.setDepth(5);
                    draggedCard.getData('background').setAlpha(1);
                }
            });
            return false;
        }

        // 鐛插彇鍏╁€嬪崱鐗囩殑妗嗙储寮?        const targetFrameIndex = targetCard.getData('currentFrameIndex');
        const currentFrameIndex = draggedCard.getData('currentFrameIndex');

        // 浜ゆ彌鍏╁€嬭嫳鏂囧崱鐗囩殑浣嶇疆
        this.swapMixedModeCards(draggedCard, targetCard, currentFrameIndex, targetFrameIndex);
        return true;
    }

    // 馃敟 娣峰悎妯″紡锛氫氦鎻涘叐鍊嬭嫳鏂囧崱鐗囩殑浣嶇疆
    swapMixedModeCards(card1, card2, frame1Index, frame2Index) {
        console.log('馃攧 娣峰悎妯″紡锛氫氦鎻涘崱鐗?, { frame1Index, frame2Index });

        // 鐛插彇鍏╁€嬫
        const frame1 = this.rightCards[frame1Index];
        const frame2 = this.rightCards[frame2Index];

        // 鐛插彇鍏╁€嬪崱鐗囩殑鍘熷浣嶇疆
        const card1OriginalX = card1.getData('originalX');
        const card1OriginalY = card1.getData('originalY');
        const card2OriginalX = card2.getData('originalX');
        const card2OriginalY = card2.getData('originalY');

        // 鏇存柊鍗＄墖鐨勬绱㈠紩
        card1.setData('currentFrameIndex', frame2Index);
        card2.setData('currentFrameIndex', frame1Index);

        // 鏇存柊鍗＄墖鐨勫師濮嬩綅缃?        card1.setData('originalX', card2OriginalX);
        card1.setData('originalY', card2OriginalY);
        card2.setData('originalX', card1OriginalX);
        card2.setData('originalY', card1OriginalY);

        // 鏇存柊妗嗙殑鏁告摎
        frame1.setData('currentCardPairId', card2.getData('pairId'));
        frame2.setData('currentCardPairId', card1.getData('pairId'));

        // 鍕曠暙绉诲嫊鍒版柊浣嶇疆
        this.tweens.add({
            targets: card1,
            x: card2OriginalX,
            y: card2OriginalY,
            scaleX: 1,
            scaleY: 1,
            duration: 300,
            ease: 'Back.easeOut',
            onComplete: () => {
                card1.setDepth(5);
                card1.getData('background').setAlpha(1);
            }
        });

        this.tweens.add({
            targets: card2,
            x: card1OriginalX,
            y: card1OriginalY,
            scaleX: 1,
            scaleY: 1,
            duration: 300,
            ease: 'Back.easeOut',
            onComplete: () => {
                card2.setDepth(5);
                card2.getData('background').setAlpha(1);
            }
        });
    }

    checkMatch(leftCard, rightCard) {
        // 馃敟 鏂版鍒讹細鐒¤珫灏嶉尟锛岄兘璁撹嫳鏂囧崱鐗囬€插叆涓枃鍏ф
        // 涓嶇珛鍗虫鏌ュ皪閷紝绛夊緟鐢ㄦ埗榛炴搳銆屾彁浜ょ瓟妗堛€嶆寜閳?        this.onMatchSuccess(leftCard, rightCard);
    }

    onMatchSuccess(leftCard, rightCard) {
        // 妯欒鐐哄凡閰嶅皪
        leftCard.setData('isMatched', true);
        leftCard.setData('matchedWith', rightCard);  // 瑷橀寗閰嶅皪鐨勫彸鍋村崱鐗?        rightCard.setData('isMatched', true);
        rightCard.setData('matchedWith', leftCard);  // 瑷橀寗閰嶅皪鐨勫乏鍋村崱鐗?
        // 鍒嗛洟妯″紡锛氬乏鍋村崱鐗囩Щ鍕曞埌鍙冲伌绌虹櫧妗嗙殑浣嶇疆锛堝畬鍏ㄨ钃嬶級
        const targetX = rightCard.x;
        const targetY = rightCard.y;

        this.tweens.add({
            targets: leftCard,
            x: targetX,
            y: targetY,
            scaleX: 1,
            scaleY: 1,
            duration: 300,
            ease: 'Back.easeOut',
            onComplete: () => {
                leftCard.setDepth(10);  // 鎻愬崌鍒扮┖鐧芥涓婃柟
                leftCard.getData('background').setAlpha(1);

                // 馃敟 妾㈡煡鏄惁鎵€鏈夊崱鐗囬兘宸查厤灏嶏紝濡傛灉鏄墖椤ず銆屾彁浜ょ瓟妗堛€嶆寜閳?                this.checkAllCardsMatched();
            }
        });
    }

    unmatchCard(leftCard) {
        // 鍙栨秷閰嶅皪鐙€鎱?        const rightCard = leftCard.getData('matchedWith');

        if (rightCard) {
            // 绉婚櫎閰嶅皪妯欒
            leftCard.setData('isMatched', false);
            leftCard.setData('matchedWith', null);
            rightCard.setData('isMatched', false);
            rightCard.setData('matchedWith', null);

            // 寰炲凡閰嶅皪闆嗗悎涓Щ闄?            this.matchedPairs.delete(leftCard.getData('pairId'));

            // 鍒嗛洟妯″紡锛氶’绀哄彸鍋寸┖鐧芥锛堝鏋滀箣鍓嶈闅辫棌锛?            rightCard.getData('background').setVisible(true);
        }
    }

    onMatchFail(leftCard, rightCard) {
        // 馃敟 涓嶉’绀洪尟瑾ゆ彁绀猴紝鍙畵宸﹀伌鍗＄墖杩斿洖鍘熶綅
        this.tweens.add({
            targets: leftCard,
            x: leftCard.getData('originalX'),
            y: leftCard.getData('originalY'),
            scaleX: 1,
            scaleY: 1,
            duration: 300,
            ease: 'Back.easeOut',
            onComplete: () => {
                leftCard.setDepth(5);
                leftCard.getData('background').setAlpha(1);
            }
        });

        console.log('鉂?閰嶅皪澶辨晽锛堜笉椤ず閷鎻愮ず锛?);
    }

    // 馃敟 妾㈡煡鏄惁鎵€鏈夊崱鐗囬兘宸查厤灏?    checkAllCardsMatched() {
        // 馃摑 瑾胯│瑷婃伅锛氳閷勯厤灏嶇媭鎱嬫鏌?        const matchedCount = this.leftCards.filter(card => card.getData('isMatched')).length;
        const totalCount = this.leftCards.length;
        const allMatched = matchedCount === totalCount;

        console.log('馃攳 妾㈡煡閰嶅皪鐙€鎱?', {
            matchedCount,
            totalCount,
            allMatched,
            hasSubmitButton: !!this.submitButton,
            matchedPairsSize: this.matchedPairs.size
        });

        if (allMatched && !this.submitButton) {
            console.log('鉁?鎵€鏈夊崱鐗囬兘宸查厤灏嶏紝椤ず鎻愪氦绛旀鎸夐垥');
            this.showSubmitButton();
        } else if (!allMatched) {
            console.log('鈴?閭勬湁鍗＄墖鏈厤灏?', totalCount - matchedCount);
        } else if (this.submitButton) {
            console.log('鈩癸笍 鎻愪氦鎸夐垥宸插瓨鍦?);
        }
    }

    // 馃敟 椤ず銆屾彁浜ょ瓟妗堛€嶆寜閳?    showSubmitButton() {
        const width = this.scale.width;
        const height = this.scale.height;

        console.log('馃攳 椤ず鎻愪氦绛旀鎸夐垥', { width, height });

        // 馃敟 鏅鸿兘鍒ゆ柗瀹瑰櫒澶у皬
        const isSmallContainer = height < 600;
        const isMediumContainer = height >= 600 && height < 800;
        const isLargeContainer = height >= 800;

        // 馃敟 鎸夐垥灏哄锛堟牴鎿氬鍣ㄥぇ灏忚鏁达級
        let buttonWidth, buttonHeight, fontSize;

        if (isSmallContainer) {
            // 灏忓鍣細鏇村皬鐨勬寜閳?            buttonWidth = Math.max(80, Math.min(120, width * 0.12));
            buttonHeight = Math.max(30, Math.min(40, height * 0.06));
            fontSize = Math.max(14, Math.min(18, width * 0.015));
        } else if (isMediumContainer) {
            // 涓瓑瀹瑰櫒锛氫腑绛夋寜閳?            buttonWidth = Math.max(100, Math.min(150, width * 0.15));
            buttonHeight = Math.max(35, Math.min(50, height * 0.07));
            fontSize = Math.max(16, Math.min(22, width * 0.02));
        } else {
            // 澶у鍣細绋嶅ぇ鐨勬寜閳?            buttonWidth = Math.max(120, Math.min(180, width * 0.12));
            buttonHeight = Math.max(40, Math.min(55, height * 0.06));
            fontSize = Math.max(18, Math.min(24, width * 0.02));
        }

        // 馃敟 鎸夐垥浣嶇疆锛堟渶搴曚笅涓ぎ锛岀暀鍑烘洿澶氱┖闁擄級
        const buttonX = width / 2;
        const buttonY = height - buttonHeight / 2 - 5;  // 璺濋洟搴曢儴 5px

        console.log('馃攳 鎸夐垥浣嶇疆', { buttonX, buttonY, buttonWidth, buttonHeight, isSmallContainer, isMediumContainer, isLargeContainer });

        // 鍓靛缓鎸夐垥鑳屾櫙
        const buttonBg = this.add.rectangle(buttonX, buttonY, buttonWidth, buttonHeight, 0x4caf50);
        buttonBg.setStrokeStyle(2, 0x388e3c);
        buttonBg.setInteractive({ useHandCursor: true });
        buttonBg.setDepth(3000);  // 馃敟 鎻愰珮娣卞害纰轰繚鍦ㄦ渶涓婂堡
        buttonBg.setScrollFactor(0);  // 馃敟 鍥哄畾鍦ㄨ灑骞曚笂锛屼笉闅ㄧ浉姗熺Щ鍕?
        // 鍓靛缓鎸夐垥鏂囧瓧
        const buttonText = this.add.text(buttonX, buttonY, '鎻愪氦绛旀', {
            fontSize: `${fontSize}px`,
            color: '#ffffff',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        buttonText.setOrigin(0.5);
        buttonText.setDepth(3001);  // 馃敟 鎻愰珮娣卞害纰轰繚鍦ㄦ渶涓婂堡
        buttonText.setScrollFactor(0);  // 馃敟 鍥哄畾鍦ㄨ灑骞曚笂锛屼笉闅ㄧ浉姗熺Щ鍕?
        console.log('鉁?鎻愪氦绛旀鎸夐垥宸插壍寤?);

        // 鎸夐垥榛炴搳浜嬩欢
        buttonBg.on('pointerdown', () => {
            console.log('馃攳 鎻愪氦绛旀锛岄枊濮嬫鏌ラ厤灏嶇祼鏋?);
            this.checkAllMatches();
        });

        // 鎸夐垥鎳稿仠鏁堟灉
        buttonBg.on('pointerover', () => {
            buttonBg.setFillStyle(0x66bb6a);
            console.log('馃攳 鎸夐垥鎳稿仠');
        });

        buttonBg.on('pointerout', () => {
            buttonBg.setFillStyle(0x4caf50);
        });

        // 淇濆瓨鎸夐垥寮曠敤
        this.submitButton = { bg: buttonBg, text: buttonText };
    }

    // 馃敟 妾㈡煡鎵€鏈夐厤灏嶇祼鏋?    checkAllMatches() {
        let correctCount = 0;
        let incorrectCount = 0;
        let unmatchedCount = 0;

        // 馃敟 鐛插彇鐣跺墠闋佺殑瑭炲綑鏁告摎
        const startIndex = this.currentPage * this.itemsPerPage;
        const endIndex = Math.min(startIndex + this.itemsPerPage, this.pairs.length);
        const currentPagePairs = this.pairs.slice(startIndex, endIndex);

        // 馃敟 娓呯┖鐣跺墠闋侀潰鐨勭瓟妗堣閷?        this.currentPageAnswers = [];

        // 妾㈡煡姣忓€嬪乏鍋村崱鐗囩殑閰嶅皪
        this.leftCards.forEach(leftCard => {
            const leftPairId = leftCard.getData('pairId');
            const rightCard = leftCard.getData('matchedWith');
            const correctPair = currentPagePairs.find(pair => pair.id === leftPairId);

            if (rightCard) {
                const rightPairId = rightCard.getData('pairId');
                const isCorrect = leftPairId === rightPairId;

                // 馃敟 鐛插彇鐢ㄦ埗鍥炵瓟鐨勮嫳鏂囷紙寰?pairs 鏁告摎涓嵅鍙栵紝鑰屼笉鏄緸鍗＄墖灏嶈薄锛?                const userAnswerPair = currentPagePairs.find(pair => pair.id === rightPairId);

                // 馃敟 瑷橀寗鐢ㄦ埗绛旀
                this.currentPageAnswers.push({
                    page: this.currentPage,
                    leftText: correctPair.chinese,  // 馃敟 浣跨敤 pair.chinese 鑰屼笉鏄?getData('text')
                    rightText: userAnswerPair ? userAnswerPair.english : '(鏈煡)',  // 馃敟 浣跨敤 pair.english
                    correctAnswer: correctPair.english,
                    correctChinese: correctPair.chinese,
                    isCorrect: isCorrect,
                    leftPairId: leftPairId,
                    rightPairId: rightPairId
                });

                if (isCorrect) {
                    // 閰嶅皪姝ｇ⒑
                    correctCount++;
                    console.log('鉁?閰嶅皪姝ｇ⒑:', correctPair.chinese, '-', userAnswerPair.english);

                    // 馃敟 椤ず姝ｇ⒑鐨勮嫳鏂囧柈瀛楋紝鍏ф鍛堢櫧鑹诧紝妯欒鍕惧嬀
                    this.showCorrectAnswer(rightCard, correctPair.english);
                } else {
                    // 閰嶅皪閷
                    incorrectCount++;
                    console.log('鉂?閰嶅皪閷:', correctPair.chinese, '-', userAnswerPair.english);

                    // 馃敟 椤ず姝ｇ⒑鐨勮嫳鏂囧柈瀛楋紝鍏ф鍛堢伆鑹诧紝妯欒 X
                    this.showIncorrectAnswer(rightCard, correctPair.english);
                }
            } else {
                // 鏈厤灏?                unmatchedCount++;
                console.log('鈿狅笍 鏈厤灏?', correctPair.chinese);

                // 馃敟 瑷橀寗鏈厤灏嶇殑绛旀
                this.currentPageAnswers.push({
                    page: this.currentPage,
                    leftText: correctPair.chinese,  // 馃敟 浣跨敤 pair.chinese
                    rightText: null,
                    correctAnswer: correctPair.english,
                    correctChinese: correctPair.chinese,
                    isCorrect: false,
                    leftPairId: leftPairId,
                    rightPairId: null
                });
            }
        });

        // 馃敟 灏囩暥鍓嶉爜闈㈢殑绛旀娣诲姞鍒版墍鏈夌瓟妗堣閷勪腑
        this.allPagesAnswers.push(...this.currentPageAnswers);

        console.log('馃摑 鐣跺墠闋侀潰绛旀瑷橀寗:', this.currentPageAnswers);
        console.log('馃摑 鎵€鏈夐爜闈㈢瓟妗堣閷?', this.allPagesAnswers);

        // 馃敟 妾㈡煡鏄惁鎵€鏈夐爜闈㈤兘宸插畬鎴?        const isLastPage = this.currentPage === this.totalPages - 1;
        if (isLastPage) {
            // 閬婃埐绲愭潫
            this.gameEndTime = Date.now();
            this.totalGameTime = (this.gameEndTime - this.gameStartTime) / 1000; // 绉?            this.gameState = 'completed';

            console.log('馃幃 閬婃埐绲愭潫锛佺附鏅傞枔:', this.totalGameTime, '绉?);

            // 椤ず閬婃埐绲愭潫妯℃厠妗?            this.showGameCompleteModal();
        } else {
            // 椤ず鐣跺墠闋侀潰鐨勭附绲?            this.showMatchSummary(correctCount, incorrectCount, unmatchedCount);
        }
    }

    // 馃敟 椤ず姝ｇ⒑绛旀锛堢櫧鑹插収妗?+ 鍕惧嬀锛?    showCorrectAnswer(rightCard, correctAnswer) {
        const background = rightCard.getData('background');
        const textObj = rightCard.getData('text');  // 馃敟 淇锛氫娇鐢?'text' 鑰岄潪 'textObj'

        // 鍏ф鍛堢櫧鑹?        background.setFillStyle(0xffffff);
        background.setStrokeStyle(2, 0x000000);

        // 鏇存柊鏂囧瓧鐐烘纰虹瓟妗?        if (textObj) {
            textObj.setText(correctAnswer);
        }

        // 娣诲姞鍕惧嬀妯欒
        const checkMark = this.add.text(
            rightCard.x + background.width / 2 - 15,
            rightCard.y - background.height / 2 + 5,
            '鉁?,
            {
                fontSize: '24px',
                color: '#4caf50',
                fontFamily: 'Arial',
                fontStyle: 'bold'
            }
        );
        checkMark.setOrigin(0.5).setDepth(15);
        rightCard.add(checkMark);
    }

    // 馃敟 椤ず閷绛旀锛堢伆鑹插収妗?+ X锛?    showIncorrectAnswer(rightCard, correctAnswer) {
        const background = rightCard.getData('background');
        const textObj = rightCard.getData('text');  // 馃敟 淇锛氫娇鐢?'text' 鑰岄潪 'textObj'

        // 鍏ф鍛堢伆鑹?        background.setFillStyle(0xcccccc);
        background.setStrokeStyle(2, 0x000000);

        // 鏇存柊鏂囧瓧鐐烘纰虹瓟妗?        if (textObj) {
            textObj.setText(correctAnswer);
        }

        // 娣诲姞 X 妯欒
        const xMark = this.add.text(
            rightCard.x + background.width / 2 - 15,
            rightCard.y - background.height / 2 + 5,
            '鉁?,
            {
                fontSize: '24px',
                color: '#f44336',
                fontFamily: 'Arial',
                fontStyle: 'bold'
            }
        );
        xMark.setOrigin(0.5).setDepth(15);
        rightCard.add(xMark);
    }

    // 馃敟 椤ず閰嶅皪绺界祼
    showMatchSummary(correctCount, incorrectCount, unmatchedCount = 0) {
        const width = this.scale.width;
        const height = this.scale.height;

        // 绉婚櫎鎻愪氦鎸夐垥
        if (this.submitButton) {
            this.submitButton.bg.destroy();
            this.submitButton.text.destroy();
            this.submitButton = null;
        }

        // 绺界祼鏂囧瓧灏哄锛堥熆鎳夊紡锛?        const fontSize = Math.max(24, Math.min(36, width * 0.03));

        // 椤ず绺界祼
        const totalCount = this.leftCards.length;
        let summaryMessage = `閰嶅皪绲愭灉\n姝ｇ⒑锛?{correctCount} / ${totalCount}\n閷锛?{incorrectCount} / ${totalCount}`;

        if (unmatchedCount > 0) {
            summaryMessage += `\n鏈厤灏嶏細${unmatchedCount} / ${totalCount}`;
        }

        const summaryText = this.add.text(
            width / 2,
            height / 2 - 50,
            summaryMessage,
            {
                fontSize: `${fontSize}px`,
                color: correctCount === totalCount && unmatchedCount === 0 ? '#4caf50' : '#ff9800',
                fontFamily: 'Arial',
                fontStyle: 'bold',
                align: 'center',
                backgroundColor: correctCount === totalCount && unmatchedCount === 0 ? '#e8f5e9' : '#fff3e0',
                padding: { x: 25, y: 15 }
            }
        );
        summaryText.setOrigin(0.5).setDepth(2000);

        // 濡傛灉鍏ㄩ儴姝ｇ⒑涓旀矑鏈夋湭閰嶅皪锛岄’绀哄畬鎴愬嫊鐣?        if (correctCount === totalCount && unmatchedCount === 0) {
            this.tweens.add({
                targets: summaryText,
                scaleX: 1.1,
                scaleY: 1.1,
                duration: 500,
                yoyo: true,
                repeat: 2,
                ease: 'Sine.easeInOut',
                onComplete: () => {
                    // 妾㈡煡鏄惁鏈変笅涓€闋?                    this.time.delayedCall(1000, () => {
                        this.onGameComplete();
                    });
                }
            });
        } else {
            // 椤ず銆岄噸瑭︺€嶆寜閳?            this.time.delayedCall(2000, () => {
                this.showRetryButton();
            });
        }
    }

    // 馃敟 椤ず銆岄噸瑭︺€嶆寜閳?    showRetryButton() {
        const width = this.scale.width;
        const height = this.scale.height;

        const buttonWidth = Math.max(120, Math.min(200, width * 0.15));
        const buttonHeight = Math.max(40, Math.min(60, height * 0.08));
        const fontSize = Math.max(16, Math.min(24, width * 0.02));

        const buttonX = width / 2;
        const buttonY = height / 2 + 50;

        const buttonBg = this.add.rectangle(buttonX, buttonY, buttonWidth, buttonHeight, 0xff9800);
        buttonBg.setStrokeStyle(2, 0xf57c00);
        buttonBg.setInteractive({ useHandCursor: true });
        buttonBg.setDepth(2000);

        const buttonText = this.add.text(buttonX, buttonY, '閲嶈│', {
            fontSize: `${fontSize}px`,
            color: '#ffffff',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        buttonText.setOrigin(0.5);
        buttonText.setDepth(2001);

        buttonBg.on('pointerdown', () => {
            console.log('馃攧 閲嶈│鐣跺墠闋?);
            this.resetCurrentPage();
        });

        buttonBg.on('pointerover', () => {
            buttonBg.setFillStyle(0xffb74d);
        });

        buttonBg.on('pointerout', () => {
            buttonBg.setFillStyle(0xff9800);
        });
    }

    // 馃敟 閲嶇疆鐣跺墠闋?    resetCurrentPage() {
        // 娓呴櫎鎵€鏈夊崱鐗?        this.leftCards.forEach(card => card.destroy());
        this.rightCards.forEach(card => card.destroy());
        this.leftCards = [];
        this.rightCards = [];
        this.matchedPairs.clear();

        // 娓呴櫎鎵€鏈夋枃瀛楀拰鎸夐垥
        this.children.list.forEach(child => {
            if (child.type === 'Text' || child.type === 'Rectangle') {
                child.destroy();
            }
        });

        // 閲嶆柊鍓靛缓鐣跺墠闋?        this.createCards();
    }

    onGameComplete() {
        // 馃敟 妾㈡煡鏄惁閭勬湁涓嬩竴闋?        if (this.enablePagination && this.currentPage < this.totalPages - 1) {
            // 閭勬湁涓嬩竴闋?            if (this.autoProceed) {
                // 鑷嫊閫插叆涓嬩竴闋?                console.log('馃搫 鐣跺墠闋佸畬鎴愶紝鑷嫊閫插叆涓嬩竴闋?);
                this.time.delayedCall(500, () => {
                    this.goToNextPage();
                });
            } else {
                // 椤ず銆屼笅涓€闋併€嶆寜閳?                console.log('馃搫 鐣跺墠闋佸畬鎴愶紝椤ず涓嬩竴闋佹寜閳?);
                this.showNextPageButton();
            }
        } else {
            // 鎵€鏈夐爜闈㈤兘瀹屾垚浜嗭紝椤ず鏈€绲傚畬鎴愯▕鎭?            console.log('馃帀 鎵€鏈夐爜闈㈠畬鎴愶紒');
            this.showFinalCompletion();
        }
    }

    // 馃敟 椤ず鏈€绲傚畬鎴愯▕鎭?    showFinalCompletion() {
        // 鍋滄瑷堟檪鍣?        if (this.timerEvent) {
            this.timerEvent.remove();
        }

        // 鐛插彇鐣跺墠铻㈠箷灏哄
        const width = this.scale.width;
        const height = this.scale.height;

        // 椤ず瀹屾垚瑷婃伅锛堥熆鎳夊紡锛?        const fontSize = Math.max(28, Math.min(48, width * 0.035));
        const completeText = this.add.text(width / 2, height / 2 - 50, '馃帀 鍏ㄩ儴瀹屾垚锛?, {
            fontSize: `${fontSize}px`,
            color: '#4caf50',
            fontFamily: 'Arial',
            fontStyle: 'bold',
            backgroundColor: '#e8f5e9',
            padding: { x: 25, y: 12 }
        });
        completeText.setOrigin(0.5).setDepth(2000);

        // 绺斁鍕曠暙
        this.tweens.add({
            targets: completeText,
            scaleX: 1.1,
            scaleY: 1.1,
            duration: 500,
            yoyo: true,
            repeat: -1,
            ease: 'Sine.easeInOut'
        });

        // 馃敟 濡傛灉闁嬪暉椤ず绛旀锛岄’绀虹瓟妗堟寜閳?        if (this.showAnswers) {
            const showAnswersButton = this.add.text(
                width / 2,
                height / 2 + 30,
                '馃摑 鏌ョ湅绛旀',
                {
                    fontSize: '24px',
                    color: '#ffffff',
                    fontFamily: 'Arial',
                    backgroundColor: '#2196F3',
                    padding: { x: 20, y: 10 }
                }
            ).setOrigin(0.5).setDepth(2001).setInteractive({ useHandCursor: true });

            showAnswersButton.on('pointerdown', () => {
                completeText.destroy();
                showAnswersButton.destroy();
                this.showAnswersScreen();
            });

            // 鎸夐垥鎳稿仠鏁堟灉
            showAnswersButton.on('pointerover', () => {
                showAnswersButton.setBackgroundColor('#1976D2');
            });

            showAnswersButton.on('pointerout', () => {
                showAnswersButton.setBackgroundColor('#2196F3');
            });
        }
    }

    // 馃敟 椤ず绛旀鐣潰
    showAnswersScreen() {
        const width = this.scale.width;
        const height = this.scale.height;

        // 娓呴櫎鎵€鏈夌従鏈夊厓绱?        this.children.removeAll(true);

        // 娣诲姞鐧借壊鑳屾櫙
        this.add.rectangle(width / 2, height / 2, width, height, 0xffffff).setDepth(-1);

        // 椤ず妯欓
        this.add.text(width / 2, 50, '馃摑 姝ｇ⒑绛旀', {
            fontSize: '32px',
            color: '#000000',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        }).setOrigin(0.5);

        // 鍓靛缓婊惧嫊鍗€鍩?        const startY = 100;
        const lineHeight = 40;
        const maxVisibleLines = Math.floor((height - 150) / lineHeight);

        // 椤ず鎵€鏈夐厤灏?        this.pairs.forEach((pair, index) => {
            const y = startY + index * lineHeight;

            // 鍙’绀哄彲瑕嬬瘎鍦嶅収鐨勭瓟妗?            if (index < maxVisibleLines) {
                this.add.text(
                    width / 2,
                    y,
                    `${pair.question} = ${pair.answer}`,
                    {
                        fontSize: '20px',
                        color: '#333333',
                        fontFamily: 'Arial'
                    }
                ).setOrigin(0.5);
            }
        });

        // 濡傛灉绛旀澶锛岄’绀烘彁绀?        if (this.pairs.length > maxVisibleLines) {
            this.add.text(
                width / 2,
                height - 50,
                `锛堥’绀哄墠 ${maxVisibleLines} 鍊嬬瓟妗堬紝鍏?${this.pairs.length} 鍊嬶級`,
                {
                    fontSize: '16px',
                    color: '#999999',
                    fontFamily: 'Arial'
                }
            ).setOrigin(0.5);
        }

        // 娣诲姞闂滈枆鎸夐垥
        const closeButton = this.add.text(
            width / 2,
            height - 80,
            '鉁?闂滈枆',
            {
                fontSize: '20px',
                color: '#ffffff',
                fontFamily: 'Arial',
                backgroundColor: '#f44336',
                padding: { x: 20, y: 10 }
            }
        ).setOrigin(0.5).setInteractive({ useHandCursor: true });

        closeButton.on('pointerdown', () => {
            // 閲嶆柊杓夊叆閬婃埐
            this.scene.restart();
        });

        // 鎸夐垥鎳稿仠鏁堟灉
        closeButton.on('pointerover', () => {
            closeButton.setBackgroundColor('#d32f2f');
        });

        closeButton.on('pointerout', () => {
            closeButton.setBackgroundColor('#f44336');
        });
    }

    // 馃敟 鍓靛缓鍒嗛爜鎸囩ず鍣?    createPageIndicator() {
        const width = this.scale.width;
        const height = this.scale.height;

        // 鍒嗛爜鎸囩ず鍣ㄦ枃瀛楋紙渚嬪锛?/5锛?        const pageText = `${this.currentPage + 1}/${this.totalPages}`;
        const fontSize = Math.max(18, Math.min(24, width * 0.02));

        this.pageIndicatorText = this.add.text(width / 2, height * 0.05, pageText, {
            fontSize: `${fontSize}px`,
            color: '#666666',
            fontFamily: 'Arial',
            fontStyle: 'bold',
            backgroundColor: '#f5f5f5',
            padding: { x: 15, y: 8 }
        });
        this.pageIndicatorText.setOrigin(0.5);
        this.pageIndicatorText.setDepth(100);  // 纰轰繚鍦ㄦ渶涓婂堡

        console.log('馃搫 鍒嗛爜鎸囩ず鍣ㄥ凡鍓靛缓:', pageText);
    }

    // 馃敟 鏇存柊鍒嗛爜鎸囩ず鍣?    updatePageIndicator() {
        if (this.pageIndicatorText) {
            const pageText = `${this.currentPage + 1}/${this.totalPages}`;
            this.pageIndicatorText.setText(pageText);
            console.log('馃搫 鍒嗛爜鎸囩ず鍣ㄥ凡鏇存柊:', pageText);
        }
    }

    // 馃敟 閫插叆涓嬩竴闋?    goToNextPage() {
        if (this.currentPage < this.totalPages - 1) {
            this.currentPage++;
            console.log('馃搫 閫插叆涓嬩竴闋?', this.currentPage + 1);

            // 閲嶆柊浣堝眬锛堟渻閲嶆柊鍓靛缓鍗＄墖锛?            this.updateLayout();
        }
    }

    // 馃敟 椤ず銆屼笅涓€闋併€嶆寜閳?    showNextPageButton() {
        const width = this.scale.width;
        const height = this.scale.height;

        // 鍓靛缓鎸夐垥鑳屾櫙
        const buttonWidth = 200;
        const buttonHeight = 60;
        const buttonX = width / 2;
        const buttonY = height / 2;

        const buttonBg = this.add.rectangle(buttonX, buttonY, buttonWidth, buttonHeight, 0x4caf50);
        buttonBg.setInteractive({ useHandCursor: true });
        buttonBg.setDepth(100);

        // 鍓靛缓鎸夐垥鏂囧瓧
        const buttonText = this.add.text(buttonX, buttonY, '鉃★笍 涓嬩竴闋?, {
            fontSize: '24px',
            color: '#ffffff',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        buttonText.setOrigin(0.5);
        buttonText.setDepth(101);

        // 榛炴搳浜嬩欢
        buttonBg.on('pointerdown', () => {
            // 绉婚櫎鎸夐垥
            buttonBg.destroy();
            buttonText.destroy();

            // 閫插叆涓嬩竴闋?            this.goToNextPage();
        });

        // 鎳稿仠鏁堟灉
        buttonBg.on('pointerover', () => {
            buttonBg.setFillStyle(0x45a049);
        });

        buttonBg.on('pointerout', () => {
            buttonBg.setFillStyle(0x4caf50);
        });

        console.log('馃搫 涓嬩竴闋佹寜閳曞凡椤ず');
    }

    // 馃敟 妾㈡煡鐣跺墠闋佹槸鍚﹀叏閮ㄩ厤灏嶅畬鎴?    checkCurrentPageComplete() {
        // 瑷堢畻鐣跺墠闋佹噳瑭叉湁澶氬皯鍊嬮厤灏?        const startIndex = this.currentPage * this.itemsPerPage;
        const endIndex = Math.min(startIndex + this.itemsPerPage, this.pairs.length);
        const currentPagePairsCount = endIndex - startIndex;

        // 瑷堢畻鐣跺墠闋佸凡閰嶅皪鐨勬暩閲?        let currentPageMatchedCount = 0;
        for (let i = startIndex; i < endIndex; i++) {
            const pairId = this.pairs[i].id;
            if (this.matchedPairs.has(pairId)) {
                currentPageMatchedCount++;
            }
        }

        console.log('馃搫 鐣跺墠闋侀厤灏嶉€插害:', {
            currentPage: this.currentPage + 1,
            matched: currentPageMatchedCount,
            total: currentPagePairsCount
        });

        // 濡傛灉鐣跺墠闋佸叏閮ㄩ厤灏嶅畬鎴?        if (currentPageMatchedCount === currentPagePairsCount) {
            this.time.delayedCall(800, () => {
                this.onGameComplete();
            });
        }
    }

    // 锟?绉婚櫎 createRestartButton() 鏂规硶锛氱敤鎴惰姹傛嬁鎺夐噸鏂伴枊濮嬫寜閳?
    // 馃敟 椤ず閬婃埐绲愭潫妯℃厠妗?    showGameCompleteModal() {
        const width = this.scale.width;
        const height = this.scale.height;

        // 瑷堢畻绺藉垎鏁?        const totalCorrect = this.allPagesAnswers.filter(answer => answer.isCorrect).length;
        const totalQuestions = this.pairs.length;

        // 鏍煎紡鍖栨檪闁?        const timeText = this.formatGameTime(this.totalGameTime);

        console.log('馃幃 椤ず閬婃埐绲愭潫妯℃厠妗?, {
            totalCorrect,
            totalQuestions,
            totalGameTime: this.totalGameTime,
            timeText
        });

        // 鍓靛缓鍗婇€忔槑鑳屾櫙锛堥伄缃╋級
        const overlay = this.add.rectangle(
            width / 2,
            height / 2,
            width,
            height,
            0x000000,
            0.7
        );
        overlay.setDepth(5000);
        overlay.setScrollFactor(0);

        // 鍓靛缓妯℃厠妗嗗鍣?        const modalWidth = Math.min(500, width * 0.8);
        const modalHeight = Math.min(400, height * 0.7);
        const modal = this.add.container(width / 2, height / 2);
        modal.setDepth(5001);
        modal.setScrollFactor(0);

        // 妯℃厠妗嗚儗鏅?        const modalBg = this.add.rectangle(0, 0, modalWidth, modalHeight, 0x2c2c2c);
        modalBg.setStrokeStyle(4, 0x000000);
        modal.add(modalBg);

        // 妯欓锛欸AME COMPLETE
        const title = this.add.text(0, -modalHeight / 2 + 40, 'GAME COMPLETE', {
            fontSize: '36px',
            color: '#ffffff',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        title.setOrigin(0.5);
        modal.add(title);

        // 鍒嗘暩妯欑堡
        const scoreLabel = this.add.text(-80, -modalHeight / 2 + 100, 'Score', {
            fontSize: '20px',
            color: '#4a9eff',
            fontFamily: 'Arial'
        });
        scoreLabel.setOrigin(0.5);
        modal.add(scoreLabel);

        // 鍒嗘暩鍊?        const scoreValue = this.add.text(-80, -modalHeight / 2 + 140, `${totalCorrect}/${totalQuestions}`, {
            fontSize: '32px',
            color: '#ffffff',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        scoreValue.setOrigin(0.5);
        modal.add(scoreValue);

        // 鏅傞枔妯欑堡锛堝鏋滄湁瑷堟檪鍣級
        if (this.timerType !== 'none') {
            const timeLabel = this.add.text(80, -modalHeight / 2 + 100, 'Time', {
                fontSize: '20px',
                color: '#4a9eff',
                fontFamily: 'Arial'
            });
            timeLabel.setOrigin(0.5);
            modal.add(timeLabel);

            // 鏅傞枔鍊?            const timeValue = this.add.text(80, -modalHeight / 2 + 140, timeText, {
                fontSize: '32px',
                color: '#ffffff',
                fontFamily: 'Arial',
                fontStyle: 'bold'
            });
            timeValue.setOrigin(0.5);
            modal.add(timeValue);
        }

        // 馃敟 鎺掑悕鎻愮ず锛堝嫊鎱嬮’绀猴紝浣嶇疆瑾挎暣鍒版寜閳曚笂鏂癸級
        const rankText = this.add.text(0, 0, 'Loading ranking...', {
            fontSize: '16px',
            color: '#ffffff',
            fontFamily: 'Arial'
        });
        rankText.setOrigin(0.5);
        modal.add(rankText);

        // 馃敟 鐣版鐛插彇鎺掑悕涓︽洿鏂版枃瀛?        this.fetchUserRanking(totalCorrect, totalQuestions, this.totalGameTime).then(ranking => {
            if (ranking && ranking.rank) {
                const rankSuffix = this.getRankSuffix(ranking.rank);
                rankText.setText(`YOU'RE ${ranking.rank}${rankSuffix} ON THE LEADERBOARD`);
            } else {
                rankText.setText('');  // 濡傛灉鐒℃硶鐛插彇鎺掑悕锛岄毐钘忔枃瀛?            }
        });

        // 鎸夐垥鍗€鍩燂紙瑾挎暣浣嶇疆锛岀偤鎺掑悕鎻愮ず鐣欏嚭绌洪枔锛?        const buttonY = modalHeight / 2 - 100;
        const buttonSpacing = 60;

        // 馃敟 瑾挎暣鎺掑悕鎻愮ず浣嶇疆鍒扮涓€鍊嬫寜閳曚笂鏂?        rankText.y = buttonY - buttonSpacing - 40;

        // Leaderboard 鎸夐垥
        this.createModalButton(modal, 0, buttonY - buttonSpacing, 'Leaderboard', () => {
            console.log('馃幃 榛炴搳 Leaderboard 鎸夐垥');
            this.showEnterNamePage();
        });

        // Show answers 鎸夐垥
        this.createModalButton(modal, 0, buttonY, 'Show answers', () => {
            console.log('馃幃 榛炴搳 Show answers 鎸夐垥');
            this.showMyAnswersPage();
        });

        // Start again 鎸夐垥
        this.createModalButton(modal, 0, buttonY + buttonSpacing, 'Start again', () => {
            console.log('馃幃 榛炴搳 Start again 鎸夐垥');
            this.restartGame();
        });

        // 淇濆瓨妯℃厠妗嗗紩鐢紙鐢ㄦ柤寰岀簩闂滈枆锛?        this.gameCompleteModal = { overlay, modal };
    }

    // 馃敟 鍓靛缓妯℃厠妗嗘寜閳?    createModalButton(container, x, y, text, callback) {
        const buttonWidth = 300;
        const buttonHeight = 45;

        // 鎸夐垥鑳屾櫙
        const buttonBg = this.add.rectangle(x, y, buttonWidth, buttonHeight, 0x3c3c3c);
        buttonBg.setStrokeStyle(2, 0x000000);
        buttonBg.setInteractive({ useHandCursor: true });
        container.add(buttonBg);

        // 鎸夐垥鏂囧瓧
        const buttonText = this.add.text(x, y, text, {
            fontSize: '22px',
            color: '#ffffff',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        buttonText.setOrigin(0.5);
        container.add(buttonText);

        // 榛炴搳浜嬩欢
        buttonBg.on('pointerdown', callback);

        // 鎳稿仠鏁堟灉
        buttonBg.on('pointerover', () => {
            buttonBg.setFillStyle(0x4c4c4c);
        });

        buttonBg.on('pointerout', () => {
            buttonBg.setFillStyle(0x3c3c3c);
        });

        return { buttonBg, buttonText };
    }

    // 馃敟 鐛插彇鐢ㄦ埗鎺掑悕锛堢暟姝ワ級
    async fetchUserRanking(correctCount, totalCount, timeSpent) {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const activityId = urlParams.get('activityId');

            if (!activityId) {
                console.log('鈿狅笍 鐒℃硶鐛插彇 activityId锛岀劇娉曟煡瑭㈡帓鍚?);
                return null;
            }

            // 瑷堢畻鍒嗘暩鍜屾簴纰虹巼
            const score = Math.round((correctCount / totalCount) * 100);
            const accuracy = Math.round((correctCount / totalCount) * 100);

            // 鐛插彇鎺掕姒滄暩鎿?            const response = await fetch(`/api/leaderboard?activityId=${activityId}&limit=100`);
            if (!response.ok) {
                console.log('鈿狅笍 鐒℃硶鐛插彇鎺掕姒滄暩鎿?);
                return null;
            }

            const data = await response.json();
            const leaderboard = data.leaderboard || [];

            // 瑷堢畻鐣跺墠鐢ㄦ埗鐨勬帓鍚?            // 鎺掑簭瑕忓墖锛氬垎鏁稿劒鍏堬紙闄嶅簭锛夛紝鏅傞枔娆′箣锛堝崌搴忥級
            const userScore = score;
            const userTime = timeSpent;

            let rank = 1;
            for (const entry of leaderboard) {
                if (entry.score > userScore) {
                    rank++;
                } else if (entry.score === userScore && entry.timeSpent < userTime) {
                    rank++;
                }
            }

            console.log('馃弳 鐢ㄦ埗鎺掑悕:', rank);
            return { rank, score, accuracy, timeSpent };
        } catch (error) {
            console.error('鉂?鐛插彇鎺掑悕澶辨晽:', error);
            return null;
        }
    }

    // 馃敟 鐛插彇鎺掑悕寰岀洞锛?st, 2nd, 3rd, 4th, ...锛?    getRankSuffix(rank) {
        if (rank % 100 >= 11 && rank % 100 <= 13) {
            return 'TH';
        }
        switch (rank % 10) {
            case 1: return 'ST';
            case 2: return 'ND';
            case 3: return 'RD';
            default: return 'TH';
        }
    }

    // 馃敟 鏍煎紡鍖栭亰鎴叉檪闁?    formatGameTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        const decimal = Math.floor((seconds % 1) * 10);

        if (mins > 0) {
            return `${mins}:${secs.toString().padStart(2, '0')}.${decimal}`;
        } else {
            return `${secs}.${decimal}s`;
        }
    }

    // 馃敟 閲嶆柊闁嬪閬婃埐
    restartGame() {
        console.log('馃幃 閲嶆柊闁嬪閬婃埐');

        // 闂滈枆妯℃厠妗?        if (this.gameCompleteModal) {
            this.gameCompleteModal.overlay.destroy();
            this.gameCompleteModal.modal.destroy();
            this.gameCompleteModal = null;
        }

        // 閲嶇疆閬婃埐鐙€鎱?        this.gameState = 'playing';
        this.gameStartTime = null;
        this.gameEndTime = null;
        this.totalGameTime = 0;
        this.allPagesAnswers = [];
        this.currentPageAnswers = [];
        this.currentPage = 0;
        this.matchedPairs.clear();

        // 閲嶆柊杓夊叆閬婃埐
        this.scene.restart();
    }

    // 馃敟 椤ず My Answers 闋侀潰
    showMyAnswersPage() {
        console.log('馃幃 椤ず My Answers 闋侀潰');

        // 闅辫棌閬婃埐绲愭潫妯℃厠妗?        if (this.gameCompleteModal) {
            this.gameCompleteModal.overlay.setVisible(false);
            this.gameCompleteModal.modal.setVisible(false);
        }

        const width = this.scale.width;
        const height = this.scale.height;

        // 鍓靛缓鍗婇€忔槑鑳屾櫙锛堥伄缃╋級
        const overlay = this.add.rectangle(
            width / 2,
            height / 2,
            width,
            height,
            0x000000,
            0.7
        );
        overlay.setDepth(6000);
        overlay.setScrollFactor(0);

        // 鍓靛缓绛旀闋侀潰瀹瑰櫒
        const pageWidth = Math.min(800, width * 0.9);
        const pageHeight = Math.min(600, height * 0.9);
        const page = this.add.container(width / 2, height / 2);
        page.setDepth(6001);
        page.setScrollFactor(0);

        // 闋侀潰鑳屾櫙
        const pageBg = this.add.rectangle(0, 0, pageWidth, pageHeight, 0xffffff);
        pageBg.setStrokeStyle(4, 0x000000);
        page.add(pageBg);

        // 妯欓锛歁y Answers
        const title = this.add.text(0, -pageHeight / 2 + 40, 'My Answers', {
            fontSize: '32px',
            color: '#000000',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        title.setOrigin(0.5);
        page.add(title);

        // 椤ず绛旀鍒楄〃
        const answerStartY = -pageHeight / 2 + 100;
        const answerSpacing = 80;
        const maxAnswersPerPage = Math.floor((pageHeight - 200) / answerSpacing);

        // 鐛插彇鎵€鏈夌瓟妗堬紙鍖呭惈鎵€鏈夐爜闈級
        const allAnswers = this.allPagesAnswers;
        console.log('馃摑 鎵€鏈夌瓟妗?', allAnswers);

        // 椤ず绛旀锛堟渶澶氶’绀?maxAnswersPerPage 鍊嬶級
        const answersToShow = allAnswers.slice(0, maxAnswersPerPage);
        const cardWidth = 300;  // 馃敟 鑸?createAnswerCard 涓殑 cardWidth 涓€鑷?        const cardX = -pageWidth / 2 + cardWidth / 2 + 30;  // 馃敟 宸﹂倞璺?30px
        answersToShow.forEach((answer, index) => {
            const y = answerStartY + index * answerSpacing;
            this.createAnswerCard(page, cardX, y, answer, 'myAnswer');
        });

        // 搴曢儴鎸夐垥鍗€鍩?        const buttonY = pageHeight / 2 - 60;

        // Correct Answers 鎸夐垥
        this.createAnswerPageButton(page, -150, buttonY, 'Correct Answers', () => {
            console.log('馃幃 榛炴搳 Correct Answers 鎸夐垥');
            this.hideMyAnswersPage();
            this.showCorrectAnswersPage();
        });

        // Back 鎸夐垥
        this.createAnswerPageButton(page, 150, buttonY, 'Back', () => {
            console.log('馃幃 榛炴搳 Back 鎸夐垥');
            this.hideMyAnswersPage();
        });

        // 淇濆瓨闋侀潰寮曠敤
        this.myAnswersPage = { overlay, page };
    }

    // 馃敟 闅辫棌 My Answers 闋侀潰
    hideMyAnswersPage() {
        if (this.myAnswersPage) {
            this.myAnswersPage.overlay.destroy();
            this.myAnswersPage.page.destroy();
            this.myAnswersPage = null;
        }

        // 椤ず閬婃埐绲愭潫妯℃厠妗?        if (this.gameCompleteModal) {
            this.gameCompleteModal.overlay.setVisible(true);
            this.gameCompleteModal.modal.setVisible(true);
        }
    }

    // 馃敟 椤ず Correct Answers 闋侀潰
    showCorrectAnswersPage() {
        console.log('馃幃 椤ず Correct Answers 闋侀潰');

        const width = this.scale.width;
        const height = this.scale.height;

        // 鍓靛缓鍗婇€忔槑鑳屾櫙锛堥伄缃╋級
        const overlay = this.add.rectangle(
            width / 2,
            height / 2,
            width,
            height,
            0x000000,
            0.7
        );
        overlay.setDepth(6000);
        overlay.setScrollFactor(0);

        // 鍓靛缓绛旀闋侀潰瀹瑰櫒
        const pageWidth = Math.min(800, width * 0.9);
        const pageHeight = Math.min(600, height * 0.9);
        const page = this.add.container(width / 2, height / 2);
        page.setDepth(6001);
        page.setScrollFactor(0);

        // 闋侀潰鑳屾櫙
        const pageBg = this.add.rectangle(0, 0, pageWidth, pageHeight, 0xffffff);
        pageBg.setStrokeStyle(4, 0x000000);
        page.add(pageBg);

        // 妯欓锛欳orrect Answers
        const title = this.add.text(0, -pageHeight / 2 + 40, 'Correct Answers', {
            fontSize: '32px',
            color: '#000000',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        title.setOrigin(0.5);
        page.add(title);

        // 椤ず绛旀鍒楄〃
        const answerStartY = -pageHeight / 2 + 100;
        const answerSpacing = 80;
        const maxAnswersPerPage = Math.floor((pageHeight - 200) / answerSpacing);

        // 鐛插彇鎵€鏈夌瓟妗堬紙鍖呭惈鎵€鏈夐爜闈級
        const allAnswers = this.allPagesAnswers;

        // 椤ず绛旀锛堟渶澶氶’绀?maxAnswersPerPage 鍊嬶級
        const answersToShow = allAnswers.slice(0, maxAnswersPerPage);
        const cardWidth = 300;  // 馃敟 鑸?createAnswerCard 涓殑 cardWidth 涓€鑷?        const cardX = -pageWidth / 2 + cardWidth / 2 + 30;  // 馃敟 宸﹂倞璺?30px
        answersToShow.forEach((answer, index) => {
            const y = answerStartY + index * answerSpacing;
            this.createAnswerCard(page, cardX, y, answer, 'correctAnswer');
        });

        // 搴曢儴鎸夐垥鍗€鍩?        const buttonY = pageHeight / 2 - 60;

        // My Answers 鎸夐垥
        this.createAnswerPageButton(page, -150, buttonY, 'My Answers', () => {
            console.log('馃幃 榛炴搳 My Answers 鎸夐垥');
            this.hideCorrectAnswersPage();
            this.showMyAnswersPage();
        });

        // Back 鎸夐垥
        this.createAnswerPageButton(page, 150, buttonY, 'Back', () => {
            console.log('馃幃 榛炴搳 Back 鎸夐垥');
            this.hideCorrectAnswersPage();
        });

        // 淇濆瓨闋侀潰寮曠敤
        this.correctAnswersPage = { overlay, page };
    }

    // 馃敟 闅辫棌 Correct Answers 闋侀潰
    hideCorrectAnswersPage() {
        if (this.correctAnswersPage) {
            this.correctAnswersPage.overlay.destroy();
            this.correctAnswersPage.page.destroy();
            this.correctAnswersPage = null;
        }

        // 椤ず閬婃埐绲愭潫妯℃厠妗?        if (this.gameCompleteModal) {
            this.gameCompleteModal.overlay.setVisible(true);
            this.gameCompleteModal.modal.setVisible(true);
        }
    }

    // 馃敟 鍓靛缓绛旀鍗＄墖
    createAnswerCard(container, x, y, answer, type) {
        const cardWidth = 300;  // 馃敟 娓涘皬鍗＄墖瀵害浠ラ仼鎳夊鍣?        const cardHeight = 60;
        const chineseX = x + cardWidth / 2 + 20;  // 馃敟 涓枃鍦ㄥ崱鐗囧彸閭?20px

        // 鏍规摎椤炲瀷姹哄畾椤ず鍏у
        let displayText, bgColor, markColor, markText;

        if (type === 'myAnswer') {
            // My Answers 闋侀潰锛氶’绀虹敤鎴剁殑绛旀
            displayText = answer.rightText || '(鏈厤灏?';
            if (answer.isCorrect) {
                bgColor = this.getCardColor(answer.leftPairId); // 褰╄壊鑳屾櫙
                markColor = '#4caf50';
                markText = '鉁?;
            } else {
                bgColor = 0xcccccc; // 鐏拌壊鑳屾櫙
                markColor = '#f44336';
                markText = '鉁?;
            }
        } else {
            // Correct Answers 闋侀潰锛氶’绀烘纰虹瓟妗?            displayText = answer.correctAnswer;
            bgColor = this.getCardColor(answer.leftPairId); // 褰╄壊鑳屾櫙
            markColor = '#4caf50';
            markText = '鉁?;
        }

        // 鍓靛缓鍗＄墖鑳屾櫙
        const cardBg = this.add.rectangle(x, y, cardWidth, cardHeight, bgColor);
        cardBg.setStrokeStyle(2, 0x000000);
        container.add(cardBg);

        // 鍓靛缓鍗＄墖鏂囧瓧
        const cardText = this.add.text(x, y, displayText, {
            fontSize: '24px',
            color: '#ffffff',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        cardText.setOrigin(0.5);
        container.add(cardText);

        // 鍓靛缓妯欒锛堝嬀鍕炬垨 X锛?        const mark = this.add.text(x + cardWidth / 2 - 20, y - cardHeight / 2 + 10, markText, {
            fontSize: '24px',
            color: markColor,
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        mark.setOrigin(0.5);
        container.add(mark);

        // 鍓靛缓涓枃鏂囧瓧锛堥’绀虹敤鎴堕伕鎿囩殑涓枃锛?        const chineseText = this.add.text(chineseX, y, answer.leftText, {
            fontSize: '28px',
            color: '#000000',
            fontFamily: 'Arial',
            fontStyle: 'normal'
        });
        chineseText.setOrigin(0, 0.5);
        container.add(chineseText);
    }

    // 馃敟 鐛插彇鍗＄墖椤忚壊锛堟牴鎿?pairId锛?    getCardColor(pairId) {
        const colors = [
            0x4a9eff, // 钘嶈壊
            0xff4a4a, // 绱呰壊
            0xffa500, // 姗欒壊
            0x4caf50, // 缍犺壊
            0x9c27b0, // 绱壊
            0xffeb3b, // 榛冭壊
            0x00bcd4, // 闈掕壊
            0xff9800  // 娣辨鑹?        ];
        return colors[(pairId - 1) % colors.length];
    }

    // 馃敟 鍓靛缓绛旀闋侀潰鎸夐垥
    createAnswerPageButton(container, x, y, text, callback) {
        const buttonWidth = 250;
        const buttonHeight = 45;

        // 鎸夐垥鑳屾櫙
        const buttonBg = this.add.rectangle(x, y, buttonWidth, buttonHeight, 0xffffff);
        buttonBg.setStrokeStyle(2, 0x000000);
        buttonBg.setInteractive({ useHandCursor: true });
        container.add(buttonBg);

        // 鎸夐垥鏂囧瓧
        const buttonText = this.add.text(x, y, text, {
            fontSize: '20px',
            color: '#000000',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        buttonText.setOrigin(0.5);
        container.add(buttonText);

        // 榛炴搳浜嬩欢
        buttonBg.on('pointerdown', callback);

        // 鎳稿仠鏁堟灉
        buttonBg.on('pointerover', () => {
            buttonBg.setFillStyle(0xf0f0f0);
        });

        buttonBg.on('pointerout', () => {
            buttonBg.setFillStyle(0xffffff);
        });

        return { buttonBg, buttonText };
    }

    // 馃敟 椤ず杓稿叆鍚嶇ū闋侀潰
    showEnterNamePage() {
        console.log('馃幃 椤ず杓稿叆鍚嶇ū闋侀潰');

        // 闅辫棌閬婃埐绲愭潫妯℃厠妗?        if (this.gameCompleteModal) {
            this.gameCompleteModal.overlay.setVisible(false);
            this.gameCompleteModal.modal.setVisible(false);
        }

        const width = this.scale.width;
        const height = this.scale.height;

        // 鍓靛缓鍗婇€忔槑鑳屾櫙锛堥伄缃╋級
        const overlay = this.add.rectangle(
            width / 2,
            height / 2,
            width,
            height,
            0x000000,
            0.7
        );
        overlay.setDepth(7000);
        overlay.setScrollFactor(0);

        // 鍓靛缓杓稿叆鍚嶇ū闋侀潰瀹瑰櫒
        const pageWidth = Math.min(600, width * 0.9);
        const pageHeight = Math.min(500, height * 0.8);
        const page = this.add.container(width / 2, height / 2);
        page.setDepth(7001);
        page.setScrollFactor(0);

        // 闋侀潰鑳屾櫙
        const pageBg = this.add.rectangle(0, 0, pageWidth, pageHeight, 0x2c2c2c);
        pageBg.setStrokeStyle(4, 0x000000);
        page.add(pageBg);

        // 妯欓锛欵NTER YOUR NAME
        const title = this.add.text(0, -pageHeight / 2 + 40, 'ENTER YOUR NAME', {
            fontSize: '24px',
            color: '#ffffff',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        title.setOrigin(0.5);
        page.add(title);

        // 鍓椤岋細You're 1st on the leaderboard
        const subtitle = this.add.text(0, -pageHeight / 2 + 80, "You're 1st on the leaderboard", {
            fontSize: '16px',
            color: '#cccccc',
            fontFamily: 'Arial'
        });
        subtitle.setOrigin(0.5);
        page.add(subtitle);

        // 杓稿叆妗?        const inputWidth = pageWidth * 0.8;
        const inputHeight = 50;
        const inputY = -pageHeight / 2 + 130;

        const inputBg = this.add.rectangle(0, inputY, inputWidth, inputHeight, 0xffffff);
        inputBg.setStrokeStyle(2, 0x000000);
        page.add(inputBg);

        // 杓稿叆鏂囧瓧
        this.playerName = '';
        const inputText = this.add.text(0, inputY, '', {
            fontSize: '24px',
            color: '#000000',
            fontFamily: 'Arial'
        });
        inputText.setOrigin(0.5);
        page.add(inputText);

        // 鍓靛缓铏涙摤閸电洡
        const keyboardY = -pageHeight / 2 + 220;
        this.createVirtualKeyboard(page, 0, keyboardY, inputText);

        // 搴曢儴鎸夐垥鍗€鍩?        const buttonY = pageHeight / 2 - 60;

        // Skip 鎸夐垥
        this.createModalButton(page, -120, buttonY, 'Skip', () => {
            console.log('馃幃 榛炴搳 Skip 鎸夐垥');
            this.hideEnterNamePage();
        });

        // Enter 鎸夐垥
        this.createModalButton(page, 120, buttonY, 'Enter', () => {
            console.log('馃幃 榛炴搳 Enter 鎸夐垥锛屽悕绋?', this.playerName);
            this.submitPlayerName();
        });

        // 淇濆瓨闋侀潰寮曠敤
        this.enterNamePage = { overlay, page, inputText };
    }

    // 馃敟 闅辫棌杓稿叆鍚嶇ū闋侀潰
    hideEnterNamePage() {
        if (this.enterNamePage) {
            this.enterNamePage.overlay.destroy();
            this.enterNamePage.page.destroy();
            this.enterNamePage = null;
        }

        // 椤ず閬婃埐绲愭潫妯℃厠妗?        if (this.gameCompleteModal) {
            this.gameCompleteModal.overlay.setVisible(true);
            this.gameCompleteModal.modal.setVisible(true);
        }
    }

    // 馃敟 鍓靛缓铏涙摤閸电洡
    createVirtualKeyboard(container, x, y, inputText) {
        const keys = [
            ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'],
            ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L'],
            ['鈫?, 'Z', 'X', 'C', 'V', 'B', 'N', 'M', '鈫?]
        ];

        const keyWidth = 40;
        const keyHeight = 40;
        const keySpacing = 5;

        keys.forEach((row, rowIndex) => {
            const rowWidth = row.length * (keyWidth + keySpacing) - keySpacing;
            const startX = x - rowWidth / 2 + keyWidth / 2;
            const keyY = y + rowIndex * (keyHeight + keySpacing);

            row.forEach((key, colIndex) => {
                const keyX = startX + colIndex * (keyWidth + keySpacing);
                this.createKeyButton(container, keyX, keyY, key, keyWidth, keyHeight, inputText);
            });
        });

        // 绌烘牸閸?        const spaceY = y + 3 * (keyHeight + keySpacing);
        this.createKeyButton(container, x, spaceY, 'Space', 200, keyHeight, inputText);

        // 123 鎸夐垥锛堝垏鎻涘埌鏁稿瓧閸电洡锛?        this.createKeyButton(container, x - 120, spaceY, '123', 80, keyHeight, inputText);
    }

    // 馃敟 鍓靛缓閸电洡鎸夐垥
    createKeyButton(container, x, y, key, width, height, inputText) {
        // 鎸夐垥鑳屾櫙
        const buttonBg = this.add.rectangle(x, y, width, height, 0x4c4c4c);
        buttonBg.setStrokeStyle(2, 0x000000);
        buttonBg.setInteractive({ useHandCursor: true });
        container.add(buttonBg);

        // 鎸夐垥鏂囧瓧
        const buttonText = this.add.text(x, y, key, {
            fontSize: '18px',
            color: '#ffffff',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        buttonText.setOrigin(0.5);
        container.add(buttonText);

        // 榛炴搳浜嬩欢
        buttonBg.on('pointerdown', () => {
            this.handleKeyPress(key, inputText);
        });

        // 鎳稿仠鏁堟灉
        buttonBg.on('pointerover', () => {
            buttonBg.setFillStyle(0x5c5c5c);
        });

        buttonBg.on('pointerout', () => {
            buttonBg.setFillStyle(0x4c4c4c);
        });
    }

    // 馃敟 铏曠悊鎸夐嵉杓稿叆
    handleKeyPress(key, inputText) {
        if (key === '鈫?) {
            // 鍒櫎鏈€寰屼竴鍊嬪瓧绗?            this.playerName = this.playerName.slice(0, -1);
        } else if (key === '鈫?) {
            // 鍒囨彌澶у皬瀵紙鏆檪涓嶅鐝撅級
            console.log('馃幃 鍒囨彌澶у皬瀵?);
        } else if (key === 'Space') {
            // 娣诲姞绌烘牸
            this.playerName += ' ';
        } else if (key === '123') {
            // 鍒囨彌鍒版暩瀛楅嵉鐩わ紙鏆檪涓嶅鐝撅級
            console.log('馃幃 鍒囨彌鍒版暩瀛楅嵉鐩?);
        } else {
            // 娣诲姞瀛楃
            if (this.playerName.length < 20) {
                this.playerName += key;
            }
        }

        // 鏇存柊杓稿叆鏂囧瓧
        inputText.setText(this.playerName);
        console.log('馃幃 鐣跺墠鍚嶇ū:', this.playerName);
    }

    // 馃敟 鎻愪氦鐜╁鍚嶇ū
    async submitPlayerName() {
        if (!this.playerName || this.playerName.trim() === '') {
            console.log('馃幃 鍚嶇ū鐐虹┖锛岃烦閬庢彁浜?);
            this.hideEnterNamePage();
            return;
        }

        console.log('馃幃 鎻愪氦鐜╁鍚嶇ū:', this.playerName);

        // 瑷堢畻绺藉垎鏁?        const totalCorrect = this.allPagesAnswers.filter(answer => answer.isCorrect).length;
        const totalQuestions = this.pairs.length;

        // 鐛插彇 activityId
        const urlParams = new URLSearchParams(window.location.search);
        const activityId = urlParams.get('activityId');

        // 婧栧倷鎺掕姒滄暩鎿氾紙鍖归厤 API 鏍煎紡锛?        const leaderboardData = {
            activityId: activityId,
            playerName: this.playerName.trim(),
            score: totalCorrect,
            correctCount: totalCorrect,
            totalCount: totalQuestions,
            accuracy: (totalCorrect / totalQuestions) * 100,
            timeSpent: this.totalGameTime,
            gameData: {
                allPagesAnswers: this.allPagesAnswers,
                timestamp: new Date().toISOString()
            }
        };

        console.log('馃幃 鎺掕姒滄暩鎿?', leaderboardData);

        try {
            // 鐧奸€佸埌 API
            const response = await fetch('/api/leaderboard', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(leaderboardData)
            });

            if (response.ok) {
                const result = await response.json();
                console.log('鉁?鎺掕姒滄暩鎿氬凡淇濆瓨:', result);

                // 闅辫棌杓稿叆鍚嶇ū闋侀潰
                this.hideEnterNamePage();

                // 椤ず鎺掕姒?                this.showLeaderboard();
            } else {
                console.error('鉂?淇濆瓨鎺掕姒滄暩鎿氬け鏁?', response.status);
                this.hideEnterNamePage();
            }
        } catch (error) {
            console.error('鉂?淇濆瓨鎺掕姒滄暩鎿氶尟瑾?', error);
            this.hideEnterNamePage();
        }
    }

    // 馃敟 椤ず鎺掕姒?    async showLeaderboard() {
        console.log('馃幃 椤ず鎺掕姒?);

        const width = this.scale.width;
        const height = this.scale.height;

        // 鐛插彇 activityId
        const urlParams = new URLSearchParams(window.location.search);
        const activityId = urlParams.get('activityId');

        // 鍓靛缓鍗婇€忔槑鑳屾櫙锛堥伄缃╋級
        const overlay = this.add.rectangle(
            width / 2,
            height / 2,
            width,
            height,
            0x000000,
            0.7
        );
        overlay.setDepth(8000);
        overlay.setScrollFactor(0);

        // 鍓靛缓鎺掕姒滈爜闈㈠鍣?        const pageWidth = Math.min(600, width * 0.9);
        const pageHeight = Math.min(700, height * 0.9);
        const page = this.add.container(width / 2, height / 2);
        page.setDepth(8001);
        page.setScrollFactor(0);

        // 闋侀潰鑳屾櫙
        const pageBg = this.add.rectangle(0, 0, pageWidth, pageHeight, 0x2c2c2c);
        pageBg.setStrokeStyle(4, 0x000000);
        page.add(pageBg);

        // 妯欓锛歀EADERBOARD
        const title = this.add.text(0, -pageHeight / 2 + 40, 'LEADERBOARD', {
            fontSize: '32px',
            color: '#ffffff',
            fontFamily: 'Arial',
            fontStyle: 'bold'
        });
        title.setOrigin(0.5);
        page.add(title);

        // 杓夊叆鎺掕姒滄暩鎿?        try {
            const response = await fetch(`/api/leaderboard?activityId=${activityId}&limit=10`);
            if (response.ok) {
                const result = await response.json();
                const leaderboardData = result.data || [];
                console.log('鉁?鎺掕姒滄暩鎿?', leaderboardData);

                // 椤ず鎺掕姒滃垪琛?                const startY = -pageHeight / 2 + 100;
                const rowHeight = 50;

                leaderboardData.slice(0, 10).forEach((entry, index) => {
                    const y = startY + index * rowHeight;
                    const rank = index + 1;
                    const isCurrentPlayer = entry.playerName === this.playerName;

                    // 鎺掑悕
                    const rankText = this.add.text(-pageWidth / 2 + 50, y, `${rank}.`, {
                        fontSize: '20px',
                        color: isCurrentPlayer ? '#ffeb3b' : '#ffffff',
                        fontFamily: 'Arial',
                        fontStyle: 'bold'
                    });
                    rankText.setOrigin(0, 0.5);
                    page.add(rankText);

                    // 鐜╁鍚嶇ū
                    const nameText = this.add.text(-pageWidth / 2 + 100, y, entry.playerName, {
                        fontSize: '20px',
                        color: isCurrentPlayer ? '#ffeb3b' : '#ffffff',
                        fontFamily: 'Arial'
                    });
                    nameText.setOrigin(0, 0.5);
                    page.add(nameText);

                    // 鍒嗘暩
                    const scoreText = this.add.text(pageWidth / 2 - 150, y, `${entry.score}/${entry.totalCount}`, {
                        fontSize: '20px',
                        color: isCurrentPlayer ? '#ffeb3b' : '#ffffff',
                        fontFamily: 'Arial'
                    });
                    scoreText.setOrigin(1, 0.5);
                    page.add(scoreText);

                    // 鏅傞枔
                    const timeText = this.add.text(pageWidth / 2 - 50, y, this.formatGameTime(entry.timeSpent), {
                        fontSize: '20px',
                        color: isCurrentPlayer ? '#ffeb3b' : '#ffffff',
                        fontFamily: 'Arial'
                    });
                    timeText.setOrigin(1, 0.5);
                    page.add(timeText);
                });
            } else {
                console.error('鉂?鐛插彇鎺掕姒滄暩鎿氬け鏁?', response.status);
            }
        } catch (error) {
            console.error('鉂?鐛插彇鎺掕姒滄暩鎿氶尟瑾?', error);
        }

        // 搴曢儴鎸夐垥
        const buttonY = pageHeight / 2 - 60;
        this.createModalButton(page, 0, buttonY, 'Back', () => {
            console.log('馃幃 榛炴搳 Back 鎸夐垥');
            this.hideLeaderboard();
        });

        // 淇濆瓨闋侀潰寮曠敤
        this.leaderboardPage = { overlay, page };
    }

    // 馃敟 闅辫棌鎺掕姒?    hideLeaderboard() {
        if (this.leaderboardPage) {
            this.leaderboardPage.overlay.destroy();
            this.leaderboardPage.page.destroy();
            this.leaderboardPage = null;
        }

        // 椤ず閬婃埐绲愭潫妯℃厠妗?        if (this.gameCompleteModal) {
            this.gameCompleteModal.overlay.setVisible(true);
            this.gameCompleteModal.modal.setVisible(true);
        }
    }

    // 馃敟 P1-4: 淇浜嬩欢鐩ｈ伣鍣ㄧ鐞?- shutdown 鏂规硶
    shutdown() {
        console.log('馃幃 GameScene: shutdown 鏂规硶闁嬪 - 娓呯悊浜嬩欢鐩ｈ伣鍣?);

        // 绉婚櫎 resize 浜嬩欢鐩ｈ伣鍣?        if (this.scale) {
            this.scale.off('resize', this.handleResize, this);
            console.log('鉁?宸茬Щ闄?resize 浜嬩欢鐩ｈ伣鍣?);
        }

        // 绉婚櫎 fullscreen 浜嬩欢鐩ｈ伣鍣紙濡傛灉瀛樺湪锛?        if (document) {
            document.removeEventListener('fullscreenchange', this.handleFullscreenChange);
            console.log('鉁?宸茬Щ闄?fullscreenchange 浜嬩欢鐩ｈ伣鍣?);
        }

        // 绉婚櫎 orientation 浜嬩欢鐩ｈ伣鍣紙濡傛灉瀛樺湪锛?        if (window) {
            window.removeEventListener('orientationchange', this.handleOrientationChange);
            console.log('鉁?宸茬Щ闄?orientationchange 浜嬩欢鐩ｈ伣鍣?);
        }

        // 鍋滄瑷堟檪鍣?        if (this.timerEvent) {
            this.timerEvent.remove();
            this.timerEvent = null;
            console.log('鉁?宸插仠姝㈣▓鏅傚櫒');
        }

        // 娓呯悊閬婃埐鐙€鎱?        this.sceneStopped = true;
        console.log('馃幃 GameScene: shutdown 鏂规硶瀹屾垚 - 鎵€鏈変簨浠剁洠鑱藉櫒宸叉竻鐞?);
    }

    // 馃敟 P1-4: 鍏ㄨ灑骞曡畩鍖栦簨浠惰檿鐞?    handleFullscreenChange() {
        console.log('馃幃 鍏ㄨ灑骞曠媭鎱嬭畩鍖?', document.fullscreenElement ? '閫插叆鍏ㄨ灑骞? : '閫€鍑哄叏铻㈠箷');
        // 閲嶆柊瑷堢畻浣堝眬
        this.updateLayout();
    }

    // 馃敟 P1-4: 瑷倷鏂瑰悜璁婂寲浜嬩欢铏曠悊
    handleOrientationChange() {
        const isPortrait = window.matchMedia('(orientation: portrait)').matches;
        console.log('馃幃 瑷倷鏂瑰悜璁婂寲:', isPortrait ? '鐩村悜' : '姗悜');
        // 閲嶆柊瑷堢畻浣堝眬
        this.updateLayout();
    }
}

