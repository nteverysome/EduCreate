var e=Object.defineProperty,t=(t,s,i)=>((t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i)(t,"symbol"!=typeof s?s+"":s,i);import{P as s}from"./phaser-CjIEy6U-.js";import{G as i,M as o,C as n}from"./managers-BXLQW2UW.js";class a{constructor(e,s){t(this,"scene"),t(this,"geptManager"),t(this,"promptContainer",null),t(this,"chineseText",null),t(this,"englishText",null),t(this,"backgroundRect",null),t(this,"config"),t(this,"state"),t(this,"accessibilitySettings"),t(this,"wordCache",new Map),t(this,"translationCache",new Map),this.scene=e,this.geptManager=s,this.config=this.getDefaultConfig(),this.state=this.getInitialState(),this.accessibilitySettings=this.getDefaultAccessibilitySettings(),this.initializePromptUI(),console.log("🌐 BilingualManager 初始化完成")}getDefaultConfig(){return{position:"top-center",style:{fontSize:24,fontFamily:"Microsoft YaHei, SimHei, Arial, sans-serif",color:"#FFFFFF",backgroundColor:"rgba(0, 0, 0, 0.8)",padding:{x:16,y:8},borderRadius:8,border:"2px solid #FFD700"},animation:{fadeIn:{duration:300,ease:"Power2.easeOut"},fadeOut:{duration:200,ease:"Power2.easeIn"},bounce:{amplitude:10,duration:500}}}}getInitialState(){return{isVisible:!1,currentWord:null,displayMode:"chinese-only",lastUpdateTime:0}}getDefaultAccessibilitySettings(){return{fontSize:"medium",contrast:"normal",enableVoice:!1,enableKeyboardNav:!0,screenReaderMode:!1}}initializePromptUI(){this.scene.scale.width,this.scene.scale.height,this.promptContainer=this.scene.add.container(0,0),this.promptContainer.setDepth(1e3),this.backgroundRect=this.scene.add.rectangle(0,0,200,60,0,.8),this.backgroundRect.setStrokeStyle(2,16766720),this.chineseText=this.scene.add.text(0,-10,"",{fontSize:`${this.config.style.fontSize}px`,fontFamily:this.config.style.fontFamily,color:this.config.style.color,align:"center",fontStyle:"bold"}),this.chineseText.setOrigin(.5),this.englishText=this.scene.add.text(0,15,"",{fontSize:.7*this.config.style.fontSize+"px",fontFamily:"Arial, sans-serif",color:"#CCCCCC",align:"center"}),this.englishText.setOrigin(.5),this.promptContainer.add([this.backgroundRect,this.chineseText,this.englishText]),this.updatePromptPosition(),this.promptContainer.setVisible(!1),this.promptContainer.setAlpha(0)}updatePromptPosition(){if(!this.promptContainer)return;const e=this.scene.scale.width,t=this.scene.scale.height;switch(this.config.position){case"top-center":this.promptContainer.setPosition(e/2,80);break;case"bottom-center":this.promptContainer.setPosition(e/2,t-80)}}showChinesePrompt(e,t){const s=this.getWordFromCache(e);s?(this.state.currentWord=s,this.state.isVisible=!0,this.state.lastUpdateTime=Date.now(),this.chineseText&&this.chineseText.setText(s.chinese),this.englishText&&"both"===this.state.displayMode?this.englishText.setText(`(${s.english})`):this.englishText&&this.englishText.setText(""),this.adjustBackgroundSize(),"floating"===this.config.position&&t&&this.promptContainer?.setPosition(t.x,t.y-60),this.playShowAnimation(),console.log(`🌐 顯示中文提示: ${s.chinese} (${s.english})`)):console.warn(`⚠️ 未找到詞彙: ${e}`)}hideChinesePrompt(){this.state.isVisible&&(this.state.isVisible=!1,this.state.currentWord=null,this.playHideAnimation(),console.log("🌐 隱藏中文提示"))}updateTargetWord(e){const t=this.getWordFromCache(e);t?(this.state.isVisible&&this.showChinesePrompt(e),console.log(`🎯 更新目標詞彙: ${t.chinese} (${t.english})`)):console.warn(`⚠️ 未找到目標詞彙: ${e}`)}getWordFromCache(e){if(this.wordCache.has(e))return this.wordCache.get(e);const t=this.geptManager.findWordByEnglish(e);return t&&(this.wordCache.set(e,t),this.translationCache.set(e,t.chinese)),t}adjustBackgroundSize(){if(!this.backgroundRect||!this.chineseText)return;const e=this.chineseText.getBounds(),t=this.config.style.padding,s=Math.max(e.width+2*t.x,120),i=Math.max(e.height+2*t.y,50);this.backgroundRect.setSize(s,i)}playShowAnimation(){this.promptContainer&&(this.promptContainer.setVisible(!0),this.scene.tweens.add({targets:this.promptContainer,alpha:1,duration:this.config.animation.fadeIn.duration,ease:this.config.animation.fadeIn.ease,onComplete:()=>{this.config.animation.bounce&&this.playBounceAnimation()}}))}playHideAnimation(){this.promptContainer&&this.scene.tweens.add({targets:this.promptContainer,alpha:0,duration:this.config.animation.fadeOut.duration,ease:this.config.animation.fadeOut.ease,onComplete:()=>{this.promptContainer?.setVisible(!1)}})}playBounceAnimation(){if(!this.promptContainer||!this.config.animation.bounce)return;const e=this.promptContainer.y,t=this.config.animation.bounce;this.scene.tweens.add({targets:this.promptContainer,y:e-t.amplitude,duration:t.duration/2,ease:"Power2.easeOut",yoyo:!0,repeat:0})}setDisplayMode(e){this.state.displayMode=e,this.state.isVisible&&this.state.currentWord&&this.showChinesePrompt(this.state.currentWord.english)}applyAccessibilitySettings(e){this.accessibilitySettings={...this.accessibilitySettings,...e},this.updateFontSize(),this.updateContrast(),console.log("♿ 應用無障礙設置:",this.accessibilitySettings)}updateFontSize(){const e={small:18,medium:24,large:30,"extra-large":36}[this.accessibilitySettings.fontSize];this.chineseText&&this.chineseText.setFontSize(e),this.englishText&&this.englishText.setFontSize(.7*e),this.adjustBackgroundSize()}updateContrast(){const e={normal:{bg:0,text:"#FFFFFF",border:16766720},high:{bg:0,text:"#FFFF00",border:16777215},reverse:{bg:16777215,text:"#000000",border:0}}[this.accessibilitySettings.contrast];this.backgroundRect&&(this.backgroundRect.setFillStyle(e.bg,.9),this.backgroundRect.setStrokeStyle(2,e.border)),this.chineseText&&this.chineseText.setColor(e.text),this.englishText&&this.englishText.setColor(e.text)}getChineseTranslation(e){if(this.translationCache.has(e))return this.translationCache.get(e);const t=this.getWordFromCache(e);return t?t.chinese:""}destroy(){this.promptContainer&&(this.promptContainer.destroy(),this.promptContainer=null),this.wordCache.clear(),this.translationCache.clear(),console.log("🧹 BilingualManager 已銷毀")}getState(){return{...this.state}}getStatistics(){return{cacheSize:this.wordCache.size,translationCacheSize:this.translationCache.size,currentLevel:this.geptManager.getCurrentLevel(),isVisible:this.state.isVisible,displayMode:this.state.displayMode}}}class r{constructor(e,s,i){t(this,"scene"),t(this,"geptManager"),t(this,"bilingualManager"),t(this,"uiElements"),t(this,"textConfig"),t(this,"accessibilitySettings"),t(this,"hudContainer",null),t(this,"targetContainer",null),t(this,"currentScore",0),t(this,"currentLives",100),t(this,"currentTarget",null),t(this,"gameStatus","waiting"),this.scene=e,this.geptManager=s,this.bilingualManager=i,this.uiElements=this.initializeUIElements(),this.textConfig=this.getDefaultTextConfig(),this.accessibilitySettings=this.getDefaultAccessibilitySettings(),this.createChineseHUD(),console.log("🎨 ChineseUIManager 初始化完成")}initializeUIElements(){return{scoreText:null,livesText:null,targetText:null,statusText:null,instructionText:null}}getDefaultTextConfig(){return{fontSize:20,fontFamily:"Microsoft YaHei, SimHei, Arial, sans-serif",color:"#FFFFFF",stroke:"#000000",strokeThickness:2,shadow:{offsetX:2,offsetY:2,color:"#000000",blur:4,fill:!0}}}getDefaultAccessibilitySettings(){return{fontSize:"medium",contrast:"normal",enableVoice:!1,enableKeyboardNav:!0,screenReaderMode:!1}}createChineseHUD(){this.createTargetDisplay(),console.log("🎨 極簡中文 HUD 創建完成（只保留統一控制元素）")}createTargetDisplay(){const e=this.scene.scale.width;this.targetContainer=this.scene.add.container(e/2,120),this.targetContainer.setDepth(998),this.uiElements.targetText=this.scene.add.text(0,0,"等待設置...",{fontSize:"48px",fontFamily:this.textConfig.fontFamily,color:"#FFFFFF",align:"center",fontStyle:"bold",backgroundColor:"#FFD700",padding:{x:20,y:10}}),this.uiElements.targetText.setOrigin(.5),this.uiElements.targetText.setInteractive(),this.targetContainer.add(this.uiElements.targetText),this.uiElements.targetText.on("pointerdown",(()=>{this.currentTarget&&this.speakEnglish(this.currentTarget.english)})),console.log("🎯 極簡目標詞彙顯示創建完成")}getTextStyle(){return{fontSize:`${this.textConfig.fontSize}px`,fontFamily:this.textConfig.fontFamily,color:this.textConfig.color,stroke:this.textConfig.stroke,strokeThickness:this.textConfig.strokeThickness,shadow:this.textConfig.shadow}}updateScore(e){this.currentScore=e}updateLives(e){this.currentLives=e}updateTargetWord(e){this.currentTarget=e,this.uiElements.targetText&&(this.uiElements.targetText.setText(e.chinese),this.speakChinese(e.chinese)),this.bilingualManager.updateTargetWord(e.english),console.log(`🎯 極簡目標詞彙: ${e.chinese}`)}updateGameStatus(e){this.gameStatus=e}showSuccessMessage(e,t){const s=this.scene.scale.width,i=this.scene.scale.height,o=this.scene.add.text(s/2,i/2,`正確！\n${e.chinese}\n+${t} 分`,{fontSize:"32px",fontFamily:this.textConfig.fontFamily,color:"#00FF00",align:"center",fontStyle:"bold",stroke:"#000000",strokeThickness:3});o.setOrigin(.5),o.setDepth(1001),this.speakEnglish(e.english),this.scene.tweens.add({targets:o,scaleX:1.2,scaleY:1.2,alpha:0,duration:1500,ease:"Power2.easeOut",onComplete:()=>{o.destroy()}}),console.log(`✅ 成功提示: ${e.chinese} +${t}分 🔊${e.english}`)}showErrorMessage(e,t){const s=this.scene.scale.width,i=this.scene.scale.height,o=this.scene.add.text(s/2,i/2,`錯誤！\n${e.chinese}\n-${t} 生命值`,{fontSize:"28px",fontFamily:this.textConfig.fontFamily,color:"#FF0000",align:"center",fontStyle:"bold",stroke:"#000000",strokeThickness:3});o.setOrigin(.5),o.setDepth(1001),this.scene.tweens.add({targets:o,scaleX:.8,scaleY:.8,alpha:0,duration:1200,ease:"Power2.easeIn",onComplete:()=>{o.destroy()}}),console.log(`❌ 顯示錯誤提示: ${e.chinese} -${t}生命值`)}applyAccessibilitySettings(e){this.accessibilitySettings={...this.accessibilitySettings,...e},this.updateAllFontSizes(),this.updateAllContrast(),console.log("♿ ChineseUIManager 應用無障礙設置:",this.accessibilitySettings)}updateAllFontSizes(){const e={small:16,medium:20,large:24,"extra-large":28}[this.accessibilitySettings.fontSize];this.textConfig.fontSize=e,Object.values(this.uiElements).forEach((t=>{t&&t.setFontSize&&t.setFontSize(e)}))}updateAllContrast(){const e={normal:{text:"#FFFFFF",stroke:"#000000"},high:{text:"#FFFF00",stroke:"#000000"},reverse:{text:"#000000",stroke:"#FFFFFF"}}[this.accessibilitySettings.contrast];this.textConfig.color=e.text,this.textConfig.stroke=e.stroke,Object.values(this.uiElements).forEach((t=>{t&&t.setColor&&(t.setColor(e.text),t.setStroke(e.stroke,this.textConfig.strokeThickness))}))}setVisible(e){this.hudContainer&&this.hudContainer.setVisible(e),this.targetContainer&&this.targetContainer.setVisible(e)}speakChinese(e){if("speechSynthesis"in window){const t=new SpeechSynthesisUtterance(e);t.lang="zh-CN",t.rate=.8,t.volume=.7,speechSynthesis.speak(t),console.log(`🔊 發中文音: ${e}`)}}speakEnglish(e){if("speechSynthesis"in window){const t=new SpeechSynthesisUtterance(e);t.lang="en-US",t.rate=.8,t.volume=.7,speechSynthesis.speak(t),console.log(`🔊 發英文音: ${e}`)}}getState(){return{score:this.currentScore,lives:this.currentLives,target:this.currentTarget,status:this.gameStatus,accessibilitySettings:this.accessibilitySettings}}destroy(){this.hudContainer&&(this.hudContainer.destroy(),this.hudContainer=null),this.targetContainer&&(this.targetContainer.destroy(),this.targetContainer=null),Object.keys(this.uiElements).forEach((e=>{this.uiElements[e]=null})),console.log("🧹 ChineseUIManager 已銷毀")}}class l{constructor(){t(this,"updateCount",0),t(this,"totalUpdateTime",0),t(this,"lastReportTime",Date.now()),t(this,"memoryUsage",[])}recordUpdate(e){if(this.updateCount++,this.totalUpdateTime+=e,performance.memory){const e=performance.memory;this.memoryUsage.push(e.usedJSHeapSize/1024/1024),this.memoryUsage.length>100&&this.memoryUsage.shift()}const t=Date.now();t-this.lastReportTime>3e4&&(this.reportPerformance(),this.lastReportTime=t)}reportPerformance(){if(0===this.updateCount)return;const e=this.totalUpdateTime/this.updateCount,t=this.memoryUsage.length>0?this.memoryUsage.reduce(((e,t)=>e+t),0)/this.memoryUsage.length:0;console.log("📊 響應式管理器性能報告:",{"更新次數":this.updateCount,"平均更新時間":`${e.toFixed(2)}ms`,"平均記憶體使用":`${t.toFixed(1)}MB`,"記憶體趨勢":this.getMemoryTrend()}),this.updateCount=0,this.totalUpdateTime=0}getMemoryTrend(){if(this.memoryUsage.length<10)return"數據不足";const e=this.memoryUsage.slice(-10),t=this.memoryUsage.slice(-20,-10);if(0===t.length)return"穩定";const s=e.reduce(((e,t)=>e+t),0)/e.length-t.reduce(((e,t)=>e+t),0)/t.length;return s>5?"上升 ⚠️":s<-5?"下降 ✅":"穩定 ✅"}getStats(){return{updateCount:this.updateCount,avgUpdateTime:this.updateCount>0?this.totalUpdateTime/this.updateCount:0,memoryUsage:this.memoryUsage.slice(-10)}}}const h=class e{constructor(s,i){t(this,"scene"),t(this,"config"),t(this,"elements",new Map),t(this,"currentViewport"),t(this,"isAnimating",!1),t(this,"updateThrottleTimer",null),t(this,"lastUpdateTime",0),t(this,"cleanupTimer",null),t(this,"performanceMonitor");try{this.scene=s,this.config={...e.DEFAULT_CONFIG,...i},this.performanceMonitor=new l,this.currentViewport=this.calculateViewportInfo(),this.setupEventListeners(),this.startPeriodicCleanup(),console.log("🎯 響應式管理器初始化完成",{baseSize:`${this.config.baseWidth}×${this.config.baseHeight}`,currentViewport:this.currentViewport,throttleMs:this.config.throttleMs})}catch(o){throw console.error("❌ 響應式管理器初始化失敗:",o),o}}registerElement(e,t,s,i){try{if(!e||"string"!=typeof e)throw new Error("元素 ID 必須是非空字符串");if(!t)throw new Error("元素不能為空");if(!["background","gameObject","ui","text"].includes(s))throw new Error(`不支援的元素類型: ${s}`);if(this.elements.has(e)&&console.warn(`⚠️ 元素 ${e} 已存在，將被覆蓋`),t.destroyed)throw new Error(`元素 ${e} 已被銷毀，無法註冊`);const o={element:t,type:s,originalX:this.safeGetProperty(t,"x",0),originalY:this.safeGetProperty(t,"y",0),originalScale:this.safeGetProperty(t,"scale",this.safeGetProperty(t,"scaleX",1)),originalSize:t.width&&t.height?{width:t.width,height:t.height}:void 0,anchor:{x:.5,y:.5},constraints:{keepAspectRatio:!0,minScale:this.config.minScale,maxScale:this.config.maxScale},...i};this.elements.set(e,o),console.log(`📝 註冊響應式元素: ${e} (${s})`)}catch(o){throw console.error(`❌ 註冊響應式元素失敗 (${e}):`,o),o}}safeGetProperty(e,t,s){try{return e&&void 0!==e[t]?e[t]:s}catch(i){return console.warn(`⚠️ 無法獲取屬性 ${t}，使用預設值:`,s),s}}unregisterElement(e){this.elements.has(e)&&(this.elements.delete(e),console.log(`🗑️ 移除響應式元素: ${e}`))}calculateViewportInfo(){this.scene.scale.gameSize;const e=this.scene.scale.displaySize,t=e.width,s=e.height,i=Math.min(t/this.config.baseWidth,s/this.config.baseHeight),o=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);let n="desktop";t<768?n="mobile":t<1024&&(n="tablet");const a=t>s?"landscape":"portrait";return{width:t,height:s,scale:Math.max(this.config.minScale,Math.min(this.config.maxScale,i)),isFullscreen:o,deviceType:n,orientation:a}}updateAllElements(e=!0){return new Promise((t=>{const s=Date.now();if(s-this.lastUpdateTime<this.config.throttleMs)return this.updateThrottleTimer&&clearTimeout(this.updateThrottleTimer),void(this.updateThrottleTimer=window.setTimeout((()=>{this.performUpdate(e).then(t)}),this.config.throttleMs));this.lastUpdateTime=s,this.performUpdate(e).then(t)}))}performUpdate(e){return new Promise((t=>{const s=performance.now();if(this.isAnimating&&e)return console.log("⏳ 動畫進行中，跳過更新"),void t();const i=this.calculateViewportInfo();if(!this.hasViewportChanged(i))return console.log("📐 視窗未變化，跳過更新"),void t();console.log("🔄 開始更新所有響應式元素",{from:this.currentViewport,to:i}),this.currentViewport=i,this.cleanupInvalidElements();const o=()=>{const e=performance.now()-s;this.performanceMonitor.recordUpdate(e),t()};e&&this.config.enableSmoothing?this.animateElements().then(o):(this.updateElementsImmediate(),o())}))}hasViewportChanged(e){return Math.abs(e.width-this.currentViewport.width)>10||Math.abs(e.height-this.currentViewport.height)>10||Math.abs(e.scale-this.currentViewport.scale)>.01||e.isFullscreen!==this.currentViewport.isFullscreen||e.deviceType!==this.currentViewport.deviceType||e.orientation!==this.currentViewport.orientation}updateElementsImmediate(){this.elements.forEach(((e,t)=>{this.updateSingleElement(e,!1)})),console.log(`✅ 立即更新完成 ${this.elements.size} 個元素`)}animateElements(){return new Promise((e=>{this.isAnimating=!0;const t=[];this.elements.forEach(((e,s)=>{const i=this.animateSingleElement(e);t.push(i)})),Promise.all(t).then((()=>{this.isAnimating=!1,console.log(`✨ 動畫更新完成 ${this.elements.size} 個元素`),e()}))}))}updateSingleElement(e,t=!1){try{const{element:t,type:s,originalX:i,originalY:o,originalScale:n,constraints:a}=e;if(!t)return void console.warn("⚠️ 元素為空，跳過更新");if(t.destroyed)return void console.warn("⚠️ 元素已銷毀，跳過更新");if(!t.active&&t.hasOwnProperty("active"))return void console.warn("⚠️ 元素未激活，跳過更新");let r=this.currentViewport.scale*n;console.log("🔍 縮放計算詳情:",{elementId:e.id||"unknown",viewportScale:this.currentViewport.scale,originalScale:n,calculatedScale:r,constraints:a});const l=r;a?.minScale&&(r=Math.max(r,a.minScale)),a?.maxScale&&(r=Math.min(r,a.maxScale)),l!==r&&console.log("⚙️ 約束已應用:",{before:l,after:r,minScale:a?.minScale,maxScale:a?.maxScale}),(!isFinite(r)||r<=0)&&(console.warn(`⚠️ 無效的縮放值: ${r}，使用預設值 1`),r=1);const h=this.calculateNewPosition(i,"x"),c=this.calculateNewPosition(o,"y");if(!isFinite(h)||!isFinite(c))return void console.warn(`⚠️ 無效的位置值: (${h}, ${c})，跳過更新`);switch(s){case"background":this.updateBackgroundElement(t,h,c,r);break;case"gameObject":this.updateGameObjectElement(t,h,c,r);break;case"ui":this.updateUIElement(t,h,c,r);break;case"text":this.updateTextElement(t,h,c,r);break;default:console.warn(`⚠️ 未知的元素類型: ${s}`)}}catch(s){console.error("❌ 更新單個元素時發生錯誤:",s)}}animateSingleElement(e){return new Promise((t=>{const{element:s}=e;if(!s||!s.active)return void t();const i=this.currentViewport.scale*e.originalScale,o=this.calculateNewPosition(e.originalX,"x"),n=this.calculateNewPosition(e.originalY,"y");this.scene.tweens.add({targets:s,x:o,y:n,scaleX:i,scaleY:i,duration:this.config.animationDuration,ease:"Power2",onComplete:()=>t()})}))}calculateNewPosition(e,t){return e/("x"===t?this.config.baseWidth:this.config.baseHeight)*("x"===t?this.currentViewport.width:this.currentViewport.height)}updateBackgroundElement(e,t,s,i){try{e.setPosition&&"function"==typeof e.setPosition?e.setPosition(t,s):void 0!==e.x&&void 0!==e.y&&(e.x=t,e.y=s),e.setScale&&"function"==typeof e.setScale?e.setScale(i):void 0!==e.scaleX&&void 0!==e.scaleY&&(e.scaleX=i,e.scaleY=i),e.setSize&&"function"==typeof e.setSize&&this.currentViewport.isFullscreen&&e.setSize(this.currentViewport.width,this.currentViewport.height)}catch(o){console.error("❌ 更新背景元素時發生錯誤:",o)}}updateGameObjectElement(e,t,s,i){console.log("🎯 更新遊戲物件:",{elementType:e.constructor.name,currentPosition:{x:e.x,y:e.y},currentScale:{x:e.scaleX,y:e.scaleY},newPosition:{x:t,y:s},newScale:i,hasSetPosition:!!e.setPosition,hasSetScale:!!e.setScale}),e.setPosition&&(e.setPosition(t,s),console.log("✅ 位置已更新:",{x:e.x,y:e.y})),e.setScale&&(e.setScale(i,i),console.log("✅ 縮放已更新（等比例）:",{x:e.scaleX,y:e.scaleY}))}updateUIElement(e,t,s,i){e.setPosition&&e.setPosition(t,s),e.setScale&&e.setScale(i)}updateTextElement(e,t,s,i){if(e.setPosition&&e.setPosition(t,s),e.setScale&&e.setScale(i),e.setFontSize){const t=parseInt(e.style.fontSize)||16,s=Math.round(t*i);e.setFontSize(`${s}px`)}}setupEventListeners(){this.scene.scale.on("resize",(()=>{this.updateAllElements(!0)}));const e=()=>{setTimeout((()=>{this.updateAllElements(!0)}),100)};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e),document.addEventListener("mozfullscreenchange",e),document.addEventListener("MSFullscreenChange",e),console.log("👂 響應式事件監聽器已設置")}cleanupInvalidElements(){const e=[];this.elements.forEach(((t,s)=>{t.element&&t.element.active&&!t.element.destroyed||e.push(s)})),e.forEach((e=>{this.elements.delete(e),console.log(`🗑️ 清理無效響應式元素: ${e}`)})),e.length>0&&console.log(`🧹 清理了 ${e.length} 個無效元素`)}startPeriodicCleanup(){this.cleanupTimer&&clearInterval(this.cleanupTimer),this.cleanupTimer=window.setInterval((()=>{this.cleanupInvalidElements()}),3e4)}getViewportInfo(){return{...this.currentViewport}}forceUpdate(e=!0){console.log("🔄 強制更新所有響應式元素");const t=this.calculateViewportInfo();return console.log("📐 當前視窗信息:",{width:t.width,height:t.height,scale:t.scale,isFullscreen:t.isFullscreen,deviceType:t.deviceType,orientation:t.orientation}),console.log("🎯 註冊的元素數量:",this.elements.size),this.updateAllElements(e)}getPerformanceStats(){return{...this.performanceMonitor.getStats(),elementsCount:this.elements.size,currentViewport:this.currentViewport,config:this.config}}getOptimizationSuggestions(){const e=[],t=this.performanceMonitor.getStats();this.elements.size>100&&e.push(`元素數量過多 (${this.elements.size})，考慮分組管理`),t.avgUpdateTime>50&&e.push(`平均更新時間過長 (${t.avgUpdateTime.toFixed(2)}ms)，考慮增加防抖間隔`);return"上升 ⚠️"===this.getMemoryTrend()&&e.push("記憶體使用呈上升趨勢，檢查是否有記憶體洩漏"),this.config.throttleMs<50&&e.push("防抖間隔過短，可能影響性能"),e}getMemoryTrend(){const e=this.performanceMonitor.getStats().memoryUsage;if(e.length<5)return"數據不足";const t=e.slice(-3),s=e.slice(-6,-3);if(0===s.length)return"穩定";const i=t.reduce(((e,t)=>e+t),0)/t.length-s.reduce(((e,t)=>e+t),0)/s.length;return i>5?"上升 ⚠️":i<-5?"下降 ✅":"穩定 ✅"}forceGarbageCollection(){window.gc?(window.gc(),console.log("🧹 強制垃圾回收已執行")):console.log("⚠️ 瀏覽器不支援強制垃圾回收")}destroy(){this.updateThrottleTimer&&(clearTimeout(this.updateThrottleTimer),this.updateThrottleTimer=null),this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null),this.elements.clear(),console.log("🧹 響應式管理器已銷毀（包含性能優化清理）")}};t(h,"DEFAULT_CONFIG",{baseWidth:1274,baseHeight:739,minScale:.3,maxScale:2,aspectRatio:1274/739,enableSmoothing:!0,animationDuration:300,throttleMs:100});let c=h;class d{constructor(e,s,i){t(this,"scene"),t(this,"container"),t(this,"background"),t(this,"healthBar"),t(this,"border"),t(this,"healthText"),t(this,"heartIcon"),t(this,"maxHealth",100),t(this,"currentHealth",100),t(this,"barWidth",200),t(this,"barHeight",20),t(this,"colors",{background:3355443,border:0,healthy:65280,warning:16776960,danger:16737792,critical:16711680}),this.scene=e,this.container=e.add.container(s,i),this.container.setDepth(100),this.createHealthBar(),this.createHeartIcon(),this.createHealthText(),console.log("❤️ 血條組件已創建")}createHealthBar(){this.background=this.scene.add.graphics(),this.background.fillStyle(this.colors.background),this.background.fillRoundedRect(0,0,this.barWidth,this.barHeight,5),this.healthBar=this.scene.add.graphics(),this.updateHealthBarColor(),this.healthBar.fillRoundedRect(2,2,this.barWidth-4,this.barHeight-4,3),this.border=this.scene.add.graphics(),this.border.lineStyle(2,this.colors.border),this.border.strokeRoundedRect(0,0,this.barWidth,this.barHeight,5),this.container.add([this.background,this.healthBar,this.border])}createHeartIcon(){this.heartIcon=this.scene.add.graphics(),this.heartIcon.fillStyle(16711680),this.heartIcon.beginPath();const e=this.barHeight/2;this.heartIcon.arc(-27,e-2,4,0,Math.PI,!0),this.heartIcon.arc(-23,e-2,4,0,Math.PI,!0),this.heartIcon.lineTo(-25,e+4),this.heartIcon.closePath(),this.heartIcon.fillPath(),this.container.add(this.heartIcon)}createHealthText(){this.healthText=this.scene.add.text(this.barWidth+10,this.barHeight/2,`${this.currentHealth}/${this.maxHealth}`,{fontSize:"16px",color:"#ffffff",fontStyle:"bold"}),this.healthText.setOrigin(0,.5),this.container.add(this.healthText)}updateHealthBarColor(){const e=this.currentHealth/this.maxHealth*100;let t;t=e>=80?this.colors.healthy:e>=40?this.colors.warning:e>=20?this.colors.danger:this.colors.critical,this.healthBar.clear(),this.healthBar.fillStyle(t);const s=(this.barWidth-4)*this.currentHealth/this.maxHealth;this.healthBar.fillRoundedRect(2,2,s,this.barHeight-4,3)}updateHealth(e,t=!0){const s=this.currentHealth;this.currentHealth=Math.max(0,Math.min(e,this.maxHealth)),console.log(`❤️ 血條更新: ${s} → ${this.currentHealth}`),t&&s!==this.currentHealth?this.animateHealthChange(s,this.currentHealth):(this.updateHealthBarColor(),this.updateHealthText()),this.currentHealth<=20&&this.currentHealth>0&&this.startCriticalHealthEffect()}animateHealthChange(e,t){this.scene.tweens.add({targets:{health:e},health:t,duration:500,ease:"Power2",onUpdate:e=>{const t=Math.round(e.targets[0].health);this.currentHealth=t,this.updateHealthBarColor(),this.updateHealthText()},onComplete:()=>{console.log("❤️ 血條動畫完成")}}),t<e&&this.scene.tweens.add({targets:this.container,x:this.container.x+5,duration:50,yoyo:!0,repeat:3,ease:"Power2"})}updateHealthText(){this.healthText.setText(`${this.currentHealth}/${this.maxHealth}`);const e=this.currentHealth/this.maxHealth*100;e<=20?this.healthText.setColor("#ff0000"):e<=40?this.healthText.setColor("#ff6600"):this.healthText.setColor("#ffffff")}startCriticalHealthEffect(){this.scene.tweens.killTweensOf(this.healthBar),this.scene.tweens.add({targets:this.healthBar,alpha:.3,duration:300,yoyo:!0,repeat:-1,ease:"Power2"})}stopCriticalHealthEffect(){this.scene.tweens.killTweensOf(this.healthBar),this.healthBar.setAlpha(1)}setPosition(e,t){this.container.setPosition(e,t)}setVisible(e){this.container.setVisible(e)}destroy(){this.scene.tweens.killTweensOf(this.container),this.scene.tweens.killTweensOf(this.healthBar),this.container.destroy(),console.log("❤️ 血條組件已銷毀")}getCurrentHealth(){return this.currentHealth}getMaxHealth(){return this.maxHealth}getContainer(){return this.container}setMaxHealth(e){this.maxHealth=e,this.updateHealthBarColor(),this.updateHealthText()}}const g=class e{constructor(s,i){t(this,"scene"),t(this,"container"),t(this,"background"),t(this,"icon"),t(this,"tooltip"),t(this,"isFullscreen",!1),t(this,"isHovered",!1),t(this,"isPressed",!1),t(this,"config"),t(this,"errorStats",new Map),t(this,"lastErrorTime",0),t(this,"retryCount",0),t(this,"maxRetries",3);try{this.scene=s,this.config={...e.DEFAULT_CONFIG,...i},this.createButton(),this.setupEvents(),this.updatePosition(),this.checkFullscreenStatus(),this.scene.time.delayedCall(3e3,(()=>{this.showFeatureIntro()})),console.log("🖥️ 專業全螢幕按鈕已創建（整合響應式管理器 + UX優化）")}catch(o){throw console.error("❌ 全螢幕按鈕創建失敗:",o),o}}createButton(){this.container=this.scene.add.container(0,0),this.container.setDepth(1e3),this.background=this.scene.add.graphics(),this.drawBackground(),this.icon=this.scene.add.graphics(),this.drawIcon(),this.container.add([this.background,this.icon]),this.container.setSize(this.config.size,this.config.size),this.container.setInteractive({useHandCursor:!0,hitArea:new Phaser.Geom.Rectangle(-this.config.size/2,-this.config.size/2,this.config.size,this.config.size),hitAreaCallback:Phaser.Geom.Rectangle.Contains})}drawBackground(){this.background.clear();const{size:e,cornerRadius:t}=this.config,s=this.config.colors;let i=s.background,o=s.border,n=.8;this.isPressed?(i=s.backgroundActive,o=s.borderHover,n=.95):this.isHovered&&(i=s.backgroundHover,o=s.borderHover,n=.9),this.background.fillStyle(i,n),this.background.fillRoundedRect(-e/2,-e/2,e,e,t),this.background.lineStyle(2,o,.6),this.background.strokeRoundedRect(-e/2,-e/2,e,e,t),this.isPressed&&(this.background.lineStyle(1,0,.3),this.background.strokeRoundedRect(-e/2+1,-e/2+1,e-2,e-2,t-1))}drawIcon(){if(this.icon.clear(),this.icon.lineStyle(2,this.config.colors.icon,1),this.isFullscreen){const e=.6*this.config.size/2;this.icon.beginPath(),this.icon.moveTo(6-e,-e),this.icon.lineTo(6-e,6-e),this.icon.lineTo(-e,6-e),this.icon.strokePath(),this.icon.beginPath(),this.icon.moveTo(e,6-e),this.icon.lineTo(e-6,6-e),this.icon.lineTo(e-6,-e),this.icon.strokePath(),this.icon.beginPath(),this.icon.moveTo(-e,e-6),this.icon.lineTo(6-e,e-6),this.icon.lineTo(6-e,e),this.icon.strokePath(),this.icon.beginPath(),this.icon.moveTo(e-6,e),this.icon.lineTo(e-6,e-6),this.icon.lineTo(e,e-6),this.icon.strokePath()}else{const e=.6*this.config.size/2;this.icon.beginPath(),this.icon.moveTo(-e,6-e),this.icon.lineTo(-e,-e),this.icon.lineTo(6-e,-e),this.icon.strokePath(),this.icon.beginPath(),this.icon.moveTo(e-6,-e),this.icon.lineTo(e,-e),this.icon.lineTo(e,6-e),this.icon.strokePath(),this.icon.beginPath(),this.icon.moveTo(-e,e-6),this.icon.lineTo(-e,e),this.icon.lineTo(6-e,e),this.icon.strokePath(),this.icon.beginPath(),this.icon.moveTo(e-6,e),this.icon.lineTo(e,e),this.icon.lineTo(e,e-6),this.icon.strokePath()}}setupEvents(){this.container.on("pointerover",this.onPointerOver,this),this.container.on("pointerout",this.onPointerOut,this),this.container.on("pointerdown",this.onPointerDown,this),this.container.on("pointerup",this.onPointerUp,this),document.addEventListener("fullscreenchange",this.onFullscreenChange.bind(this)),document.addEventListener("webkitfullscreenchange",this.onFullscreenChange.bind(this)),document.addEventListener("mozfullscreenchange",this.onFullscreenChange.bind(this)),document.addEventListener("MSFullscreenChange",this.onFullscreenChange.bind(this)),this.scene.input.keyboard?.on("keydown-F11",(e=>{e.preventDefault(),this.toggleFullscreen(),this.showKeyboardHint("F11 快捷鍵已觸發")})),this.scene.input.keyboard?.on("keydown-ESC",(()=>{this.isFullscreen&&(this.exitFullscreen(),this.showKeyboardHint("ESC 快捷鍵已觸發"))})),this.showInitialHint()}onPointerOver(){this.isHovered||(this.isHovered=!0,this.updateVisuals(),this.playHoverAnimation(),this.showTooltip())}onPointerOut(){this.isHovered&&(this.isHovered=!1,this.isPressed=!1,this.updateVisuals(),this.playNormalAnimation(),this.hideTooltip())}onPointerDown(){this.isPressed=!0,this.updateVisuals(),this.playClickAnimation()}onPointerUp(){this.isPressed&&(this.isPressed=!1,this.updateVisuals(),this.toggleFullscreen())}updateVisuals(){this.drawBackground(),this.drawIcon()}playHoverAnimation(){this.scene.tweens.add({targets:this.container,scaleX:this.config.animations.hoverScale,scaleY:this.config.animations.hoverScale,duration:this.config.animations.duration,ease:"Power2"})}playNormalAnimation(){this.scene.tweens.add({targets:this.container,scaleX:1,scaleY:1,duration:this.config.animations.duration,ease:"Power2"})}playClickAnimation(){this.scene.tweens.add({targets:this.container,scaleX:this.config.animations.clickScale,scaleY:this.config.animations.clickScale,duration:this.config.animations.duration/2,ease:"Power2",yoyo:!0})}showTooltip(){if(this.tooltip)return;const e=this.isFullscreen?"退出全螢幕 (F11)":"進入全螢幕 (F11)",t=this.scene.add.graphics();t.fillStyle(0,.8),t.fillRoundedRect(-50,-15,100,30,4);const s=this.scene.add.text(0,0,e,{fontSize:"12px",color:"#ffffff",align:"center"}).setOrigin(.5);this.tooltip=this.scene.add.container(this.container.x-60,this.container.y-40),this.tooltip.add([t,s]),this.tooltip.setDepth(1001),this.tooltip.setAlpha(0),this.scene.tweens.add({targets:this.tooltip,alpha:1,duration:200,ease:"Power2"})}hideTooltip(){this.tooltip&&this.scene.tweens.add({targets:this.tooltip,alpha:0,duration:200,ease:"Power2",onComplete:()=>{this.tooltip?.destroy(),this.tooltip=void 0}})}onHover(){this.background.clear(),this.background.fillStyle(this.config.colors.backgroundHover,.9),this.background.fillRoundedRect(-this.config.size/2,-this.config.size/2,this.config.size,this.config.size,this.config.cornerRadius),this.background.lineStyle(2,this.config.colors.iconHover,.8),this.background.strokeRoundedRect(-this.config.size/2,-this.config.size/2,this.config.size,this.config.size,this.config.cornerRadius),this.icon.clear(),this.icon.lineStyle(2,this.config.colors.iconHover,1),this.drawIcon(),this.container.setScale(1.1)}onOut(){this.background.clear(),this.background.fillStyle(this.config.colors.background,.7),this.background.fillRoundedRect(-this.config.size/2,-this.config.size/2,this.config.size,this.config.size,this.config.cornerRadius),this.background.lineStyle(2,16777215,.3),this.background.strokeRoundedRect(-this.config.size/2,-this.config.size/2,this.config.size,this.config.size,this.config.cornerRadius),this.icon.clear(),this.icon.lineStyle(2,this.config.colors.icon,1),this.drawIcon(),this.container.setScale(1)}async toggleFullscreen(){try{this.isFullscreen?await this.exitFullscreen():await this.enterFullscreen()}catch(e){this.handleFullscreenError(e)}}async enterFullscreen(){const e=document.documentElement;if(!this.isFullscreenSupported())throw new Error("瀏覽器不支援全螢幕 API");e.requestFullscreen?await e.requestFullscreen():e.webkitRequestFullscreen?await e.webkitRequestFullscreen():e.mozRequestFullScreen?await e.mozRequestFullScreen():e.msRequestFullscreen&&await e.msRequestFullscreen(),console.log("🖥️ 成功進入全螢幕模式"),this.onFullscreenEnter()}async exitFullscreen(){document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.mozCancelFullScreen?await document.mozCancelFullScreen():document.msExitFullscreen&&await document.msExitFullscreen(),console.log("🖥️ 成功退出全螢幕模式"),this.onFullscreenExit()}isFullscreenSupported(){const e=document.documentElement;return!!(e.requestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen)}handleFullscreenError(e){console.error("❌ 全螢幕操作失敗:",e);let t="全螢幕操作失敗",s="unknown";"NotAllowedError"===e.name?(console.warn("⚠️ 全螢幕被用戶或瀏覽器政策阻止"),t="全螢幕功能被阻止，請檢查瀏覽器設定或嘗試用戶手動觸發",s="permission"):"TypeError"===e.name?(console.warn("⚠️ 瀏覽器不支援全螢幕 API"),t="您的瀏覽器不支援全螢幕功能，請嘗試更新瀏覽器",s="unsupported"):"InvalidStateError"===e.name?(console.warn("⚠️ 全螢幕狀態無效"),t="全螢幕狀態異常，請重新整理頁面",s="state"):"SecurityError"===e.name?(console.warn("⚠️ 全螢幕安全限制"),t="安全限制阻止全螢幕，請確保在安全環境下操作",s="security"):(console.warn("⚠️ 全螢幕操作遇到未知錯誤"),t="全螢幕操作失敗，請稍後再試或重新整理頁面",s="unknown"),this.showErrorMessage(t,s),this.recordError(s,e.message)}recordError(e,t){const s=this.errorStats.get(e)||0;this.errorStats.set(e,s+1),this.lastErrorTime=Date.now(),console.log(`📊 錯誤統計 - ${e}: ${s+1} 次`),s>=2&&this.showFrequentErrorAdvice(e)}showFrequentErrorAdvice(e){let t="";switch(e){case"permission":t="建議：在用戶手勢後再嘗試全螢幕，或檢查瀏覽器權限設定";break;case"unsupported":t="建議：使用支援全螢幕 API 的現代瀏覽器";break;case"state":t="建議：重新整理頁面或等待一段時間後再試";break;case"security":t="建議：確保在 HTTPS 環境下使用，或檢查瀏覽器安全設定";break;default:t="建議：重新整理頁面或聯繫技術支援"}console.log(`💡 ${t}`),this.showKeyboardHint(t)}attemptRecovery(){this.retryCount>=this.maxRetries?console.log("⚠️ 已達到最大重試次數，停止自動恢復"):(this.retryCount++,console.log(`🔄 嘗試自動恢復 (${this.retryCount}/${this.maxRetries})`),this.checkFullscreenStatus(),this.updateVisuals(),setTimeout((()=>{this.retryCount<this.maxRetries&&console.log("🔄 準備重新嘗試全螢幕操作")}),2e3))}resetErrorState(){this.errorStats.clear(),this.retryCount=0,this.lastErrorTime=0,console.log("🔄 錯誤狀態已重置")}getErrorStats(){const e={};return this.errorStats.forEach(((t,s)=>{e[s]=t})),e}showErrorMessage(e,t="unknown"){const s=this.scene.add.container(this.container.x-80,this.container.y-60),i=this.scene.add.graphics();i.fillStyle(16729156,.9),i.fillRoundedRect(-70,-20,140,40,6);const o=this.scene.add.text(0,0,e,{fontSize:"11px",color:"#ffffff",align:"center",wordWrap:{width:130}}).setOrigin(.5);s.add([i,o]),s.setDepth(1002),this.scene.time.delayedCall(3e3,(()=>{s.destroy()}))}onFullscreenEnter(){setTimeout((()=>{this.scene.scale.refresh(),this.updatePosition(),this.triggerResponsiveUpdate()}),100),console.log("🎮 遊戲已進入全螢幕模式")}onFullscreenExit(){setTimeout((()=>{this.scene.scale.refresh(),this.updatePosition(),this.triggerResponsiveUpdate()}),100),console.log("🎮 遊戲已退出全螢幕模式")}triggerResponsiveUpdate(){const e=this.scene;e.responsiveManager&&"function"==typeof e.responsiveManager.forceUpdate?(console.log("🔄 觸發響應式管理器全域更新（帶平滑動畫）"),e.responsiveManager.forceUpdate(!0)):console.log("⚠️ 響應式管理器未找到，跳過更新")}showKeyboardHint(e){const t=this.scene.add.container(this.container.x-80,this.container.y-80),s=this.scene.add.graphics();s.fillStyle(5025616,.9),s.fillRoundedRect(-60,-15,120,30,6);const i=this.scene.add.text(0,0,e,{fontSize:"11px",color:"#ffffff",align:"center"}).setOrigin(.5);t.add([s,i]),t.setDepth(1003),t.setAlpha(0),this.scene.tweens.add({targets:t,alpha:1,duration:200,ease:"Power2",onComplete:()=>{this.scene.time.delayedCall(2e3,(()=>{this.scene.tweens.add({targets:t,alpha:0,duration:300,ease:"Power2",onComplete:()=>t.destroy()})}))}})}showInitialHint(){this.scene.time.delayedCall(5e3,(()=>{this.isFullscreen||this.showKeyboardHint("按 F11 進入全螢幕")})),this.scene.time.delayedCall(15e3,(()=>{this.isFullscreen||this.showAdvancedHints()}))}showAdvancedHints(){const e=["💡 全螢幕模式可獲得更好的遊戲體驗","🎮 支援鍵盤快捷鍵 F11 和 ESC","📱 在不同設備上都能完美適配","✨ 享受沉浸式的太空冒險"],t=e[Math.floor(Math.random()*e.length)];this.showKeyboardHint(t)}showSmartHints(){const e=this.scene;e.score&&e.score>100?this.showKeyboardHint("🏆 分數不錯！全螢幕模式體驗更佳"):e.gameStarted&&this.showKeyboardHint("🎯 遊戲進行中，試試全螢幕模式")}analyzeUserBehavior(){this.isHovered&&this.scene.time.delayedCall(3e3,(()=>{this.isHovered&&!this.isFullscreen&&this.showKeyboardHint("點擊進入全螢幕，或按 F11")})),this.errorStats.size>0&&this.showTroubleshootingTips()}showTroubleshootingTips(){const e=["🔧 如果全螢幕無法使用，請檢查瀏覽器設定","🔄 嘗試重新整理頁面後再試","🌐 建議使用 Chrome 或 Firefox 瀏覽器","🔒 確保在安全的 HTTPS 環境下使用"],t=e[Math.floor(Math.random()*e.length)];this.showKeyboardHint(t)}showFeatureIntro(){const e=this.scene.add.container(this.container.x-120,this.container.y-100),t=this.scene.add.graphics();t.fillStyle(2201331,.95),t.fillRoundedRect(-100,-40,200,80,8);const s=this.scene.add.text(0,-15,"🖥️ 全螢幕功能",{fontSize:"14px",color:"#ffffff",fontStyle:"bold",align:"center"}).setOrigin(.5),i=this.scene.add.text(0,10,"點擊按鈕或按 F11\n獲得最佳遊戲體驗",{fontSize:"11px",color:"#ffffff",align:"center"}).setOrigin(.5);e.add([t,s,i]),e.setDepth(1004),e.setAlpha(0),this.scene.tweens.add({targets:e,alpha:1,duration:300,ease:"Power2",onComplete:()=>{this.scene.time.delayedCall(4e3,(()=>{this.scene.tweens.add({targets:e,alpha:0,duration:500,ease:"Power2",onComplete:()=>e.destroy()})}))}})}onFullscreenChange(){this.checkFullscreenStatus(),this.drawIcon(),console.log("🖥️ 全螢幕狀態變化:",{isFullscreen:this.isFullscreen,windowSize:{width:window.innerWidth,height:window.innerHeight},gameSize:{width:this.scene.scale.gameSize.width,height:this.scene.scale.gameSize.height}}),setTimeout((()=>{this.scene.scale.refresh();const e=this.scene;e.responsiveManager?(console.log("🔄 觸發響應式管理器強制更新..."),e.responsiveManager.forceUpdate(!0),console.log("✅ 響應式管理器更新完成")):console.warn("⚠️ 響應式管理器不存在"),this.updatePosition(),console.log("🎯 全螢幕自適應處理完成")}),150)}checkFullscreenStatus(){this.isFullscreen=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)}updatePosition(){const e=this.scene.scale.gameSize,t=e.width-this.config.size/2-16,s=e.height-this.config.size/2-16;this.container.setPosition(t,s)}destroy(){document.removeEventListener("fullscreenchange",this.onFullscreenChange.bind(this)),document.removeEventListener("webkitfullscreenchange",this.onFullscreenChange.bind(this)),document.removeEventListener("mozfullscreenchange",this.onFullscreenChange.bind(this)),document.removeEventListener("MSFullscreenChange",this.onFullscreenChange.bind(this)),this.container.destroy(),console.log("🗑️ 全螢幕按鈕已銷毀")}};t(g,"DEFAULT_CONFIG",{size:48,cornerRadius:8,colors:{background:0,backgroundHover:3355443,backgroundActive:5592405,icon:16777215,iconHover:65416,border:6710886,borderHover:65416},animations:{hoverScale:1.1,clickScale:.95,duration:150}});let u=g;class p extends s.Scene{constructor(){super({key:"GameScene"}),t(this,"gameConfig"),t(this,"gameState",{isPlaying:!1,isPaused:!1,currentScore:0,currentHealth:100,wordsLearned:0,accuracy:0}),t(this,"player"),t(this,"shooterContainer"),t(this,"clouds"),t(this,"cursors"),t(this,"backgroundLayers",[]),t(this,"scoreText"),t(this,"healthBar"),t(this,"targetWordText"),t(this,"accuracyText"),t(this,"wordsLearnedText"),t(this,"geptManager"),t(this,"collisionSystem"),t(this,"memoryEngine"),t(this,"bilingualManager"),t(this,"chineseUIManager"),t(this,"responsiveManager"),t(this,"fullscreenButton"),t(this,"useBackupCloudTexture",!1),t(this,"cloudSpawnTimer"),t(this,"currentTargetWord"),t(this,"targetWordSetTime",0),t(this,"totalCollisions",0),t(this,"correctCollisions",0),t(this,"wrongCollisions",0),t(this,"showStartScreen",!0),t(this,"gameStarted",!1),t(this,"startScreen"),t(this,"playButton")}init(){console.log("🎮 初始化遊戲場景"),this.gameConfig=this.registry.get("gameConfig")||{geptLevel:"elementary",enableSound:!0,enableHapticFeedback:!0,difficulty:"medium",gameMode:"practice"},console.log("📋 遊戲配置:",this.gameConfig),this.initializeManagers()}initializeManagers(){try{console.log("🔧 開始初始化管理器系統..."),console.log("📚 初始化 GEPT 管理器..."),this.geptManager=new i,this.geptManager.setLevel(this.gameConfig.geptLevel),console.log("✅ GEPT 管理器初始化完成"),console.log("🧠 初始化記憶增強引擎..."),this.memoryEngine=new o,console.log("✅ 記憶增強引擎初始化完成"),console.log("💥 初始化碰撞檢測系統..."),this.collisionSystem=new n(this,this.gameConfig.geptLevel,{enableParticles:!0,enableScreenShake:!0,enableSoundEffects:this.gameConfig.enableSound,enableVisualFeedback:!0,particleIntensity:"medium",soundVolume:.7}),console.log("✅ 碰撞檢測系統初始化完成"),console.log("🌐 初始化雙語管理器..."),this.bilingualManager=new a(this,this.geptManager),console.log("✅ 雙語管理器初始化完成"),console.log("🈳 初始化中文 UI 管理器..."),this.chineseUIManager=new r(this,this.geptManager,this.bilingualManager),console.log("✅ 中文 UI 管理器初始化完成"),console.log("📱 初始化響應式管理器..."),this.responsiveManager=new c(this,{baseWidth:1274,baseHeight:739,enableSmoothing:!0,animationDuration:300}),console.log("✅ 響應式管理器初始化完成"),console.log("🎉 所有管理器初始化完成（包含雙語系統 + 響應式管理器）")}catch(e){throw console.error("❌ 管理器初始化失敗:",e),e}}preload(){console.log("🎨 載入遊戲資源"),this.loadMoonBackground(),console.log("🚀 載入玩家太空船精靈表..."),this.load.spritesheet("player_spaceship","assets/sprite_player_spaceship_up_down.png",{frameWidth:Math.floor(350),frameHeight:150}),this.load.spritesheet("random_shooter","assets/random_shooter-sheet.png",{frameWidth:64,frameHeight:64}),this.load.image("player_spaceship_image","assets/sprite_player_spaceship_up_down.png"),this.load.image("complete_spaceship","assets/complete_spaceship.png"),console.log("✅ 太空船資源載入配置完成"),console.log("✈️ 創建玩家飛機紋理 - 恢復原版 + 增強");try{const e=this.add.graphics();e.fillStyle(26367),e.fillTriangle(16,0,0,32,32,32),e.lineStyle(2,16777215,1),e.strokeTriangle(16,0,0,32,32,32),e.generateTexture("player-plane",32,32),e.destroy(),console.log("✅ 備用飛機紋理創建完成")}catch(s){console.error("❌ 備用飛機紋理創建失敗:",s)}this.load.image("cloud-word","assets/images/cloud_shape3_3.png"),this.load.on("filecomplete-image-cloud-word",(()=>{console.log("✅ 雲朵圖片載入成功")})),this.load.on("loaderror",(e=>{"cloud-word"===e.key&&(console.log("⚠️ 雲朵圖片載入失敗，使用淺藍色備用紋理（防止白色閃爍）"),this.useBackupCloudTexture=!0)}));const e=this.add.graphics();e.fillStyle(15135743),e.fillEllipse(32,16,60,28),e.lineStyle(2,4886754),e.strokeEllipse(32,16,60,28),e.generateTexture("cloud-word-fallback",64,32),e.destroy(),console.log("☁️ 備用雲朵紋理已創建（淺藍色，防止白色閃爍）");const t=this.add.graphics();t.fillStyle(16777215),t.fillCircle(2,2,2),t.generateTexture("star",4,4),t.destroy(),this.load.on("complete",(()=>{console.log("✅ 簡化資源載入完成 - 準備測試全螢幕按鈕")})),console.log("🎨 簡化遊戲資源載入排程完成（專注測試全螢幕按鈕）")}createSpaceshipAnimation(){if(console.log("🚀 創建新太空船動畫配置"),this.textures.exists("player_spaceship")){console.log("✨ 使用新的玩家太空船精靈表");const e=this.textures.get("player_spaceship");console.log("🔍 精靈表詳細信息:",{key:"player_spaceship",width:e.source[0].width,height:e.source[0].height,frameTotal:e.frameTotal,frames:Object.keys(e.frames)}),this.anims.create({key:"spaceship_fly",frames:this.anims.generateFrameNumbers("player_spaceship",{start:0,end:6}),frameRate:10,repeat:-1,yoyo:!1}),console.log("✅ 太空船飛行動畫創建完成: spaceship_fly (7幀動畫，292x512)")}else this.textures.exists("random_shooter")?(console.log("🔄 備用方案：使用原始精靈表"),this.anims.create({key:"spaceship_fly",frames:this.anims.generateFrameNumbers("random_shooter",{start:0,end:3}),frameRate:6,repeat:-1,yoyo:!1}),console.log("✅ 備用太空船動畫創建完成: spaceship_fly (原始精靈表)")):console.warn("⚠️ 沒有可用的太空船精靈表，跳過動畫創建")}createSpaceshipSprite(){const e=[];for(let t=0;t<4;t++){const i=this.add.graphics(),o=200+10*t,n=s.Display.Color.HSVToRGB(o/360,.8,.9);i.fillStyle(n.color),i.fillEllipse(32,32,24,40),i.fillTriangle(8,20,20,32,8,44),i.fillTriangle(56,20,44,32,56,44),i.fillStyle(65535),i.fillEllipse(32,28,8,12);const a=.5+.2*t;i.fillStyle(s.Display.Color.GetColor(255,100+30*t,0)),i.fillEllipse(32,50+t,6,8*a),i.generateTexture(`spaceship_${t}`,64,64),i.destroy(),e.push({key:`spaceship_${t}`})}this.anims.create({key:"spaceship_backup_anim",frames:e,frameRate:8,repeat:-1})}createDynamicSprite(){const e=[];for(let t=0;t<8;t++){const i=this.add.graphics(),o=45*t%360,n=s.Display.Color.HSVToRGB(o/360,.8,.9);i.fillStyle(n.color),i.fillCircle(32,32,28),i.lineStyle(3,16777215),i.strokeCircle(32,32,28),i.generateTexture(`enemy_circle_${t}`,64,64),i.destroy(),e.push({key:`enemy_circle_${t}`})}this.anims.create({key:"enemy_circle_anim",frames:e,frameRate:10,repeat:-1})}loadMoonBackground(){console.log("🌙 載入月亮主題背景");try{this.load.image("moon-sky","assets/backgrounds/moon/moon_sky.png"),this.load.image("moon-back","assets/backgrounds/moon/moon_back.png"),this.load.image("moon-mid","assets/backgrounds/moon/moon_mid.png"),this.load.image("moon-earth","assets/backgrounds/moon/moon_earth.png"),this.load.image("moon-front","assets/backgrounds/moon/moon_front.png"),this.load.image("moon-floor","assets/backgrounds/moon/moon_floor.png"),console.log("🌙 真實月亮背景圖片載入排程完成（相對路徑）")}catch(e){console.warn("⚠️ 月亮背景載入失敗，將使用備用背景:",e)}}create(){console.log("🏗️ 創建遊戲場景"),this.createSpaceshipAnimation(),this.createParallaxBackground(),this.createPlayer(),this.createClouds(),this.createGameHUD(),this.setupInput(),this.setupPhysics(),this.setRandomTargetWord(),console.log("✅ 遊戲場景創建完成"),console.log("🚀 跳過開始畫面，直接開始遊戲"),this.showStartScreen=!1,this.gameStarted=!0,this.time.delayedCall(1e3,(()=>{console.log("🎮 延遲啟動遊戲..."),this.startGame()}))}updateClouds(){const e=this.clouds.children.entries.length;Math.floor(Date.now()/1e3)%5==0&&console.log("🔄 雲朵更新檢查 - 總數:",e),this.clouds.children.entries.forEach(((e,t)=>{if(Math.floor(Date.now()/1e3)%5==0&&console.log(`☁️ 雲朵 ${t}: x=${Math.round(e.x)}, y=${Math.round(e.y)}, velocity=${e.body?.velocity?.x||"N/A"}`),e.x<-100){const t=e.getData("wordText");t&&t.destroy(),e.destroy(),console.log("🗑️ 清理離開螢幕的雲朵 - 位置:",e.x)}}))}createStartScreen(){console.log("🎮 創建 Wordwall 風格開始畫面"),console.log("🔍 當前狀態 - showStartScreen:",this.showStartScreen,"gameStarted:",this.gameStarted);const e=this.add.rectangle(637,369.5,1274,739,0,.7);e.setDepth(1e3),e.setInteractive(),e.on("pointerdown",(()=>{console.log("🖱️ 遮罩點擊檢測，開始遊戲"),this.showStartScreen&&(this.hideStartScreen(),this.startGame())})),this.startScreen=this.add.container(634,336),this.startScreen.setDepth(1001);const t=this.add.text(0,-150,"🛩️ 飛機英語學習遊戲",{fontSize:"48px",fontFamily:"Arial, sans-serif",color:"#FFFFFF",align:"center",fontStyle:"bold"}).setOrigin(.5),i=this.add.text(0,-80,"駕駛飛機收集目標英文單字\n避開其他單字，學習更有效！",{fontSize:"24px",fontFamily:"Arial, sans-serif",color:"#CCCCCC",align:"center",lineSpacing:10}).setOrigin(.5),o=this.add.circle(0,50,80,5025616);o.setStrokeStyle(4,16777215);const n=this.add.text(0,50,"PLAY",{fontSize:"32px",fontFamily:"Arial, sans-serif",color:"#FFFFFF",fontStyle:"bold"}).setOrigin(.5);this.startScreen.add([t,i,o,n]),this.responsiveManager.registerElement("startScreen",this.startScreen,"ui",{anchor:{x:.5,y:.5},constraints:{keepAspectRatio:!0,minScale:.6,maxScale:1.2}}),o.setInteractive(new s.Geom.Circle(0,0,100),s.Geom.Circle.Contains),n.setInteractive({useHandCursor:!0});const a=()=>{console.log("🎮 點擊 Play 按鈕，開始遊戲"),this.hideStartScreen(),this.startGame()};o.on("pointerdown",a),n.on("pointerdown",a),this.input.on("pointerdown",(e=>{console.log("🖱️ 檢測到點擊事件，showStartScreen:",this.showStartScreen),this.showStartScreen?(console.log("🎮 全畫面點擊檢測，開始遊戲"),this.hideStartScreen(),this.startGame()):console.log("⚠️ 開始畫面已隱藏，忽略點擊")})),o.on("pointerover",(()=>{o.setFillStyle(4563017),o.setScale(1.1)})),o.on("pointerout",(()=>{o.setFillStyle(5025616),o.setScale(1)})),console.log("✅ Wordwall 風格開始畫面創建完成")}hideStartScreen(){this.startScreen&&(this.responsiveManager.unregisterElement("startScreen"),this.startScreen.destroy(),this.startScreen=void 0),this.children.list.forEach((e=>{1e3===e.depth&&e.destroy()})),this.showStartScreen=!1,this.gameStarted=!0,console.log("🎮 開始畫面已隱藏，遊戲開始")}createParallaxBackground(){console.log("🌌 創建視差背景");this.add.rectangle(637,369.5,1274,739,0).setDepth(-20),this.createMoonBackgroundLayers(),this.createStarField(),console.log("🌌 視差背景創建完成")}createMoonBackgroundLayers(){const e=[],t=this.textures.exists("moon-sky"),s=this.textures.exists("moon-back"),i=this.textures.exists("moon-mid"),o=this.textures.exists("moon-earth"),n=this.textures.exists("moon-front"),a=this.textures.exists("moon-floor");if(t||s||i||o||n||a){if(console.log("🌙 使用真實月亮主題背景圖片"),t){const t=this.add.tileSprite(0,0,1274,739,"moon-sky");t.setOrigin(0,0),t.setDepth(-20),e.push(t)}if(s){const t=this.add.tileSprite(0,0,1274,739,"moon-back");t.setOrigin(0,0),t.setDepth(-18),e.push(t)}if(o){console.log("🌍 重新分析參考圖片，修正地球大小和位置");const e=this.add.image(1220,277,"moon-earth");e.setDepth(100),e.setScale(.45),e.setAlpha(1),console.log("🌍 地球第三次往上移動1/10完成:",{x:e.x,y:e.y,scale:e.scale,calculatedWidth:"3800*0.45=1710px",position:"第三次往上移動 (1220, 277)",depth:e.depth})}if(i){const t=this.add.tileSprite(0,0,1274,739,"moon-mid");t.setOrigin(0,0),t.setDepth(-14),e.push(t)}if(n){const t=this.add.tileSprite(0,0,1274,739,"moon-front");t.setOrigin(0,0),t.setDepth(-12),e.push(t)}if(a){const t=this.add.tileSprite(0,0,1274,739,"moon-floor");t.setOrigin(0,0),t.setDepth(-10),e.push(t)}}else{console.log("🌌 使用備用漸層背景");const t=this.add.graphics();t.fillGradientStyle(657966,657966,1710670,1710670),t.fillRect(0,0,800,600),t.generateTexture("fallback-bg-1",800,600),t.destroy();const s=this.add.graphics();s.fillGradientStyle(1710670,1710670,2763374,2763374),s.fillRect(0,0,800,600),s.generateTexture("fallback-bg-2",800,600),s.destroy();const i=this.add.tileSprite(0,0,800,600,"fallback-bg-1");i.setOrigin(0,0),i.setDepth(-15),i.setAlpha(.7),e.push(i);const o=this.add.tileSprite(0,0,800,600,"fallback-bg-2");o.setOrigin(0,0),o.setDepth(-13),o.setAlpha(.5),e.push(o)}this.backgroundLayers=e,this.registerBackgroundLayersToResponsiveManager()}createStarField(){console.log("⭐ 創建星空背景");for(let e=0;e<150;e++){const e=s.Math.Between(0,1268),t=s.Math.Between(0,500),i=this.add.image(e,t,"star"),o=s.Math.FloatBetween(.2,.8),n=s.Math.FloatBetween(.6,1);i.setScale(o),i.setAlpha(n),i.setDepth(-19),this.tweens.add({targets:i,alpha:.4*n,duration:s.Math.Between(3e3,6e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}}createPlayer(){console.log("🎯 創建玩家射手角色 - 恢復原版太空船邏輯");const e=this.textures.exists("player_spaceship_image"),t=this.textures.exists("player_spaceship"),s=this.textures.exists("random_shooter"),i=this.textures.exists("complete_spaceship"),o=this.textures.exists("player-plane");if(console.log("🔍 檢查可用資源:",{player_spaceship_image:e,player_spaceship:t,random_shooter:s,complete_spaceship:i,"player-plane":o}),t)console.log("🚀 使用新的玩家太空船精靈表 - 創建一艘太空船"),this.player=this.physics.add.sprite(150,336,"player_spaceship"),this.player.setOrigin(.5,.5),this.player.play("spaceship_fly"),console.log("✅ 太空船創建完成：1個精靈 + 7幀飛行動畫 (292x512)");else if(e)console.log("🚀 備用方案：使用新的玩家太空船圖片（普通圖片模式）"),this.player=this.physics.add.sprite(150,336,"player_spaceship_image"),console.log("✅ 新太空船圖片載入中（靜態模式）");else if(s)console.log("🔄 備用方案1：使用原始精靈表創建太空船動畫"),this.player=this.physics.add.sprite(150,336,"random_shooter"),this.player.play("spaceship_fly"),console.log("✅ 太空船動畫播放中：spaceship_fly (原始精靈表)");else if(i)console.log("🚀 備用方案2：使用用戶提供的完整太空船圖片"),this.player=this.physics.add.sprite(150,336,"complete_spaceship"),this.createEngineFlameEffect();else{if(!o){console.log("❌ 沒有可用的飛機資源，創建緊急備用");const e=this.add.rectangle(150,336,40,40,16711680);return e.setDepth(200),this.physics.world.enable(e),this.player=e,void console.log("🚨 使用緊急紅色矩形作為飛機")}console.log("🔧 備用方案3：使用藍色三角形飛機"),this.player=this.physics.add.sprite(150,336,"player-plane")}this.setupSpaceshipProperties(),this.responsiveManager.registerElement("player",this.player,"gameObject",{anchor:{x:.5,y:.5},constraints:{keepAspectRatio:!0,minScale:.1,maxScale:2}}),console.log("📝 玩家太空船已註冊到響應式管理器")}setupSpaceshipProperties(){console.log("⚙️ 設置太空船統一屬性 - 恢復原版");try{this.player.setScale(.4),this.player.setCollideWorldBounds(!0),this.player.setDepth(10),this.player.setAlpha(1),this.player.setVisible(!0),console.log("✅ 太空船屬性設置完成: 中心錨點 + 0.8倍縮放 + 深度10")}catch(t){console.error("❌ 太空船屬性設置失敗:",t)}this.tweens.add({targets:this.player,scaleX:{from:.4,to:.42},scaleY:{from:.4,to:.42},duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),console.log("✅ 太空船屬性設置完成: 中心錨點 + 0.4倍縮放（50%大小）+ 保持原始方向（無旋轉翻轉）+ 脈動效果"),console.log("🎯 玩家飛機創建完成 - 詳細狀態:",{x:this.player.x,y:this.player.y,visible:this.player.visible,alpha:this.player.alpha,depth:this.player.depth,scaleX:this.player.scaleX,scaleY:this.player.scaleY,texture:this.player.texture.key,width:this.player.width,height:this.player.height,originX:this.player.originX,originY:this.player.originY,active:this.player.active});const e=this.player.x>=0&&this.player.x<=1274&&this.player.y>=0&&this.player.y<=739;console.log("📍 飛機位置檢查:",{gameSize:"1274x739",playerPosition:`${this.player.x}, ${this.player.y}`,isInBounds:e,distanceFromLeft:this.player.x,distanceFromTop:this.player.y})}createClouds(){this.clouds=this.physics.add.group(),console.log("☁️ 創建雲朵群組"),console.log("🌍 物理世界狀態:",{gravity:this.physics.world.gravity,bounds:this.physics.world.bounds,isPaused:this.physics.world.isPaused}),this.physics.world.isPaused&&(console.log("⚡ 物理世界已暫停，強制恢復"),this.physics.world.resume())}createGameHUD(){console.log("📊 創建遊戲 HUD (已擴展目標詞彙顯示)"),this.scoreText=this.add.text(16,16,"分數: 0",{fontSize:"24px",color:"#000000",backgroundColor:"#f8f9fa",padding:{x:8,y:4}}).setDepth(100),this.accuracyText=this.add.text(16,50,"準確率: 0%",{fontSize:"20px",color:"#000000",backgroundColor:"#f8f9fa",padding:{x:8,y:4}}).setDepth(100),this.wordsLearnedText=this.add.text(16,84,"學習詞彙: 0",{fontSize:"20px",color:"#000000",backgroundColor:"#f8f9fa",padding:{x:8,y:4}}).setDepth(100),this.healthBar=new d(this,16,this.cameras.main.height-60),console.log("❤️ 血條 UI 已創建（左下角位置）"),this.targetWordText=this.add.text(637,20,"目標: 載入中...",{fontSize:"32px",color:"#1f2937",backgroundColor:"#fef3c7",padding:{x:16,y:12},fontStyle:"bold"}).setOrigin(.5,0).setDepth(100);try{console.log("🖥️ 開始創建全螢幕按鈕..."),this.fullscreenButton=new u(this),console.log("✅ 全螢幕按鈕已創建（右下角位置）")}catch(e){console.error("❌ 全螢幕按鈕創建失敗:",e)}this.registerUIElementsToResponsiveManager()}registerUIElementsToResponsiveManager(){this.responsiveManager.registerElement("scoreText",this.scoreText,"ui",{anchor:{x:0,y:0},constraints:{fixedPosition:!1}}),this.responsiveManager.registerElement("accuracyText",this.accuracyText,"ui",{anchor:{x:0,y:0},constraints:{fixedPosition:!1}}),this.responsiveManager.registerElement("wordsLearnedText",this.wordsLearnedText,"ui",{anchor:{x:0,y:0},constraints:{fixedPosition:!1}}),this.responsiveManager.registerElement("healthBar",this.healthBar.getContainer(),"ui",{anchor:{x:0,y:1},constraints:{fixedPosition:!1}}),this.responsiveManager.registerElement("targetWordText",this.targetWordText,"ui",{anchor:{x:.5,y:0},constraints:{fixedPosition:!1}}),console.log("📝 所有 UI 元素已註冊到響應式管理器")}registerBackgroundLayersToResponsiveManager(){this.backgroundLayers.forEach(((e,t)=>{this.responsiveManager.registerElement(`backgroundLayer_${t}`,e,"background",{anchor:{x:0,y:0},constraints:{keepAspectRatio:!0,minScale:.5,maxScale:2}})})),console.log(`📝 ${this.backgroundLayers.length} 個背景層已註冊到響應式管理器`)}setupInput(){this.cursors=this.input.keyboard.createCursorKeys();const e=this.input.keyboard.addKeys("W,S,A,D");this.wasd=e,this.setupTouchAndMouseControls(),console.log("🎮 設置輸入控制（鍵盤 + 觸碰 + 滑鼠）")}setupTouchAndMouseControls(){console.log("👆 設置觸碰和滑鼠控制"),this.touchControl={isPressed:!1,moveUp:!1,moveDown:!1},this.input.on("pointerdown",(e=>{if(!this.gameState.isPlaying||this.gameState.isPaused||this.showStartScreen)return;const t=this.touchControl;t.isPressed=!0;e.y<369.5?(t.moveUp=!0,t.moveDown=!1,console.log("👆 觸碰控制：向上移動")):(t.moveUp=!1,t.moveDown=!0,console.log("👇 觸碰控制：向下移動"))})),this.input.on("pointerup",(()=>{const e=this.touchControl;e.isPressed=!1,e.moveUp=!1,e.moveDown=!1,console.log("✋ 觸碰控制：停止移動")})),this.input.on("pointerout",(()=>{const e=this.touchControl;e.isPressed=!1,e.moveUp=!1,e.moveDown=!1,console.log("🚫 觸碰控制：指針移出，停止移動")})),console.log("✅ 觸碰和滑鼠控制設置完成"),console.log("📱 使用方法："),console.log("  - 點擊/觸碰畫面上半部分：飛機向上移動"),console.log("  - 點擊/觸碰畫面下半部分：飛機向下移動"),console.log("  - 釋放滑鼠/手指：停止移動")}setupPhysics(){console.log("⚡ 設置物理碰撞 (已移除子彈碰撞，修改玩家碰撞)"),this.physics.add.overlap(this.player,this.clouds,this.handleAdvancedCollision,void 0,this)}setRandomTargetWord(){const e=this.geptManager.getRandomWord();this.currentTargetWord=e||void 0,this.gameState.currentTargetWord=this.currentTargetWord,this.targetWordSetTime=Date.now(),this.targetWordText&&this.currentTargetWord&&(this.targetWordText.setText(`目標: ${this.currentTargetWord.chinese} (${this.currentTargetWord.english})`),this.collisionSystem.setTargetWord(this.currentTargetWord.english,this.currentTargetWord.chinese),this.bilingualManager.updateTargetWord(this.currentTargetWord.english),this.chineseUIManager.updateTargetWord(this.currentTargetWord),console.log("🎯 設置目標詞彙:",this.currentTargetWord.english))}startCloudSpawning(){this.cloudSpawnTimer=this.time.addEvent({delay:2e3,callback:this.spawnCloud,callbackScope:this,loop:!0}),console.log("☁️ 開始雲朵生成 - 每 2 秒生成一個雲朵"),console.log("🎮 遊戲狀態:",this.gameState),this.time.delayedCall(500,(()=>{console.log("🧪 測試：立即生成第一個雲朵"),this.spawnCloud()}))}spawnCloud(){if(console.log("🔄 嘗試生成雲朵..."),console.log("🎮 遊戲狀態 isPlaying:",this.gameState.isPlaying),!this.gameState.isPlaying)return void console.log("❌ 遊戲未在進行中，跳過雲朵生成");const e=this.geptManager.getRandomWord();if(console.log("📝 獲取詞彙:",e),!e)return void console.log("❌ 無法獲取詞彙，跳過雲朵生成");const t=1350,i=s.Math.Between(100,639),o=this.useBackupCloudTexture?"cloud-word-fallback":"cloud-word",n=this.physics.add.image(t,i,o);console.log("☁️ 使用雲朵紋理:",o,"位置:",t,i),n.setScale(1.44),n.body||(console.log("❌ 雲朵沒有物理體，強制啟用物理"),this.physics.world.enable(n)),n.setVelocityX(-200),n.body&&(n.body.setVelocityX(-200),n.body.velocity.x=-200),console.log("🔧 雲朵物理屬性 (修復後):",{hasBody:!!n.body,velocity:n.body?.velocity,velocityX:n.body?.velocity?.x,position:{x:n.x,y:n.y},bodyType:n.body?.constructor.name}),n.setData("word",e),n.setData("isTarget",e.english===this.currentTargetWord?.english),n.setDepth(110),n.setAlpha(1),n.setVisible(!0);const a=e.english===this.currentTargetWord?.english,r=this.add.text(t,i,e.english,{fontSize:"23px",color:a?"#ff0000":"#000000",fontStyle:a?"bold":"normal",backgroundColor:a?"#ffff00":"rgba(255, 255, 255, 0.8)",padding:{x:6,y:3}}).setOrigin(.5);r.setDepth(111),r.setAlpha(1),r.setVisible(!0),n.setData("wordText",r);const l=`cloud_${Date.now()}_${Math.random()}`,h=`cloudText_${Date.now()}_${Math.random()}`;this.responsiveManager.registerElement(l,n,"gameObject",{constraints:{keepAspectRatio:!0,minScale:.8,maxScale:2}}),this.responsiveManager.registerElement(h,r,"text",{constraints:{keepAspectRatio:!0,minScale:.6,maxScale:1.8}}),a&&this.bilingualManager&&this.bilingualManager.showChinesePrompt(e.english,{x:t,y:i-60}),console.log("🔧 添加到群組前的速度:",n.body?.velocity?.x),this.clouds.add(n),console.log("🔧 添加到群組後的速度:",n.body?.velocity?.x),-200!==n.body?.velocity?.x&&(console.log("⚠️ 速度被重置，強制恢復"),n.setVelocityX(-200),n.body.velocity.x=-200),console.log("☁️ 生成雲朵 (修復版本):",e.english,a?"(目標)":"",{cloudVisible:n.visible,textVisible:r.visible,cloudDepth:n.depth,textDepth:r.depth})}forceSpawnTestCloud(){console.log("🧪 強制生成測試雲朵 - 開始");const e=1e3,t=this.useBackupCloudTexture?"cloud-word-fallback":"cloud-word",s=this.physics.add.image(e,300,t);s.body||(console.log("❌ 測試雲朵沒有物理體，強制啟用物理"),this.physics.world.enable(s)),s.setVelocityX(-150),s.body&&(s.body.setVelocityX(-150),s.body.velocity.x=-150),s.setDepth(10),s.setAlpha(1),s.setVisible(!0),s.setTint(16711680),console.log("🧪 測試雲朵使用紋理:",t),console.log("🧪 測試雲朵物理屬性:",{hasBody:!!s.body,velocity:s.body?.velocity,velocityX:s.body?.velocity?.x});const i=this.add.text(e,300,"TEST",{fontSize:"20px",color:"#ffffff",fontStyle:"bold",backgroundColor:"#dc2626",padding:{x:8,y:4}}).setOrigin(.5);i.setDepth(11),i.setAlpha(1),i.setVisible(!0),s.setData("wordText",i),s.setData("word",{english:"test",chinese:"測試"}),s.setData("isTarget",!1),console.log("🧪 添加到群組前的測試雲朵速度:",s.body?.velocity?.x),this.clouds.add(s),console.log("🧪 添加到群組後的測試雲朵速度:",s.body?.velocity?.x),-150!==s.body?.velocity?.x&&(console.log("⚠️ 測試雲朵速度被重置，強制恢復"),s.setVelocityX(-150),s.body.velocity.x=-150),console.log("🧪 測試雲朵已生成:",{x:e,y:300,visible:s.visible,depth:s.depth,velocity:s.body?.velocity})}createSimpleTestObject(){console.log("🔴 創建簡單紅色方塊");const e=this.add.rectangle(600,200,50,50,16711680);e.setDepth(20),e.setAlpha(1),e.setVisible(!0),this.tweens.add({targets:e,x:100,duration:3e3,ease:"Linear"}),console.log("🔴 紅色方塊已創建:",{x:e.x,y:e.y,visible:e.visible,depth:e.depth})}handleAdvancedCollision(e,t){if(!this.gameState.isPlaying||this.gameState.isPaused)return;const s=t.getData("word");t.getData("isTarget");const i=t.getData("wordText");if(t.getData("processed"))return;t.setData("processed",!0);const o=this.collisionSystem.handleCollision(e,t,s),n={wordId:s.id,word:s.english,timestamp:Date.now(),responseTime:Date.now()-this.targetWordSetTime,isCorrect:"correct"===o.type,attemptNumber:this.totalCollisions+1,contextData:{targetWord:this.currentTargetWord?.english,geptLevel:this.gameConfig.geptLevel,gameMode:this.gameConfig.gameMode}};if(this.memoryEngine.recordLearningEvent(n),this.totalCollisions++,"correct"===o.type)this.correctCollisions++,this.gameState.currentScore+=10,this.gameState.wordsLearned++,this.chineseUIManager&&this.chineseUIManager.showSuccessMessage(s,10),this.bilingualManager&&this.bilingualManager.hideChinesePrompt(),this.setRandomTargetWord(),console.log("✅ 正確碰撞:",s.english);else{if(this.wrongCollisions++,console.log("❌ 錯誤碰撞:",s.english,`(第${this.wrongCollisions}次錯誤)`),this.wrongCollisions>=5)return console.log("💥 第5次錯誤！分數歸零後結束遊戲"),this.gameState.isPlaying=!1,this.gameState.currentScore=0,this.updateUI(),this.chineseUIManager&&this.chineseUIManager.showErrorMessage({english:"GAME OVER",chinese:"遊戲結束"},0),this.removeCloudWithAnimation(t,i),void this.time.delayedCall(1e3,(()=>{this.endGame()}));if(this.gameState.currentHealth-=20,this.chineseUIManager&&this.chineseUIManager.showErrorMessage(s,20),this.gameState.currentHealth<=0)return this.removeCloudWithAnimation(t,i),void this.endGame()}this.removeCloudWithAnimation(t,i),this.updateGameStats(),this.updateUI(),this.sendMessageToParent({type:"GAME_SCORE_UPDATE",score:this.gameState.currentScore,health:this.gameState.currentHealth})}updateGameStats(){this.gameState.accuracy=this.totalCollisions>0?Math.round(this.correctCollisions/this.totalCollisions*100):0}updateUI(){this.scoreText.setText(`分數: ${this.gameState.currentScore}`),this.healthBar.updateHealth(this.gameState.currentHealth,!0),this.accuracyText.setText(`準確率: ${this.gameState.accuracy}%`),this.wordsLearnedText.setText(`學習詞彙: ${this.gameState.wordsLearned}`),console.log("📊 更新 HUD:",{"分數":this.gameState.currentScore,"生命值":this.gameState.currentHealth,"準確率":this.gameState.accuracy,"學習詞彙":this.gameState.wordsLearned})}startGame(){this.gameState.isPlaying=!0,this.gameState.isPaused=!1,this.totalCollisions=0,this.correctCollisions=0,this.wrongCollisions=0,console.log("🚀 遊戲開始（錯誤次數已重置）"),this.startCloudSpawning(),this.sendMessageToParent({type:"GAME_STATE_CHANGE",state:"playing"})}endGame(){this.gameState.isPlaying=!1,this.gameState.currentHealth=0,this.updateUI(),console.log("🏁 遊戲結束 - 生命值歸零"),this.cloudSpawnTimer&&this.cloudSpawnTimer.destroy(),this.clearCloudsGradually(),this.sendMessageToParent({type:"GAME_COMPLETE",score:this.gameState.currentScore,health:this.gameState.currentHealth})}clearCloudsGradually(){console.log("🌤️ 開始漸進式清理雲朵，防止白色閃爍");const e=this.clouds.children.entries;0!==e.length?(e.forEach(((e,t)=>{this.tweens.add({targets:e,alpha:0,scale:.5,duration:300,delay:50*t,ease:"Power2",onComplete:()=>{e&&e.active&&e.destroy()}})})),this.time.delayedCall(1e3,(()=>{this.clouds.clear(!1,!1),console.log("✅ 雲朵漸進式清理完成")}))):console.log("✅ 沒有雲朵需要清理")}removeCloudWithAnimation(e,t){console.log("🌤️ 使用淡出動畫移除雲朵"),t&&t.active&&this.tweens.add({targets:t,alpha:0,scale:.2,duration:150,ease:"Power2",onComplete:()=>{t&&t.active&&(t.destroy(),console.log("✅ 文字已銷毀"))}}),this.tweens.add({targets:e,alpha:0,scale:.3,duration:200,delay:50,ease:"Power2",onComplete:()=>{e&&e.active&&(e.destroy(),console.log("✅ 雲朵已銷毀"))}})}sendMessageToParent(e){window.parent!==window&&window.parent.postMessage(e,"*")}update(e,t){this.gameState.isPlaying&&!this.gameState.isPaused&&(this.updateParallaxBackground(),this.handlePlayerMovement(),this.updateClouds(),this.updateChineseUI(),this.cleanupObjects())}updateParallaxBackground(){this.backgroundLayers.forEach(((e,t)=>{const s=.3*(t+1);e.tilePositionX+=s})),console.log("🌌 更新視差背景")}updateChineseUI(){if(this.chineseUIManager){this.chineseUIManager.updateScore(this.gameState.currentScore),this.chineseUIManager.updateLives(this.gameState.currentHealth);const e=this.gameState.isPlaying?"playing":this.gameState.isPaused?"paused":"waiting";this.chineseUIManager.updateGameStatus(e)}}handlePlayerMovement(){const e=this.wasd,t=this.touchControl;this.player.setVelocityX(0);const s=this.cursors.up.isDown||e?.W.isDown||t?.moveUp,i=this.cursors.down.isDown||e?.S.isDown||t?.moveDown;s?this.player.setVelocityY(-250):i?this.player.setVelocityY(250):this.player.setVelocityY(0)}createEngineFlameEffect(){console.log("🔥 創建引擎火焰效果");const e=this.player.x,t=this.player.y+30,s=this.add.sprite(e,t,"cloud");s.setScale(.3),s.setTint(16737792),s.setDepth(this.player.depth-1),this.tweens.add({targets:s,alpha:{from:.8,to:.3},scaleX:{from:.3,to:.4},scaleY:{from:.3,to:.4},duration:150,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),console.log("🔥 引擎火焰效果創建完成")}cleanupObjects(){this.clouds.children.entries.forEach((e=>{if(e.x<-100){const t=e.getData("wordText");t&&t.destroy(),e.destroy()}else{const t=e.getData("wordText");t&&t.setPosition(e.x,e.y)}}))}}export{p as G};
//# sourceMappingURL=scenes-DHN9EBcS.js.map
