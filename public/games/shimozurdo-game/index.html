<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='chrome=1'>
    <meta name='viewport' content='width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent'>

    <!-- PWA Configuration -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-title" content="Shimozurdo Game">

    <!-- PWA Icons for iOS -->
    <link rel="apple-touch-icon" href="./assets/icon-192.svg">
    <link rel="apple-touch-icon" sizes="192x192" href="./assets/icon-192.svg">
    <link rel="apple-touch-icon" sizes="512x512" href="./assets/icon-512.svg">

    <!-- Base href to ensure relative asset URLs resolve under /games/shimozurdo-game even without trailing slash -->
    <base href="/games/shimozurdo-game/">
    <link rel='icon' href='favicon.ico' />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: 'Open Sans', sans-serif;

            /* å¼·åŒ–ç¶²å€åˆ—éš±è— - Chrome æ‰‹æ©Ÿç‰ˆ */
            height: 100vh;
            height: 100dvh; /* å‹•æ…‹è¦–çª—é«˜åº¦ï¼Œæ›´æº–ç¢º */
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            margin: 0;
            padding: 0;
            /* ğŸ”§ ä¿®å¾©ï¼šç¢ºä¿ body ä¸æ””æˆªè§¸æ§äº‹ä»¶ */
            pointer-events: none;
        }

        html {
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            width: 100%;
            margin: 0;
            padding: 0;
            /* ğŸ”§ ä¿®å¾©ï¼šç¢ºä¿ html ä¸æ””æˆªè§¸æ§äº‹ä»¶ */
            pointer-events: none;
        }

        /* é‡å°æ‰‹æ©Ÿç€è¦½å™¨çš„é¡å¤–éš±è— */
        @media screen and (max-width: 768px) {
            body, html {
                height: 100vh !important;
                height: 100dvh !important;
                overflow: hidden !important;
                position: fixed !important;
                width: 100% !important;
                top: 0 !important;
                left: 0 !important;
                /* ğŸ”§ ä¿®å¾©ï¼šç¢ºä¿æ‰‹æ©Ÿä¸Š html å’Œ body ä¸æ””æˆªè§¸æ§äº‹ä»¶ */
                pointer-events: none !important;
            }
        }

        #game {
            width: 100vw;
            height: 100dvh;
            /* ğŸ”§ ä¿®å¾©ï¼šç¢ºä¿éŠæˆ²å®¹å™¨èƒ½æ¥æ”¶è§¸æ§äº‹ä»¶ */
            pointer-events: auto !important;
            touch-action: manipulation !important;
        }

        /* å…¨è¢å¹•æ¨£å¼ä¿®å¾© */
        #game:fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }

        #game:-webkit-full-screen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }

        #game:-moz-full-screen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }

        #game:-ms-fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }

        /* ğŸ® TouchControls è™›æ“¬æŒ‰éˆ•æ¨£å¼ */
        #touch-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 240px;
            background: transparent;
            display: none;  /* é è¨­éš±è—ï¼Œåª’é«”æŸ¥è©¢æ§åˆ¶é¡¯ç¤º */
            z-index: 1000;
            pointer-events: none;
        }

        /* è™›æ“¬æ–æ¡¿ */
        .touch-joystick {
            position: absolute;
            bottom: 60px;
            left: 20px;
            width: 120px;
            height: 120px;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            pointer-events: all;
        }

        .touch-joystick-knob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.1s;
        }

        /* å°„æ“ŠæŒ‰éˆ• */
        .touch-shoot-btn {
            position: absolute;
            bottom: 60px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: #ff4757;
            border: none;
            border-radius: 50%;
            font-size: 32px;
            pointer-events: all;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s;
        }

        .touch-shoot-btn:active {
            transform: scale(0.95);
        }

        /* å…¨è¢å¹•æŒ‰éˆ• */
        .fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 24px;
            pointer-events: all;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s;
        }

        .fullscreen-btn:active {
            transform: scale(0.95);
        }

        /* åª’é«”æŸ¥è©¢ï¼šç§»å‹•è¨­å‚™é¡¯ç¤º */
        @media (max-width: 1024px) and (max-height: 768px),
               (pointer: coarse),
               (hover: none) and (pointer: coarse) {
            #touch-controls {
                display: block !important;
            }
        }
    </style>
    <title>Game</title>
</head>

<body>
    <div id='game'></div>

    <!-- ğŸ® TouchControls è™›æ“¬æŒ‰éˆ• -->
    <div id="touch-controls">
        <!-- è™›æ“¬æ–æ¡¿ -->
        <div class="touch-joystick">
            <div class="touch-joystick-knob"></div>
        </div>

        <!-- å°„æ“ŠæŒ‰éˆ• -->
        <button class="touch-shoot-btn">ğŸš€</button>

        <!-- å…¨è¢å¹•æŒ‰éˆ• -->
        <button class="fullscreen-btn">â›¶</button>
    </div>


    <!-- Phaser å¼•æ“ -->
    <script src="//cdn.jsdelivr.net/npm/phaser@3.53.1/dist/phaser.min.js"></script>

    <!-- åº§æ¨™ä¿®å¾©å·¥å…· -->
    <script src="/games/shimozurdo-game/scenes/coordinate-fix.js"></script>

    <!-- æ¨¡çµ„è¼‰å…¥å™¨ï¼ˆä½¿ç”¨çµ•å°è·¯å¾‘é¿å…ç„¡æ–œç·š URL çš„ç›¸å°è§£æå•é¡Œï¼‰ -->
    <script src="/games/shimozurdo-game/module-loader.js"></script>

    <!-- ğŸ® TouchControls è™›æ“¬æŒ‰éˆ• JavaScript -->
    <script>
        // TouchControls é¡ - è™›æ“¬æŒ‰éˆ•æ§åˆ¶ç³»çµ±
        class TouchControls {
            constructor() {
                this.joystick = document.querySelector('.touch-joystick');
                this.knob = document.querySelector('.touch-joystick-knob');
                this.shootBtn = document.querySelector('.touch-shoot-btn');
                this.fullscreenBtn = document.querySelector('.fullscreen-btn');

                this.joystickActive = false;
                this.joystickCenter = { x: 0, y: 0 };
                this.currentDirection = { x: 0, y: 0 };
                this.shooting = false;

                this.init();
            }

            init() {
                if (!this.joystick || !this.shootBtn || !this.fullscreenBtn) {
                    console.warn('âš ï¸ TouchControls å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                // æ–æ¡¿æ§åˆ¶
                this.joystick.addEventListener('touchstart', this.onJoystickStart.bind(this), { passive: false });
                this.joystick.addEventListener('touchmove', this.onJoystickMove.bind(this), { passive: false });
                this.joystick.addEventListener('touchend', this.onJoystickEnd.bind(this), { passive: false });

                // å°„æ“ŠæŒ‰éˆ•
                this.shootBtn.addEventListener('touchstart', this.onShootStart.bind(this), { passive: false });
                this.shootBtn.addEventListener('touchend', this.onShootEnd.bind(this), { passive: false });

                // å…¨è¢å¹•æŒ‰éˆ•
                this.fullscreenBtn.addEventListener('click', this.toggleFullscreen.bind(this));

                console.log('âœ… TouchControls åˆå§‹åŒ–å®Œæˆ');
            }

            onJoystickStart(e) {
                e.preventDefault();
                this.joystickActive = true;

                const rect = this.joystick.getBoundingClientRect();
                this.joystickCenter = {
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2
                };

                const touch = e.touches[0];
                this.updateJoystickPosition(touch.clientX, touch.clientY);
            }

            onJoystickMove(e) {
                if (!this.joystickActive) return;
                e.preventDefault();

                const touch = e.touches[0];
                this.updateJoystickPosition(touch.clientX, touch.clientY);
            }

            onJoystickEnd(e) {
                e.preventDefault();
                this.joystickActive = false;
                this.currentDirection = { x: 0, y: 0 };
                this.knob.style.transform = 'translate(-50%, -50%)';
            }

            updateJoystickPosition(clientX, clientY) {
                const deltaX = clientX - this.joystickCenter.x;
                const deltaY = clientY - this.joystickCenter.y;

                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const maxDistance = 40;

                if (distance <= maxDistance) {
                    this.knob.style.transform = `translate(${deltaX - 20}px, ${deltaY - 20}px)`;
                    this.currentDirection = {
                        x: deltaX / maxDistance,
                        y: deltaY / maxDistance
                    };
                } else {
                    const angle = Math.atan2(deltaY, deltaX);
                    const limitedX = Math.cos(angle) * maxDistance;
                    const limitedY = Math.sin(angle) * maxDistance;

                    this.knob.style.transform = `translate(${limitedX - 20}px, ${limitedY - 20}px)`;
                    this.currentDirection = {
                        x: Math.cos(angle),
                        y: Math.sin(angle)
                    };
                }
            }

            onShootStart(e) {
                e.preventDefault();
                this.shooting = true;
                console.log('ğŸš€ å°„æ“ŠæŒ‰éˆ•æŒ‰ä¸‹');
            }

            onShootEnd(e) {
                e.preventDefault();
                this.shooting = false;
            }

            toggleFullscreen() {
                console.log('ğŸ–¥ï¸ å…¨è¢å¹•æŒ‰éˆ•é»æ“Š');

                // ç™¼é€ PostMessage åˆ°çˆ¶é é¢
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'DUAL_FULLSCREEN_REQUEST',
                        action: 'toggle',
                        timestamp: Date.now(),
                        source: 'shimozurdo-fullscreen-button'
                    }, '*');

                    console.log('ğŸ“¤ å·²ç™¼é€å…¨è¢å¹•è«‹æ±‚åˆ°çˆ¶é é¢');
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç€è¦½å™¨åŸç”Ÿå…¨è¢å¹• API
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                    } else {
                        document.exitFullscreen();
                    }
                }
            }

            getInputState() {
                return {
                    direction: { ...this.currentDirection },
                    shooting: this.shooting
                };
            }
        }

        // åˆå§‹åŒ– TouchControls
        window.touchControls = new TouchControls();
    </script>

    <!-- éŠæˆ²æº–å‚™å°±ç·’äº‹ä»¶ç›£è½å™¨ -->
    <script>
        // ğŸ”§ ä¿®å¾©ï¼šå…¨åŸŸæ””æˆªå±¤æ¸…ç†å‡½æ•¸
        function cleanupGlobalInterceptLayers() {
            console.log('ğŸ§¹ åŸ·è¡Œå…¨åŸŸæ””æˆªå±¤æ¸…ç†');

            // ç§»é™¤é«˜ z-index çš„è¦†è“‹å±¤
            const overlays = document.querySelectorAll('div[style*="z-index:999999"], div[style*="z-index: 999999"]');
            overlays.forEach(overlay => {
                console.log('ğŸ—‘ï¸ ç§»é™¤å…¨åŸŸæ””æˆªå±¤:', overlay);
                overlay.remove();
            });

            // ç§»é™¤å¯èƒ½æ””æˆªè§¸æ§çš„ CSS é¡åˆ¥
            document.body.classList.remove('mobile-fullscreen', 'fullscreen-game', 'real-mobile-fullscreen');

            // ç¢ºä¿éŠæˆ²å®¹å™¨å’Œ Canvas èƒ½æ¥æ”¶è§¸æ§äº‹ä»¶
            const gameContainer = document.getElementById('game');
            if (gameContainer) {
                gameContainer.style.pointerEvents = 'auto';
                gameContainer.style.touchAction = 'manipulation';
            }

            console.log('âœ… å…¨åŸŸæ””æˆªå±¤æ¸…ç†å®Œæˆ');
        }

        // é é¢è¼‰å…¥æ™‚ç«‹å³æ¸…ç†
        cleanupGlobalInterceptLayers();

        // ç›£è½éŠæˆ²æº–å‚™å°±ç·’äº‹ä»¶
        window.addEventListener('shimozurdoGameReady', function(event) {
            console.log('ğŸ‰ shimozurdo éŠæˆ²æº–å‚™å°±ç·’');

            // ğŸ”§ ä¿®å¾©ï¼šéŠæˆ²æº–å‚™å°±ç·’æ™‚å†æ¬¡æ¸…ç†æ””æˆªå±¤
            cleanupGlobalInterceptLayers();

            // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }

            // ç¢ºä¿éŠæˆ²å®¹å™¨å¯è¦‹
            const gameContainer = document.getElementById('game');
            if (gameContainer) {
                gameContainer.style.display = 'block';
            }
        });

        // éŒ¯èª¤è™•ç†
        window.addEventListener('error', function(event) {
            console.error('âŒ é é¢éŒ¯èª¤:', event.error);

            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                // å·²ç§»é™¤éŒ¯èª¤è¨Šæ¯ UIï¼šä¿ç•™åŸè¼‰å…¥æç¤ºï¼Œä¸è¦†è“‹å…§å®¹
            }
        });

        // è¶…æ™‚è™•ç†
        setTimeout(function() {
            if (!window.game) {
                console.warn('âš ï¸ éŠæˆ²è¼‰å…¥è¶…æ™‚');
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = '<div style="color: orange;">âš ï¸ è¼‰å…¥æ™‚é–“è¼ƒé•·</div><div style="font-size: 12px;">è«‹ç¨å€™æˆ–é‡æ–°æ•´ç†é é¢</div>';
                }
            }
        }, 15000);

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('âœ… PWA: Service Worker registered successfully', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('ğŸ”„ PWA: New version available');
                                    // Optionally show update notification
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.log('âŒ PWA: Service Worker registration failed', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', function(e) {
            console.log('ğŸ“± PWA: Install prompt available');
            e.preventDefault();
            deferredPrompt = e;

            // Show install button or notification
            showInstallPrompt();
        });

        function showInstallPrompt() {
            // Create install button if not exists
            if (!document.getElementById('pwa-install-btn')) {
                const installBtn = document.createElement('button');
                installBtn.id = 'pwa-install-btn';
                installBtn.innerHTML = 'ğŸ“± å®‰è£æ‡‰ç”¨';
                installBtn.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    z-index: 9999;
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    cursor: pointer;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                `;

                installBtn.addEventListener('click', function() {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then(function(choiceResult) {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('ğŸ‰ PWA: User accepted install prompt');
                            } else {
                                console.log('âŒ PWA: User dismissed install prompt');
                            }
                            deferredPrompt = null;
                            installBtn.remove();
                        });
                    }
                });

                document.body.appendChild(installBtn);

                // Auto-hide after 10 seconds
                setTimeout(function() {
                    if (installBtn.parentNode) {
                        installBtn.remove();
                    }
                }, 10000);
            }
        }

        // PWA App Installed
        window.addEventListener('appinstalled', function(evt) {
            console.log('ğŸ‰ PWA: App installed successfully');
            const installBtn = document.getElementById('pwa-install-btn');
            if (installBtn) {
                installBtn.remove();
            }
        });
    </script>
</body>

</html>