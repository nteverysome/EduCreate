<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='chrome=1'>
    <meta name='viewport' content='width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent'>

    <!-- PWA Configuration -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-title" content="Shimozurdo Game">

    <!-- PWA Icons for iOS -->
    <link rel="apple-touch-icon" href="./assets/icon-192.svg">
    <link rel="apple-touch-icon" sizes="192x192" href="./assets/icon-192.svg">
    <link rel="apple-touch-icon" sizes="512x512" href="./assets/icon-512.svg">

    <!-- Base href to ensure relative asset URLs resolve under /games/shimozurdo-game even without trailing slash -->
    <base href="/games/shimozurdo-game/">
    <link rel='icon' href='favicon.ico' />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: 'Open Sans', sans-serif;

            /* 強化網址列隱藏 - Chrome 手機版 */
            height: 100vh;
            height: 100dvh; /* 動態視窗高度，更準確 */
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            margin: 0;
            padding: 0;
            /* 🔧 修復：確保 body 不攔截觸控事件 */
            pointer-events: none;
        }

        html {
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            width: 100%;
            margin: 0;
            padding: 0;
            /* 🔧 修復：確保 html 不攔截觸控事件 */
            pointer-events: none;
        }

        /* 針對手機瀏覽器的額外隱藏 */
        @media screen and (max-width: 768px) {
            body, html {
                height: 100vh !important;
                height: 100dvh !important;
                overflow: hidden !important;
                position: fixed !important;
                width: 100% !important;
                top: 0 !important;
                left: 0 !important;
                /* 🔧 修復：確保手機上 html 和 body 不攔截觸控事件 */
                pointer-events: none !important;
            }
        }

        #game {
            width: 100vw;
            height: 100dvh;
            /* 🔧 修復：確保遊戲容器能接收觸控事件 */
            pointer-events: auto !important;
            touch-action: manipulation !important;
        }

        /* 全螢幕樣式修復 */
        #game:fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }

        #game:-webkit-full-screen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }

        #game:-moz-full-screen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }

        #game:-ms-fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }
    </style>
    <title>Game</title>
</head>

<body>
    <div id='game'></div>


    <!-- Phaser 引擎 -->
    <script src="//cdn.jsdelivr.net/npm/phaser@3.53.1/dist/phaser.min.js"></script>

    <!-- 座標修復工具 -->
    <script src="/games/shimozurdo-game/scenes/coordinate-fix.js"></script>

    <!-- 模組載入器（使用絕對路徑避免無斜線 URL 的相對解析問題） -->
    <script src="/games/shimozurdo-game/module-loader.js"></script>

    <!-- 遊戲準備就緒事件監聽器 -->
    <script>
        // 🔧 修復：全域攔截層清理函數
        function cleanupGlobalInterceptLayers() {
            console.log('🧹 執行全域攔截層清理');

            // 移除高 z-index 的覆蓋層
            const overlays = document.querySelectorAll('div[style*="z-index:999999"], div[style*="z-index: 999999"]');
            overlays.forEach(overlay => {
                console.log('🗑️ 移除全域攔截層:', overlay);
                overlay.remove();
            });

            // 移除可能攔截觸控的 CSS 類別
            document.body.classList.remove('mobile-fullscreen', 'fullscreen-game', 'real-mobile-fullscreen');

            // 確保遊戲容器和 Canvas 能接收觸控事件
            const gameContainer = document.getElementById('game');
            if (gameContainer) {
                gameContainer.style.pointerEvents = 'auto';
                gameContainer.style.touchAction = 'manipulation';
            }

            console.log('✅ 全域攔截層清理完成');
        }

        // 頁面載入時立即清理
        cleanupGlobalInterceptLayers();

        // 監聽遊戲準備就緒事件
        window.addEventListener('shimozurdoGameReady', function(event) {
            console.log('🎉 shimozurdo 遊戲準備就緒');

            // 🔧 修復：遊戲準備就緒時再次清理攔截層
            cleanupGlobalInterceptLayers();

            // 隱藏載入指示器
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }

            // 確保遊戲容器可見
            const gameContainer = document.getElementById('game');
            if (gameContainer) {
                gameContainer.style.display = 'block';
            }
        });

        // 錯誤處理
        window.addEventListener('error', function(event) {
            console.error('❌ 頁面錯誤:', event.error);

            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                // 已移除錯誤訊息 UI：保留原載入提示，不覆蓋內容
            }
        });

        // 超時處理
        setTimeout(function() {
            if (!window.game) {
                console.warn('⚠️ 遊戲載入超時');
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = '<div style="color: orange;">⚠️ 載入時間較長</div><div style="font-size: 12px;">請稍候或重新整理頁面</div>';
                }
            }
        }, 15000);

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('✅ PWA: Service Worker registered successfully', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('🔄 PWA: New version available');
                                    // Optionally show update notification
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.log('❌ PWA: Service Worker registration failed', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', function(e) {
            console.log('📱 PWA: Install prompt available');
            e.preventDefault();
            deferredPrompt = e;

            // Show install button or notification
            showInstallPrompt();
        });

        function showInstallPrompt() {
            // Create install button if not exists
            if (!document.getElementById('pwa-install-btn')) {
                const installBtn = document.createElement('button');
                installBtn.id = 'pwa-install-btn';
                installBtn.innerHTML = '📱 安裝應用';
                installBtn.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    z-index: 9999;
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    cursor: pointer;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                `;

                installBtn.addEventListener('click', function() {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then(function(choiceResult) {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('🎉 PWA: User accepted install prompt');
                            } else {
                                console.log('❌ PWA: User dismissed install prompt');
                            }
                            deferredPrompt = null;
                            installBtn.remove();
                        });
                    }
                });

                document.body.appendChild(installBtn);

                // Auto-hide after 10 seconds
                setTimeout(function() {
                    if (installBtn.parentNode) {
                        installBtn.remove();
                    }
                }, 10000);
            }
        }

        // PWA App Installed
        window.addEventListener('appinstalled', function(evt) {
            console.log('🎉 PWA: App installed successfully');
            const installBtn = document.getElementById('pwa-install-btn');
            if (installBtn) {
                installBtn.remove();
            }
        });
    </script>
</body>

</html>