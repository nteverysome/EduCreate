<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='chrome=1'>
    <meta name='viewport' content='width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent'>

    <!-- PWA Configuration -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-title" content="Shimozurdo Game">

    <!-- PWA Icons for iOS -->
    <link rel="apple-touch-icon" href="./assets/icon-192.svg">
    <link rel="apple-touch-icon" sizes="192x192" href="./assets/icon-192.svg">
    <link rel="apple-touch-icon" sizes="512x512" href="./assets/icon-512.svg">

    <!-- Base href to ensure relative asset URLs resolve under /games/shimozurdo-game even without trailing slash -->
    <base href="/games/shimozurdo-game/">
    <link rel='icon' href='favicon.ico' />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: 'Open Sans', sans-serif;

            /* 強化網址列隱藏 - Chrome 手機版 */
            height: 100vh;
            height: 100dvh; /* 動態視窗高度，更準確 */
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            margin: 0;
            padding: 0;
            /* 🔧 修復：確保 body 不攔截觸控事件 */
            pointer-events: none;
        }

        html {
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            width: 100%;
            margin: 0;
            padding: 0;
            /* 🔧 修復：確保 html 不攔截觸控事件 */
            pointer-events: none;
        }

        /* 針對手機瀏覽器的額外隱藏 */
        @media screen and (max-width: 768px) {
            body, html {
                height: 100vh !important;
                height: 100dvh !important;
                overflow: hidden !important;
                position: fixed !important;
                width: 100% !important;
                top: 0 !important;
                left: 0 !important;
                /* 🔧 修復：確保手機上 html 和 body 不攔截觸控事件 */
                pointer-events: none !important;
            }
        }

        #game {
            width: 100vw;
            height: 100dvh;
            /* 🔧 修復：確保遊戲容器能接收觸控事件 */
            pointer-events: auto !important;
            touch-action: manipulation !important;
        }

        /* 全螢幕樣式修復 */
        #game:fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }

        #game:-webkit-full-screen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }

        #game:-moz-full-screen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }

        #game:-ms-fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }

        /* 🎮 TouchControls 虛擬按鈕樣式 */
        #touch-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 240px;
            background: transparent;
            display: none;  /* 預設隱藏，媒體查詢控制顯示 */
            z-index: 1000;
            pointer-events: none;
        }

        /* 虛擬搖桿 */
        .touch-joystick {
            position: absolute;
            bottom: 60px;
            left: 20px;
            width: 120px;
            height: 120px;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            pointer-events: all;
        }

        .touch-joystick-knob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.1s;
        }

        /* 射擊按鈕 */
        .touch-shoot-btn {
            position: absolute;
            bottom: 60px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: #ff4757;
            border: none;
            border-radius: 50%;
            font-size: 32px;
            pointer-events: all;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s;
        }

        .touch-shoot-btn:active {
            transform: scale(0.95);
        }

        /* 全螢幕按鈕 */
        .fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 24px;
            pointer-events: all;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s;
        }

        .fullscreen-btn:active {
            transform: scale(0.95);
        }

        /* 媒體查詢：移動設備顯示 */
        @media (max-width: 1024px) and (max-height: 768px),
               (pointer: coarse),
               (hover: none) and (pointer: coarse) {
            #touch-controls {
                display: block !important;
            }
        }
    </style>
    <title>Game</title>
</head>

<body>
    <div id='game'></div>

    <!-- 🎮 TouchControls 虛擬按鈕 -->
    <div id="touch-controls">
        <!-- 虛擬搖桿 -->
        <div class="touch-joystick">
            <div class="touch-joystick-knob"></div>
        </div>

        <!-- 射擊按鈕 -->
        <button class="touch-shoot-btn">🚀</button>

        <!-- 全螢幕按鈕 -->
        <button class="fullscreen-btn">⛶</button>
    </div>


    <!-- Phaser 引擎 -->
    <script src="//cdn.jsdelivr.net/npm/phaser@3.53.1/dist/phaser.min.js"></script>

    <!-- 座標修復工具 -->
    <script src="/games/shimozurdo-game/scenes/coordinate-fix.js"></script>

    <!-- 模組載入器（使用絕對路徑避免無斜線 URL 的相對解析問題） -->
    <script src="/games/shimozurdo-game/module-loader.js"></script>

    <!-- 🎮 TouchControls 虛擬按鈕 JavaScript -->
    <script>
        // TouchControls 類 - 虛擬按鈕控制系統
        class TouchControls {
            constructor() {
                this.joystick = document.querySelector('.touch-joystick');
                this.knob = document.querySelector('.touch-joystick-knob');
                this.shootBtn = document.querySelector('.touch-shoot-btn');
                this.fullscreenBtn = document.querySelector('.fullscreen-btn');

                this.joystickActive = false;
                this.joystickCenter = { x: 0, y: 0 };
                this.currentDirection = { x: 0, y: 0 };
                this.shooting = false;

                this.init();
            }

            init() {
                if (!this.joystick || !this.shootBtn || !this.fullscreenBtn) {
                    console.warn('⚠️ TouchControls 元素未找到');
                    return;
                }

                // 搖桿控制
                this.joystick.addEventListener('touchstart', this.onJoystickStart.bind(this), { passive: false });
                this.joystick.addEventListener('touchmove', this.onJoystickMove.bind(this), { passive: false });
                this.joystick.addEventListener('touchend', this.onJoystickEnd.bind(this), { passive: false });

                // 射擊按鈕
                this.shootBtn.addEventListener('touchstart', this.onShootStart.bind(this), { passive: false });
                this.shootBtn.addEventListener('touchend', this.onShootEnd.bind(this), { passive: false });

                // 全螢幕按鈕
                this.fullscreenBtn.addEventListener('click', this.toggleFullscreen.bind(this));

                console.log('✅ TouchControls 初始化完成');
            }

            onJoystickStart(e) {
                e.preventDefault();
                this.joystickActive = true;

                const rect = this.joystick.getBoundingClientRect();
                this.joystickCenter = {
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2
                };

                const touch = e.touches[0];
                this.updateJoystickPosition(touch.clientX, touch.clientY);
            }

            onJoystickMove(e) {
                if (!this.joystickActive) return;
                e.preventDefault();

                const touch = e.touches[0];
                this.updateJoystickPosition(touch.clientX, touch.clientY);
            }

            onJoystickEnd(e) {
                e.preventDefault();
                this.joystickActive = false;
                this.currentDirection = { x: 0, y: 0 };
                this.knob.style.transform = 'translate(-50%, -50%)';
            }

            updateJoystickPosition(clientX, clientY) {
                const deltaX = clientX - this.joystickCenter.x;
                const deltaY = clientY - this.joystickCenter.y;

                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const maxDistance = 40;

                if (distance <= maxDistance) {
                    this.knob.style.transform = `translate(${deltaX - 20}px, ${deltaY - 20}px)`;
                    this.currentDirection = {
                        x: deltaX / maxDistance,
                        y: deltaY / maxDistance
                    };
                } else {
                    const angle = Math.atan2(deltaY, deltaX);
                    const limitedX = Math.cos(angle) * maxDistance;
                    const limitedY = Math.sin(angle) * maxDistance;

                    this.knob.style.transform = `translate(${limitedX - 20}px, ${limitedY - 20}px)`;
                    this.currentDirection = {
                        x: Math.cos(angle),
                        y: Math.sin(angle)
                    };
                }
            }

            onShootStart(e) {
                e.preventDefault();
                this.shooting = true;
                console.log('🚀 射擊按鈕按下');
            }

            onShootEnd(e) {
                e.preventDefault();
                this.shooting = false;
            }

            toggleFullscreen() {
                console.log('🖥️ 全螢幕按鈕點擊');

                // 發送 PostMessage 到父頁面
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'DUAL_FULLSCREEN_REQUEST',
                        action: 'toggle',
                        timestamp: Date.now(),
                        source: 'shimozurdo-fullscreen-button'
                    }, '*');

                    console.log('📤 已發送全螢幕請求到父頁面');
                } else {
                    // 備用方案：使用瀏覽器原生全螢幕 API
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                    } else {
                        document.exitFullscreen();
                    }
                }
            }

            getInputState() {
                return {
                    direction: { ...this.currentDirection },
                    shooting: this.shooting
                };
            }
        }

        // 初始化 TouchControls
        window.touchControls = new TouchControls();
    </script>

    <!-- 遊戲準備就緒事件監聽器 -->
    <script>
        // 🔧 修復：全域攔截層清理函數
        function cleanupGlobalInterceptLayers() {
            console.log('🧹 執行全域攔截層清理');

            // 移除高 z-index 的覆蓋層
            const overlays = document.querySelectorAll('div[style*="z-index:999999"], div[style*="z-index: 999999"]');
            overlays.forEach(overlay => {
                console.log('🗑️ 移除全域攔截層:', overlay);
                overlay.remove();
            });

            // 移除可能攔截觸控的 CSS 類別
            document.body.classList.remove('mobile-fullscreen', 'fullscreen-game', 'real-mobile-fullscreen');

            // 確保遊戲容器和 Canvas 能接收觸控事件
            const gameContainer = document.getElementById('game');
            if (gameContainer) {
                gameContainer.style.pointerEvents = 'auto';
                gameContainer.style.touchAction = 'manipulation';
            }

            console.log('✅ 全域攔截層清理完成');
        }

        // 頁面載入時立即清理
        cleanupGlobalInterceptLayers();

        // 監聽遊戲準備就緒事件
        window.addEventListener('shimozurdoGameReady', function(event) {
            console.log('🎉 shimozurdo 遊戲準備就緒');

            // 🔧 修復：遊戲準備就緒時再次清理攔截層
            cleanupGlobalInterceptLayers();

            // 隱藏載入指示器
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }

            // 確保遊戲容器可見
            const gameContainer = document.getElementById('game');
            if (gameContainer) {
                gameContainer.style.display = 'block';
            }
        });

        // 錯誤處理
        window.addEventListener('error', function(event) {
            console.error('❌ 頁面錯誤:', event.error);

            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                // 已移除錯誤訊息 UI：保留原載入提示，不覆蓋內容
            }
        });

        // 超時處理
        setTimeout(function() {
            if (!window.game) {
                console.warn('⚠️ 遊戲載入超時');
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = '<div style="color: orange;">⚠️ 載入時間較長</div><div style="font-size: 12px;">請稍候或重新整理頁面</div>';
                }
            }
        }, 15000);

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('✅ PWA: Service Worker registered successfully', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('🔄 PWA: New version available');
                                    // Optionally show update notification
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.log('❌ PWA: Service Worker registration failed', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', function(e) {
            console.log('📱 PWA: Install prompt available');
            e.preventDefault();
            deferredPrompt = e;

            // Show install button or notification
            showInstallPrompt();
        });

        function showInstallPrompt() {
            // Create install button if not exists
            if (!document.getElementById('pwa-install-btn')) {
                const installBtn = document.createElement('button');
                installBtn.id = 'pwa-install-btn';
                installBtn.innerHTML = '📱 安裝應用';
                installBtn.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    z-index: 9999;
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    cursor: pointer;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                `;

                installBtn.addEventListener('click', function() {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then(function(choiceResult) {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('🎉 PWA: User accepted install prompt');
                            } else {
                                console.log('❌ PWA: User dismissed install prompt');
                            }
                            deferredPrompt = null;
                            installBtn.remove();
                        });
                    }
                });

                document.body.appendChild(installBtn);

                // Auto-hide after 10 seconds
                setTimeout(function() {
                    if (installBtn.parentNode) {
                        installBtn.remove();
                    }
                }, 10000);
            }
        }

        // PWA App Installed
        window.addEventListener('appinstalled', function(evt) {
            console.log('🎉 PWA: App installed successfully');
            const installBtn = document.getElementById('pwa-install-btn');
            if (installBtn) {
                installBtn.remove();
            }
        });
    </script>
</body>

</html>