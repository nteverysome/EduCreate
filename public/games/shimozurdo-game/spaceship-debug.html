<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 太空船調試測試</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            color: white;
        }
        #game {
            border: 2px solid #4facfe;
            border-radius: 10px;
            margin: 20px 0;
        }
        .debug-info {
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 600px;
            text-align: left;
        }
        .step {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 3px;
        }
        .step.success { background: rgba(0,255,0,0.2); }
        .step.error { background: rgba(255,0,0,0.2); }
        .step.pending { background: rgba(255,255,0,0.2); }
    </style>
</head>
<body>
    <h1>🚀 太空船調試測試</h1>
    
    <div class="debug-info">
        <div id="step1" class="step pending">1. 檢查 Phaser 物理引擎</div>
        <div id="step2" class="step pending">2. 檢查精靈圖資源</div>
        <div id="step3" class="step pending">3. 創建太空船</div>
        <div id="step4" class="step pending">4. 檢查太空船位置</div>
        <div id="step5" class="step pending">5. 檢查太空船可見性</div>
    </div>
    
    <div id="game"></div>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <script>
        function updateStep(stepId, status, message) {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
            step.textContent = message;
            console.log(`[${status.toUpperCase()}] ${message}`);
        }

        class SpaceshipDebugScene extends Phaser.Scene {
            constructor() {
                super({ key: 'SpaceshipDebugScene' });
            }

            preload() {
                updateStep('step1', 'success', '1. ✅ Phaser 物理引擎已啟用');
                
                // 載入太空船精靈圖
                this.load.spritesheet('player_spaceship', 'assets/images/sprites/player_spaceship.png', {
                    frameWidth: Math.floor(2450 / 7),
                    frameHeight: 150
                });
                
                this.load.on('filecomplete-spritesheet-player_spaceship', () => {
                    updateStep('step2', 'success', '2. ✅ 太空船精靈圖載入成功');
                });
                
                this.load.on('loaderror', (file) => {
                    if (file.key === 'player_spaceship') {
                        updateStep('step2', 'error', '2. ❌ 太空船精靈圖載入失敗');
                    }
                });
            }

            create() {
                const { width, height } = this.cameras.main;
                
                // 創建深色背景
                this.add.rectangle(width/2, height/2, width, height, 0x1a1a2e);
                
                // 標題
                this.add.text(width/2, 50, '🚀 太空船調試場景', {
                    fontSize: '24px',
                    color: '#4facfe',
                    fontStyle: 'bold'
                }).setOrigin(0.5);
                
                // 嘗試創建太空船
                this.createDebugSpaceship();
                
                // 顯示調試信息
                this.createDebugInfo();
            }

            createDebugSpaceship() {
                const { width, height } = this.cameras.main;
                
                try {
                    if (this.textures.exists('player_spaceship')) {
                        updateStep('step3', 'pending', '3. 🔄 使用真實精靈圖創建太空船...');
                        
                        // 創建動畫
                        this.anims.create({
                            key: 'spaceship_fly',
                            frames: this.anims.generateFrameNumbers('player_spaceship', {
                                start: 0, end: 6
                            }),
                            frameRate: 10,
                            repeat: -1
                        });
                        
                        // 創建太空船（使用物理）
                        this.player = this.physics.add.sprite(width * 0.2, height * 0.5, 'player_spaceship');
                        this.player.setOrigin(0.5, 0.5);
                        this.player.setScale(0.4);
                        this.player.setDepth(10); // 確保在前景
                        this.player.play('spaceship_fly');
                        
                        // 設置物理屬性
                        this.player.setCollideWorldBounds(true);
                        
                        updateStep('step3', 'success', '3. ✅ 真實太空船創建成功');
                        
                    } else {
                        updateStep('step3', 'pending', '3. 🔄 使用備用太空船...');
                        this.createBackupSpaceship();
                    }
                    
                    // 檢查太空船狀態
                    this.checkSpaceshipStatus();
                    
                } catch (error) {
                    updateStep('step3', 'error', `3. ❌ 太空船創建失敗: ${error.message}`);
                    console.error('太空船創建錯誤:', error);
                }
            }

            createBackupSpaceship() {
                const { width, height } = this.cameras.main;
                
                try {
                    // 創建簡單的備用太空船
                    const graphics = this.add.graphics();
                    graphics.fillStyle(0x4facfe);
                    graphics.fillTriangle(30, 0, 0, 20, 0, -20);
                    graphics.lineStyle(2, 0xffffff, 1);
                    graphics.strokeTriangle(30, 0, 0, 20, 0, -20);
                    graphics.generateTexture('backup_spaceship', 40, 40);
                    graphics.destroy();
                    
                    // 創建備用太空船
                    this.player = this.physics.add.sprite(width * 0.2, height * 0.5, 'backup_spaceship');
                    this.player.setOrigin(0.5, 0.5);
                    this.player.setScale(1.5);
                    this.player.setDepth(10);
                    this.player.setCollideWorldBounds(true);
                    
                    updateStep('step3', 'success', '3. ✅ 備用太空船創建成功');
                    
                } catch (error) {
                    updateStep('step3', 'error', `3. ❌ 備用太空船創建失敗: ${error.message}`);
                }
            }

            checkSpaceshipStatus() {
                if (this.player) {
                    const x = Math.round(this.player.x);
                    const y = Math.round(this.player.y);
                    const visible = this.player.visible;
                    const active = this.player.active;
                    const alpha = this.player.alpha;
                    const depth = this.player.depth;
                    
                    updateStep('step4', 'success', `4. ✅ 太空船位置: (${x}, ${y})`);
                    updateStep('step5', visible ? 'success' : 'error', 
                        `5. ${visible ? '✅' : '❌'} 可見性: ${visible}, 活躍: ${active}, 透明度: ${alpha}, 深度: ${depth}`);
                    
                    // 在控制台輸出詳細信息
                    console.log('太空船詳細狀態:', {
                        x, y, visible, active, alpha, depth,
                        texture: this.player.texture.key,
                        scale: this.player.scale
                    });
                    
                } else {
                    updateStep('step4', 'error', '4. ❌ 太空船對象不存在');
                    updateStep('step5', 'error', '5. ❌ 無法檢查可見性');
                }
            }

            createDebugInfo() {
                const { width, height } = this.cameras.main;
                
                // 顯示太空船應該在的位置（紅色圓圈）
                const expectedX = width * 0.2;
                const expectedY = height * 0.5;
                
                const circle = this.add.circle(expectedX, expectedY, 50, 0xff0000, 0.3);
                circle.setStrokeStyle(2, 0xff0000);
                circle.setDepth(5);
                
                this.add.text(expectedX, expectedY + 70, '預期太空船位置', {
                    fontSize: '16px',
                    color: '#ff0000'
                }).setOrigin(0.5);
                
                // 添加說明文字
                this.add.text(width/2, height - 100, '紅色圓圈標示太空船應該出現的位置', {
                    fontSize: '18px',
                    color: '#ffffff'
                }).setOrigin(0.5);
            }

            update() {
                // 持續檢查太空船狀態
                if (this.player && this.time.now % 1000 < 16) { // 每秒檢查一次
                    this.checkSpaceshipStatus();
                }
            }
        }

        // Phaser 配置
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game',
            backgroundColor: '#1a1a2e',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: true // 啟用物理調試
                }
            },
            scene: SpaceshipDebugScene
        };

        try {
            const game = new Phaser.Game(config);
            console.log('🎮 調試遊戲啟動成功');
        } catch (error) {
            updateStep('step1', 'error', `1. ❌ Phaser 初始化失敗: ${error.message}`);
            console.error('Phaser 初始化錯誤:', error);
        }
    </script>
</body>
</html>
