<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📱 手機 PostMessage 通信測試工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: background 0.3s;
        }
        
        .test-button:hover {
            background: #45a049;
        }
        
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }
        
        .status.info {
            background: rgba(33, 150, 243, 0.3);
            border: 1px solid #2196F3;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .iframe-container {
            width: 100%;
            height: 400px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .environment-info {
            font-size: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📱 手機 PostMessage 通信測試工具</h1>
        
        <!-- 環境信息 -->
        <div class="environment-info" id="environmentInfo">
            <strong>🔍 環境檢測中...</strong>
        </div>
        
        <!-- 通信狀態 -->
        <div class="test-section">
            <h3>📡 通信狀態</h3>
            <div id="commStatus" class="status info">
                🔄 初始化中...
            </div>
        </div>
        
        <!-- 測試按鈕 -->
        <div class="test-section">
            <h3>🧪 測試功能</h3>
            <button class="test-button" onclick="testBasicCommunication()">
                📤 測試基本通信
            </button>
            <button class="test-button" onclick="testEnhancedCommunication()">
                🔧 測試強化通信
            </button>
            <button class="test-button" onclick="testFullscreenRequest()">
                🍎 測試全螢幕請求
            </button>
            <button class="test-button" onclick="monitorCommunication()">
                📊 監控通信狀態
            </button>
            <button class="test-button" onclick="clearLog()">
                🗑️ 清除日誌
            </button>
        </div>
        
        <!-- 日誌 -->
        <div class="test-section">
            <h3>📋 測試日誌</h3>
            <div id="testLog" class="log">
等待測試開始...
            </div>
        </div>
        
        <!-- iframe 測試區域 -->
        <div class="test-section">
            <h3>🎮 遊戲 iframe 測試</h3>
            <div class="iframe-container">
                <iframe id="gameIframe" src="/games/starshake-game/dist/index.html"></iframe>
            </div>
        </div>
    </div>

    <script>
        console.log('📱 手機 PostMessage 測試工具載入');
        
        // 全局變量
        let testLog = [];
        let communicationStatus = {
            initialized: false,
            working: false,
            lastTest: null,
            errors: []
        };

        // 全螢幕狀態
        window.isGameFullscreen = false;
        
        // 日誌函數
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logElement = document.getElementById('testLog');
            logElement.textContent = testLog.join('\\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(message);
        }
        
        // 更新狀態
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('commStatus');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
        
        // 環境檢測
        function detectEnvironment() {
            const env = {
                userAgent: navigator.userAgent,
                isMobile: /Mobi|Android/i.test(navigator.userAgent),
                isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
                isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
                isAndroid: /Android/.test(navigator.userAgent),
                screenWidth: screen.width,
                screenHeight: screen.height,
                windowWidth: window.innerWidth,
                windowHeight: window.innerHeight,
                hasPostMessage: typeof window.postMessage === 'function',
                timestamp: new Date().toISOString()
            };
            
            const envInfo = document.getElementById('environmentInfo');
            envInfo.innerHTML = `
                <strong>🔍 環境信息：</strong><br>
                📱 移動設備: ${env.isMobile ? '是' : '否'}<br>
                🍎 Safari: ${env.isSafari ? '是' : '否'}<br>
                📱 iOS: ${env.isIOS ? '是' : '否'}<br>
                🤖 Android: ${env.isAndroid ? '是' : '否'}<br>
                📐 螢幕: ${env.screenWidth}x${env.screenHeight}<br>
                🪟 視窗: ${env.windowWidth}x${env.windowHeight}<br>
                📡 PostMessage: ${env.hasPostMessage ? '支援' : '不支援'}
            `;
            
            log('🔍 環境檢測完成: ' + JSON.stringify(env, null, 2));
            return env;
        }
        
        // 設置父頁面監聽器
        function setupParentListener() {
            log('📡 設置父頁面 PostMessage 監聽器');
            
            window.addEventListener('message', function(event) {
                log('📨 父頁面收到消息: ' + JSON.stringify(event.data));
                
                try {
                    if (!event.data || typeof event.data !== 'object') {
                        return;
                    }
                    
                    const message = event.data;
                    
                    // 處理監聽器設置請求
                    if (message.type === 'SETUP_PARENT_LISTENER') {
                        log('🔧 處理監聽器設置請求');
                        
                        event.source.postMessage({
                            type: 'PARENT_LISTENER_READY',
                            timestamp: Date.now(),
                            parentUserAgent: navigator.userAgent
                        }, event.origin);
                        
                        log('✅ 父頁面監聽器就緒響應已發送');
                        updateStatus('✅ 父頁面監聽器已就緒', 'success');
                    }
                    
                    // 處理通信測試
                    else if (message.type === 'COMMUNICATION_TEST') {
                        log('🧪 處理通信測試: ' + message.testId);
                        
                        event.source.postMessage({
                            type: 'COMMUNICATION_TEST_RESPONSE',
                            testId: message.testId,
                            timestamp: Date.now(),
                            parentUserAgent: navigator.userAgent,
                            receivedAt: Date.now(),
                            originalMessage: message
                        }, event.origin);
                        
                        log('✅ 通信測試響應已發送');
                        communicationStatus.working = true;
                        updateStatus('✅ PostMessage 通信正常工作', 'success');
                    }
                    
                    // 處理全螢幕請求 - 簡化版本
                    else if (message.type === 'DUAL_FULLSCREEN_REQUEST') {
                        log('🍎 收到全螢幕切換請求，當前狀態: ' + window.isGameFullscreen);

                        // 防重複處理
                        if (window.isProcessingFullscreen) {
                            log('⚠️ 正在處理全螢幕請求，忽略重複請求');
                            return;
                        }

                        window.isProcessingFullscreen = true;

                        // 簡單切換：根據當前狀態決定動作
                        setTimeout(() => {
                            if (window.isGameFullscreen) {
                                log('🔄 當前全螢幕，執行退出');
                                exitCSSFullscreen();
                            } else {
                                log('📱 當前非全螢幕，執行進入');
                                enterCSSFullscreen();
                            }

                            // 1秒後解除處理鎖
                            setTimeout(() => {
                                window.isProcessingFullscreen = false;
                            }, 1000);
                        }, 100);


                    }
                    
                } catch (error) {
                    log('❌ 父頁面消息處理失敗: ' + error.message);
                    communicationStatus.errors.push(error.message);
                }
            });
            
            log('✅ 父頁面 PostMessage 監聽器已設置');
        }

        // 進入CSS全螢幕函數
        function enterCSSFullscreen() {
            log('🚀 執行進入CSS全螢幕');

            const container = document.querySelector('.container');
            const iframeContainer = document.querySelector('.iframe-container');
            const iframe = document.getElementById('gameIframe');

            if (container && iframeContainer && iframe) {
                // 隱藏所有其他內容
                const children = container.children;
                for (let i = 0; i < children.length; i++) {
                    if (children[i] !== iframeContainer.parentElement) {
                        children[i].style.display = 'none';
                    }
                }

                // 設置 body 全螢幕
                document.body.style.position = 'fixed';
                document.body.style.top = '0';
                document.body.style.left = '0';
                document.body.style.width = '100vw';
                document.body.style.height = '100vh';
                document.body.style.zIndex = '9999';
                document.body.style.backgroundColor = '#000';
                document.body.style.margin = '0';
                document.body.style.padding = '0';

                // 設置容器全螢幕
                container.style.maxWidth = 'none';
                container.style.width = '100vw';
                container.style.height = '100vh';
                container.style.margin = '0';
                container.style.padding = '0';
                container.style.background = 'transparent';

                // 設置 iframe 容器全螢幕，向上移動
                iframeContainer.style.position = 'fixed';
                iframeContainer.style.top = '-80px';
                iframeContainer.style.left = '0';
                iframeContainer.style.width = '100vw';
                iframeContainer.style.height = 'calc(100vh + 80px)';
                iframeContainer.style.background = '#000';
                iframeContainer.style.borderRadius = '0';
                iframeContainer.style.zIndex = '10000';
                iframeContainer.style.overflow = 'hidden';

                // 設置 iframe 全螢幕，向上移動給搖桿留空間
                iframe.style.position = 'absolute';
                iframe.style.top = '-100px';
                iframe.style.left = '0';
                iframe.style.width = '100vw';
                iframe.style.height = 'calc(100vh + 100px)';
                iframe.style.border = 'none';
                iframe.style.borderRadius = '0';
                iframe.style.zIndex = '10001';
                iframe.style.display = 'block';

                // 隱藏 Safari 地址欄
                window.scrollTo(0, 1);
                setTimeout(() => window.scrollTo(0, 1), 100);

                // 標記全螢幕狀態
                window.isGameFullscreen = true;
                log('✅ 進入CSS全螢幕完成');
                updateStatus('✅ 遊戲全螢幕已啟用', 'success');
            } else {
                log('❌ 找不到必要的 DOM 元素');
            }
        }

        // 退出CSS全螢幕函數
        function exitCSSFullscreen() {
            log('🔄 執行退出CSS全螢幕');

            const container = document.querySelector('.container');
            const iframeContainer = document.querySelector('.iframe-container');
            const iframe = document.getElementById('gameIframe');

            if (container && iframeContainer && iframe) {
                // 恢復其他元素
                const children = container.children;
                for (let i = 0; i < children.length; i++) {
                    children[i].style.display = '';
                }

                // 恢復樣式
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.left = '';
                document.body.style.width = '';
                document.body.style.height = '';
                document.body.style.zIndex = '';
                document.body.style.backgroundColor = '';
                document.body.style.margin = '';
                document.body.style.padding = '';

                container.style.maxWidth = '';
                container.style.width = '';
                container.style.height = '';
                container.style.margin = '';
                container.style.padding = '';
                container.style.background = '';

                iframeContainer.style.position = '';
                iframeContainer.style.top = '';
                iframeContainer.style.left = '';
                iframeContainer.style.width = '';
                iframeContainer.style.height = '';
                iframeContainer.style.background = '';
                iframeContainer.style.borderRadius = '';
                iframeContainer.style.zIndex = '';
                iframeContainer.style.overflow = '';

                iframe.style.position = '';
                iframe.style.top = '';
                iframe.style.left = '';
                iframe.style.width = '';
                iframe.style.height = '';
                iframe.style.border = '';
                iframe.style.borderRadius = '';
                iframe.style.zIndex = '';
                iframe.style.display = '';

                window.isGameFullscreen = false;
                log('✅ 退出CSS全螢幕完成');
                updateStatus('✅ 遊戲全螢幕已退出', 'success');
            } else {
                log('❌ 找不到必要的 DOM 元素');
            }
        }
        
        // 測試基本通信
        async function testBasicCommunication() {
            log('🧪 開始測試基本 PostMessage 通信');
            updateStatus('🔄 測試基本通信中...', 'info');
            
            try {
                const iframe = document.getElementById('gameIframe');
                if (!iframe || !iframe.contentWindow) {
                    throw new Error('iframe 未載入或無法訪問');
                }
                
                const testMessage = {
                    type: 'BASIC_COMMUNICATION_TEST',
                    timestamp: Date.now(),
                    testId: 'basic_' + Date.now()
                };
                
                log('📤 發送基本測試消息: ' + JSON.stringify(testMessage));
                iframe.contentWindow.postMessage(testMessage, '*');
                
                // 等待響應
                setTimeout(() => {
                    if (!communicationStatus.working) {
                        log('⏰ 基本通信測試超時');
                        updateStatus('⏰ 基本通信測試超時', 'error');
                    }
                }, 3000);
                
            } catch (error) {
                log('❌ 基本通信測試失敗: ' + error.message);
                updateStatus('❌ 基本通信測試失敗', 'error');
            }
        }
        
        // 測試強化通信
        async function testEnhancedCommunication() {
            log('🔧 開始測試強化 PostMessage 通信');
            updateStatus('🔄 測試強化通信中...', 'info');
            
            try {
                const iframe = document.getElementById('gameIframe');
                if (!iframe || !iframe.contentWindow) {
                    throw new Error('iframe 未載入或無法訪問');
                }
                
                // 觸發 iframe 內的強化通信測試
                const testMessage = {
                    type: 'TRIGGER_ENHANCED_TEST',
                    timestamp: Date.now()
                };
                
                log('📤 觸發 iframe 內的強化通信測試');
                iframe.contentWindow.postMessage(testMessage, '*');
                
                // 也可以直接調用 iframe 內的函數（如果可訪問）
                setTimeout(() => {
                    try {
                        if (iframe.contentWindow.testPostMessageCommEnhanced) {
                            log('🔧 直接調用 iframe 內的強化測試函數');
                            iframe.contentWindow.testPostMessageCommEnhanced();
                        }
                    } catch (e) {
                        log('⚠️ 無法直接調用 iframe 內的函數: ' + e.message);
                    }
                }, 1000);
                
            } catch (error) {
                log('❌ 強化通信測試失敗: ' + error.message);
                updateStatus('❌ 強化通信測試失敗', 'error');
            }
        }
        
        // 測試全螢幕請求
        async function testFullscreenRequest() {
            log('🍎 開始測試全螢幕請求');
            updateStatus('🔄 測試全螢幕請求中...', 'info');
            
            try {
                const iframe = document.getElementById('gameIframe');
                if (!iframe || !iframe.contentWindow) {
                    throw new Error('iframe 未載入或無法訪問');
                }
                
                // 觸發 iframe 內的全螢幕請求
                const fullscreenMessage = {
                    type: 'TRIGGER_FULLSCREEN_TEST',
                    timestamp: Date.now()
                };
                
                log('📤 觸發 iframe 內的全螢幕測試');
                iframe.contentWindow.postMessage(fullscreenMessage, '*');
                
                // 也可以直接調用 iframe 內的函數
                setTimeout(() => {
                    try {
                        if (iframe.contentWindow.requestFullscreenWithCommFix) {
                            log('🔧 直接調用 iframe 內的修復全螢幕函數');
                            iframe.contentWindow.requestFullscreenWithCommFix();
                        }
                    } catch (e) {
                        log('⚠️ 無法直接調用 iframe 內的全螢幕函數: ' + e.message);
                    }
                }, 1000);
                
            } catch (error) {
                log('❌ 全螢幕請求測試失敗: ' + error.message);
                updateStatus('❌ 全螢幕請求測試失敗', 'error');
            }
        }
        
        // 監控通信狀態
        function monitorCommunication() {
            log('📊 開始監控 PostMessage 通信狀態');
            
            const status = {
                ...communicationStatus,
                timestamp: new Date().toISOString(),
                environment: detectEnvironment()
            };
            
            log('📊 當前通信狀態: ' + JSON.stringify(status, null, 2));
            
            // 嘗試獲取 iframe 內的狀態
            try {
                const iframe = document.getElementById('gameIframe');
                if (iframe && iframe.contentWindow && iframe.contentWindow.monitorCommStatus) {
                    const iframeStatus = iframe.contentWindow.monitorCommStatus();
                    log('📊 iframe 內的通信狀態: ' + JSON.stringify(iframeStatus, null, 2));
                }
            } catch (e) {
                log('⚠️ 無法獲取 iframe 內的狀態: ' + e.message);
            }
        }
        
        // 清除日誌
        function clearLog() {
            testLog = [];
            document.getElementById('testLog').textContent = '日誌已清除...';
            log('🗑️ 日誌已清除');
        }
        
        // 初始化
        function init() {
            log('🚀 手機 PostMessage 測試工具初始化');
            
            // 檢測環境
            detectEnvironment();
            
            // 設置父頁面監聽器
            setupParentListener();
            
            // 等待 iframe 載入
            const iframe = document.getElementById('gameIframe');
            iframe.onload = function() {
                log('✅ 遊戲 iframe 已載入');
                updateStatus('✅ iframe 已載入，可以開始測試', 'success');
                
                // 自動觸發一次基本通信測試
                setTimeout(() => {
                    testBasicCommunication();
                }, 2000);
            };
            
            iframe.onerror = function() {
                log('❌ 遊戲 iframe 載入失敗');
                updateStatus('❌ iframe 載入失敗', 'error');
            };
            
            communicationStatus.initialized = true;
            log('✅ 測試工具初始化完成');
        }
        
        // 頁面載入完成後初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
