<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“± æ‰‹æ©Ÿ PostMessage é€šä¿¡æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: background 0.3s;
        }
        
        .test-button:hover {
            background: #45a049;
        }
        
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }
        
        .status.info {
            background: rgba(33, 150, 243, 0.3);
            border: 1px solid #2196F3;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .iframe-container {
            width: 100%;
            height: 400px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .environment-info {
            font-size: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± æ‰‹æ©Ÿ PostMessage é€šä¿¡æ¸¬è©¦å·¥å…·</h1>
        
        <!-- ç’°å¢ƒä¿¡æ¯ -->
        <div class="environment-info" id="environmentInfo">
            <strong>ğŸ” ç’°å¢ƒæª¢æ¸¬ä¸­...</strong>
        </div>
        
        <!-- é€šä¿¡ç‹€æ…‹ -->
        <div class="test-section">
            <h3>ğŸ“¡ é€šä¿¡ç‹€æ…‹</h3>
            <div id="commStatus" class="status info">
                ğŸ”„ åˆå§‹åŒ–ä¸­...
            </div>
        </div>
        
        <!-- æ¸¬è©¦æŒ‰éˆ• -->
        <div class="test-section">
            <h3>ğŸ§ª æ¸¬è©¦åŠŸèƒ½</h3>
            <button class="test-button" onclick="testBasicCommunication()">
                ğŸ“¤ æ¸¬è©¦åŸºæœ¬é€šä¿¡
            </button>
            <button class="test-button" onclick="testEnhancedCommunication()">
                ğŸ”§ æ¸¬è©¦å¼·åŒ–é€šä¿¡
            </button>
            <button class="test-button" onclick="testFullscreenRequest()">
                ğŸ æ¸¬è©¦å…¨è¢å¹•è«‹æ±‚
            </button>
            <button class="test-button" onclick="monitorCommunication()">
                ğŸ“Š ç›£æ§é€šä¿¡ç‹€æ…‹
            </button>
            <button class="test-button" onclick="clearLog()">
                ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ
            </button>
        </div>
        
        <!-- æ—¥èªŒ -->
        <div class="test-section">
            <h3>ğŸ“‹ æ¸¬è©¦æ—¥èªŒ</h3>
            <div id="testLog" class="log">
ç­‰å¾…æ¸¬è©¦é–‹å§‹...
            </div>
        </div>
        
        <!-- iframe æ¸¬è©¦å€åŸŸ -->
        <div class="test-section">
            <h3>ğŸ® éŠæˆ² iframe æ¸¬è©¦</h3>
            <div class="iframe-container">
                <iframe id="gameIframe" src="/games/starshake-game/dist/index.html"></iframe>
            </div>
        </div>
    </div>

    <script>
        console.log('ğŸ“± æ‰‹æ©Ÿ PostMessage æ¸¬è©¦å·¥å…·è¼‰å…¥');
        
        // å…¨å±€è®Šé‡
        let testLog = [];
        let communicationStatus = {
            initialized: false,
            working: false,
            lastTest: null,
            errors: []
        };

        // å…¨è¢å¹•ç‹€æ…‹
        window.isGameFullscreen = false;
        
        // æ—¥èªŒå‡½æ•¸
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logElement = document.getElementById('testLog');
            logElement.textContent = testLog.join('\\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(message);
        }
        
        // æ›´æ–°ç‹€æ…‹
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('commStatus');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
        
        // ç’°å¢ƒæª¢æ¸¬
        function detectEnvironment() {
            const env = {
                userAgent: navigator.userAgent,
                isMobile: /Mobi|Android/i.test(navigator.userAgent),
                isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
                isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
                isAndroid: /Android/.test(navigator.userAgent),
                screenWidth: screen.width,
                screenHeight: screen.height,
                windowWidth: window.innerWidth,
                windowHeight: window.innerHeight,
                hasPostMessage: typeof window.postMessage === 'function',
                timestamp: new Date().toISOString()
            };
            
            const envInfo = document.getElementById('environmentInfo');
            envInfo.innerHTML = `
                <strong>ğŸ” ç’°å¢ƒä¿¡æ¯ï¼š</strong><br>
                ğŸ“± ç§»å‹•è¨­å‚™: ${env.isMobile ? 'æ˜¯' : 'å¦'}<br>
                ğŸ Safari: ${env.isSafari ? 'æ˜¯' : 'å¦'}<br>
                ğŸ“± iOS: ${env.isIOS ? 'æ˜¯' : 'å¦'}<br>
                ğŸ¤– Android: ${env.isAndroid ? 'æ˜¯' : 'å¦'}<br>
                ğŸ“ è¢å¹•: ${env.screenWidth}x${env.screenHeight}<br>
                ğŸªŸ è¦–çª—: ${env.windowWidth}x${env.windowHeight}<br>
                ğŸ“¡ PostMessage: ${env.hasPostMessage ? 'æ”¯æ´' : 'ä¸æ”¯æ´'}
            `;
            
            log('ğŸ” ç’°å¢ƒæª¢æ¸¬å®Œæˆ: ' + JSON.stringify(env, null, 2));
            return env;
        }
        
        // è¨­ç½®çˆ¶é é¢ç›£è½å™¨
        function setupParentListener() {
            log('ğŸ“¡ è¨­ç½®çˆ¶é é¢ PostMessage ç›£è½å™¨');
            
            window.addEventListener('message', function(event) {
                log('ğŸ“¨ çˆ¶é é¢æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(event.data));
                
                try {
                    if (!event.data || typeof event.data !== 'object') {
                        return;
                    }
                    
                    const message = event.data;
                    
                    // è™•ç†ç›£è½å™¨è¨­ç½®è«‹æ±‚
                    if (message.type === 'SETUP_PARENT_LISTENER') {
                        log('ğŸ”§ è™•ç†ç›£è½å™¨è¨­ç½®è«‹æ±‚');
                        
                        event.source.postMessage({
                            type: 'PARENT_LISTENER_READY',
                            timestamp: Date.now(),
                            parentUserAgent: navigator.userAgent
                        }, event.origin);
                        
                        log('âœ… çˆ¶é é¢ç›£è½å™¨å°±ç·’éŸ¿æ‡‰å·²ç™¼é€');
                        updateStatus('âœ… çˆ¶é é¢ç›£è½å™¨å·²å°±ç·’', 'success');
                    }
                    
                    // è™•ç†é€šä¿¡æ¸¬è©¦
                    else if (message.type === 'COMMUNICATION_TEST') {
                        log('ğŸ§ª è™•ç†é€šä¿¡æ¸¬è©¦: ' + message.testId);
                        
                        event.source.postMessage({
                            type: 'COMMUNICATION_TEST_RESPONSE',
                            testId: message.testId,
                            timestamp: Date.now(),
                            parentUserAgent: navigator.userAgent,
                            receivedAt: Date.now(),
                            originalMessage: message
                        }, event.origin);
                        
                        log('âœ… é€šä¿¡æ¸¬è©¦éŸ¿æ‡‰å·²ç™¼é€');
                        communicationStatus.working = true;
                        updateStatus('âœ… PostMessage é€šä¿¡æ­£å¸¸å·¥ä½œ', 'success');
                    }
                    
                    // è™•ç†å…¨è¢å¹•è«‹æ±‚
                    else if (message.type === 'DUAL_FULLSCREEN_REQUEST') {
                        log('ğŸ è™•ç†å…¨è¢å¹•è«‹æ±‚: ' + message.action);

                        // æ™ºèƒ½åˆ‡æ›ï¼šå¦‚æœå·²ç¶“å…¨è¢å¹•å°±é€€å‡ºï¼Œå¦å‰‡é€²å…¥
                        if (message.action === 'ENTER_CSS_FULLSCREEN') {
                            if (window.isGameFullscreen) {
                                log('ğŸ”„ å·²ç¶“å…¨è¢å¹•ï¼Œè‡ªå‹•åˆ‡æ›ç‚ºé€€å‡ºå…¨è¢å¹•');
                                // è§¸ç™¼é€€å‡ºå…¨è¢å¹•
                                window.postMessage({
                                    type: 'DUAL_FULLSCREEN_REQUEST',
                                    action: 'EXIT_CSS_FULLSCREEN',
                                    timestamp: Date.now(),
                                    source: 'AUTO_TOGGLE'
                                }, '*');
                                return;
                            }
                            // éš±è—æ¸¬è©¦å·¥å…·ç•Œé¢ï¼Œåªé¡¯ç¤ºéŠæˆ² iframe
                            const container = document.querySelector('.container');
                            const iframeContainer = document.querySelector('.iframe-container');
                            const iframe = document.getElementById('gameIframe');

                            if (container && iframeContainer && iframe) {
                                // éš±è—æ‰€æœ‰å…¶ä»–å…§å®¹
                                const children = container.children;
                                for (let i = 0; i < children.length; i++) {
                                    if (children[i] !== iframeContainer.parentElement) {
                                        children[i].style.display = 'none';
                                    }
                                }

                                // è¨­ç½® body å…¨è¢å¹•
                                document.body.style.position = 'fixed';
                                document.body.style.top = '0';
                                document.body.style.left = '0';
                                document.body.style.width = '100vw';
                                document.body.style.height = '100vh';
                                document.body.style.zIndex = '9999';
                                document.body.style.backgroundColor = '#000';
                                document.body.style.margin = '0';
                                document.body.style.padding = '0';

                                // è¨­ç½®å®¹å™¨å…¨è¢å¹•
                                container.style.maxWidth = 'none';
                                container.style.width = '100vw';
                                container.style.height = '100vh';
                                container.style.margin = '0';
                                container.style.padding = '0';
                                container.style.background = 'transparent';

                                // è¨­ç½® iframe å®¹å™¨å…¨è¢å¹•ï¼Œå‘ä¸Šç§»å‹•
                                iframeContainer.style.position = 'fixed';
                                iframeContainer.style.top = '-80px';  // å®¹å™¨ä¹Ÿå‘ä¸Šç§»å‹•
                                iframeContainer.style.left = '0';
                                iframeContainer.style.width = '100vw';
                                iframeContainer.style.height = 'calc(100vh + 80px)';  // å¢åŠ å®¹å™¨é«˜åº¦
                                iframeContainer.style.margin = '0';
                                iframeContainer.style.padding = '0';
                                iframeContainer.style.border = 'none';
                                iframeContainer.style.borderRadius = '0';
                                iframeContainer.style.zIndex = '10000';
                                iframeContainer.style.overflow = 'hidden';  // éš±è—æº¢å‡º

                                log('âœ… iframe å®¹å™¨ä½ç½®èª¿æ•´: top: -80px, height: calc(100vh + 80px)');

                                // è¨­ç½® iframe å…¨è¢å¹•ï¼Œå‘ä¸Šç§»å‹•çµ¦æ–æ¡¿ç•™ç©ºé–“
                                iframe.style.position = 'absolute';
                                iframe.style.top = '-100px';  // å‘ä¸Šç§»å‹•100pxçµ¦æ–æ¡¿ç•™æ›´å¤šç©ºé–“
                                iframe.style.left = '0';
                                iframe.style.width = '100vw';
                                iframe.style.height = 'calc(100vh + 100px)';  // å¢åŠ é«˜åº¦è£œå„Ÿå‘ä¸Šç§»å‹•
                                iframe.style.border = 'none';
                                iframe.style.margin = '0';
                                iframe.style.padding = '0';
                                iframe.style.transform = 'translateY(0)';
                                iframe.style.overflow = 'hidden';  // éš±è—æº¢å‡ºéƒ¨åˆ†

                                log('âœ… iframe ä½ç½®èª¿æ•´: top: -100px, height: calc(100vh + 100px)');

                                // å˜—è©¦éš±è— Safari åœ°å€æ¬„
                                try {
                                    // æ»¾å‹•åˆ°é ‚éƒ¨éš±è—åœ°å€æ¬„
                                    window.scrollTo(0, 1);
                                    setTimeout(() => window.scrollTo(0, 0), 100);

                                    // å˜—è©¦ä½¿ç”¨åŸç”Ÿå…¨è¢å¹• API
                                    if (document.documentElement.requestFullscreen) {
                                        document.documentElement.requestFullscreen().catch(e => {
                                            log('âš ï¸ åŸç”Ÿå…¨è¢å¹• API å¤±æ•—: ' + e.message);
                                        });
                                    } else if (document.documentElement.webkitRequestFullscreen) {
                                        document.documentElement.webkitRequestFullscreen();
                                    }

                                    log('âœ… å˜—è©¦éš±è— Safari åœ°å€æ¬„');
                                } catch (error) {
                                    log('âš ï¸ éš±è—åœ°å€æ¬„å¤±æ•—: ' + error.message);
                                }

                                log('âœ… éŠæˆ² iframe CSS å…¨è¢å¹•å·²å•Ÿç”¨');
                                updateStatus('âœ… éŠæˆ²å…¨è¢å¹•å·²å•Ÿç”¨', 'success');

                                // æ¨™è¨˜å…¨è¢å¹•ç‹€æ…‹
                                window.isGameFullscreen = true;
                            } else {
                                log('âŒ æ‰¾ä¸åˆ°å¿…è¦çš„ DOM å…ƒç´ ');
                            }

                        } else if (message.action === 'EXIT_CSS_FULLSCREEN') {
                            // æ¢å¾©æ¸¬è©¦å·¥å…·ç•Œé¢
                            const container = document.querySelector('.container');
                            const iframeContainer = document.querySelector('.iframe-container');
                            const iframe = document.getElementById('gameIframe');

                            if (container && iframeContainer && iframe) {
                                // æ¢å¾©æ‰€æœ‰éš±è—çš„å…§å®¹
                                const children = container.children;
                                for (let i = 0; i < children.length; i++) {
                                    children[i].style.display = '';
                                }

                                // æ¢å¾© body æ¨£å¼
                                document.body.style.position = '';
                                document.body.style.top = '';
                                document.body.style.left = '';
                                document.body.style.width = '';
                                document.body.style.height = '';
                                document.body.style.zIndex = '';
                                document.body.style.backgroundColor = '';
                                document.body.style.margin = '';
                                document.body.style.padding = '';

                                // æ¢å¾©å®¹å™¨æ¨£å¼
                                container.style.maxWidth = '';
                                container.style.width = '';
                                container.style.height = '';
                                container.style.margin = '';
                                container.style.padding = '';
                                container.style.background = '';

                                // æ¢å¾© iframe å®¹å™¨æ¨£å¼
                                iframeContainer.style.position = '';
                                iframeContainer.style.top = '';
                                iframeContainer.style.left = '';
                                iframeContainer.style.width = '';
                                iframeContainer.style.height = '';
                                iframeContainer.style.margin = '';
                                iframeContainer.style.padding = '';
                                iframeContainer.style.border = '';
                                iframeContainer.style.borderRadius = '';
                                iframeContainer.style.zIndex = '';
                                iframeContainer.style.overflow = '';

                                // æ¢å¾© iframe æ¨£å¼
                                iframe.style.position = '';
                                iframe.style.top = '';
                                iframe.style.left = '';
                                iframe.style.width = '';
                                iframe.style.height = '';
                                iframe.style.border = '';
                                iframe.style.margin = '';
                                iframe.style.padding = '';
                                iframe.style.transform = '';
                                iframe.style.overflow = '';

                                // é€€å‡ºåŸç”Ÿå…¨è¢å¹•
                                try {
                                    if (document.exitFullscreen) {
                                        document.exitFullscreen().catch(e => {
                                            log('âš ï¸ é€€å‡ºåŸç”Ÿå…¨è¢å¹•å¤±æ•—: ' + e.message);
                                        });
                                    } else if (document.webkitExitFullscreen) {
                                        document.webkitExitFullscreen();
                                    }

                                    log('âœ… å˜—è©¦é€€å‡ºåŸç”Ÿå…¨è¢å¹•');
                                } catch (error) {
                                    log('âš ï¸ é€€å‡ºå…¨è¢å¹•å¤±æ•—: ' + error.message);
                                }

                                log('âœ… éŠæˆ² iframe CSS å…¨è¢å¹•å·²é€€å‡º');
                                updateStatus('âœ… éŠæˆ²å…¨è¢å¹•å·²é€€å‡º', 'success');

                                // æ¸…é™¤å…¨è¢å¹•ç‹€æ…‹
                                window.isGameFullscreen = false;
                            } else {
                                log('âŒ æ‰¾ä¸åˆ°å¿…è¦çš„ DOM å…ƒç´ ');
                            }
                        }
                    }
                    
                } catch (error) {
                    log('âŒ çˆ¶é é¢æ¶ˆæ¯è™•ç†å¤±æ•—: ' + error.message);
                    communicationStatus.errors.push(error.message);
                }
            });
            
            log('âœ… çˆ¶é é¢ PostMessage ç›£è½å™¨å·²è¨­ç½®');
        }
        
        // æ¸¬è©¦åŸºæœ¬é€šä¿¡
        async function testBasicCommunication() {
            log('ğŸ§ª é–‹å§‹æ¸¬è©¦åŸºæœ¬ PostMessage é€šä¿¡');
            updateStatus('ğŸ”„ æ¸¬è©¦åŸºæœ¬é€šä¿¡ä¸­...', 'info');
            
            try {
                const iframe = document.getElementById('gameIframe');
                if (!iframe || !iframe.contentWindow) {
                    throw new Error('iframe æœªè¼‰å…¥æˆ–ç„¡æ³•è¨ªå•');
                }
                
                const testMessage = {
                    type: 'BASIC_COMMUNICATION_TEST',
                    timestamp: Date.now(),
                    testId: 'basic_' + Date.now()
                };
                
                log('ğŸ“¤ ç™¼é€åŸºæœ¬æ¸¬è©¦æ¶ˆæ¯: ' + JSON.stringify(testMessage));
                iframe.contentWindow.postMessage(testMessage, '*');
                
                // ç­‰å¾…éŸ¿æ‡‰
                setTimeout(() => {
                    if (!communicationStatus.working) {
                        log('â° åŸºæœ¬é€šä¿¡æ¸¬è©¦è¶…æ™‚');
                        updateStatus('â° åŸºæœ¬é€šä¿¡æ¸¬è©¦è¶…æ™‚', 'error');
                    }
                }, 3000);
                
            } catch (error) {
                log('âŒ åŸºæœ¬é€šä¿¡æ¸¬è©¦å¤±æ•—: ' + error.message);
                updateStatus('âŒ åŸºæœ¬é€šä¿¡æ¸¬è©¦å¤±æ•—', 'error');
            }
        }
        
        // æ¸¬è©¦å¼·åŒ–é€šä¿¡
        async function testEnhancedCommunication() {
            log('ğŸ”§ é–‹å§‹æ¸¬è©¦å¼·åŒ– PostMessage é€šä¿¡');
            updateStatus('ğŸ”„ æ¸¬è©¦å¼·åŒ–é€šä¿¡ä¸­...', 'info');
            
            try {
                const iframe = document.getElementById('gameIframe');
                if (!iframe || !iframe.contentWindow) {
                    throw new Error('iframe æœªè¼‰å…¥æˆ–ç„¡æ³•è¨ªå•');
                }
                
                // è§¸ç™¼ iframe å…§çš„å¼·åŒ–é€šä¿¡æ¸¬è©¦
                const testMessage = {
                    type: 'TRIGGER_ENHANCED_TEST',
                    timestamp: Date.now()
                };
                
                log('ğŸ“¤ è§¸ç™¼ iframe å…§çš„å¼·åŒ–é€šä¿¡æ¸¬è©¦');
                iframe.contentWindow.postMessage(testMessage, '*');
                
                // ä¹Ÿå¯ä»¥ç›´æ¥èª¿ç”¨ iframe å…§çš„å‡½æ•¸ï¼ˆå¦‚æœå¯è¨ªå•ï¼‰
                setTimeout(() => {
                    try {
                        if (iframe.contentWindow.testPostMessageCommEnhanced) {
                            log('ğŸ”§ ç›´æ¥èª¿ç”¨ iframe å…§çš„å¼·åŒ–æ¸¬è©¦å‡½æ•¸');
                            iframe.contentWindow.testPostMessageCommEnhanced();
                        }
                    } catch (e) {
                        log('âš ï¸ ç„¡æ³•ç›´æ¥èª¿ç”¨ iframe å…§çš„å‡½æ•¸: ' + e.message);
                    }
                }, 1000);
                
            } catch (error) {
                log('âŒ å¼·åŒ–é€šä¿¡æ¸¬è©¦å¤±æ•—: ' + error.message);
                updateStatus('âŒ å¼·åŒ–é€šä¿¡æ¸¬è©¦å¤±æ•—', 'error');
            }
        }
        
        // æ¸¬è©¦å…¨è¢å¹•è«‹æ±‚
        async function testFullscreenRequest() {
            log('ğŸ é–‹å§‹æ¸¬è©¦å…¨è¢å¹•è«‹æ±‚');
            updateStatus('ğŸ”„ æ¸¬è©¦å…¨è¢å¹•è«‹æ±‚ä¸­...', 'info');
            
            try {
                const iframe = document.getElementById('gameIframe');
                if (!iframe || !iframe.contentWindow) {
                    throw new Error('iframe æœªè¼‰å…¥æˆ–ç„¡æ³•è¨ªå•');
                }
                
                // è§¸ç™¼ iframe å…§çš„å…¨è¢å¹•è«‹æ±‚
                const fullscreenMessage = {
                    type: 'TRIGGER_FULLSCREEN_TEST',
                    timestamp: Date.now()
                };
                
                log('ğŸ“¤ è§¸ç™¼ iframe å…§çš„å…¨è¢å¹•æ¸¬è©¦');
                iframe.contentWindow.postMessage(fullscreenMessage, '*');
                
                // ä¹Ÿå¯ä»¥ç›´æ¥èª¿ç”¨ iframe å…§çš„å‡½æ•¸
                setTimeout(() => {
                    try {
                        if (iframe.contentWindow.requestFullscreenWithCommFix) {
                            log('ğŸ”§ ç›´æ¥èª¿ç”¨ iframe å…§çš„ä¿®å¾©å…¨è¢å¹•å‡½æ•¸');
                            iframe.contentWindow.requestFullscreenWithCommFix();
                        }
                    } catch (e) {
                        log('âš ï¸ ç„¡æ³•ç›´æ¥èª¿ç”¨ iframe å…§çš„å…¨è¢å¹•å‡½æ•¸: ' + e.message);
                    }
                }, 1000);
                
            } catch (error) {
                log('âŒ å…¨è¢å¹•è«‹æ±‚æ¸¬è©¦å¤±æ•—: ' + error.message);
                updateStatus('âŒ å…¨è¢å¹•è«‹æ±‚æ¸¬è©¦å¤±æ•—', 'error');
            }
        }
        
        // ç›£æ§é€šä¿¡ç‹€æ…‹
        function monitorCommunication() {
            log('ğŸ“Š é–‹å§‹ç›£æ§ PostMessage é€šä¿¡ç‹€æ…‹');
            
            const status = {
                ...communicationStatus,
                timestamp: new Date().toISOString(),
                environment: detectEnvironment()
            };
            
            log('ğŸ“Š ç•¶å‰é€šä¿¡ç‹€æ…‹: ' + JSON.stringify(status, null, 2));
            
            // å˜—è©¦ç²å– iframe å…§çš„ç‹€æ…‹
            try {
                const iframe = document.getElementById('gameIframe');
                if (iframe && iframe.contentWindow && iframe.contentWindow.monitorCommStatus) {
                    const iframeStatus = iframe.contentWindow.monitorCommStatus();
                    log('ğŸ“Š iframe å…§çš„é€šä¿¡ç‹€æ…‹: ' + JSON.stringify(iframeStatus, null, 2));
                }
            } catch (e) {
                log('âš ï¸ ç„¡æ³•ç²å– iframe å…§çš„ç‹€æ…‹: ' + e.message);
            }
        }
        
        // æ¸…é™¤æ—¥èªŒ
        function clearLog() {
            testLog = [];
            document.getElementById('testLog').textContent = 'æ—¥èªŒå·²æ¸…é™¤...';
            log('ğŸ—‘ï¸ æ—¥èªŒå·²æ¸…é™¤');
        }
        
        // åˆå§‹åŒ–
        function init() {
            log('ğŸš€ æ‰‹æ©Ÿ PostMessage æ¸¬è©¦å·¥å…·åˆå§‹åŒ–');
            
            // æª¢æ¸¬ç’°å¢ƒ
            detectEnvironment();
            
            // è¨­ç½®çˆ¶é é¢ç›£è½å™¨
            setupParentListener();
            
            // ç­‰å¾… iframe è¼‰å…¥
            const iframe = document.getElementById('gameIframe');
            iframe.onload = function() {
                log('âœ… éŠæˆ² iframe å·²è¼‰å…¥');
                updateStatus('âœ… iframe å·²è¼‰å…¥ï¼Œå¯ä»¥é–‹å§‹æ¸¬è©¦', 'success');
                
                // è‡ªå‹•è§¸ç™¼ä¸€æ¬¡åŸºæœ¬é€šä¿¡æ¸¬è©¦
                setTimeout(() => {
                    testBasicCommunication();
                }, 2000);
            };
            
            iframe.onerror = function() {
                log('âŒ éŠæˆ² iframe è¼‰å…¥å¤±æ•—');
                updateStatus('âŒ iframe è¼‰å…¥å¤±æ•—', 'error');
            };
            
            communicationStatus.initialized = true;
            log('âœ… æ¸¬è©¦å·¥å…·åˆå§‹åŒ–å®Œæˆ');
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
