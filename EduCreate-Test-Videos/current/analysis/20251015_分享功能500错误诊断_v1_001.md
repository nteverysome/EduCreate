# 分享功能 500 错误诊断报告

## 📋 测试信息
- **测试日期**: 2025-10-15
- **测试类型**: 问题诊断
- **测试工具**: Playwright 浏览器自动化
- **测试环境**: https://edu-create.vercel.app/my-results
- **当前状态**: ⚠️ 500 服务器错误

## 🔍 问题演进历程

### 第一阶段：401 未授权错误
**问题**: 分享功能一直返回 401 错误
**根本原因**: `authOptions` 导入路径错误
```typescript
// 错误的导入
import { authOptions } from '../../../auth/[...nextauth]/route';

// 正确的导入
import { authOptions } from '@/lib/auth';
```
**修复状态**: ✅ 已修复并部署

### 第二阶段：500 服务器错误（当前）
**问题**: 修复 authOptions 后，现在返回 500 错误
**错误信息**:
```
[ERROR] Failed to load resource: the server responded with a status of 500
[ERROR] 获取分享状态失败: 500
[ERROR] ❌ 更新分享状态失败: {"error":"伺服器錯誤"}
```

## 🎯 当前问题分析

### 可能的原因

#### 1. Session 类型问题
NextAuth 的 `session.user` 默认没有 `id` 和 `role` 属性。

**当前代码**:
```typescript
const session = await getServerSession(authOptions);
if (!session?.user?.id) {
  return NextResponse.json({ error: '未授權' }, { status: 401 });
}

// 使用 session.user.id
const result = await prisma.assignmentResult.findFirst({
  where: {
    id: resultId,
    assignment: {
      userId: session.user.id  // 可能 undefined
    }
  }
});
```

**问题**: `session.user.id` 可能是 `undefined`，导致数据库查询失败。

#### 2. TypeScript 类型定义缺失
需要扩展 NextAuth 的类型定义：

```typescript
// types/next-auth.d.ts
import NextAuth from "next-auth"

declare module "next-auth" {
  interface Session {
    user: {
      id: string
      email: string
      name: string
      image?: string
      role: string
    }
  }

  interface User {
    id: string
    email: string
    name: string
    image?: string
    role: string
  }
}
```

#### 3. Callback 配置问题
`lib/auth.ts` 中的 session callback 可能没有正确设置 `id` 和 `role`：

```typescript
async session({ session, user }) {
  // 使用数据库会话策略时，user 来自数据库
  if (user && session.user) {
    session.user.id = user.id;
    session.user.role = user.role;
  }
  return session;
}
```

**问题**: 如果使用 JWT 策略，`user` 参数可能不存在。

## 🔧 建议的修复方案

### 方案 1：修复 Session Callback（推荐）

**文件**: `lib/auth.ts`

```typescript
callbacks: {
  async jwt({ token, user }) {
    // 首次登录时，将用户信息添加到 token
    if (user) {
      token.id = user.id;
      token.role = user.role;
    }
    return token;
  },
  async session({ session, token, user }) {
    // 根据策略选择数据源
    if (token && session.user) {
      // JWT 策略
      session.user.id = token.id as string;
      session.user.role = token.role as string;
    } else if (user && session.user) {
      // 数据库策略
      session.user.id = user.id;
      session.user.role = user.role;
    }
    return session;
  }
}
```

### 方案 2：添加类型定义文件

**文件**: `types/next-auth.d.ts`（新建）

```typescript
import NextAuth, { DefaultSession } from "next-auth"

declare module "next-auth" {
  interface Session {
    user: {
      id: string
      role: string
    } & DefaultSession["user"]
  }

  interface User {
    id: string
    role: string
  }
}

declare module "next-auth/jwt" {
  interface JWT {
    id: string
    role: string
  }
}
```

### 方案 3：API 路由防御性编程

**文件**: `app/api/results/[resultId]/share/route.ts`

```typescript
export async function GET(
  request: NextRequest,
  { params }: { params: { resultId: string } }
) {
  try {
    const session = await getServerSession(authOptions);
    
    // 更详细的日志
    console.log('🔍 Session 信息:', {
      hasSession: !!session,
      hasUser: !!session?.user,
      userId: session?.user?.id,
      userEmail: session?.user?.email
    });
    
    if (!session?.user?.id) {
      console.error('❌ Session 无效:', session);
      return NextResponse.json({ error: '未授權' }, { status: 401 });
    }

    // ... 其余代码
  } catch (error) {
    console.error('❌ API 错误详情:', error);
    return NextResponse.json(
      { error: '伺服器錯誤', details: error.message },
      { status: 500 }
    );
  }
}
```

## 📊 诊断步骤

### 步骤 1：检查 Session 内容
添加日志查看 session 的实际内容：

```typescript
console.log('Session:', JSON.stringify(session, null, 2));
```

### 步骤 2：检查数据库策略
确认 `lib/auth.ts` 使用的是哪种策略：
- 有 `adapter: PrismaAdapter(prisma)` = 数据库策略
- 没有 adapter = JWT 策略

### 步骤 3：检查 Vercel 日志
查看 Vercel 部署的实时日志，找到具体的错误堆栈。

## 🎯 下一步行动

1. **立即**: 添加详细的日志记录到 API 路由
2. **短期**: 修复 session callback 确保 `id` 和 `role` 正确传递
3. **中期**: 添加 TypeScript 类型定义文件
4. **长期**: 考虑统一使用 JWT 策略简化会话管理

## 📝 测试验证计划

修复后需要验证：
1. ✅ Session 包含正确的 `user.id` 和 `user.role`
2. ✅ GET `/api/results/[resultId]/share` 返回 200
3. ✅ PATCH `/api/results/[resultId]/share` 返回 200
4. ✅ 分享模态框正常打开
5. ✅ 可以切换公开/私人状态
6. ✅ 分享链接正确生成

## 🔗 相关文件
- `lib/auth.ts` - NextAuth 配置
- `app/api/results/[resultId]/share/route.ts` - 分享 API
- `types/next-auth.d.ts` - TypeScript 类型定义（需要创建）

## 📌 总结

**进展**:
- ✅ 第一个问题（401 错误）已解决
- ⚠️ 第二个问题（500 错误）正在诊断

**根本原因**:
- NextAuth session 的 `user.id` 可能未正确设置
- 需要修复 session callback 或添加类型定义

**优先级**: 🔴 高（核心功能无法使用）

