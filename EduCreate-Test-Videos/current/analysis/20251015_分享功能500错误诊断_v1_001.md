# åˆ†äº«åŠŸèƒ½ 500 é”™è¯¯è¯Šæ–­æŠ¥å‘Š

## ğŸ“‹ æµ‹è¯•ä¿¡æ¯
- **æµ‹è¯•æ—¥æœŸ**: 2025-10-15
- **æµ‹è¯•ç±»å‹**: é—®é¢˜è¯Šæ–­
- **æµ‹è¯•å·¥å…·**: Playwright æµè§ˆå™¨è‡ªåŠ¨åŒ–
- **æµ‹è¯•ç¯å¢ƒ**: https://edu-create.vercel.app/my-results
- **å½“å‰çŠ¶æ€**: âš ï¸ 500 æœåŠ¡å™¨é”™è¯¯

## ğŸ” é—®é¢˜æ¼”è¿›å†ç¨‹

### ç¬¬ä¸€é˜¶æ®µï¼š401 æœªæˆæƒé”™è¯¯
**é—®é¢˜**: åˆ†äº«åŠŸèƒ½ä¸€ç›´è¿”å› 401 é”™è¯¯
**æ ¹æœ¬åŸå› **: `authOptions` å¯¼å…¥è·¯å¾„é”™è¯¯
```typescript
// é”™è¯¯çš„å¯¼å…¥
import { authOptions } from '../../../auth/[...nextauth]/route';

// æ­£ç¡®çš„å¯¼å…¥
import { authOptions } from '@/lib/auth';
```
**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶éƒ¨ç½²

### ç¬¬äºŒé˜¶æ®µï¼š500 æœåŠ¡å™¨é”™è¯¯ï¼ˆå½“å‰ï¼‰
**é—®é¢˜**: ä¿®å¤ authOptions åï¼Œç°åœ¨è¿”å› 500 é”™è¯¯
**é”™è¯¯ä¿¡æ¯**:
```
[ERROR] Failed to load resource: the server responded with a status of 500
[ERROR] è·å–åˆ†äº«çŠ¶æ€å¤±è´¥: 500
[ERROR] âŒ æ›´æ–°åˆ†äº«çŠ¶æ€å¤±è´¥: {"error":"ä¼ºæœå™¨éŒ¯èª¤"}
```

## ğŸ¯ å½“å‰é—®é¢˜åˆ†æ

### å¯èƒ½çš„åŸå› 

#### 1. Session ç±»å‹é—®é¢˜
NextAuth çš„ `session.user` é»˜è®¤æ²¡æœ‰ `id` å’Œ `role` å±æ€§ã€‚

**å½“å‰ä»£ç **:
```typescript
const session = await getServerSession(authOptions);
if (!session?.user?.id) {
  return NextResponse.json({ error: 'æœªæˆæ¬Š' }, { status: 401 });
}

// ä½¿ç”¨ session.user.id
const result = await prisma.assignmentResult.findFirst({
  where: {
    id: resultId,
    assignment: {
      userId: session.user.id  // å¯èƒ½ undefined
    }
  }
});
```

**é—®é¢˜**: `session.user.id` å¯èƒ½æ˜¯ `undefined`ï¼Œå¯¼è‡´æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ã€‚

#### 2. TypeScript ç±»å‹å®šä¹‰ç¼ºå¤±
éœ€è¦æ‰©å±• NextAuth çš„ç±»å‹å®šä¹‰ï¼š

```typescript
// types/next-auth.d.ts
import NextAuth from "next-auth"

declare module "next-auth" {
  interface Session {
    user: {
      id: string
      email: string
      name: string
      image?: string
      role: string
    }
  }

  interface User {
    id: string
    email: string
    name: string
    image?: string
    role: string
  }
}
```

#### 3. Callback é…ç½®é—®é¢˜
`lib/auth.ts` ä¸­çš„ session callback å¯èƒ½æ²¡æœ‰æ­£ç¡®è®¾ç½® `id` å’Œ `role`ï¼š

```typescript
async session({ session, user }) {
  // ä½¿ç”¨æ•°æ®åº“ä¼šè¯ç­–ç•¥æ—¶ï¼Œuser æ¥è‡ªæ•°æ®åº“
  if (user && session.user) {
    session.user.id = user.id;
    session.user.role = user.role;
  }
  return session;
}
```

**é—®é¢˜**: å¦‚æœä½¿ç”¨ JWT ç­–ç•¥ï¼Œ`user` å‚æ•°å¯èƒ½ä¸å­˜åœ¨ã€‚

## ğŸ”§ å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä¿®å¤ Session Callbackï¼ˆæ¨èï¼‰

**æ–‡ä»¶**: `lib/auth.ts`

```typescript
callbacks: {
  async jwt({ token, user }) {
    // é¦–æ¬¡ç™»å½•æ—¶ï¼Œå°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ° token
    if (user) {
      token.id = user.id;
      token.role = user.role;
    }
    return token;
  },
  async session({ session, token, user }) {
    // æ ¹æ®ç­–ç•¥é€‰æ‹©æ•°æ®æº
    if (token && session.user) {
      // JWT ç­–ç•¥
      session.user.id = token.id as string;
      session.user.role = token.role as string;
    } else if (user && session.user) {
      // æ•°æ®åº“ç­–ç•¥
      session.user.id = user.id;
      session.user.role = user.role;
    }
    return session;
  }
}
```

### æ–¹æ¡ˆ 2ï¼šæ·»åŠ ç±»å‹å®šä¹‰æ–‡ä»¶

**æ–‡ä»¶**: `types/next-auth.d.ts`ï¼ˆæ–°å»ºï¼‰

```typescript
import NextAuth, { DefaultSession } from "next-auth"

declare module "next-auth" {
  interface Session {
    user: {
      id: string
      role: string
    } & DefaultSession["user"]
  }

  interface User {
    id: string
    role: string
  }
}

declare module "next-auth/jwt" {
  interface JWT {
    id: string
    role: string
  }
}
```

### æ–¹æ¡ˆ 3ï¼šAPI è·¯ç”±é˜²å¾¡æ€§ç¼–ç¨‹

**æ–‡ä»¶**: `app/api/results/[resultId]/share/route.ts`

```typescript
export async function GET(
  request: NextRequest,
  { params }: { params: { resultId: string } }
) {
  try {
    const session = await getServerSession(authOptions);
    
    // æ›´è¯¦ç»†çš„æ—¥å¿—
    console.log('ğŸ” Session ä¿¡æ¯:', {
      hasSession: !!session,
      hasUser: !!session?.user,
      userId: session?.user?.id,
      userEmail: session?.user?.email
    });
    
    if (!session?.user?.id) {
      console.error('âŒ Session æ— æ•ˆ:', session);
      return NextResponse.json({ error: 'æœªæˆæ¬Š' }, { status: 401 });
    }

    // ... å…¶ä½™ä»£ç 
  } catch (error) {
    console.error('âŒ API é”™è¯¯è¯¦æƒ…:', error);
    return NextResponse.json(
      { error: 'ä¼ºæœå™¨éŒ¯èª¤', details: error.message },
      { status: 500 }
    );
  }
}
```

## ğŸ“Š è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ£€æŸ¥ Session å†…å®¹
æ·»åŠ æ—¥å¿—æŸ¥çœ‹ session çš„å®é™…å†…å®¹ï¼š

```typescript
console.log('Session:', JSON.stringify(session, null, 2));
```

### æ­¥éª¤ 2ï¼šæ£€æŸ¥æ•°æ®åº“ç­–ç•¥
ç¡®è®¤ `lib/auth.ts` ä½¿ç”¨çš„æ˜¯å“ªç§ç­–ç•¥ï¼š
- æœ‰ `adapter: PrismaAdapter(prisma)` = æ•°æ®åº“ç­–ç•¥
- æ²¡æœ‰ adapter = JWT ç­–ç•¥

### æ­¥éª¤ 3ï¼šæ£€æŸ¥ Vercel æ—¥å¿—
æŸ¥çœ‹ Vercel éƒ¨ç½²çš„å®æ—¶æ—¥å¿—ï¼Œæ‰¾åˆ°å…·ä½“çš„é”™è¯¯å †æ ˆã€‚

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³**: æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•åˆ° API è·¯ç”±
2. **çŸ­æœŸ**: ä¿®å¤ session callback ç¡®ä¿ `id` å’Œ `role` æ­£ç¡®ä¼ é€’
3. **ä¸­æœŸ**: æ·»åŠ  TypeScript ç±»å‹å®šä¹‰æ–‡ä»¶
4. **é•¿æœŸ**: è€ƒè™‘ç»Ÿä¸€ä½¿ç”¨ JWT ç­–ç•¥ç®€åŒ–ä¼šè¯ç®¡ç†

## ğŸ“ æµ‹è¯•éªŒè¯è®¡åˆ’

ä¿®å¤åéœ€è¦éªŒè¯ï¼š
1. âœ… Session åŒ…å«æ­£ç¡®çš„ `user.id` å’Œ `user.role`
2. âœ… GET `/api/results/[resultId]/share` è¿”å› 200
3. âœ… PATCH `/api/results/[resultId]/share` è¿”å› 200
4. âœ… åˆ†äº«æ¨¡æ€æ¡†æ­£å¸¸æ‰“å¼€
5. âœ… å¯ä»¥åˆ‡æ¢å…¬å¼€/ç§äººçŠ¶æ€
6. âœ… åˆ†äº«é“¾æ¥æ­£ç¡®ç”Ÿæˆ

## ğŸ”— ç›¸å…³æ–‡ä»¶
- `lib/auth.ts` - NextAuth é…ç½®
- `app/api/results/[resultId]/share/route.ts` - åˆ†äº« API
- `types/next-auth.d.ts` - TypeScript ç±»å‹å®šä¹‰ï¼ˆéœ€è¦åˆ›å»ºï¼‰

## ğŸ“Œ æ€»ç»“

**è¿›å±•**:
- âœ… ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ˆ401 é”™è¯¯ï¼‰å·²è§£å†³
- âš ï¸ ç¬¬äºŒä¸ªé—®é¢˜ï¼ˆ500 é”™è¯¯ï¼‰æ­£åœ¨è¯Šæ–­

**æ ¹æœ¬åŸå› **:
- NextAuth session çš„ `user.id` å¯èƒ½æœªæ­£ç¡®è®¾ç½®
- éœ€è¦ä¿®å¤ session callback æˆ–æ·»åŠ ç±»å‹å®šä¹‰

**ä¼˜å…ˆçº§**: ğŸ”´ é«˜ï¼ˆæ ¸å¿ƒåŠŸèƒ½æ— æ³•ä½¿ç”¨ï¼‰

