name: CDP Responsively App è‡ªå‹•åŒ–æ¸¬è©¦

on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'public/games/match-up-game/**'
      - 'scripts/cdp-*.js'
      - '.github/workflows/cdp-responsively-test.yml'
  pull_request:
    branches: [ master, main, develop ]
  schedule:
    # æ¯å¤© UTC æ™‚é–“ 02:00 é‹è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  cdp-test:
    runs-on: windows-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v3
      
      - name: ğŸ“¦ è¨­ç½® Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ğŸ“š å®‰è£ä¾è³´
        run: npm ci
      
      - name: ğŸ” æª¢æŸ¥ chrome-remote-interface
        run: npm list chrome-remote-interface
      
      - name: ğŸš€ å•Ÿå‹• Responsively App ä¸¦å•Ÿç”¨ CDP
        run: |
          $responsivelyPath = "C:\Users\Administrator\AppData\Local\Programs\ResponsivelyApp\ResponsivelyApp.exe"
          $gameUrl = "https://edu-create.vercel.app/games/switcher?game=match-up-game&activityId=cmh93tjuh0001l404hszkdf94&layout=mixed&itemsPerPage=20"
          
          if (Test-Path $responsivelyPath) {
            Write-Host "âœ… Responsively App å·²æ‰¾åˆ°"
            Start-Process -FilePath $responsivelyPath `
                         -ArgumentList "--remote-debugging-port=9222", $gameUrl `
                         -PassThru
            Start-Sleep -Seconds 15
            Write-Host "âœ… Responsively App å·²å•Ÿå‹•"
          } else {
            Write-Host "âš ï¸  Responsively App æœªæ‰¾åˆ°ï¼Œè·³é CDP æ¸¬è©¦"
            exit 0
          }
        shell: powershell
      
      - name: ğŸ§ª é‹è¡Œ CDP è‡ªå‹•åŒ–æ¸¬è©¦
        run: node scripts/cdp-auto-setup.js
        continue-on-error: true
      
      - name: ğŸ“Š é‹è¡Œå¢å¼·ç‰ˆ CDP æ¸¬è©¦ (å«æ€§èƒ½ç›£æ§)
        run: node scripts/cdp-enhanced-controller.js --network-throttle --screenshot
        continue-on-error: true
      
      - name: ğŸ“ˆ ç”Ÿæˆæ¸¬è©¦å ±å‘Š
        if: always()
        run: |
          Write-Host "ğŸ“‹ ç”Ÿæˆæ¸¬è©¦å ±å‘Š..."
          
          $reportDir = "reports"
          if (Test-Path $reportDir) {
            Get-ChildItem $reportDir -Filter "*.json" | ForEach-Object {
              Write-Host "âœ… å ±å‘Š: $($_.Name)"
            }
          }
      
      - name: ğŸ“¤ ä¸Šå‚³å ±å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cdp-test-reports-${{ matrix.node-version }}
          path: reports/
          retention-days: 30
      
      - name: ğŸ“¤ ä¸Šå‚³æˆªåœ–
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cdp-screenshots-${{ matrix.node-version }}
          path: reports/screenshots/
          retention-days: 30
      
      - name: ğŸ“Š ç™¼ä½ˆæ¸¬è©¦çµæœ
        if: always()
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          Write-Host "â•‘  âœ… CDP Responsively App è‡ªå‹•åŒ–æ¸¬è©¦å®Œæˆ                   â•‘"
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          Write-Host "ğŸ“‹ å ±å‘Šä½ç½®: reports/"
          Write-Host "ğŸ“¸ æˆªåœ–ä½ç½®: reports/screenshots/"
          Write-Host ""
          Write-Host "âœ… å·¥ä½œæµç¨‹å®Œæˆ"

  notify:
    runs-on: ubuntu-latest
    needs: cdp-test
    if: always()
    
    steps:
      - name: ğŸ“¢ ç™¼é€é€šçŸ¥
        run: |
          echo "âœ… CDP Responsively App è‡ªå‹•åŒ–æ¸¬è©¦å·²å®Œæˆ"
          echo "ç‹€æ…‹: ${{ needs.cdp-test.result }}"

