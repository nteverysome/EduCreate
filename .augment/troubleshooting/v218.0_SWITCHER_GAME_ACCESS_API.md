# v218.0 - Switcher URL 遊戲直接訪問 API

## 🎉 功能概述

在 Switcher URL 中，遊戲現在可以通過全局 `window.EduCreateGameAccess` 對象直接訪問！

**Switcher URL 示例：**
```
http://localhost:3000/games/switcher?game=match-up-game&activityId=cmh93tjuh0001l404hszkdf94
```

## 📋 可用方法

### 1. `getGame()`
獲取 iframe 中的 Phaser 遊戲對象

```javascript
const game = window.EduCreateGameAccess.getGame();
console.log(game); // Phaser.Game 實例
```

### 2. `getGameScene()`
獲取 GameScene 實例

```javascript
const gameScene = window.EduCreateGameAccess.getGameScene();
console.log(gameScene); // GameScene 實例
```

### 3. `showAllAnswers()`
調用 "Show All Answers" 功能

```javascript
const success = window.EduCreateGameAccess.showAllAnswers();
console.log(success); // true 或 false
```

**日誌輸出：**
```
✅ [v218.0] Show All Answers 已調用
```

### 4. `getCurrentPageInfo()`
獲取當前頁面的詳細信息

```javascript
const pageInfo = window.EduCreateGameAccess.getCurrentPageInfo();
console.log(pageInfo);
// 輸出：
// {
//   currentPage: 1,
//   totalPages: 2,
//   leftCardsPairIds: [1, 2, 3, 4],
//   rightEmptyBoxesPairIds: [4, 2, 3, 1],
//   isShowingAllAnswers: true
// }
```

### 5. `goToNextPage()`
導航到下一頁

```javascript
const success = window.EduCreateGameAccess.goToNextPage();
console.log(success); // true 或 false
```

### 6. `goToPreviousPage()`
導航到上一頁

```javascript
const success = window.EduCreateGameAccess.goToPreviousPage();
console.log(success); // true 或 false
```

## 🧪 完整測試流程

### 在瀏覽器控制台中執行：

```javascript
// 1. 檢查 API 是否可用
console.log(window.EduCreateGameAccess);

// 2. 獲取當前頁面信息
const pageInfo = window.EduCreateGameAccess.getCurrentPageInfo();
console.log('當前頁面:', pageInfo);

// 3. 調用 Show All Answers
window.EduCreateGameAccess.showAllAnswers();

// 4. 導航到下一頁
window.EduCreateGameAccess.goToNextPage();

// 5. 再次獲取頁面信息
const newPageInfo = window.EduCreateGameAccess.getCurrentPageInfo();
console.log('新頁面:', newPageInfo);

// 6. 返回上一頁
window.EduCreateGameAccess.goToPreviousPage();
```

## ✅ 測試結果

### 第1頁 - Show All Answers
- ✅ 卡片狀態：pairIds [1, 2, 3, 4]
- ✅ 空白框狀態：pairIds [4, 2, 3, 1]
- ✅ 移動結果：所有4張卡片成功移動到正確位置
- ✅ 動畫完成：所有Tween動畫完成，位置匹配

### 第2頁 - 導航並 Show All Answers
- ✅ 卡片狀態：pairIds [5, 6]
- ✅ 空白框狀態：pairIds [5, 6]
- ✅ 移動結果：卡片已在正確位置
- ✅ 自動恢復：卡片已自動移動到空白框位置

### 返回第1頁 - 關鍵測試
- ✅ 卡片狀態：pairIds [1, 2, 3, 4] ✅ **正確！**
- ✅ 空白框狀態：pairIds [2, 4, 1, 3]（新的隨機排列）
- ✅ 自動恢復：v217.2 狀態恢復成功！
- ✅ 移動結果：所有卡片自動移動到正確位置

## 🔧 實現細節

### 代碼位置
- **文件：** `components/games/GameSwitcher.tsx`
- **方法：** `handleIframeLoad` (第 1128-1209 行)
- **版本：** v218.0

### 工作原理

1. **iframe 加載完成時** → 觸發 `handleIframeLoad`
2. **創建全局訪問對象** → `window.EduCreateGameAccess`
3. **暴露遊戲方法** → 通過 iframe 的 `contentWindow` 訪問
4. **提供便捷接口** → 簡化的方法調用

### 關鍵代碼片段

```javascript
// 在 handleIframeLoad 中
window.EduCreateGameAccess = {
  getGame: () => iframeWindow.matchUpGame,
  
  getGameScene: () => {
    const game = iframeWindow.matchUpGame;
    if (!game) return null;
    return game.scene.scenes.find((s: any) => s.constructor.name === 'GameScene');
  },
  
  showAllAnswers: () => {
    const gameScene = window.EduCreateGameAccess.getGameScene();
    if (gameScene) {
      gameScene.showAllCorrectAnswers();
      return true;
    }
    return false;
  },
  
  // ... 其他方法
};
```

## 📝 使用場景

### 場景 1：自動化測試
```javascript
// 自動測試 Show All Answers 功能
window.EduCreateGameAccess.showAllAnswers();
await new Promise(r => setTimeout(r, 1000));
const pageInfo = window.EduCreateGameAccess.getCurrentPageInfo();
console.log('測試結果:', pageInfo.isShowingAllAnswers);
```

### 場景 2：頁面導航測試
```javascript
// 測試多頁導航
for (let i = 0; i < 5; i++) {
  window.EduCreateGameAccess.goToNextPage();
  await new Promise(r => setTimeout(r, 500));
}
```

### 場景 3：調試遊戲狀態
```javascript
// 定期檢查遊戲狀態
setInterval(() => {
  const info = window.EduCreateGameAccess.getCurrentPageInfo();
  console.log('遊戲狀態:', info);
}, 2000);
```

## 🎯 優勢

✅ **直接訪問** - 無需通過控制台複雜操作
✅ **簡化 API** - 提供便捷的方法接口
✅ **完整功能** - 支援所有主要遊戲操作
✅ **自動恢復** - 頁面導航時自動恢復狀態
✅ **調試友好** - 詳細的日誌輸出

## 🚀 下一步

- 可以為 Switcher 頁面添加一個 "Show All Answers" 按鈕
- 可以創建自動化測試腳本
- 可以集成到教師儀表板進行遠程控制

