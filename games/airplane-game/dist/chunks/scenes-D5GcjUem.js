var e=Object.defineProperty,t=(t,s,a)=>((t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a)(t,"symbol"!=typeof s?s+"":s,a);import{P as s}from"./phaser-CjIEy6U-.js";import{G as a,M as o,C as i}from"./managers-BDCOAzdU.js";class r extends s.Scene{constructor(){super({key:"GameScene"}),t(this,"gameConfig"),t(this,"gameState",{isPlaying:!1,isPaused:!1,currentScore:0,currentHealth:100,wordsLearned:0,accuracy:0}),t(this,"player"),t(this,"clouds"),t(this,"cursors"),t(this,"backgroundLayers",[]),t(this,"scoreText"),t(this,"healthText"),t(this,"targetWordText"),t(this,"accuracyText"),t(this,"wordsLearnedText"),t(this,"geptManager"),t(this,"collisionSystem"),t(this,"memoryEngine"),t(this,"cloudSpawnTimer"),t(this,"currentTargetWord"),t(this,"targetWordSetTime",0),t(this,"totalCollisions",0),t(this,"correctCollisions",0)}init(){console.log("🎮 初始化遊戲場景"),this.gameConfig=this.registry.get("gameConfig")||{geptLevel:"elementary",enableSound:!0,enableHapticFeedback:!0,difficulty:"medium",gameMode:"practice"},console.log("📋 遊戲配置:",this.gameConfig),this.initializeManagers()}initializeManagers(){this.geptManager=new a,this.geptManager.setLevel(this.gameConfig.geptLevel),this.memoryEngine=new o,this.collisionSystem=new i(this,this.gameConfig.geptLevel,{enableParticles:!0,enableScreenShake:!0,enableSoundEffects:this.gameConfig.enableSound,enableVisualFeedback:!0,particleIntensity:"medium",soundVolume:.7}),console.log("🔧 管理器初始化完成")}preload(){console.log("🎨 載入遊戲資源"),this.loadMoonBackground();const e=this.add.graphics();e.fillStyle(26367),e.fillTriangle(16,0,0,32,32,32),e.generateTexture("player-plane",32,32),e.destroy();const t=this.add.graphics();t.fillStyle(16777215),t.fillEllipse(32,16,60,28),t.lineStyle(2,8947848),t.strokeEllipse(32,16,60,28),t.generateTexture("cloud-word",64,32),t.destroy();const s=this.add.graphics();s.fillStyle(16777215),s.fillCircle(2,2,2),s.generateTexture("star",4,4),s.destroy(),console.log("✅ 遊戲資源載入完成 - 包含月亮背景")}loadMoonBackground(){console.log("🌙 載入月亮主題背景");try{this.load.image("moon-bg-1","/assets/backgrounds/moon/layer-1.png"),this.load.image("moon-bg-2","/assets/backgrounds/moon/layer-2.png"),this.load.image("moon-bg-3","/assets/backgrounds/moon/layer-3.png"),this.load.image("moon","/assets/backgrounds/moon/moon.png"),console.log("🌙 月亮背景圖片載入排程完成")}catch(e){console.warn("⚠️ 月亮背景載入失敗，將使用備用背景:",e)}}create(){console.log("🏗️ 創建遊戲場景"),this.createParallaxBackground(),this.createPlayer(),this.createClouds(),this.createGameHUD(),this.setupInput(),this.setupPhysics(),this.setRandomTargetWord(),this.startCloudSpawning(),console.log("✅ 遊戲場景創建完成"),this.startGame()}createParallaxBackground(){console.log("� 創建月亮主題視差背景");this.add.rectangle(400,300,800,600,657966).setDepth(-20),this.createMoonBackgroundLayers(),this.createStarField(),console.log("🌙 月亮主題視差背景創建完成")}createMoonBackgroundLayers(){const e=[],t=this.textures.exists("moon-bg-1"),s=this.textures.exists("moon-bg-2"),a=this.textures.exists("moon-bg-3"),o=this.textures.exists("moon");if(t||s||a){if(console.log("🌙 使用月亮主題背景圖片"),t){const t=this.add.tileSprite(0,0,800,600,"moon-bg-1");t.setOrigin(0,0),t.setDepth(-15),e.push(t)}if(o){const e=this.add.image(650,150,"moon");e.setDepth(-14),e.setScale(.8),e.setAlpha(.9)}if(s){const t=this.add.tileSprite(0,0,800,600,"moon-bg-2");t.setOrigin(0,0),t.setDepth(-13),e.push(t)}if(a){const t=this.add.tileSprite(0,0,800,600,"moon-bg-3");t.setOrigin(0,0),t.setDepth(-12),e.push(t)}}else{console.log("🌌 使用備用漸層背景");const t=this.add.graphics();t.fillGradientStyle(657966,657966,1710670,1710670),t.fillRect(0,0,800,600),t.generateTexture("fallback-bg-1",800,600),t.destroy();const s=this.add.graphics();s.fillGradientStyle(1710670,1710670,2763374,2763374),s.fillRect(0,0,800,600),s.generateTexture("fallback-bg-2",800,600),s.destroy();const a=this.add.tileSprite(0,0,800,600,"fallback-bg-1");a.setOrigin(0,0),a.setDepth(-15),a.setAlpha(.7),e.push(a);const o=this.add.tileSprite(0,0,800,600,"fallback-bg-2");o.setOrigin(0,0),o.setDepth(-13),o.setAlpha(.5),e.push(o)}this.backgroundLayers=e}createStarField(){console.log("⭐ 創建星空背景");for(let e=0;e<80;e++){const e=s.Math.Between(0,800),t=s.Math.Between(0,400),a=this.add.image(e,t,"star"),o=s.Math.FloatBetween(.3,1.2),i=s.Math.FloatBetween(.4,1);a.setScale(o),a.setAlpha(i),a.setDepth(-11),this.tweens.add({targets:a,alpha:.3*i,duration:s.Math.Between(2e3,4e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}}createPlayer(){console.log("✈️ 創建玩家飛機 (修復版本)"),this.player=this.physics.add.image(100,300,"player-plane"),this.player.setCollideWorldBounds(!0),this.player.setScale(1.5),this.player.setDepth(10),this.player.setAlpha(1),this.player.setVisible(!0),console.log("✈️ 玩家飛機創建完成:",{x:this.player.x,y:this.player.y,visible:this.player.visible,alpha:this.player.alpha,depth:this.player.depth,texture:this.player.texture.key})}createClouds(){this.clouds=this.physics.add.group(),console.log("☁️ 創建雲朵群組")}createGameHUD(){console.log("📊 創建遊戲 HUD (已擴展目標詞彙顯示)"),this.scoreText=this.add.text(16,16,"分數: 0",{fontSize:"24px",color:"#ffffff",backgroundColor:"#000000",padding:{x:8,y:4}}).setDepth(100),this.healthText=this.add.text(16,50,"生命值: 100",{fontSize:"20px",color:"#ffffff",backgroundColor:"#000000",padding:{x:8,y:4}}).setDepth(100),this.accuracyText=this.add.text(16,84,"準確率: 0%",{fontSize:"18px",color:"#ffffff",backgroundColor:"#000000",padding:{x:8,y:4}}).setDepth(100),this.wordsLearnedText=this.add.text(16,118,"學習詞彙: 0",{fontSize:"18px",color:"#ffffff",backgroundColor:"#000000",padding:{x:8,y:4}}).setDepth(100),this.targetWordText=this.add.text(400,16,"目標: 載入中...",{fontSize:"24px",color:"#ffff00",backgroundColor:"#000000",padding:{x:12,y:8},fontStyle:"bold"}).setOrigin(.5,0).setDepth(100),this.add.text(400,50,`GEPT: ${this.gameConfig.geptLevel}`,{fontSize:"16px",color:"#00ff00",backgroundColor:"#000000",padding:{x:8,y:4}}).setOrigin(.5,0).setDepth(100)}setupInput(){this.cursors=this.input.keyboard.createCursorKeys();const e=this.input.keyboard.addKeys("W,S,A,D");this.wasd=e,console.log("🎮 設置輸入控制")}setupPhysics(){console.log("⚡ 設置物理碰撞 (已移除子彈碰撞，修改玩家碰撞)"),this.physics.add.overlap(this.player,this.clouds,this.handleAdvancedCollision,void 0,this)}setRandomTargetWord(){const e=this.geptManager.getRandomWord();this.currentTargetWord=e||void 0,this.gameState.currentTargetWord=this.currentTargetWord,this.targetWordSetTime=Date.now(),this.targetWordText&&this.currentTargetWord&&(this.targetWordText.setText(`目標: ${this.currentTargetWord.chinese} (${this.currentTargetWord.english})`),this.collisionSystem.setTargetWord(this.currentTargetWord.english,this.currentTargetWord.chinese),console.log("🎯 設置目標詞彙:",this.currentTargetWord.english))}startCloudSpawning(){this.cloudSpawnTimer=this.time.addEvent({delay:2e3,callback:this.spawnCloud,callbackScope:this,loop:!0}),console.log("☁️ 開始雲朵生成")}spawnCloud(){if(!this.gameState.isPlaying)return;const e=this.geptManager.getRandomWord();if(!e)return;const t=s.Math.Between(100,500),a=this.physics.add.image(850,t,"cloud-word");a.setVelocityX(-100),a.setData("word",e),a.setData("isTarget",e.english===this.currentTargetWord?.english),a.setDepth(5),a.setAlpha(1),a.setVisible(!0);const o=e.english===this.currentTargetWord?.english,i=this.add.text(850,t,e.english,{fontSize:"16px",color:o?"#ff0000":"#000000",fontStyle:o?"bold":"normal",backgroundColor:o?"#ffff00":"#ffffff",padding:{x:4,y:2}}).setOrigin(.5);i.setDepth(6),i.setAlpha(1),i.setVisible(!0),a.setData("wordText",i),this.clouds.add(a),console.log("☁️ 生成雲朵 (修復版本):",e.english,o?"(目標)":"",{cloudVisible:a.visible,textVisible:i.visible,cloudDepth:a.depth,textDepth:i.depth})}handleAdvancedCollision(e,t){const s=t.getData("word");t.getData("isTarget");const a=t.getData("wordText"),o=this.collisionSystem.handleCollision(e,t,s),i={wordId:s.id,word:s.english,timestamp:Date.now(),responseTime:Date.now()-this.targetWordSetTime,isCorrect:"correct"===o.type,attemptNumber:this.totalCollisions+1,contextData:{targetWord:this.currentTargetWord?.english,geptLevel:this.gameConfig.geptLevel,gameMode:this.gameConfig.gameMode}};if(this.memoryEngine.recordLearningEvent(i),this.totalCollisions++,"correct"===o.type)this.correctCollisions++,this.gameState.currentScore+=10,this.gameState.wordsLearned++,this.setRandomTargetWord(),console.log("✅ 正確碰撞:",s.english);else if(this.gameState.currentHealth-=20,console.log("❌ 錯誤碰撞:",s.english),this.gameState.currentHealth<=0)return void this.endGame();a&&a.destroy(),t.destroy(),this.updateGameStats(),this.updateUI(),this.sendMessageToParent({type:"GAME_SCORE_UPDATE",score:this.gameState.currentScore,health:this.gameState.currentHealth})}updateGameStats(){this.gameState.accuracy=this.totalCollisions>0?Math.round(this.correctCollisions/this.totalCollisions*100):0}updateUI(){this.scoreText.setText(`分數: ${this.gameState.currentScore}`),this.healthText.setText(`生命值: ${this.gameState.currentHealth}`),this.accuracyText.setText(`準確率: ${this.gameState.accuracy}%`),this.wordsLearnedText.setText(`學習詞彙: ${this.gameState.wordsLearned}`),console.log("📊 更新 HUD:",{"分數":this.gameState.currentScore,"生命值":this.gameState.currentHealth,"準確率":this.gameState.accuracy,"學習詞彙":this.gameState.wordsLearned})}startGame(){this.gameState.isPlaying=!0,this.gameState.isPaused=!1,console.log("🚀 遊戲開始"),this.sendMessageToParent({type:"GAME_STATE_CHANGE",state:"playing"})}endGame(){this.gameState.isPlaying=!1,console.log("🏁 遊戲結束"),this.cloudSpawnTimer&&this.cloudSpawnTimer.destroy(),this.clouds.clear(!0,!0),this.sendMessageToParent({type:"GAME_COMPLETE",score:this.gameState.currentScore,health:this.gameState.currentHealth})}sendMessageToParent(e){window.parent!==window&&window.parent.postMessage(e,"*")}update(e,t){this.gameState.isPlaying&&!this.gameState.isPaused&&(this.updateParallaxBackground(),this.handlePlayerMovement(),this.cleanupObjects())}updateParallaxBackground(){this.backgroundLayers.forEach(((e,t)=>{const s=.3*(t+1);e.tilePositionX+=s})),Math.floor(Date.now()/1e3)%10==0&&console.log("� 更新月亮主題視差背景")}handlePlayerMovement(){const e=250,t=this.wasd;this.cursors.left.isDown||t?.A.isDown?this.player.setVelocityX(-250):this.cursors.right.isDown||t?.D.isDown?this.player.setVelocityX(e):this.player.setVelocityX(0),this.cursors.up.isDown||t?.W.isDown?this.player.setVelocityY(-250):this.cursors.down.isDown||t?.S.isDown?this.player.setVelocityY(e):this.player.setVelocityY(0)}cleanupObjects(){this.clouds.children.entries.forEach((e=>{if(e.x<-100){const t=e.getData("wordText");t&&t.destroy(),e.destroy()}else{const t=e.getData("wordText");t&&t.setPosition(e.x,e.y)}}))}}export{r as default};
//# sourceMappingURL=scenes-D5GcjUem.js.map
