# 混合模式卡片動態調整尺寸 - 可視化架構

## 🏗️ 系統架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                     混合模式卡片尺寸系統                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 輸入層                                                           │
│ ├─ width: 螢幕寬度                                              │
│ ├─ height: 螢幕高度                                             │
│ ├─ itemCount: 卡片數量                                          │
│ ├─ hasImages: 是否有圖片                                        │
│ └─ isFullscreen: 是否全螢幕                                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 第 1 層：設備檢測層                                              │
│ ├─ 寬度判斷 (< 768, 768-1024, > 1024)                          │
│ ├─ 高度判斷 (直向 vs 橫向)                                      │
│ └─ 輸出：deviceType (5 種)                                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 第 2 層：容器配置層                                              │
│ ├─ 根據 deviceType 選擇配置                                     │
│ ├─ 應用全螢幕調整 (× 0.5-0.8)                                   │
│ └─ 輸出：config (邊距、按鈕、列數、最小卡片)                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 第 3 層：可用空間計算層                                          │
│ ├─ availableWidth = width - sideMargin × 2                     │
│ ├─ availableHeight = height - topButtonArea - bottomButtonArea │
│ ├─ horizontalSpacing = clamp(width × 0.015, 15, 30)           │
│ └─ verticalSpacing = clamp(height × 0.04, 40, 80)             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 第 4 層：列數計算層                                              │
│ ├─ 固定列數 (手機: 5)                                           │
│ ├─ 動態列數 (平板/桌面)                                         │
│ │  ├─ 計算 maxPossibleCols                                     │
│ │  ├─ 根據 aspectRatio 選擇最大列數                            │
│ │  └─ optimalCols = min(maxPossible, maxLimit, itemCount)     │
│ └─ 輸出：cols                                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 第 5 層：卡片尺寸計算層                                          │
│ ├─ 計算行數：rows = ceil(itemCount / cols)                     │
│ ├─ 判斷卡片類型                                                 │
│ │  ├─ 正方形 (hasImages = true)                               │
│ │  │  ├─ squareSizeByHeight = availableHeightPerRow / 1.4    │
│ │  │  ├─ squareSizeByWidth = (availableWidth - spacing) / cols│
│ │  │  └─ squareSize = min(byHeight, byWidth)                 │
│ │  └─ 長方形 (hasImages = false)                              │
│ │     ├─ cardWidth = (availableWidth - spacing) / cols        │
│ │     └─ cardHeight = (availableHeightPerRow - spacing) / 1.4 │
│ ├─ 應用最小/最大限制                                            │
│ └─ 輸出：cardWidth, cardHeight                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 第 6 層：特殊處理層                                              │
│ ├─ 中文文字高度計算                                              │
│ │  ├─ 正方形：chineseTextHeight = cardHeight × 0.4            │
│ │  └─ 長方形：chineseTextHeight = 30px                        │
│ ├─ 驗證和調整                                                   │
│ │  ├─ 卡片尺寸 < 最小值？→ 增加列數                            │
│ │  ├─ 行數 > 最大行數？→ 增加列數                              │
│ │  └─ 卡片超出邊界？→ 調整尺寸                                 │
│ └─ 輸出：最終結果                                               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 輸出層                                                           │
│ ├─ cardWidth: 卡片寬度                                          │
│ ├─ cardHeight: 卡片高度                                         │
│ ├─ cols: 列數                                                   │
│ ├─ rows: 行數                                                   │
│ ├─ horizontalSpacing: 水平間距                                  │
│ ├─ verticalSpacing: 垂直間距                                    │
│ ├─ deviceType: 設備類型                                         │
│ └─ mode: 模式 (compact/desktop)                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 設備類型決策樹

```
                        開始
                         ↓
                  獲取螢幕尺寸
                         ↓
                  width < 768?
                    ↙        ↘
                  是          否
                   ↓           ↓
            height > width?   width < 1024?
              ↙        ↘       ↙        ↘
            是          否    是          否
             ↓           ↓     ↓           ↓
        mobile-    mobile-  height >   desktop
        portrait   landscape width?
                            ↙        ↘
                          是          否
                           ↓           ↓
                      tablet-    tablet-
                      portrait   landscape
```

---

## 🔄 列數計算決策樹

```
                    開始
                     ↓
            config.cols = 'dynamic'?
              ↙                  ↘
            是                    否
             ↓                     ↓
        計算動態列數          使用固定列數
             ↓                     ↓
        計算 aspectRatio      optimalCols = config.cols
             ↓
        aspectRatio > 2.0?
          ↙        ↘
        是          否
         ↓           ↓
    max=10      aspectRatio > 1.5?
                  ↙        ↘
                是          否
                 ↓           ↓
            max=10      aspectRatio > 1.2?
                          ↙        ↘
                        是          否
                         ↓           ↓
                    max=8        max=5
```

---

## 📐 卡片尺寸計算決策樹

```
                    開始
                     ↓
            hasImages = true?
              ↙              ↘
            是                否
             ↓                 ↓
        正方形模式          長方形模式
             ↓                 ↓
        計算 byHeight      計算 cardWidth
        計算 byWidth       計算 cardHeight
             ↓                 ↓
        squareSize =      應用最小/最大
        min(byH, byW)     限制
             ↓                 ↓
        應用最小/最大      cardWidth, cardHeight
        限制                   ↓
             ↓              計算文字高度
        cardWidth =        (30px)
        cardHeight =           ↓
        squareSize             ↓
             ↓              計算總單元高度
        計算文字高度           ↓
        (cardHeight × 0.4)  完成
             ↓
        計算總單元高度
             ↓
            完成
```

---

## 🎯 寬高比決策表

```
┌──────────────────────────────────────────────────────┐
│ 寬高比 (width / height)                              │
├──────────────────────────────────────────────────────┤
│ > 2.0                                                │
│ ├─ 螢幕類型：超寬（21:9, 32:9）                     │
│ ├─ 最大列數：10                                      │
│ └─ 例子：3840×1080, 5120×1440                       │
├──────────────────────────────────────────────────────┤
│ 1.5 - 2.0                                            │
│ ├─ 螢幕類型：寬（16:9, 16:10）                      │
│ ├─ 最大列數：10                                      │
│ └─ 例子：1920×1080, 1920×1200                       │
├──────────────────────────────────────────────────────┤
│ 1.2 - 1.5                                            │
│ ├─ 螢幕類型：標準（4:3, 3:2）                       │
│ ├─ 最大列數：8                                       │
│ └─ 例子：1024×768, 1440×960                         │
├──────────────────────────────────────────────────────┤
│ < 1.2                                                │
│ ├─ 螢幕類型：直向（9:16）                           │
│ ├─ 最大列數：5                                       │
│ └─ 例子：768×1024, 1080×1920                        │
└──────────────────────────────────────────────────────┘
```

---

## 🔢 計算流程示例

### 例子 1：手機直向（375×667）

```
輸入：width=375, height=667, itemCount=12, hasImages=true

第 1 層：設備檢測
├─ width < 768? 是
├─ height > width? 是
└─ deviceType = 'mobile-portrait'

第 2 層：容器配置
├─ config.topButtonArea = 40
├─ config.bottomButtonArea = 40
├─ config.sideMargin = 20
├─ config.cols = 5
└─ config.minCardSize = 150

第 3 層：可用空間
├─ availableWidth = 375 - 20×2 = 335
├─ availableHeight = 667 - 40 - 40 = 587
├─ horizontalSpacing = 15
└─ verticalSpacing = 40

第 4 層：列數計算
├─ config.cols = 5（固定）
└─ optimalCols = 5

第 5 層：卡片尺寸
├─ rows = ceil(12 / 5) = 3
├─ availableHeightPerRow = (587 - 40×4) / 3 ≈ 169
├─ squareSizeByHeight = 169 / 1.4 ≈ 121
├─ squareSizeByWidth = (335 - 15×6) / 5 ≈ 57
├─ squareSize = min(121, 57) = 57
└─ cardWidth = cardHeight = 57

第 6 層：特殊處理
├─ chineseTextHeight = 57 × 0.4 ≈ 23
├─ totalUnitHeight = 57 + 23 + 40 = 120
└─ 驗證通過

輸出：
├─ cardWidth: 57
├─ cardHeight: 57
├─ cols: 5
├─ rows: 3
├─ horizontalSpacing: 15
├─ verticalSpacing: 40
├─ deviceType: 'mobile-portrait'
└─ mode: 'compact'
```

### 例子 2：桌面全螢幕（1920×1080）

```
輸入：width=1920, height=1080, itemCount=20, hasImages=false, isFullscreen=true

第 1 層：設備檢測
├─ width >= 1024
└─ deviceType = 'desktop'

第 2 層：容器配置
├─ config.topButtonArea = 80 × 0.5 = 40
├─ config.bottomButtonArea = 80 × 0.5 = 40
├─ config.sideMargin = 50 × 0.75 = 37.5
├─ config.cols = 'dynamic'
└─ config.minCardSize = 150 × 0.8 = 120

第 3 層：可用空間
├─ availableWidth = 1920 - 37.5×2 = 1845
├─ availableHeight = 1080 - 40 - 40 = 1000
├─ horizontalSpacing = 30
└─ verticalSpacing = 40

第 4 層：列數計算
├─ aspectRatio = 1920 / 1080 ≈ 1.78
├─ maxPossibleCols = floor((1845 + 30) / (120 + 30)) ≈ 11
├─ 1.5 < 1.78 < 2.0 → max = 10
└─ optimalCols = min(11, 10, 20) = 10

第 5 層：卡片尺寸
├─ rows = ceil(20 / 10) = 2
├─ availableHeightPerRow = (1000 - 40×3) / 2 = 440
├─ cardWidth = (1845 - 30×11) / 10 ≈ 168
├─ cardHeight = (440 - 40) / 1.4 ≈ 286
└─ 應用限制後：cardWidth ≈ 168, cardHeight ≈ 286

第 6 層：特殊處理
├─ chineseTextHeight = 30（長方形模式）
├─ totalUnitHeight = 286 + 30 + 40 = 356
└─ 驗證通過

輸出：
├─ cardWidth: 168
├─ cardHeight: 286
├─ cols: 10
├─ rows: 2
├─ horizontalSpacing: 30
├─ verticalSpacing: 40
├─ deviceType: 'desktop'
└─ mode: 'desktop'
```

---

## 🎨 佈局視覺化

### 手機直向佈局（5 列 × 3 行）

```
┌─────────────────────────────────────┐
│ 手機直向 (375×667)                  │
├─────────────────────────────────────┤
│ [按鈕區域] (40px)                   │
├─────────────────────────────────────┤
│ ┌─┬─┬─┬─┬─┐                         │
│ │ │ │ │ │ │ 卡片 57×57              │
│ │ │ │ │ │ │ 文字 23px               │
│ ├─┼─┼─┼─┼─┤ 間距 40px               │
│ │ │ │ │ │ │                         │
│ │ │ │ │ │ │                         │
│ ├─┼─┼─┼─┼─┤                         │
│ │ │ │ │ │ │                         │
│ │ │ │ │ │ │                         │
│ └─┴─┴─┴─┴─┘                         │
├─────────────────────────────────────┤
│ [按鈕區域] (40px)                   │
└─────────────────────────────────────┘
```

### 桌面佈局（10 列 × 2 行）

```
┌──────────────────────────────────────────────────────────────────┐
│ 桌面 (1920×1080)                                                 │
├──────────────────────────────────────────────────────────────────┤
│ [按鈕區域] (40px)                                                │
├──────────────────────────────────────────────────────────────────┤
│ ┌──┬──┬──┬──┬──┬──┬──┬──┬──┬──┐                                  │
│ │  │  │  │  │  │  │  │  │  │  │ 卡片 168×286                   │
│ │  │  │  │  │  │  │  │  │  │  │ 文字 30px                      │
│ │  │  │  │  │  │  │  │  │  │  │ 間距 40px                      │
│ ├──┼──┼──┼──┼──┼──┼──┼──┼──┼──┤                                  │
│ │  │  │  │  │  │  │  │  │  │  │                                 │
│ │  │  │  │  │  │  │  │  │  │  │                                 │
│ │  │  │  │  │  │  │  │  │  │  │                                 │
│ └──┴──┴──┴──┴──┴──┴──┴──┴──┴──┘                                  │
├──────────────────────────────────────────────────────────────────┤
│ [按鈕區域] (40px)                                                │
└──────────────────────────────────────────────────────────────────┘
```

---

## ✅ 驗證流程

```
計算完成
    ↓
驗證 1：卡片尺寸 ≥ 最小值？
├─ 是 → 繼續
└─ 否 → 增加列數，重新計算

驗證 2：行數 ≤ 最大可能行數？
├─ 是 → 繼續
└─ 否 → 增加列數，重新計算

驗證 3：所有卡片都在容器內？
├─ 是 → 驗證通過
└─ 否 → 調整尺寸

驗證通過
    ↓
返回結果
```

